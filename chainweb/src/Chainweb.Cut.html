<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="%24con2tag_4u3IupfCVNcGhabk2vAWLS"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DefaultSignatures #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE ParallelListComp #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- Module: Chainweb.Cut</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- Copyright: Copyright &#169; 2018 Kadena LLC.</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- License: MIT</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Maintainer: Lars Kuhtz &lt;lars@kadena.io&gt;</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- Stability: experimental</span><span>
</span><span id="line-28"></span><span class="hs-comment">--</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- TODO</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Chainweb.Cut</span><span>
</span><span id="line-32"></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier">Cut</span></a></span><span>
</span><span id="line-33"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#_cutMap"><span class="hs-identifier">_cutMap</span></a></span><span>
</span><span id="line-34"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutMap"><span class="hs-identifier">cutMap</span></a></span><span>
</span><span id="line-35"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#_cutHeight"><span class="hs-identifier">_cutHeight</span></a></span><span>
</span><span id="line-36"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutHeight"><span class="hs-identifier">cutHeight</span></a></span><span>
</span><span id="line-37"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#_cutWeight"><span class="hs-identifier">_cutWeight</span></a></span><span>
</span><span id="line-38"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutWeight"><span class="hs-identifier">cutWeight</span></a></span><span>
</span><span id="line-39"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#_cutAdjPairs"><span class="hs-identifier">_cutAdjPairs</span></a></span><span>
</span><span id="line-40"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutAdjPairs"><span class="hs-identifier">cutAdjPairs</span></a></span><span>
</span><span id="line-41"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutAdjs"><span class="hs-identifier">cutAdjs</span></a></span><span>
</span><span id="line-42"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#lookupCutM"><span class="hs-identifier">lookupCutM</span></a></span><span>
</span><span id="line-43"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#forkDepth"><span class="hs-identifier">forkDepth</span></a></span><span>
</span><span id="line-44"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#limitCut"><span class="hs-identifier">limitCut</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="annot"><span class="hs-comment">-- * Exceptions</span></span><span>
</span><span id="line-47"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#CutException"><span class="hs-identifier">CutException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="annot"><span class="hs-comment">-- * Genesis Cut</span></span><span>
</span><span id="line-50"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#genesisCut"><span class="hs-identifier">genesisCut</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="annot"><span class="hs-comment">-- * Checks</span></span><span>
</span><span id="line-53"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCut"><span class="hs-identifier">checkBraidingOfCut</span></a></span><span>
</span><span id="line-54"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCutPairs"><span class="hs-identifier">checkBraidingOfCutPairs</span></a></span><span>
</span><span id="line-55"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCutPair"><span class="hs-identifier">checkBraidingOfCutPair</span></a></span><span>
</span><span id="line-56"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#isBraidingOfCutPair"><span class="hs-identifier">isBraidingOfCutPair</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="annot"><span class="hs-comment">-- * Extending Cuts</span></span><span>
</span><span id="line-59"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#isMonotonicCutExtension"><span class="hs-identifier">isMonotonicCutExtension</span></a></span><span>
</span><span id="line-60"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#monotonicCutExtension"><span class="hs-identifier">monotonicCutExtension</span></a></span><span>
</span><span id="line-61"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#tryMonotonicCutExtension"><span class="hs-identifier">tryMonotonicCutExtension</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="annot"><span class="hs-comment">-- * Join</span></span><span>
</span><span id="line-64"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier">Join</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#join"><span class="hs-identifier">join</span></a></span><span>
</span><span id="line-66"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#join_"><span class="hs-identifier">join_</span></a></span><span>
</span><span id="line-67"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#applyJoin"><span class="hs-identifier">applyJoin</span></a></span><span>
</span><span id="line-68"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#prioritizeHeavier"><span class="hs-identifier">prioritizeHeavier</span></a></span><span>
</span><span id="line-69"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#prioritizeHeavier_"><span class="hs-identifier">prioritizeHeavier_</span></a></span><span>
</span><span id="line-70"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#joinIntoHeavier"><span class="hs-identifier">joinIntoHeavier</span></a></span><span>
</span><span id="line-71"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#joinIntoHeavier_"><span class="hs-identifier">joinIntoHeavier_</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="annot"><span class="hs-comment">-- * Meet</span></span><span>
</span><span id="line-74"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#meet"><span class="hs-identifier">meet</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="annot"><span class="hs-comment">-- * Misc internal tools</span></span><span>
</span><span id="line-77"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#zipCuts"><span class="hs-identifier">zipCuts</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catch</span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">join</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifoldable</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Of</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Heap</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Reflection</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">int</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.These</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Numeric.Natural</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Streaming.Prelude</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- internal modules</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html"><span class="hs-identifier">Chainweb.BlockHash</span></a></span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html"><span class="hs-identifier">Chainweb.BlockHeader</span></a></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.Genesis.html"><span class="hs-identifier">Chainweb.BlockHeader.Genesis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.Genesis.html#genesisBlockHeaders"><span class="hs-identifier">genesisBlockHeaders</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html"><span class="hs-identifier">Chainweb.ChainId</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Graph.html"><span class="hs-identifier">Chainweb.Graph</span></a></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html"><span class="hs-identifier">Chainweb.TreeDB</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.TreeDB.html#properties"><span class="hs-identifier">properties</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.html"><span class="hs-identifier">Chainweb.Utils</span></a></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Version.html"><span class="hs-identifier">Chainweb.Version</span></a></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.html"><span class="hs-identifier">Chainweb.WebBlockHeaderDB</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- Cut</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | A cut is a distributed state of a concurrent computation. Formally, a cut</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- satisfies the property</span><span>
</span><span id="line-126"></span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- * prop_cutBraiding</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- A cut also satisfies the properties that</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- * the graph is valid,</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- * the graph corresponds to the 'ChainwebVersion',</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- * the set of 'ChainId's of the cut are exactly the vertices of the graph,</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- * all blockHeaders are valid (which is guaranteed by 'genesisBlockHeader')</span><span>
</span><span id="line-135"></span><span class="hs-comment">--   with respect to the graph.</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span id="local-6989586621681491795"><span id="local-6989586621681491796"></span></span><span class="hs-keyword">data</span><span> </span><span id="Cut"><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-var">Cut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Cut"><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-var">Cut</span></a></span></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_cutHeaders"><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_cutChainwebVersion"><span class="annot"><span class="annottext">Cut -&gt; ChainwebVersion
</span><a href="Chainweb.Cut.html#_cutChainwebVersion"><span class="hs-identifier hs-var hs-var">_cutChainwebVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491786"><span id="local-6989586621681491788"><span id="local-6989586621681491790"><span class="annot"><span class="annottext">Int -&gt; Cut -&gt; ShowS
[Cut] -&gt; ShowS
Cut -&gt; String
(Int -&gt; Cut -&gt; ShowS)
-&gt; (Cut -&gt; String) -&gt; ([Cut] -&gt; ShowS) -&gt; Show Cut
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Cut] -&gt; ShowS
$cshowList :: [Cut] -&gt; ShowS
show :: Cut -&gt; String
$cshow :: Cut -&gt; String
showsPrec :: Int -&gt; Cut -&gt; ShowS
$cshowsPrec :: Int -&gt; Cut -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491781"><span id="local-6989586621681491783"><span class="annot"><span class="annottext">Cut -&gt; Cut -&gt; Bool
(Cut -&gt; Cut -&gt; Bool) -&gt; (Cut -&gt; Cut -&gt; Bool) -&gt; Eq Cut
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Cut -&gt; Cut -&gt; Bool
$c/= :: Cut -&gt; Cut -&gt; Bool
== :: Cut -&gt; Cut -&gt; Bool
$c== :: Cut -&gt; Cut -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491765"><span id="local-6989586621681491767"><span id="local-6989586621681491769"><span id="local-6989586621681491771"><span id="local-6989586621681491773"><span id="local-6989586621681491775"><span id="local-6989586621681491777"><span class="annot"><span class="annottext">Eq Cut
Eq Cut =&gt;
(Cut -&gt; Cut -&gt; Ordering)
-&gt; (Cut -&gt; Cut -&gt; Bool)
-&gt; (Cut -&gt; Cut -&gt; Bool)
-&gt; (Cut -&gt; Cut -&gt; Bool)
-&gt; (Cut -&gt; Cut -&gt; Bool)
-&gt; (Cut -&gt; Cut -&gt; Cut)
-&gt; (Cut -&gt; Cut -&gt; Cut)
-&gt; Ord Cut
Cut -&gt; Cut -&gt; Bool
Cut -&gt; Cut -&gt; Ordering
Cut -&gt; Cut -&gt; Cut
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: Cut -&gt; Cut -&gt; Cut
$cmin :: Cut -&gt; Cut -&gt; Cut
max :: Cut -&gt; Cut -&gt; Cut
$cmax :: Cut -&gt; Cut -&gt; Cut
&gt;= :: Cut -&gt; Cut -&gt; Bool
$c&gt;= :: Cut -&gt; Cut -&gt; Bool
&gt; :: Cut -&gt; Cut -&gt; Bool
$c&gt; :: Cut -&gt; Cut -&gt; Bool
&lt;= :: Cut -&gt; Cut -&gt; Bool
$c&lt;= :: Cut -&gt; Cut -&gt; Bool
&lt; :: Cut -&gt; Cut -&gt; Bool
$c&lt; :: Cut -&gt; Cut -&gt; Bool
compare :: Cut -&gt; Cut -&gt; Ordering
$ccompare :: Cut -&gt; Cut -&gt; Ordering
$cp1Ord :: Eq Cut
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. Cut -&gt; Rep Cut x)
-&gt; (forall x. Rep Cut x -&gt; Cut) -&gt; Generic Cut
forall x. Rep Cut x -&gt; Cut
forall x. Cut -&gt; Rep Cut x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Cut x -&gt; Cut
$cfrom :: forall x. Cut -&gt; Rep Cut x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491759"><span class="annot"><span class="annottext">Cut -&gt; ()
(Cut -&gt; ()) -&gt; NFData Cut
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: Cut -&gt; ()
$crnf :: Cut -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></span></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span id="cutHeaders"><span id="cutChainwebVersion"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Cut</span></span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681491753"><span class="annot"><a href="Chainweb.Graph.html#HasChainGraph"><span class="hs-identifier hs-type">HasChainGraph</span></a></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621681491751"><span class="annot"><span class="annottext">_chainGraph :: Cut -&gt; ChainGraph
</span><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-identifier hs-var hs-var hs-var hs-var">_chainGraph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; ChainGraph
forall a. HasChainGraph a =&gt; a -&gt; ChainGraph
</span><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-identifier hs-var">_chainGraph</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainwebVersion -&gt; ChainGraph)
-&gt; (Cut -&gt; ChainwebVersion) -&gt; Cut -&gt; ChainGraph
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; ChainwebVersion
forall a. HasChainwebVersion a =&gt; a -&gt; ChainwebVersion
</span><a href="Chainweb.Version.html#_chainwebVersion"><span class="hs-identifier hs-var">_chainwebVersion</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-pragma hs-type">_chainGraph</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681491745"><span class="annot"><a href="Chainweb.Version.html#HasChainwebVersion"><span class="hs-identifier hs-type">HasChainwebVersion</span></a></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621681491743"><span class="annot"><span class="annottext">_chainwebVersion :: Cut -&gt; ChainwebVersion
</span><a href="#local-6989586621681491743"><span class="hs-identifier hs-var hs-var hs-var hs-var">_chainwebVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting ChainwebVersion Cut ChainwebVersion
-&gt; Cut -&gt; ChainwebVersion
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting ChainwebVersion Cut ChainwebVersion
Lens' Cut ChainwebVersion
</span><a href="Chainweb.Cut.html#cutChainwebVersion"><span class="hs-identifier hs-var">cutChainwebVersion</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Version.html#_chainwebVersion"><span class="hs-pragma hs-type">_chainwebVersion</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="Index"><span class="annot"><span class="hs-identifier hs-var">Index</span></span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-155"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="IxValue"><span class="annot"><span class="hs-identifier hs-var">IxValue</span></span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Chainweb.Utils.html#IxedGet"><span class="hs-identifier hs-type">IxedGet</span></a></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621681491739"><span class="annot"><span class="annottext">ixg :: Index Cut -&gt; Fold Cut (IxValue Cut)
</span><a href="Chainweb.Utils.html#ixg"><span class="hs-identifier hs-var hs-var hs-var hs-var">ixg</span></a></span></span><span> </span><span id="local-6989586621681491737"><span class="annot"><span class="annottext">i :: Index Cut
</span><a href="#local-6989586621681491737"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader -&gt; f (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; f Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader -&gt; f (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; f Cut)
-&gt; ((BlockHeader -&gt; f BlockHeader)
    -&gt; HashMap ChainId BlockHeader -&gt; f (HashMap ChainId BlockHeader))
-&gt; (BlockHeader -&gt; f BlockHeader)
-&gt; Cut
-&gt; f Cut
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (HashMap ChainId BlockHeader)
-&gt; Traversal'
     (HashMap ChainId BlockHeader)
     (IxValue (HashMap ChainId BlockHeader))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (HashMap ChainId BlockHeader)
Index Cut
</span><a href="#local-6989586621681491737"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Utils.html#ixg"><span class="hs-pragma hs-type">ixg</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Chainweb.Cut.html#_cutMap"><span class="hs-identifier hs-type">_cutMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-162"></span><span id="_cutMap"><span class="annot"><span class="annottext">_cutMap :: Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutMap"><span class="hs-identifier hs-var hs-var">_cutMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><a href="Chainweb.Cut.html#cutMap"><span class="hs-identifier hs-type">cutMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Getter</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span id="cutMap"><span class="annot"><span class="annottext">cutMap :: (HashMap ChainId BlockHeader -&gt; f (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; f Cut
</span><a href="Chainweb.Cut.html#cutMap"><span class="hs-identifier hs-var hs-var">cutMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader -&gt; f (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; f Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span id="local-6989586621681491734"><span id="local-6989586621681491735"><span class="annot"><a href="Chainweb.Cut.html#lookupCutM"><span class="hs-identifier hs-type">lookupCutM</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491735"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#HasChainId"><span class="hs-identifier hs-type">HasChainId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491734"><span class="hs-identifier hs-type">cid</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491734"><span class="hs-identifier hs-type">cid</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span></span></span><span>
</span><span id="line-173"></span><span id="lookupCutM"><span class="annot"><span class="annottext">lookupCutM :: cid -&gt; Cut -&gt; m BlockHeader
</span><a href="Chainweb.Cut.html#lookupCutM"><span class="hs-identifier hs-var hs-var">lookupCutM</span></a></span></span><span> </span><span id="local-6989586621681491733"><span class="annot"><span class="annottext">cid :: cid
</span><a href="#local-6989586621681491733"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681491732"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491732"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting (Leftmost BlockHeader) Cut BlockHeader
-&gt; Cut -&gt; Maybe BlockHeader
forall a s. Getting (Leftmost a) s a -&gt; s -&gt; Maybe a
</span><span class="hs-identifier hs-var">firstOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index Cut -&gt; Fold Cut (IxValue Cut)
forall a. IxedGet a =&gt; Index a -&gt; Fold a (IxValue a)
</span><a href="Chainweb.Utils.html#ixg"><span class="hs-identifier hs-var">ixg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">cid -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">cid
</span><a href="#local-6989586621681491733"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491732"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><span class="annottext">Maybe BlockHeader -&gt; ChainGraphException -&gt; m BlockHeader
forall (m :: * -&gt; *) e a.
(MonadThrow m, Exception e) =&gt;
Maybe a -&gt; e -&gt; m a
</span><a href="Chainweb.Utils.html#%3F%3F%3F"><span class="hs-operator hs-var">???</span></a></span><span> </span><span class="annot"><span class="annottext">Expected (HashSet ChainId) -&gt; Actual ChainId -&gt; ChainGraphException
</span><a href="Chainweb.Graph.html#ChainNotInChainGraphException"><span class="hs-identifier hs-var">ChainNotInChainGraphException</span></a></span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet ChainId -&gt; Expected (HashSet ChainId)
forall a. a -&gt; Expected a
</span><a href="Chainweb.Utils.html#Expected"><span class="hs-identifier hs-var">Expected</span></a></span><span> </span><span class="annot"><span class="annottext">(HashSet ChainId -&gt; Expected (HashSet ChainId))
-&gt; HashSet ChainId -&gt; Expected (HashSet ChainId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashSet ChainId
forall v. HasChainwebVersion v =&gt; v -&gt; HashSet ChainId
</span><a href="Chainweb.Version.html#chainIds"><span class="hs-identifier hs-var">chainIds</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491732"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId -&gt; Actual ChainId
forall a. a -&gt; Actual a
</span><a href="Chainweb.Utils.html#Actual"><span class="hs-identifier hs-var">Actual</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">cid -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">cid
</span><a href="#local-6989586621681491733"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Chainweb.Cut.html#_cutWeight"><span class="hs-identifier hs-type">_cutWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockWeight"><span class="hs-identifier hs-type">BlockWeight</span></a></span><span>
</span><span id="line-179"></span><span id="_cutWeight"><span class="annot"><span class="annottext">_cutWeight :: Cut -&gt; BlockWeight
</span><a href="Chainweb.Cut.html#_cutWeight"><span class="hs-identifier hs-var hs-var">_cutWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting (Endo (Endo BlockWeight)) Cut BlockWeight
-&gt; Cut -&gt; BlockWeight
forall a s. Num a =&gt; Getting (Endo (Endo a)) s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">sumOf</span></span><span> </span><span class="annot"><span class="annottext">(Getting (Endo (Endo BlockWeight)) Cut BlockWeight
 -&gt; Cut -&gt; BlockWeight)
-&gt; Getting (Endo (Endo BlockWeight)) Cut BlockWeight
-&gt; Cut
-&gt; BlockWeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; Const (Endo (Endo BlockWeight)) Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader
  -&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; Const (Endo (Endo BlockWeight)) Cut)
-&gt; ((BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
    -&gt; HashMap ChainId BlockHeader
    -&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader))
-&gt; Getting (Endo (Endo BlockWeight)) Cut BlockWeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
-&gt; HashMap ChainId BlockHeader
-&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader)
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
 -&gt; HashMap ChainId BlockHeader
 -&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader))
-&gt; ((BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
    -&gt; BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
-&gt; (BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
-&gt; HashMap ChainId BlockHeader
-&gt; Const (Endo (Endo BlockWeight)) (HashMap ChainId BlockHeader)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
-&gt; BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader
Lens' BlockHeader BlockWeight
</span><a href="Chainweb.BlockHeader.html#blockWeight"><span class="hs-identifier hs-var">blockWeight</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Chainweb.Cut.html#cutWeight"><span class="hs-identifier hs-type">cutWeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Getter</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockWeight"><span class="hs-identifier hs-type">BlockWeight</span></a></span><span>
</span><span id="line-182"></span><span id="cutWeight"><span class="annot"><span class="annottext">cutWeight :: (BlockWeight -&gt; f BlockWeight) -&gt; Cut -&gt; f Cut
</span><a href="Chainweb.Cut.html#cutWeight"><span class="hs-identifier hs-var hs-var">cutWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; BlockWeight)
-&gt; (BlockWeight -&gt; f BlockWeight) -&gt; Cut -&gt; f Cut
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; BlockWeight
</span><a href="Chainweb.Cut.html#_cutWeight"><span class="hs-identifier hs-var">_cutWeight</span></a></span><span>
</span><span id="line-183"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutWeight"><span class="hs-pragma hs-type">cutWeight</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="annot"><a href="Chainweb.Cut.html#_cutHeight"><span class="hs-identifier hs-type">_cutHeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span>
</span><span id="line-186"></span><span id="_cutHeight"><span class="annot"><span class="annottext">_cutHeight :: Cut -&gt; BlockHeight
</span><a href="Chainweb.Cut.html#_cutHeight"><span class="hs-identifier hs-var hs-var">_cutHeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting (Endo (Endo BlockHeight)) Cut BlockHeight
-&gt; Cut -&gt; BlockHeight
forall a s. Num a =&gt; Getting (Endo (Endo a)) s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">sumOf</span></span><span> </span><span class="annot"><span class="annottext">(Getting (Endo (Endo BlockHeight)) Cut BlockHeight
 -&gt; Cut -&gt; BlockHeight)
-&gt; Getting (Endo (Endo BlockHeight)) Cut BlockHeight
-&gt; Cut
-&gt; BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; Const (Endo (Endo BlockHeight)) Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader
  -&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; Const (Endo (Endo BlockHeight)) Cut)
-&gt; ((BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
    -&gt; HashMap ChainId BlockHeader
    -&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader))
-&gt; Getting (Endo (Endo BlockHeight)) Cut BlockHeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
-&gt; HashMap ChainId BlockHeader
-&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader)
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
 -&gt; HashMap ChainId BlockHeader
 -&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader))
-&gt; ((BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
    -&gt; BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
-&gt; (BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
-&gt; HashMap ChainId BlockHeader
-&gt; Const (Endo (Endo BlockHeight)) (HashMap ChainId BlockHeader)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
-&gt; BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader
Lens' BlockHeader BlockHeight
</span><a href="Chainweb.BlockHeader.html#blockHeight"><span class="hs-identifier hs-var">blockHeight</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="annot"><a href="Chainweb.Cut.html#cutHeight"><span class="hs-identifier hs-type">cutHeight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Getter</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span>
</span><span id="line-189"></span><span id="cutHeight"><span class="annot"><span class="annottext">cutHeight :: (BlockHeight -&gt; f BlockHeight) -&gt; Cut -&gt; f Cut
</span><a href="Chainweb.Cut.html#cutHeight"><span class="hs-identifier hs-var hs-var">cutHeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; BlockHeight)
-&gt; (BlockHeight -&gt; f BlockHeight) -&gt; Cut -&gt; f Cut
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; BlockHeight
</span><a href="Chainweb.Cut.html#_cutHeight"><span class="hs-identifier hs-var">_cutHeight</span></a></span><span>
</span><span id="line-190"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutHeight"><span class="hs-pragma hs-type">cutHeight</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- | All adjacent pairs of a cut</span><span>
</span><span id="line-193"></span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span class="annot"><a href="Chainweb.Cut.html#_cutAdjPairs"><span class="hs-identifier hs-type">_cutAdjPairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HS.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span id="_cutAdjPairs"><span class="annot"><span class="annottext">_cutAdjPairs :: Cut -&gt; HashSet (AdjPair BlockHeader)
</span><a href="Chainweb.Cut.html#_cutAdjPairs"><span class="hs-identifier hs-var hs-var">_cutAdjPairs</span></a></span></span><span> </span><span id="local-6989586621681491719"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491719"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AdjPair ChainId -&gt; AdjPair BlockHeader)
-&gt; HashSet (AdjPair ChainId) -&gt; HashSet (AdjPair BlockHeader)
forall b a.
(Hashable b, Eq b) =&gt;
(a -&gt; b) -&gt; HashSet a -&gt; HashSet b
</span><span class="hs-identifier hs-var">HS.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainId -&gt; BlockHeader) -&gt; AdjPair ChainId -&gt; AdjPair BlockHeader
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681491717"><span class="annot"><span class="annottext">x :: ChainId
</span><a href="#local-6989586621681491717"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491719"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Getting (Endo BlockHeader) Cut BlockHeader -&gt; BlockHeader
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index Cut -&gt; Fold Cut (IxValue Cut)
forall a. IxedGet a =&gt; Index a -&gt; Fold a (IxValue a)
</span><a href="Chainweb.Utils.html#ixg"><span class="hs-identifier hs-var">ixg</span></a></span><span> </span><span class="annot"><span class="annottext">Index Cut
ChainId
</span><a href="#local-6989586621681491717"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HashSet (AdjPair ChainId) -&gt; HashSet (AdjPair BlockHeader))
-&gt; (ChainGraph -&gt; HashSet (AdjPair ChainId))
-&gt; ChainGraph
-&gt; HashSet (AdjPair BlockHeader)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ChainGraph -&gt; HashSet (AdjPair ChainId)
</span><a href="Chainweb.Graph.html#adjs"><span class="hs-identifier hs-var">adjs</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainGraph -&gt; HashSet (AdjPair BlockHeader))
-&gt; ChainGraph -&gt; HashSet (AdjPair BlockHeader)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; ChainGraph
forall a. HasChainGraph a =&gt; a -&gt; ChainGraph
</span><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-identifier hs-var">_chainGraph</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491719"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Chainweb.Cut.html#cutAdjPairs"><span class="hs-identifier hs-type">cutAdjPairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Getter</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HS.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span id="cutAdjPairs"><span class="annot"><span class="annottext">cutAdjPairs :: (HashSet (AdjPair BlockHeader)
 -&gt; f (HashSet (AdjPair BlockHeader)))
-&gt; Cut -&gt; f Cut
</span><a href="Chainweb.Cut.html#cutAdjPairs"><span class="hs-identifier hs-var hs-var">cutAdjPairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; HashSet (AdjPair BlockHeader))
-&gt; (HashSet (AdjPair BlockHeader)
    -&gt; f (HashSet (AdjPair BlockHeader)))
-&gt; Cut
-&gt; f Cut
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashSet (AdjPair BlockHeader)
</span><a href="Chainweb.Cut.html#_cutAdjPairs"><span class="hs-identifier hs-var">_cutAdjPairs</span></a></span><span>
</span><span id="line-199"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#cutAdjPairs"><span class="hs-pragma hs-type">cutAdjPairs</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-- | Assumes that the cid exists in the graph.</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span id="local-6989586621681491714"><span class="annot"><a href="Chainweb.Cut.html#cutAdjs"><span class="hs-identifier hs-type">cutAdjs</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#HasChainId"><span class="hs-identifier hs-type">HasChainId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491714"><span class="hs-identifier hs-type">cid</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491714"><span class="hs-identifier hs-type">cid</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span></span><span>
</span><span id="line-208"></span><span id="cutAdjs"><span class="annot"><span class="annottext">cutAdjs :: Cut -&gt; cid -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#cutAdjs"><span class="hs-identifier hs-var hs-var">cutAdjs</span></a></span></span><span> </span><span id="local-6989586621681491713"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491713"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681491712"><span class="annot"><span class="annottext">cid :: cid
</span><a href="#local-6989586621681491712"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
-&gt; HashMap ChainId () -&gt; HashMap ChainId BlockHeader
forall k v w.
(Eq k, Hashable k) =&gt;
HashMap k v -&gt; HashMap k w -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.intersection</span></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491713"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet ChainId -&gt; HashMap ChainId ()
forall a. HashSet a -&gt; HashMap a ()
</span><span class="hs-identifier hs-var">HS.toMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainGraph -&gt; cid -&gt; HashSet ChainId
forall p. HasChainId p =&gt; ChainGraph -&gt; p -&gt; HashSet ChainId
</span><a href="Chainweb.Graph.html#adjacentChainIds"><span class="hs-identifier hs-var">adjacentChainIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; ChainGraph
forall a. HasChainGraph a =&gt; a -&gt; ChainGraph
</span><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-identifier hs-var">_chainGraph</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491713"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">cid
</span><a href="#local-6989586621681491712"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- Limit Cut Hashes By Height</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Find a `Cut` that is a predecessor of the given one, and that has a block</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- height that is smaller or equal the given height.</span><span>
</span><span id="line-217"></span><span class="hs-comment">--</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- If the requested limit is larger or equal to the current height, the given</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- cut is returned.</span><span>
</span><span id="line-220"></span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- Otherwise, the requested height limit is divided by the number of chains</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- (rounded down) and the result is used such that for each chain the</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- predecessor of the given cut at the respective height is returned.</span><span>
</span><span id="line-224"></span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span class="annot"><a href="Chainweb.Cut.html#limitCut"><span class="hs-identifier hs-type">limitCut</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-comment">-- upper bound for the cut height. This is not a tight bound.</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-232"></span><span id="limitCut"><span class="annot"><span class="annottext">limitCut :: WebBlockHeaderDb -&gt; BlockHeight -&gt; Cut -&gt; IO Cut
</span><a href="Chainweb.Cut.html#limitCut"><span class="hs-identifier hs-var hs-var">limitCut</span></a></span></span><span> </span><span id="local-6989586621681491708"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491708"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491707"><span class="annot"><span class="annottext">h :: BlockHeight
</span><a href="#local-6989586621681491707"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621681491706"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491706"><span class="hs-identifier hs-var">c</span></a></span></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681491707"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHeight -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; BlockHeight
</span><a href="Chainweb.Cut.html#_cutHeight"><span class="hs-identifier hs-var">_cutHeight</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491706"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; IO Cut
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491706"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491706"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; (Cut -&gt; IO Cut) -&gt; IO Cut
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader -&gt; IO (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; IO Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader -&gt; IO (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; IO Cut)
-&gt; ((ChainId -&gt; BlockHeader -&gt; IO BlockHeader)
    -&gt; HashMap ChainId BlockHeader -&gt; IO (HashMap ChainId BlockHeader))
-&gt; (ChainId -&gt; BlockHeader -&gt; IO BlockHeader)
-&gt; Cut
-&gt; IO Cut
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ChainId -&gt; BlockHeader -&gt; IO BlockHeader)
-&gt; HashMap ChainId BlockHeader -&gt; IO (HashMap ChainId BlockHeader)
forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(TraversableWithIndex i t, Applicative f) =&gt;
(i -&gt; a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">itraverse</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; BlockHeader -&gt; IO BlockHeader
</span><a href="#local-6989586621681491703"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><a href="#local-6989586621681491702"><span class="hs-identifier hs-type">gorder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621681491702"><span class="annot"><span class="annottext">gorder :: Natural
</span><a href="#local-6989586621681491702"><span class="hs-identifier hs-var hs-var">gorder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainGraph -&gt; Natural
</span><a href="Chainweb.Graph.html#order"><span class="hs-identifier hs-var">order</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainGraph -&gt; Natural) -&gt; ChainGraph -&gt; Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb -&gt; ChainGraph
forall a. HasChainGraph a =&gt; a -&gt; ChainGraph
</span><a href="Chainweb.Graph.html#_chainGraph"><span class="hs-identifier hs-var">_chainGraph</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491708"><span class="hs-identifier hs-var">wdb</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><a href="#local-6989586621681491700"><span class="hs-identifier hs-type">ch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621681491700"><span class="annot"><span class="annottext">ch :: BlockHeight
</span><a href="#local-6989586621681491700"><span class="hs-identifier hs-var hs-var">ch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681491707"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHeight -&gt; BlockHeight
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; BlockHeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491702"><span class="hs-identifier hs-var">gorder</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621681491703"><span class="annot"><span class="annottext">go :: ChainId -&gt; BlockHeader -&gt; IO BlockHeader
</span><a href="#local-6989586621681491703"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681491697"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681491697"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681491696"><span class="annot"><span class="annottext">bh :: BlockHeader
</span><a href="#local-6989586621681491696"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681491695"><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491695"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a r. a -&gt; (Given a =&gt; r) -&gt; r
</span><span class="hs-identifier hs-var">give</span></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491708"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">((Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb)
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; IO BlockHeaderDb
forall (m :: * -&gt; *) p.
(MonadThrow m, HasChainId p, Given WebBlockHeaderDb) =&gt;
p -&gt; m BlockHeaderDb
</span><a href="Chainweb.WebBlockHeaderDB.html#getWebBlockHeaderDb"><span class="hs-identifier hs-var">getWebBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491697"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><span class="annottext">Maybe BlockHeader -&gt; BlockHeader
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><a href="Chainweb.Utils.html#fromJuste"><span class="hs-identifier hs-var">fromJuste</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe BlockHeader -&gt; BlockHeader)
-&gt; IO (Maybe BlockHeader) -&gt; IO BlockHeader
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; DbEntry BlockHeaderDb
-&gt; Natural
-&gt; IO (Maybe (DbEntry BlockHeaderDb))
forall db.
TreeDb db =&gt;
db -&gt; DbEntry db -&gt; Natural -&gt; IO (Maybe (DbEntry db))
</span><a href="Chainweb.TreeDB.html#seekAncestor"><span class="hs-identifier hs-var">seekAncestor</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491695"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681491696"><span class="hs-identifier hs-var">bh</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeight -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeight -&gt; Natural) -&gt; BlockHeight -&gt; Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491696"><span class="hs-identifier hs-var">bh</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeight -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681491700"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-comment">-- this is safe because it's guaranteed that the requested rank is</span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-comment">-- smaller then the block height of the argument</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- Genesis Cut</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | TODO</span><span>
</span><span id="line-253"></span><span class="hs-comment">--</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- This guarantees that</span><span>
</span><span id="line-255"></span><span class="hs-comment">--</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- * the graph is valid,</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- * the graph corresponds to the 'ChainwebVersion',</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- * the set of 'ChainId's of the cut are the exactly the vertices of the graph,</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- * all blockHeaders are valid (which is guaranteed by 'genesisBlockHeader').</span><span>
</span><span id="line-260"></span><span class="hs-comment">--</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- These properties are maintained as inductive invariants for all Cuts.</span><span>
</span><span id="line-262"></span><span class="hs-comment">--</span><span>
</span><span id="line-263"></span><span class="annot"><a href="Chainweb.Cut.html#genesisCut"><span class="hs-identifier hs-type">genesisCut</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-266"></span><span id="genesisCut"><span class="annot"><span class="annottext">genesisCut :: ChainwebVersion -&gt; Cut
</span><a href="Chainweb.Cut.html#genesisCut"><span class="hs-identifier hs-var hs-var">genesisCut</span></a></span></span><span> </span><span id="local-6989586621681491687"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681491687"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WCut :: HashMap ChainId BlockHeader -&gt; ChainwebVersion -&gt; Cut
</span><a href="Chainweb.Cut.html#%24WCut"><span class="hs-identifier hs-type hs-type">Cut</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cutHeaders :: HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var">_cutHeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.BlockHeader.Genesis.html#genesisBlockHeaders"><span class="hs-identifier hs-var">genesisBlockHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681491687"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_cutChainwebVersion :: ChainwebVersion
</span><a href="Chainweb.Cut.html#_cutChainwebVersion"><span class="hs-identifier hs-var">_cutChainwebVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681491687"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- Exceptions</span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span id="local-6989586621681491684"><span id="local-6989586621681491685"></span></span><span class="hs-keyword">data</span><span> </span><span id="CutException"><span class="annot"><a href="Chainweb.Cut.html#CutException"><span class="hs-identifier hs-var">CutException</span></a></span></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="InvalidCutPair"><span class="annot"><a href="Chainweb.Cut.html#InvalidCutPair"><span class="hs-identifier hs-var">InvalidCutPair</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="NonMonotonicCutExtension"><span class="annot"><a href="Chainweb.Cut.html#NonMonotonicCutExtension"><span class="hs-identifier hs-var">NonMonotonicCutExtension</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Utils.html#Expected"><span class="hs-identifier hs-type">Expected</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Utils.html#Actual"><span class="hs-identifier hs-type">Actual</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InvalidCutExtension"><span class="annot"><a href="Chainweb.Cut.html#InvalidCutExtension"><span class="hs-identifier hs-var">InvalidCutExtension</span></a></span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491675"><span id="local-6989586621681491677"><span id="local-6989586621681491679"><span class="annot"><span class="annottext">Int -&gt; CutException -&gt; ShowS
[CutException] -&gt; ShowS
CutException -&gt; String
(Int -&gt; CutException -&gt; ShowS)
-&gt; (CutException -&gt; String)
-&gt; ([CutException] -&gt; ShowS)
-&gt; Show CutException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CutException] -&gt; ShowS
$cshowList :: [CutException] -&gt; ShowS
show :: CutException -&gt; String
$cshow :: CutException -&gt; String
showsPrec :: Int -&gt; CutException -&gt; ShowS
$cshowsPrec :: Int -&gt; CutException -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491671"><span id="local-6989586621681491673"><span class="annot"><span class="annottext">CutException -&gt; CutException -&gt; Bool
(CutException -&gt; CutException -&gt; Bool)
-&gt; (CutException -&gt; CutException -&gt; Bool) -&gt; Eq CutException
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CutException -&gt; CutException -&gt; Bool
$c/= :: CutException -&gt; CutException -&gt; Bool
== :: CutException -&gt; CutException -&gt; Bool
$c== :: CutException -&gt; CutException -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491656"><span id="local-6989586621681491658"><span id="local-6989586621681491660"><span id="local-6989586621681491662"><span id="local-6989586621681491664"><span id="local-6989586621681491666"><span id="local-6989586621681491668"><span class="annot"><span class="annottext">Eq CutException
Eq CutException =&gt;
(CutException -&gt; CutException -&gt; Ordering)
-&gt; (CutException -&gt; CutException -&gt; Bool)
-&gt; (CutException -&gt; CutException -&gt; Bool)
-&gt; (CutException -&gt; CutException -&gt; Bool)
-&gt; (CutException -&gt; CutException -&gt; Bool)
-&gt; (CutException -&gt; CutException -&gt; CutException)
-&gt; (CutException -&gt; CutException -&gt; CutException)
-&gt; Ord CutException
CutException -&gt; CutException -&gt; Bool
CutException -&gt; CutException -&gt; Ordering
CutException -&gt; CutException -&gt; CutException
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: CutException -&gt; CutException -&gt; CutException
$cmin :: CutException -&gt; CutException -&gt; CutException
max :: CutException -&gt; CutException -&gt; CutException
$cmax :: CutException -&gt; CutException -&gt; CutException
&gt;= :: CutException -&gt; CutException -&gt; Bool
$c&gt;= :: CutException -&gt; CutException -&gt; Bool
&gt; :: CutException -&gt; CutException -&gt; Bool
$c&gt; :: CutException -&gt; CutException -&gt; Bool
&lt;= :: CutException -&gt; CutException -&gt; Bool
$c&lt;= :: CutException -&gt; CutException -&gt; Bool
&lt; :: CutException -&gt; CutException -&gt; Bool
$c&lt; :: CutException -&gt; CutException -&gt; Bool
compare :: CutException -&gt; CutException -&gt; Ordering
$ccompare :: CutException -&gt; CutException -&gt; Ordering
$cp1Ord :: Eq CutException
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. CutException -&gt; Rep CutException x)
-&gt; (forall x. Rep CutException x -&gt; CutException)
-&gt; Generic CutException
forall x. Rep CutException x -&gt; CutException
forall x. CutException -&gt; Rep CutException x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep CutException x -&gt; CutException
$cfrom :: forall x. CutException -&gt; Rep CutException x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681491646"><span id="local-6989586621681491648"><span id="local-6989586621681491650"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#CutException"><span class="hs-identifier hs-type">CutException</span></a></span></span></span></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- Cut Properties</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- | Check that a cut is correctly braided.</span><span>
</span><span id="line-286"></span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- This check is only needed for external cuts. Note, that for</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- imported cuts this must be checked recursively. This can</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- be done by doing a join that starts with a meet with a local</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- cut.</span><span>
</span><span id="line-291"></span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span id="local-6989586621681491644"><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCut"><span class="hs-identifier hs-type">checkBraidingOfCut</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491644"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-296"></span><span id="checkBraidingOfCut"><span class="annot"><span class="annottext">checkBraidingOfCut :: Cut -&gt; m ()
</span><a href="Chainweb.Cut.html#checkBraidingOfCut"><span class="hs-identifier hs-var hs-var">checkBraidingOfCut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet (AdjPair BlockHeader) -&gt; m ()
forall (m :: * -&gt; *) (f :: * -&gt; *).
(MonadThrow m, Foldable f) =&gt;
f (AdjPair BlockHeader) -&gt; m ()
</span><a href="Chainweb.Cut.html#checkBraidingOfCutPairs"><span class="hs-identifier hs-var">checkBraidingOfCutPairs</span></a></span><span> </span><span class="annot"><span class="annottext">(HashSet (AdjPair BlockHeader) -&gt; m ())
-&gt; (Cut -&gt; HashSet (AdjPair BlockHeader)) -&gt; Cut -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashSet (AdjPair BlockHeader)
</span><a href="Chainweb.Cut.html#_cutAdjPairs"><span class="hs-identifier hs-var">_cutAdjPairs</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | Check that a set of adjacent pairs of a cut is correctly braided.</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span id="local-6989586621681491948"><span id="local-6989586621681491949"><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCutPairs"><span class="hs-identifier hs-type">checkBraidingOfCutPairs</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491949"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621681491948"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491948"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491949"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-305"></span><span id="checkBraidingOfCutPairs"><span class="annot"><span class="annottext">checkBraidingOfCutPairs :: f (AdjPair BlockHeader) -&gt; m ()
</span><a href="Chainweb.Cut.html#checkBraidingOfCutPairs"><span class="hs-identifier hs-var hs-var">checkBraidingOfCutPairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AdjPair BlockHeader -&gt; m ()) -&gt; f (AdjPair BlockHeader) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">AdjPair BlockHeader -&gt; m ()
forall (m :: * -&gt; *). MonadThrow m =&gt; AdjPair BlockHeader -&gt; m ()
</span><a href="Chainweb.Cut.html#checkBraidingOfCutPair"><span class="hs-identifier hs-var">checkBraidingOfCutPair</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span id="local-6989586621681491941"><span class="annot"><a href="Chainweb.Cut.html#checkBraidingOfCutPair"><span class="hs-identifier hs-type">checkBraidingOfCutPair</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491941"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491941"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-311"></span><span id="checkBraidingOfCutPair"><span class="annot"><span class="annottext">checkBraidingOfCutPair :: AdjPair BlockHeader -&gt; m ()
</span><a href="Chainweb.Cut.html#checkBraidingOfCutPair"><span class="hs-identifier hs-var hs-var">checkBraidingOfCutPair</span></a></span></span><span> </span><span id="local-6989586621681491642"><span class="annot"><span class="annottext">p :: AdjPair BlockHeader
</span><a href="#local-6989586621681491642"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; m () -&gt; m ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><a href="Chainweb.Utils.html#unlessM"><span class="hs-identifier hs-var">unlessM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AdjPair BlockHeader -&gt; m Bool
forall (m :: * -&gt; *). MonadThrow m =&gt; AdjPair BlockHeader -&gt; m Bool
</span><a href="Chainweb.Cut.html#isBraidingOfCutPair"><span class="hs-identifier hs-var">isBraidingOfCutPair</span></a></span><span> </span><span class="annot"><span class="annottext">AdjPair BlockHeader
</span><a href="#local-6989586621681491642"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CutException -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AdjPair BlockHeader -&gt; CutException
</span><a href="Chainweb.Cut.html#InvalidCutPair"><span class="hs-identifier hs-var">InvalidCutPair</span></a></span><span> </span><span class="annot"><span class="annottext">AdjPair BlockHeader
</span><a href="#local-6989586621681491642"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">-- | Returns whether an adjacent pair in a cut is correctly braided.</span><span>
</span><span id="line-315"></span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- * throws 'ChainNotAdjacentException'</span><span>
</span><span id="line-317"></span><span class="hs-comment">--</span><span>
</span><span id="line-318"></span><span id="local-6989586621681491938"><span class="annot"><a href="Chainweb.Cut.html#isBraidingOfCutPair"><span class="hs-identifier hs-type">isBraidingOfCutPair</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491938"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Graph.html#AdjPair"><span class="hs-identifier hs-type">AdjPair</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491938"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-322"></span><span id="isBraidingOfCutPair"><span class="annot"><span class="annottext">isBraidingOfCutPair :: AdjPair BlockHeader -&gt; m Bool
</span><a href="Chainweb.Cut.html#isBraidingOfCutPair"><span class="hs-identifier hs-var hs-var">isBraidingOfCutPair</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Graph.html#Adj"><span class="hs-identifier hs-type">Adj</span></a></span><span> </span><span id="local-6989586621681491638"><span class="annot"><span class="annottext">a :: BlockHeader
</span><a href="#local-6989586621681491638"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491637"><span class="annot"><span class="annottext">b :: BlockHeader
</span><a href="#local-6989586621681491637"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621681491636"><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491636"><span class="hs-identifier hs-var">ab</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader -&gt; m BlockHash
forall (m :: * -&gt; *) p.
(MonadThrow m, HasChainId p) =&gt;
p -&gt; BlockHeader -&gt; m BlockHash
</span><a href="Chainweb.BlockHeader.html#getAdjacentHash"><span class="hs-identifier hs-var">getAdjacentHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491637"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491638"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621681491634"><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491634"><span class="hs-identifier hs-var">ba</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader -&gt; m BlockHash
forall (m :: * -&gt; *) p.
(MonadThrow m, HasChainId p) =&gt;
p -&gt; BlockHeader -&gt; m BlockHash
</span><a href="Chainweb.BlockHeader.html#getAdjacentHash"><span class="hs-identifier hs-var">getAdjacentHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491638"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491637"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockParent"><span class="hs-identifier hs-var hs-var">_blockParent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491638"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491634"><span class="hs-identifier hs-var">ba</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockParent"><span class="hs-identifier hs-var hs-var">_blockParent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491637"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491636"><span class="hs-identifier hs-var">ab</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491634"><span class="hs-identifier hs-var">ba</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491638"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491636"><span class="hs-identifier hs-var">ab</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491637"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- Extending Cuts</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span class="hs-comment">-- | Extends a Cut monotonically, i.e. the replaced block header is the parent</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- of the added block header.</span><span>
</span><span id="line-335"></span><span class="hs-comment">--</span><span>
</span><span id="line-336"></span><span class="hs-comment">-- Checks</span><span>
</span><span id="line-337"></span><span class="hs-comment">--</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- * block header is from the ChainGraph of the Cut</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- * result has valid braiding</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- * result is a cut</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- * update is monotonic</span><span>
</span><span id="line-342"></span><span class="hs-comment">--</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- This includes a check that inductively maintains 'checkBraidingOfCut'.</span><span>
</span><span id="line-344"></span><span class="hs-comment">--</span><span>
</span><span id="line-345"></span><span id="local-6989586621681491920"><span class="annot"><a href="Chainweb.Cut.html#isMonotonicCutExtension"><span class="hs-identifier hs-type">isMonotonicCutExtension</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491920"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491920"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-350"></span><span id="isMonotonicCutExtension"><span class="annot"><span class="annottext">isMonotonicCutExtension :: Cut -&gt; BlockHeader -&gt; m Bool
</span><a href="Chainweb.Cut.html#isMonotonicCutExtension"><span class="hs-identifier hs-var hs-var">isMonotonicCutExtension</span></a></span></span><span> </span><span id="local-6989586621681491628"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491628"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681491627"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681491627"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="annottext">BlockHeader -&gt; m ()
forall (m :: * -&gt; *). MonadThrow m =&gt; BlockHeader -&gt; m ()
</span><a href="Chainweb.WebBlockHeaderDB.html#checkBlockHeaderGraph"><span class="hs-identifier hs-var">checkBlockHeaderGraph</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491627"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681491625"><span class="hs-identifier hs-var">monotonic</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681491624"><span class="hs-identifier hs-var">validBraiding</span></a></span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621681491625"><span class="annot"><span class="annottext">monotonic :: Bool
</span><a href="#local-6989586621681491625"><span class="hs-identifier hs-var hs-var">monotonic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockParent"><span class="hs-identifier hs-var hs-var">_blockParent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491627"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491628"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Getting (Endo BlockHash) Cut BlockHash -&gt; BlockHash
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index Cut -&gt; Fold Cut (IxValue Cut)
forall a. IxedGet a =&gt; Index a -&gt; Fold a (IxValue a)
</span><a href="Chainweb.Utils.html#ixg"><span class="hs-identifier hs-var">ixg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491627"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const (Endo BlockHash) BlockHeader)
 -&gt; Cut -&gt; Const (Endo BlockHash) Cut)
-&gt; ((BlockHash -&gt; Const (Endo BlockHash) BlockHash)
    -&gt; BlockHeader -&gt; Const (Endo BlockHash) BlockHeader)
-&gt; Getting (Endo BlockHash) Cut BlockHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockHash -&gt; Const (Endo BlockHash) BlockHash)
-&gt; BlockHeader -&gt; Const (Endo BlockHash) BlockHeader
Lens' BlockHeader BlockHash
</span><a href="Chainweb.BlockHeader.html#blockHash"><span class="hs-identifier hs-var">blockHash</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621681491624"><span class="annot"><span class="annottext">validBraiding :: Bool
</span><a href="#local-6989586621681491624"><span class="hs-identifier hs-var hs-var">validBraiding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">All -&gt; Bool
</span><span class="hs-identifier hs-var hs-var">getAll</span></span><span> </span><span class="annot"><span class="annottext">(All -&gt; Bool) -&gt; All -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ChainId -&gt; BlockHash -&gt; All) -&gt; HashMap ChainId BlockHash -&gt; All
forall i (f :: * -&gt; *) m a.
(FoldableWithIndex i f, Monoid m) =&gt;
(i -&gt; a -&gt; m) -&gt; f a -&gt; m
</span><span class="hs-identifier hs-var">ifoldMap</span></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681491620"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681491620"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681491619"><span class="annot"><span class="annottext">v :: BlockHash
</span><a href="#local-6989586621681491619"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; All
</span><span class="hs-identifier hs-var">All</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; All) -&gt; Bool -&gt; All
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681491617"><span class="annot"><span class="annottext">a :: BlockHeader
</span><a href="#local-6989586621681491617"><span class="hs-identifier hs-var hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491628"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Getting (Endo BlockHeader) Cut BlockHeader -&gt; BlockHeader
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index Cut -&gt; Fold Cut (IxValue Cut)
forall a. IxedGet a =&gt; Index a -&gt; Fold a (IxValue a)
</span><a href="Chainweb.Utils.html#ixg"><span class="hs-identifier hs-var">ixg</span></a></span><span> </span><span class="annot"><span class="annottext">Index Cut
ChainId
</span><a href="#local-6989586621681491620"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491617"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491619"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockParent"><span class="hs-identifier hs-var hs-var">_blockParent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491617"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491619"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHashRecord -&gt; HashMap ChainId BlockHash
</span><a href="Chainweb.BlockHash.html#_getBlockHashRecord"><span class="hs-identifier hs-var hs-var">_getBlockHashRecord</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHashRecord -&gt; HashMap ChainId BlockHash)
-&gt; BlockHashRecord -&gt; HashMap ChainId BlockHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHashRecord
</span><a href="Chainweb.BlockHeader.html#_blockAdjacentHashes"><span class="hs-identifier hs-var hs-var">_blockAdjacentHashes</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491627"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span id="local-6989586621681491614"><span class="annot"><a href="Chainweb.Cut.html#monotonicCutExtension"><span class="hs-identifier hs-type">monotonicCutExtension</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491614"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491614"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span></span><span>
</span><span id="line-364"></span><span id="monotonicCutExtension"><span class="annot"><span class="annottext">monotonicCutExtension :: Cut -&gt; BlockHeader -&gt; m Cut
</span><a href="Chainweb.Cut.html#monotonicCutExtension"><span class="hs-identifier hs-var hs-var">monotonicCutExtension</span></a></span></span><span> </span><span id="local-6989586621681491613"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491613"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681491612"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681491612"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><span class="annottext">m Bool -&gt; m () -&gt; m ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><a href="Chainweb.Utils.html#unlessM"><span class="hs-identifier hs-var">unlessM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; BlockHeader -&gt; m Bool
forall (m :: * -&gt; *). MonadThrow m =&gt; Cut -&gt; BlockHeader -&gt; m Bool
</span><a href="Chainweb.Cut.html#isMonotonicCutExtension"><span class="hs-identifier hs-var">isMonotonicCutExtension</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491613"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491612"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CutException -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(CutException -&gt; m ()) -&gt; CutException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; CutException
</span><a href="Chainweb.Cut.html#InvalidCutExtension"><span class="hs-identifier hs-var">InvalidCutExtension</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491612"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">Cut -&gt; m Cut
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; m Cut) -&gt; Cut -&gt; m Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491613"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; (Cut -&gt; Cut) -&gt; Cut
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; Identity (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; Identity Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader
  -&gt; Identity (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; Identity Cut)
-&gt; ((BlockHeader -&gt; Identity BlockHeader)
    -&gt; HashMap ChainId BlockHeader
    -&gt; Identity (HashMap ChainId BlockHeader))
-&gt; (BlockHeader -&gt; Identity BlockHeader)
-&gt; Cut
-&gt; Identity Cut
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (HashMap ChainId BlockHeader)
-&gt; Traversal'
     (HashMap ChainId BlockHeader)
     (IxValue (HashMap ChainId BlockHeader))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491612"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Identity BlockHeader) -&gt; Cut -&gt; Identity Cut)
-&gt; BlockHeader -&gt; Cut -&gt; Cut
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491612"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span id="local-6989586621681491857"><span class="annot"><a href="Chainweb.Cut.html#tryMonotonicCutExtension"><span class="hs-identifier hs-type">tryMonotonicCutExtension</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491857"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491857"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-373"></span><span id="tryMonotonicCutExtension"><span class="annot"><span class="annottext">tryMonotonicCutExtension :: Cut -&gt; BlockHeader -&gt; m (Maybe Cut)
</span><a href="Chainweb.Cut.html#tryMonotonicCutExtension"><span class="hs-identifier hs-var hs-var">tryMonotonicCutExtension</span></a></span></span><span> </span><span id="local-6989586621681491610"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491610"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681491609"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681491609"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Cut
</span><a href="#local-6989586621681491608"><span class="hs-identifier hs-var">extendIf</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe Cut) -&gt; m Bool -&gt; m (Maybe Cut)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; BlockHeader -&gt; m Bool
forall (m :: * -&gt; *). MonadThrow m =&gt; Cut -&gt; BlockHeader -&gt; m Bool
</span><a href="Chainweb.Cut.html#isMonotonicCutExtension"><span class="hs-identifier hs-var">isMonotonicCutExtension</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491610"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491609"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621681491608"><span class="annot"><span class="annottext">extendIf :: Bool -&gt; Maybe Cut
</span><a href="#local-6989586621681491608"><span class="hs-identifier hs-var hs-var">extendIf</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Maybe Cut
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; Maybe Cut) -&gt; Cut -&gt; Maybe Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Identity BlockHeader) -&gt; Cut -&gt; Identity Cut)
-&gt; BlockHeader -&gt; Cut -&gt; Cut
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; Identity (HashMap ChainId BlockHeader))
-&gt; Cut -&gt; Identity Cut
Lens' Cut (HashMap ChainId BlockHeader)
</span><a href="Chainweb.Cut.html#cutHeaders"><span class="hs-identifier hs-var">cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader
  -&gt; Identity (HashMap ChainId BlockHeader))
 -&gt; Cut -&gt; Identity Cut)
-&gt; ((BlockHeader -&gt; Identity BlockHeader)
    -&gt; HashMap ChainId BlockHeader
    -&gt; Identity (HashMap ChainId BlockHeader))
-&gt; (BlockHeader -&gt; Identity BlockHeader)
-&gt; Cut
-&gt; Identity Cut
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (HashMap ChainId BlockHeader)
-&gt; Traversal'
     (HashMap ChainId BlockHeader)
     (IxValue (HashMap ChainId BlockHeader))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491609"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491609"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491610"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><a href="#local-6989586621681491608"><span class="hs-identifier hs-var">extendIf</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Cut
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- Join</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span class="hs-keyword">type</span><span> </span><span id="DiffItem"><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-var">DiffItem</span></a></span></span><span> </span><span id="local-6989586621681491606"><span class="annot"><a href="#local-6989586621681491606"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="annot"><a href="#local-6989586621681491606"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491606"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="hs-keyword">type</span><span> </span><span id="JoinQueue"><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-var">JoinQueue</span></a></span></span><span> </span><span id="local-6989586621681491605"><span class="annot"><a href="#local-6989586621681491605"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.Heap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">H.Entry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681491605"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="hs-keyword">data</span><span> </span><span id="Join"><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-var">Join</span></a></span></span><span> </span><span id="local-6989586621681491895"><span class="annot"><a href="#local-6989586621681491895"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Join"><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-var">Join</span></a></span></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_joinBase"><span class="annot"><span class="annottext">Join a -&gt; Cut
</span><a href="Chainweb.Cut.html#_joinBase"><span class="hs-identifier hs-var hs-var">_joinBase</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_joinQueue"><span class="annot"><span class="annottext">Join a -&gt; JoinQueue a
</span><a href="Chainweb.Cut.html#_joinQueue"><span class="hs-identifier hs-var hs-var">_joinQueue</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-type">JoinQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491895"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span id="local-6989586621681491601"><span class="annot"><a href="Chainweb.Cut.html#join"><span class="hs-identifier hs-type">join</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621681491601"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621681491601"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-type">Join</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491601"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-397"></span><span id="join"><span class="annot"><span class="annottext">join :: WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe a))
-&gt; Cut
-&gt; Cut
-&gt; IO (Join a)
</span><a href="Chainweb.Cut.html#join"><span class="hs-identifier hs-var hs-var">join</span></a></span></span><span> </span><span id="local-6989586621681491600"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491600"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491599"><span class="annot"><span class="annottext">f :: DiffItem BlockHeader -&gt; DiffItem (Maybe a)
</span><a href="#local-6989586621681491599"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe a))
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO (Join a)
forall a.
Ord a =&gt;
WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe a))
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO (Join a)
</span><a href="Chainweb.Cut.html#join_"><span class="hs-identifier hs-var">join_</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491600"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">DiffItem BlockHeader -&gt; DiffItem (Maybe a)
</span><a href="#local-6989586621681491599"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; HashMap ChainId BlockHeader -&gt; IO (Join a))
-&gt; (Cut -&gt; HashMap ChainId BlockHeader)
-&gt; Cut
-&gt; Cut
-&gt; IO (Join a)
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- | This merges two maps from ChainIds to BlockHeaders such that the result</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- is a Cut. Note, however, that the resulting cut contains only the chain ids</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- from the intersection of the input maps.</span><span>
</span><span id="line-402"></span><span class="hs-comment">--</span><span>
</span><span id="line-403"></span><span class="annot"><a href="Chainweb.Cut.html#join_"><span class="hs-identifier hs-type">join_</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681491905"><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-type">Join</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span id="join_"><span class="annot"><span class="annottext">join_ :: WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe a))
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO (Join a)
</span><a href="Chainweb.Cut.html#join_"><span class="hs-identifier hs-var hs-var">join_</span></a></span></span><span> </span><span id="local-6989586621681491597"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491597"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491596"><span class="annot"><span class="annottext">prioFun :: DiffItem BlockHeader -&gt; DiffItem (Maybe a)
</span><a href="#local-6989586621681491596"><span class="hs-identifier hs-var">prioFun</span></a></span></span><span> </span><span id="local-6989586621681491595"><span class="annot"><span class="annottext">a :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491595"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491594"><span class="annot"><span class="annottext">b :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491594"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681491593"><span class="annot"><span class="annottext">m :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491593"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491592"><span class="annot"><span class="annottext">h :: JoinQueue a
</span><a href="#local-6989586621681491592"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader, JoinQueue a)
 -&gt; (ChainId, BlockHeader, BlockHeader)
 -&gt; IO (HashMap ChainId BlockHeader, JoinQueue a))
-&gt; (HashMap ChainId BlockHeader, JoinQueue a)
-&gt; [(ChainId, BlockHeader, BlockHeader)]
-&gt; IO (HashMap ChainId BlockHeader, JoinQueue a)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader, JoinQueue a)
-&gt; (ChainId, BlockHeader, BlockHeader)
-&gt; IO (HashMap ChainId BlockHeader, JoinQueue a)
</span><a href="#local-6989586621681491590"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; [(ChainId, BlockHeader, BlockHeader)]
</span><a href="#local-6989586621681491589"><span class="hs-identifier hs-var">zipChainIdMaps</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491595"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491594"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><span class="annottext">Join a -&gt; IO (Join a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Join a -&gt; IO (Join a)) -&gt; Join a -&gt; IO (Join a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; JoinQueue a -&gt; Join a
forall a. Cut -&gt; JoinQueue a -&gt; Join a
</span><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-var">Join</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; ChainwebVersion -&gt; Cut
</span><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-var">Cut</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491593"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WebBlockHeaderDb -&gt; ChainwebVersion
forall a. HasChainwebVersion a =&gt; a -&gt; ChainwebVersion
</span><a href="Chainweb.Version.html#_chainwebVersion"><span class="hs-identifier hs-var">_chainwebVersion</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491597"><span class="hs-identifier hs-var">wdb</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491592"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-415"></span><span>    </span><span class="annot"><a href="#local-6989586621681491590"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-type">JoinQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-type">JoinQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>    </span><span id="local-6989586621681491590"><span class="annot"><span class="annottext">f :: (HashMap ChainId BlockHeader, JoinQueue a)
-&gt; (ChainId, BlockHeader, BlockHeader)
-&gt; IO (HashMap ChainId BlockHeader, JoinQueue a)
</span><a href="#local-6989586621681491590"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491588"><span class="annot"><span class="annottext">m :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491588"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491587"><span class="annot"><span class="annottext">q :: JoinQueue a
</span><a href="#local-6989586621681491587"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491586"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681491586"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491585"><span class="annot"><span class="annottext">x :: BlockHeader
</span><a href="#local-6989586621681491585"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491584"><span class="annot"><span class="annottext">y :: BlockHeader
</span><a href="#local-6989586621681491584"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>        </span><span id="local-6989586621681491583"><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491583"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a r. a -&gt; (Given a =&gt; r) -&gt; r
</span><span class="hs-identifier hs-var">give</span></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491597"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">((Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb)
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; IO BlockHeaderDb
forall (m :: * -&gt; *) p.
(MonadThrow m, HasChainId p, Given WebBlockHeaderDb) =&gt;
p -&gt; m BlockHeaderDb
</span><a href="Chainweb.WebBlockHeaderDB.html#getWebBlockHeaderDb"><span class="hs-identifier hs-var">getWebBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491586"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681491582"><span class="annot"><span class="annottext">q' :: JoinQueue a
</span><a href="#local-6989586621681491582"><span class="hs-identifier hs-var">q'</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span id="local-6989586621681491580"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681491580"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(JoinQueue a -&gt; DiffItem BlockHeader -&gt; JoinQueue a)
-&gt; JoinQueue a
-&gt; (JoinQueue a -&gt; JoinQueue a)
-&gt; Stream (Of (DiffItem BlockHeader)) IO BlockHeader
-&gt; IO (Of (JoinQueue a) BlockHeader)
forall (m :: * -&gt; *) x a b r.
Monad m =&gt;
(x -&gt; a -&gt; x) -&gt; x -&gt; (x -&gt; b) -&gt; Stream (Of a) m r -&gt; m (Of b r)
</span><span class="hs-identifier hs-var">S.fold</span></span><span> </span><span class="annot"><span class="annottext">JoinQueue a -&gt; DiffItem BlockHeader -&gt; JoinQueue a
</span><a href="#local-6989586621681491578"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491587"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">JoinQueue a -&gt; JoinQueue a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(Stream (Of (DiffItem BlockHeader)) IO BlockHeader
 -&gt; IO (Of (JoinQueue a) BlockHeader))
-&gt; Stream (Of (DiffItem BlockHeader)) IO BlockHeader
-&gt; IO (Of (JoinQueue a) BlockHeader)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; DbEntry BlockHeaderDb
-&gt; DbEntry BlockHeaderDb
-&gt; Stream
     (Of (These (DbEntry BlockHeaderDb) (DbEntry BlockHeaderDb)))
     IO
     (DbEntry BlockHeaderDb)
forall db.
TreeDb db =&gt;
db
-&gt; DbEntry db
-&gt; DbEntry db
-&gt; Stream (Of (These (DbEntry db) (DbEntry db))) IO (DbEntry db)
</span><a href="Chainweb.TreeDB.html#branchDiff_"><span class="hs-identifier hs-var">branchDiff_</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491583"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681491585"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681491584"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491575"><span class="annot"><span class="annottext">h' :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491575"><span class="hs-identifier hs-var hs-var">h'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491582"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">JoinQueue a
-&gt; HashMap ChainId BlockHeader -&gt; HashMap ChainId BlockHeader
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491580"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
-&gt; HashMap ChainId BlockHeader -&gt; HashMap ChainId BlockHeader
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">ChainId
-&gt; BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491586"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491580"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491588"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader, JoinQueue a)
-&gt; IO (HashMap ChainId BlockHeader, JoinQueue a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((HashMap ChainId BlockHeader, JoinQueue a)
 -&gt; IO (HashMap ChainId BlockHeader, JoinQueue a))
-&gt; (HashMap ChainId BlockHeader, JoinQueue a)
-&gt; IO (HashMap ChainId BlockHeader, JoinQueue a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491575"><span class="hs-identifier hs-var">h'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491582"><span class="hs-identifier hs-var">q'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><a href="#local-6989586621681491578"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-type">JoinQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#JoinQueue"><span class="hs-identifier hs-type">JoinQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621681491578"><span class="annot"><span class="annottext">g :: JoinQueue a -&gt; DiffItem BlockHeader -&gt; JoinQueue a
</span><a href="#local-6989586621681491578"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span id="local-6989586621681491573"><span class="annot"><span class="annottext">q :: JoinQueue a
</span><a href="#local-6989586621681491573"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621681491572"><span class="annot"><span class="annottext">x :: DiffItem BlockHeader
</span><a href="#local-6989586621681491572"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(JoinQueue a -&gt; (BlockHeader, Maybe a) -&gt; JoinQueue a)
-&gt; JoinQueue a -&gt; [(BlockHeader, Maybe a)] -&gt; JoinQueue a
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">JoinQueue a -&gt; (BlockHeader, Maybe a) -&gt; JoinQueue a
</span><a href="#local-6989586621681491570"><span class="hs-identifier hs-var">maybeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491573"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">([(BlockHeader, Maybe a)] -&gt; JoinQueue a)
-&gt; [(BlockHeader, Maybe a)] -&gt; JoinQueue a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BlockHeader] -&gt; [Maybe a] -&gt; [(BlockHeader, Maybe a)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffItem BlockHeader -&gt; [BlockHeader]
forall (t :: * -&gt; * -&gt; *) a. Bifoldable t =&gt; t a a -&gt; [a]
</span><span class="hs-identifier hs-var">biList</span></span><span> </span><span class="annot"><span class="annottext">DiffItem BlockHeader
</span><a href="#local-6989586621681491572"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffItem (Maybe a) -&gt; [Maybe a]
forall (t :: * -&gt; * -&gt; *) a. Bifoldable t =&gt; t a a -&gt; [a]
</span><span class="hs-identifier hs-var">biList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffItem BlockHeader -&gt; DiffItem (Maybe a)
</span><a href="#local-6989586621681491596"><span class="hs-identifier hs-var">prioFun</span></a></span><span> </span><span class="annot"><span class="annottext">DiffItem BlockHeader
</span><a href="#local-6989586621681491572"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><a href="#local-6989586621681491570"><span class="hs-identifier hs-type">maybeInsert</span></a></span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.Heap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">H.Entry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.Heap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">H.Entry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681491905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621681491570"><span class="annot"><span class="annottext">maybeInsert :: JoinQueue a -&gt; (BlockHeader, Maybe a) -&gt; JoinQueue a
</span><a href="#local-6989586621681491570"><span class="hs-identifier hs-var hs-var">maybeInsert</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491568"><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491568"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491568"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><a href="#local-6989586621681491570"><span class="hs-identifier hs-var">maybeInsert</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491567"><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491567"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681491566"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491566"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491565"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681491565"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry (BlockHeight, a) BlockHeader -&gt; JoinQueue a -&gt; JoinQueue a
forall a. Ord a =&gt; a -&gt; Heap a -&gt; Heap a
</span><span class="hs-identifier hs-var">H.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeight, a)
-&gt; BlockHeader -&gt; Entry (BlockHeight, a) BlockHeader
forall p a. p -&gt; a -&gt; Entry p a
</span><span class="hs-identifier hs-var">H.Entry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491566"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681491565"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491566"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">JoinQueue a
</span><a href="#local-6989586621681491567"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-comment">-- | Only chain ids of the intersection are included in the result.</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><a href="#local-6989586621681491589"><span class="hs-identifier hs-type">zipChainIdMaps</span></a></span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-439"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621681491589"><span class="annot"><span class="annottext">zipChainIdMaps :: HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; [(ChainId, BlockHeader, BlockHeader)]
</span><a href="#local-6989586621681491589"><span class="hs-identifier hs-var hs-var">zipChainIdMaps</span></a></span></span><span> </span><span id="local-6989586621681491562"><span class="annot"><span class="annottext">m0 :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491562"><span class="hs-identifier hs-var">m0</span></a></span></span><span> </span><span id="local-6989586621681491561"><span class="annot"><span class="annottext">m1 :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491561"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe (ChainId, BlockHeader, BlockHeader)]
-&gt; [(ChainId, BlockHeader, BlockHeader)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491560"><span class="hs-identifier hs-var">cida</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491559"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491558"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainId, BlockHeader, BlockHeader)
-&gt; Maybe () -&gt; Maybe (ChainId, BlockHeader, BlockHeader)
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491560"><span class="hs-identifier hs-var">cida</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; ChainId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491556"><span class="hs-identifier hs-var">cidb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491560"><span class="annot"><span class="annottext">cida :: ChainId
</span><a href="#local-6989586621681491560"><span class="hs-identifier hs-var">cida</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491559"><span class="annot"><span class="annottext">x :: BlockHeader
</span><a href="#local-6989586621681491559"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall i (f :: * -&gt; *) a. FoldableWithIndex i f =&gt; f a -&gt; [(i, a)]
</span><span class="hs-identifier hs-var">itoList</span></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491562"><span class="hs-identifier hs-var">m0</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491556"><span class="annot"><span class="annottext">cidb :: ChainId
</span><a href="#local-6989586621681491556"><span class="hs-identifier hs-var">cidb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491558"><span class="annot"><span class="annottext">y :: BlockHeader
</span><a href="#local-6989586621681491558"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall i (f :: * -&gt; *) a. FoldableWithIndex i f =&gt; f a -&gt; [(i, a)]
</span><span class="hs-identifier hs-var">itoList</span></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491561"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="hs-comment">-- | If the cuts are from different graphs only the chain ids of the</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- intersection are included in the result.</span><span>
</span><span id="line-449"></span><span class="hs-comment">--</span><span>
</span><span id="line-450"></span><span class="annot"><a href="Chainweb.Cut.html#zipCuts"><span class="hs-identifier hs-type">zipCuts</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-454"></span><span id="zipCuts"><span class="annot"><span class="annottext">zipCuts :: Cut -&gt; Cut -&gt; [(ChainId, BlockHeader, BlockHeader)]
</span><a href="Chainweb.Cut.html#zipCuts"><span class="hs-identifier hs-var hs-var">zipCuts</span></a></span></span><span> </span><span id="local-6989586621681491554"><span class="annot"><span class="annottext">a :: Cut
</span><a href="#local-6989586621681491554"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491553"><span class="annot"><span class="annottext">b :: Cut
</span><a href="#local-6989586621681491553"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe (ChainId, BlockHeader, BlockHeader)]
-&gt; [(ChainId, BlockHeader, BlockHeader)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491552"><span class="hs-identifier hs-var">cida</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491551"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491550"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainId, BlockHeader, BlockHeader)
-&gt; Maybe () -&gt; Maybe (ChainId, BlockHeader, BlockHeader)
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491552"><span class="hs-identifier hs-var">cida</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; ChainId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491549"><span class="hs-identifier hs-var">cidb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491552"><span class="annot"><span class="annottext">cida :: ChainId
</span><a href="#local-6989586621681491552"><span class="hs-identifier hs-var">cida</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491551"><span class="annot"><span class="annottext">x :: BlockHeader
</span><a href="#local-6989586621681491551"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall i (f :: * -&gt; *) a. FoldableWithIndex i f =&gt; f a -&gt; [(i, a)]
</span><span class="hs-identifier hs-var">itoList</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)])
-&gt; HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491554"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491549"><span class="annot"><span class="annottext">cidb :: ChainId
</span><a href="#local-6989586621681491549"><span class="hs-identifier hs-var">cidb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491550"><span class="annot"><span class="annottext">y :: BlockHeader
</span><a href="#local-6989586621681491550"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall i (f :: * -&gt; *) a. FoldableWithIndex i f =&gt; f a -&gt; [(i, a)]
</span><span class="hs-identifier hs-var">itoList</span></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)])
-&gt; HashMap ChainId BlockHeader -&gt; [(ChainId, BlockHeader)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491553"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">-- This can't fail because of missing dependencies. It can fail because</span><span>
</span><span id="line-461"></span><span class="hs-comment">-- of conflict.</span><span>
</span><span id="line-462"></span><span class="hs-comment">--</span><span>
</span><span id="line-463"></span><span id="local-6989586621681491852"><span id="local-6989586621681491853"><span class="annot"><a href="Chainweb.Cut.html#applyJoin"><span class="hs-identifier hs-type">applyJoin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621681491853"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Join"><span class="hs-identifier hs-type">Join</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491852"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491853"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span></span></span><span>
</span><span id="line-464"></span><span id="applyJoin"><span class="annot"><span class="annottext">applyJoin :: Join a -&gt; m Cut
</span><a href="Chainweb.Cut.html#applyJoin"><span class="hs-identifier hs-var hs-var">applyJoin</span></a></span></span><span> </span><span id="local-6989586621681491548"><span class="annot"><span class="annottext">m :: Join a
</span><a href="#local-6989586621681491548"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; Entry (BlockHeight, a) BlockHeader -&gt; m Cut)
-&gt; Cut -&gt; Heap (Entry (BlockHeight, a) BlockHeader) -&gt; m Cut
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681491547"><span class="annot"><span class="annottext">c :: Cut
</span><a href="#local-6989586621681491547"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681491546"><span class="annot"><span class="annottext">b :: Entry (BlockHeight, a) BlockHeader
</span><a href="#local-6989586621681491546"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Maybe Cut -&gt; Cut
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491547"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Cut -&gt; Cut) -&gt; m (Maybe Cut) -&gt; m Cut
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; BlockHeader -&gt; m (Maybe Cut)
forall (m :: * -&gt; *).
MonadThrow m =&gt;
Cut -&gt; BlockHeader -&gt; m (Maybe Cut)
</span><a href="Chainweb.Cut.html#tryMonotonicCutExtension"><span class="hs-identifier hs-var">tryMonotonicCutExtension</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491547"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry (BlockHeight, a) BlockHeader -&gt; BlockHeader
forall p a. Entry p a -&gt; a
</span><span class="hs-identifier hs-var hs-var">H.payload</span></span><span> </span><span class="annot"><span class="annottext">Entry (BlockHeight, a) BlockHeader
</span><a href="#local-6989586621681491546"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Join a -&gt; Cut
forall a. Join a -&gt; Cut
</span><a href="Chainweb.Cut.html#_joinBase"><span class="hs-identifier hs-var hs-var">_joinBase</span></a></span><span> </span><span class="annot"><span class="annottext">Join a
</span><a href="#local-6989586621681491548"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Join a -&gt; Heap (Entry (BlockHeight, a) BlockHeader)
forall a. Join a -&gt; JoinQueue a
</span><a href="Chainweb.Cut.html#_joinQueue"><span class="hs-identifier hs-var hs-var">_joinQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Join a
</span><a href="#local-6989586621681491548"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="hs-comment">-- | Merge two Cuts. If at least one of the input cuts had a valid braiding the</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- result is guaranteed to have a valid braiding for all blocks included in cut</span><span>
</span><span id="line-471"></span><span class="hs-comment">-- and their ancestors.</span><span>
</span><span id="line-472"></span><span class="hs-comment">--</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- This is because the merge starts with the intersection of both cuts, using</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- 'branchDiff_' on each chain, and constructs the merge cut using</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- 'tryMonotonicCutExtension'. If one of the inputs is correctly braided, so is</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- the intersection. 'tryMonotonicCutExtension' is guaranteed to maintain that</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- property.</span><span>
</span><span id="line-478"></span><span class="hs-comment">--</span><span>
</span><span id="line-479"></span><span class="annot"><a href="Chainweb.Cut.html#joinIntoHeavier"><span class="hs-identifier hs-type">joinIntoHeavier</span></a></span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-484"></span><span id="joinIntoHeavier"><span class="annot"><span class="annottext">joinIntoHeavier :: WebBlockHeaderDb -&gt; Cut -&gt; Cut -&gt; IO Cut
</span><a href="Chainweb.Cut.html#joinIntoHeavier"><span class="hs-identifier hs-var hs-var">joinIntoHeavier</span></a></span></span><span> </span><span id="local-6989586621681491544"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491544"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO Cut
</span><a href="Chainweb.Cut.html#joinIntoHeavier_"><span class="hs-identifier hs-var">joinIntoHeavier_</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491544"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; HashMap ChainId BlockHeader -&gt; IO Cut)
-&gt; (Cut -&gt; HashMap ChainId BlockHeader) -&gt; Cut -&gt; Cut -&gt; IO Cut
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span class="annot"><a href="Chainweb.Cut.html#joinIntoHeavier_"><span class="hs-identifier hs-type">joinIntoHeavier_</span></a></span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-491"></span><span id="joinIntoHeavier_"><span class="annot"><span class="annottext">joinIntoHeavier_ :: WebBlockHeaderDb
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO Cut
</span><a href="Chainweb.Cut.html#joinIntoHeavier_"><span class="hs-identifier hs-var hs-var">joinIntoHeavier_</span></a></span></span><span> </span><span id="local-6989586621681491543"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491543"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491542"><span class="annot"><span class="annottext">a :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491542"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491541"><span class="annot"><span class="annottext">b :: HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491541"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621681491540"><span class="annot"><span class="annottext">Join Int
</span><a href="#local-6989586621681491540"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe Int))
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO (Join Int)
forall a.
Ord a =&gt;
WebBlockHeaderDb
-&gt; (DiffItem BlockHeader -&gt; DiffItem (Maybe a))
-&gt; HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; IO (Join a)
</span><a href="Chainweb.Cut.html#join_"><span class="hs-identifier hs-var">join_</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491543"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; DiffItem BlockHeader
-&gt; DiffItem (Maybe Int)
forall (f :: * -&gt; *).
(Foldable f, Ord (f BlockHeader)) =&gt;
f BlockHeader
-&gt; f BlockHeader -&gt; DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="Chainweb.Cut.html#prioritizeHeavier_"><span class="hs-identifier hs-var">prioritizeHeavier_</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491542"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491541"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491542"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491541"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><span class="annottext">Join Int -&gt; IO Cut
forall (m :: * -&gt; *) a. MonadThrow m =&gt; Join a -&gt; m Cut
</span><a href="Chainweb.Cut.html#applyJoin"><span class="hs-identifier hs-var">applyJoin</span></a></span><span> </span><span class="annot"><span class="annottext">Join Int
</span><a href="#local-6989586621681491540"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="annot"><a href="Chainweb.Cut.html#prioritizeHeavier"><span class="hs-identifier hs-type">prioritizeHeavier</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span id="prioritizeHeavier"><span class="annot"><span class="annottext">prioritizeHeavier :: Cut -&gt; Cut -&gt; DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="Chainweb.Cut.html#prioritizeHeavier"><span class="hs-identifier hs-var hs-var">prioritizeHeavier</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
-&gt; HashMap ChainId BlockHeader
-&gt; DiffItem BlockHeader
-&gt; DiffItem (Maybe Int)
forall (f :: * -&gt; *).
(Foldable f, Ord (f BlockHeader)) =&gt;
f BlockHeader
-&gt; f BlockHeader -&gt; DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="Chainweb.Cut.html#prioritizeHeavier_"><span class="hs-identifier hs-var">prioritizeHeavier_</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap ChainId BlockHeader
 -&gt; HashMap ChainId BlockHeader
 -&gt; DiffItem BlockHeader
 -&gt; DiffItem (Maybe Int))
-&gt; (Cut -&gt; HashMap ChainId BlockHeader)
-&gt; Cut
-&gt; Cut
-&gt; DiffItem BlockHeader
-&gt; DiffItem (Maybe Int)
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; HashMap ChainId BlockHeader
</span><a href="Chainweb.Cut.html#_cutHeaders"><span class="hs-identifier hs-var hs-var">_cutHeaders</span></a></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="hs-comment">-- | Note: consider the weight of the recursive dependencies for the</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- priority of a block header. For that we would have to annotate the</span><span>
</span><span id="line-500"></span><span class="hs-comment">-- block headers before putting them in the queue. To traverse only once,</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- we'd have to traverse the zipped cuts by height and not by chainid, which</span><span>
</span><span id="line-502"></span><span class="hs-comment">-- could easily be done by merging/zipping the branch-diff streams.</span><span>
</span><span id="line-503"></span><span class="hs-comment">--</span><span>
</span><span id="line-504"></span><span id="local-6989586621681491854"><span class="annot"><a href="Chainweb.Cut.html#prioritizeHeavier_"><span class="hs-identifier hs-type">prioritizeHeavier_</span></a></span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621681491854"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681491854"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491854"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491854"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#DiffItem"><span class="hs-identifier hs-type">DiffItem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-511"></span><span id="prioritizeHeavier_"><span class="annot"><span class="annottext">prioritizeHeavier_ :: f BlockHeader
-&gt; f BlockHeader -&gt; DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="Chainweb.Cut.html#prioritizeHeavier_"><span class="hs-identifier hs-var hs-var">prioritizeHeavier_</span></a></span></span><span> </span><span id="local-6989586621681491539"><span class="annot"><span class="annottext">a :: f BlockHeader
</span><a href="#local-6989586621681491539"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491538"><span class="annot"><span class="annottext">b :: f BlockHeader
</span><a href="#local-6989586621681491538"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="#local-6989586621681491537"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-513"></span><span>    </span><span id="local-6989586621681491536"><span class="annot"><span class="annottext">heaviest :: f BlockHeader
</span><a href="#local-6989586621681491536"><span class="hs-identifier hs-var hs-var">heaviest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(f BlockHeader -&gt; f BlockHeader -&gt; Ordering)
-&gt; f BlockHeader -&gt; f BlockHeader -&gt; f BlockHeader
forall a. (a -&gt; a -&gt; Ordering) -&gt; a -&gt; a -&gt; a
</span><a href="Chainweb.Utils.html#maxBy"><span class="hs-identifier hs-var">maxBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockWeight, BlockHeight, f BlockHeader)
-&gt; (BlockWeight, BlockHeight, f BlockHeader) -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">((BlockWeight, BlockHeight, f BlockHeader)
 -&gt; (BlockWeight, BlockHeight, f BlockHeader) -&gt; Ordering)
-&gt; (f BlockHeader -&gt; (BlockWeight, BlockHeight, f BlockHeader))
-&gt; f BlockHeader
-&gt; f BlockHeader
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">f BlockHeader -&gt; (BlockWeight, BlockHeight, f BlockHeader)
forall (f :: * -&gt; *).
Foldable f =&gt;
f BlockHeader -&gt; (BlockWeight, BlockHeight, f BlockHeader)
</span><a href="#local-6989586621681491533"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491539"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491538"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621681491532"><span class="annot"><span class="annottext">w :: f BlockHeader -&gt; Int
</span><a href="#local-6989586621681491532"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span id="local-6989586621681491531"><span class="annot"><span class="annottext">c :: f BlockHeader
</span><a href="#local-6989586621681491531"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491531"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">f BlockHeader -&gt; f BlockHeader -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491536"><span class="hs-identifier hs-var">heaviest</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>    </span><span id="local-6989586621681491537"><span class="annot"><span class="annottext">f :: DiffItem BlockHeader -&gt; DiffItem (Maybe Int)
</span><a href="#local-6989586621681491537"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">This</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; DiffItem (Maybe Int)
forall a b. a -&gt; These a b
</span><span class="hs-identifier hs-var">This</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f BlockHeader -&gt; Int
</span><a href="#local-6989586621681491532"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491539"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>    </span><span class="annot"><a href="#local-6989586621681491537"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">That</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; DiffItem (Maybe Int)
forall a b. b -&gt; These a b
</span><span class="hs-identifier hs-var">That</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">f BlockHeader -&gt; Int
</span><a href="#local-6989586621681491532"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491538"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>    </span><span class="annot"><a href="#local-6989586621681491537"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491536"><span class="hs-identifier hs-var">heaviest</span></a></span><span> </span><span class="annot"><span class="annottext">f BlockHeader -&gt; f BlockHeader -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491539"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int -&gt; DiffItem (Maybe Int)
forall a b. a -&gt; b -&gt; These a b
</span><span class="hs-identifier hs-var">These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int -&gt; DiffItem (Maybe Int)
forall a b. a -&gt; b -&gt; These a b
</span><span class="hs-identifier hs-var">These</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>    </span><span id="local-6989586621681491533"><span class="annot"><span class="annottext">weight :: f BlockHeader -&gt; (BlockWeight, BlockHeight, f BlockHeader)
</span><a href="#local-6989586621681491533"><span class="hs-identifier hs-var hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621681491527"><span class="annot"><span class="annottext">c :: f BlockHeader
</span><a href="#local-6989586621681491527"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-523"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Getting (Endo (Endo BlockWeight)) (f BlockHeader) BlockWeight
-&gt; f BlockHeader -&gt; BlockWeight
forall a s. Num a =&gt; Getting (Endo (Endo a)) s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">sumOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
-&gt; f BlockHeader -&gt; Const (Endo (Endo BlockWeight)) (f BlockHeader)
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
 -&gt; f BlockHeader
 -&gt; Const (Endo (Endo BlockWeight)) (f BlockHeader))
-&gt; ((BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
    -&gt; BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader)
-&gt; Getting (Endo (Endo BlockWeight)) (f BlockHeader) BlockWeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockWeight -&gt; Const (Endo (Endo BlockWeight)) BlockWeight)
-&gt; BlockHeader -&gt; Const (Endo (Endo BlockWeight)) BlockHeader
Lens' BlockHeader BlockWeight
</span><a href="Chainweb.BlockHeader.html#blockWeight"><span class="hs-identifier hs-var">blockWeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491527"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-524"></span><span>            </span><span class="hs-comment">-- first sort by weight</span><span>
</span><span id="line-525"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Getting (Endo (Endo BlockHeight)) (f BlockHeader) BlockHeight
-&gt; f BlockHeader -&gt; BlockHeight
forall a s. Num a =&gt; Getting (Endo (Endo a)) s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">sumOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
-&gt; f BlockHeader -&gt; Const (Endo (Endo BlockHeight)) (f BlockHeader)
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
 -&gt; f BlockHeader
 -&gt; Const (Endo (Endo BlockHeight)) (f BlockHeader))
-&gt; ((BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
    -&gt; BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader)
-&gt; Getting (Endo (Endo BlockHeight)) (f BlockHeader) BlockHeight
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeight -&gt; Const (Endo (Endo BlockHeight)) BlockHeight)
-&gt; BlockHeader -&gt; Const (Endo (Endo BlockHeight)) BlockHeader
Lens' BlockHeader BlockHeight
</span><a href="Chainweb.BlockHeader.html#blockHeight"><span class="hs-identifier hs-var">blockHeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491527"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-526"></span><span>            </span><span class="hs-comment">-- for scenarios with trivial difficulty height is added as</span><span>
</span><span id="line-527"></span><span>            </span><span class="hs-comment">-- secondary metrics</span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">f BlockHeader
</span><a href="#local-6989586621681491527"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-comment">-- the block hashes of the cut are added as tie breaker in order</span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-comment">-- to guarantee commutativity.</span><span>
</span><span id="line-531"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-534"></span><span class="hs-comment">-- Cut Meet</span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span class="hs-comment">-- | Intersection of cuts</span><span>
</span><span id="line-537"></span><span class="hs-comment">--</span><span>
</span><span id="line-538"></span><span class="annot"><a href="Chainweb.Cut.html#meet"><span class="hs-identifier hs-type">meet</span></a></span><span>
</span><span id="line-539"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-543"></span><span id="meet"><span class="annot"><span class="annottext">meet :: WebBlockHeaderDb -&gt; Cut -&gt; Cut -&gt; IO Cut
</span><a href="Chainweb.Cut.html#meet"><span class="hs-identifier hs-var hs-var">meet</span></a></span></span><span> </span><span id="local-6989586621681491526"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491526"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491525"><span class="annot"><span class="annottext">a :: Cut
</span><a href="#local-6989586621681491525"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491524"><span class="annot"><span class="annottext">b :: Cut
</span><a href="#local-6989586621681491524"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681491523"><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491523"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(ChainId, BlockHeader)] -&gt; HashMap ChainId BlockHeader
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(ChainId, BlockHeader)] -&gt; HashMap ChainId BlockHeader)
-&gt; IO [(ChainId, BlockHeader)] -&gt; IO (HashMap ChainId BlockHeader)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((ChainId, BlockHeader, BlockHeader) -&gt; IO (ChainId, BlockHeader))
-&gt; [(ChainId, BlockHeader, BlockHeader)]
-&gt; IO [(ChainId, BlockHeader)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(ChainId, BlockHeader, BlockHeader) -&gt; IO (ChainId, BlockHeader)
</span><a href="#local-6989586621681491520"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; Cut -&gt; [(ChainId, BlockHeader, BlockHeader)]
</span><a href="Chainweb.Cut.html#zipCuts"><span class="hs-identifier hs-var">zipCuts</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491525"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491524"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>    </span><span class="annot"><span class="annottext">Cut -&gt; IO Cut
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; IO Cut) -&gt; Cut -&gt; IO Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader -&gt; ChainwebVersion -&gt; Cut
</span><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-var">Cut</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap ChainId BlockHeader
</span><a href="#local-6989586621681491523"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WebBlockHeaderDb -&gt; ChainwebVersion
forall a. HasChainwebVersion a =&gt; a -&gt; ChainwebVersion
</span><a href="Chainweb.Version.html#_chainwebVersion"><span class="hs-identifier hs-var">_chainwebVersion</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491526"><span class="hs-identifier hs-var">wdb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-547"></span><span>    </span><span id="local-6989586621681491520"><span class="annot"><span class="annottext">f :: (ChainId, BlockHeader, BlockHeader) -&gt; IO (ChainId, BlockHeader)
</span><a href="#local-6989586621681491520"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681491519"><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491519"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491518"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491518"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681491517"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491517"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491519"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; (ChainId, BlockHeader))
-&gt; IO BlockHeader -&gt; IO (ChainId, BlockHeader)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>        </span><span id="local-6989586621681491515"><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491515"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a r. a -&gt; (Given a =&gt; r) -&gt; r
</span><span class="hs-identifier hs-var">give</span></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491526"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">((Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb)
-&gt; (Given WebBlockHeaderDb =&gt; IO BlockHeaderDb) -&gt; IO BlockHeaderDb
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; IO BlockHeaderDb
forall (m :: * -&gt; *) p.
(MonadThrow m, HasChainId p, Given WebBlockHeaderDb) =&gt;
p -&gt; m BlockHeaderDb
</span><a href="Chainweb.WebBlockHeaderDB.html#getWebBlockHeaderDb"><span class="hs-identifier hs-var">getWebBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681491519"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; DbEntry BlockHeaderDb
-&gt; DbEntry BlockHeaderDb
-&gt; IO (DbEntry BlockHeaderDb)
forall db.
TreeDb db =&gt;
db -&gt; DbEntry db -&gt; DbEntry db -&gt; IO (DbEntry db)
</span><a href="Chainweb.TreeDB.html#forkEntry"><span class="hs-identifier hs-var">forkEntry</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491515"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681491518"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681491517"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="annot"><a href="Chainweb.Cut.html#forkDepth"><span class="hs-identifier hs-type">forkDepth</span></a></span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.WebBlockHeaderDB.Types.html#WebBlockHeaderDb"><span class="hs-identifier hs-type">WebBlockHeaderDb</span></a></span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-556"></span><span id="forkDepth"><span class="annot"><span class="annottext">forkDepth :: WebBlockHeaderDb -&gt; Cut -&gt; Cut -&gt; IO Natural
</span><a href="Chainweb.Cut.html#forkDepth"><span class="hs-identifier hs-var hs-var">forkDepth</span></a></span></span><span> </span><span id="local-6989586621681491513"><span class="annot"><span class="annottext">wdb :: WebBlockHeaderDb
</span><a href="#local-6989586621681491513"><span class="hs-identifier hs-var">wdb</span></a></span></span><span> </span><span id="local-6989586621681491512"><span class="annot"><span class="annottext">a :: Cut
</span><a href="#local-6989586621681491512"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681491511"><span class="annot"><span class="annottext">b :: Cut
</span><a href="#local-6989586621681491511"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-557"></span><span>    </span><span id="local-6989586621681491510"><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491510"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb -&gt; Cut -&gt; Cut -&gt; IO Cut
</span><a href="Chainweb.Cut.html#meet"><span class="hs-identifier hs-var">meet</span></a></span><span> </span><span class="annot"><span class="annottext">WebBlockHeaderDb
</span><a href="#local-6989586621681491513"><span class="hs-identifier hs-var">wdb</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491512"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491511"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-558"></span><span>    </span><span class="annot"><span class="annottext">Natural -&gt; IO Natural
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; IO Natural) -&gt; Natural -&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeight -&gt; Natural) -&gt; BlockHeight -&gt; Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHeight -&gt; BlockHeight
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; Cut -&gt; BlockHeight
</span><a href="#local-6989586621681491508"><span class="hs-identifier hs-var">maxDepth</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491510"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491512"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; Cut -&gt; BlockHeight
</span><a href="#local-6989586621681491508"><span class="hs-identifier hs-var">maxDepth</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491510"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491511"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-560"></span><span>    </span><span id="local-6989586621681491508"><span class="annot"><span class="annottext">maxDepth :: Cut -&gt; Cut -&gt; BlockHeight
</span><a href="#local-6989586621681491508"><span class="hs-identifier hs-var hs-var">maxDepth</span></a></span></span><span> </span><span id="local-6989586621681491507"><span class="annot"><span class="annottext">l :: Cut
</span><a href="#local-6989586621681491507"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681491506"><span class="annot"><span class="annottext">u :: Cut
</span><a href="#local-6989586621681491506"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BlockHeight] -&gt; BlockHeight
forall (t :: * -&gt; *) a. (Foldable t, Ord a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximum</span></span><span>
</span><span id="line-561"></span><span>        </span><span class="annot"><span class="annottext">([BlockHeight] -&gt; BlockHeight) -&gt; [BlockHeight] -&gt; BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491504"><span class="annot"><span class="annottext">x :: BlockHeader
</span><a href="#local-6989586621681491504"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681491503"><span class="annot"><span class="annottext">y :: BlockHeader
</span><a href="#local-6989586621681491503"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491503"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHeight -&gt; BlockHeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681491504"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>        </span><span class="annot"><span class="annottext">((ChainId, BlockHeader, BlockHeader) -&gt; BlockHeight)
-&gt; [(ChainId, BlockHeader, BlockHeader)] -&gt; [BlockHeight]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Cut -&gt; [(ChainId, BlockHeader, BlockHeader)]
</span><a href="Chainweb.Cut.html#zipCuts"><span class="hs-identifier hs-var">zipCuts</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491507"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681491506"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-563"></span></pre></body></html>