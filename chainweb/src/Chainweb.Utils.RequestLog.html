<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Module: Chainweb.Utils.RequestLog</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- Copyright: Copyright &#169; 2019 Kadena LLC.</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- License: MIT</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- Maintainer: Lars Kuhtz &lt;lars@kadena.io&gt;</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- Stability: experimental</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- TODO</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Chainweb.Utils.RequestLog</span><span>
</span><span id="line-22"></span><span class="hs-special">(</span><span>
</span><span id="line-23"></span><span class="annot"><span class="hs-comment">-- * Request Logging Middleware</span></span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier">RequestLog</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogVersion"><span class="hs-identifier">requestLogVersion</span></a></span><span>
</span><span id="line-26"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogMethod"><span class="hs-identifier">requestLogMethod</span></a></span><span>
</span><span id="line-27"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogPath"><span class="hs-identifier">requestLogPath</span></a></span><span>
</span><span id="line-28"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogIsSecure"><span class="hs-identifier">requestLogIsSecure</span></a></span><span>
</span><span id="line-29"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogRemoteHost"><span class="hs-identifier">requestLogRemoteHost</span></a></span><span>
</span><span id="line-30"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogQueryString"><span class="hs-identifier">requestLogQueryString</span></a></span><span>
</span><span id="line-31"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogBodyLength"><span class="hs-identifier">requestLogBodyLength</span></a></span><span>
</span><span id="line-32"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogUserAgent"><span class="hs-identifier">requestLogUserAgent</span></a></span><span>
</span><span id="line-33"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogger"><span class="hs-identifier">requestLogger</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="annot"><span class="hs-comment">-- * Request-Response Logging Middleware</span></span><span>
</span><span id="line-36"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestResponseLog"><span class="hs-identifier">RequestResponseLog</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestResponseLogRequest"><span class="hs-identifier">requestResponseLogRequest</span></a></span><span>
</span><span id="line-38"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestResponseLogStatus"><span class="hs-identifier">requestResponseLogStatus</span></a></span><span>
</span><span id="line-39"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestResponseLogDurationMicro"><span class="hs-identifier">requestResponseLogDurationMicro</span></a></span><span>
</span><span id="line-40"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestResponseLogger"><span class="hs-identifier">requestResponseLogger</span></a></span><span>
</span><span id="line-41"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai</span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Numeric.Natural</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Clock</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.LogLevel</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- internal modules</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Logger.html"><span class="hs-identifier">Chainweb.Logger</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.html"><span class="hs-identifier">Chainweb.Utils</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- Request Logger</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621681473832"><span id="local-6989586621681473833"></span></span><span class="hs-keyword">data</span><span> </span><span id="RequestLog"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier hs-var">RequestLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RequestLog"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier hs-var">RequestLog</span></a></span></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_requestLogVersion"><span class="annot"><span class="annottext">RequestLog -&gt; Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogVersion"><span class="hs-identifier hs-var hs-var">_requestLogVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogMethod"><span class="annot"><span class="annottext">RequestLog -&gt; Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogMethod"><span class="hs-identifier hs-var hs-var">_requestLogMethod</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogPath"><span class="annot"><span class="annottext">RequestLog -&gt; [Text]
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogPath"><span class="hs-identifier hs-var hs-var">_requestLogPath</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">]</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogIsSecure"><span class="annot"><span class="annottext">RequestLog -&gt; Bool
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogIsSecure"><span class="hs-identifier hs-var hs-var">_requestLogIsSecure</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogRemoteHost"><span class="annot"><span class="annottext">RequestLog -&gt; Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogRemoteHost"><span class="hs-identifier hs-var hs-var">_requestLogRemoteHost</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogQueryString"><span class="annot"><span class="annottext">RequestLog -&gt; QueryText
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogQueryString"><span class="hs-identifier hs-var hs-var">_requestLogQueryString</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">QueryText</span></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogBodyLength"><span class="annot"><span class="annottext">RequestLog -&gt; Maybe Natural
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogBodyLength"><span class="hs-identifier hs-var hs-var">_requestLogBodyLength</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestLogUserAgent"><span class="annot"><span class="annottext">RequestLog -&gt; Maybe Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogUserAgent"><span class="hs-identifier hs-var hs-var">_requestLogUserAgent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681473817"><span id="local-6989586621681473819"><span id="local-6989586621681473821"><span class="annot"><span class="annottext">Int -&gt; RequestLog -&gt; ShowS
[RequestLog] -&gt; ShowS
RequestLog -&gt; String
(Int -&gt; RequestLog -&gt; ShowS)
-&gt; (RequestLog -&gt; String)
-&gt; ([RequestLog] -&gt; ShowS)
-&gt; Show RequestLog
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RequestLog] -&gt; ShowS
$cshowList :: [RequestLog] -&gt; ShowS
show :: RequestLog -&gt; String
$cshow :: RequestLog -&gt; String
showsPrec :: Int -&gt; RequestLog -&gt; ShowS
$cshowsPrec :: Int -&gt; RequestLog -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473812"><span id="local-6989586621681473814"><span class="annot"><span class="annottext">RequestLog -&gt; RequestLog -&gt; Bool
(RequestLog -&gt; RequestLog -&gt; Bool)
-&gt; (RequestLog -&gt; RequestLog -&gt; Bool) -&gt; Eq RequestLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RequestLog -&gt; RequestLog -&gt; Bool
$c/= :: RequestLog -&gt; RequestLog -&gt; Bool
== :: RequestLog -&gt; RequestLog -&gt; Bool
$c== :: RequestLog -&gt; RequestLog -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473796"><span id="local-6989586621681473798"><span id="local-6989586621681473800"><span id="local-6989586621681473802"><span id="local-6989586621681473804"><span id="local-6989586621681473806"><span id="local-6989586621681473808"><span class="annot"><span class="annottext">Eq RequestLog
Eq RequestLog =&gt;
(RequestLog -&gt; RequestLog -&gt; Ordering)
-&gt; (RequestLog -&gt; RequestLog -&gt; Bool)
-&gt; (RequestLog -&gt; RequestLog -&gt; Bool)
-&gt; (RequestLog -&gt; RequestLog -&gt; Bool)
-&gt; (RequestLog -&gt; RequestLog -&gt; Bool)
-&gt; (RequestLog -&gt; RequestLog -&gt; RequestLog)
-&gt; (RequestLog -&gt; RequestLog -&gt; RequestLog)
-&gt; Ord RequestLog
RequestLog -&gt; RequestLog -&gt; Bool
RequestLog -&gt; RequestLog -&gt; Ordering
RequestLog -&gt; RequestLog -&gt; RequestLog
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: RequestLog -&gt; RequestLog -&gt; RequestLog
$cmin :: RequestLog -&gt; RequestLog -&gt; RequestLog
max :: RequestLog -&gt; RequestLog -&gt; RequestLog
$cmax :: RequestLog -&gt; RequestLog -&gt; RequestLog
&gt;= :: RequestLog -&gt; RequestLog -&gt; Bool
$c&gt;= :: RequestLog -&gt; RequestLog -&gt; Bool
&gt; :: RequestLog -&gt; RequestLog -&gt; Bool
$c&gt; :: RequestLog -&gt; RequestLog -&gt; Bool
&lt;= :: RequestLog -&gt; RequestLog -&gt; Bool
$c&lt;= :: RequestLog -&gt; RequestLog -&gt; Bool
&lt; :: RequestLog -&gt; RequestLog -&gt; Bool
$c&lt; :: RequestLog -&gt; RequestLog -&gt; Bool
compare :: RequestLog -&gt; RequestLog -&gt; Ordering
$ccompare :: RequestLog -&gt; RequestLog -&gt; Ordering
$cp1Ord :: Eq RequestLog
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. RequestLog -&gt; Rep RequestLog x)
-&gt; (forall x. Rep RequestLog x -&gt; RequestLog) -&gt; Generic RequestLog
forall x. Rep RequestLog x -&gt; RequestLog
forall x. RequestLog -&gt; Rep RequestLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep RequestLog x -&gt; RequestLog
$cfrom :: forall x. RequestLog -&gt; Rep RequestLog x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681473790"><span class="annot"><span class="annottext">RequestLog -&gt; ()
(RequestLog -&gt; ()) -&gt; NFData RequestLog
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: RequestLog -&gt; ()
$crnf :: RequestLog -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473781"><span id="local-6989586621681473783"><span id="local-6989586621681473785"><span id="local-6989586621681473787"><span class="annot"><span class="annottext">[RequestLog] -&gt; Encoding
[RequestLog] -&gt; Value
RequestLog -&gt; Encoding
RequestLog -&gt; Value
(RequestLog -&gt; Value)
-&gt; (RequestLog -&gt; Encoding)
-&gt; ([RequestLog] -&gt; Value)
-&gt; ([RequestLog] -&gt; Encoding)
-&gt; ToJSON RequestLog
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [RequestLog] -&gt; Encoding
$ctoEncodingList :: [RequestLog] -&gt; Encoding
toJSONList :: [RequestLog] -&gt; Value
$ctoJSONList :: [RequestLog] -&gt; Value
toEncoding :: RequestLog -&gt; Encoding
$ctoEncoding :: RequestLog -&gt; Encoding
toJSON :: RequestLog -&gt; Value
$ctoJSON :: RequestLog -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span id="requestLogUserAgent"><span id="requestLogBodyLength"><span id="requestLogQueryString"><span id="requestLogRemoteHost"><span id="requestLogIsSecure"><span id="requestLogPath"><span id="requestLogMethod"><span id="requestLogVersion"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">RequestLog</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-comment">-- | INVARIANT: this result of this function must not retain pointers to</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- the original request data that came over the wire.</span><span>
</span><span id="line-85"></span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#logRequest"><span class="hs-identifier hs-type">logRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier hs-type">RequestLog</span></a></span><span>
</span><span id="line-87"></span><span id="logRequest"><span class="annot"><span class="annottext">logRequest :: Request -&gt; RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#logRequest"><span class="hs-identifier hs-var hs-var">logRequest</span></a></span></span><span> </span><span id="local-6989586621681473778"><span class="annot"><span class="annottext">req :: Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WRequestLog :: Text
-&gt; Text
-&gt; [Text]
-&gt; Bool
-&gt; Text
-&gt; QueryText
-&gt; Maybe Natural
-&gt; Maybe Text
-&gt; RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#%24WRequestLog"><span class="hs-identifier hs-type hs-type">RequestLog</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_requestLogVersion :: Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogVersion"><span class="hs-identifier hs-var">_requestLogVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpVersion -&gt; Text) -&gt; HttpVersion -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; HttpVersion
</span><span class="hs-identifier hs-var hs-var">httpVersion</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogMethod :: Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogMethod"><span class="hs-identifier hs-var">_requestLogMethod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">T.decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; ByteString
</span><span class="hs-identifier hs-var hs-var">requestMethod</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogPath :: [Text]
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogPath"><span class="hs-identifier hs-var">_requestLogPath</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogIsSecure :: Bool
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogIsSecure"><span class="hs-identifier hs-var">_requestLogIsSecure</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Bool
</span><span class="hs-identifier hs-var hs-var">isSecure</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogRemoteHost :: Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogRemoteHost"><span class="hs-identifier hs-var">_requestLogRemoteHost</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">(SockAddr -&gt; Text) -&gt; SockAddr -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; SockAddr
</span><span class="hs-identifier hs-var hs-var">remoteHost</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogQueryString :: QueryText
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogQueryString"><span class="hs-identifier hs-var">_requestLogQueryString</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; QueryText
</span><span class="hs-identifier hs-var">queryToQueryText</span></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; QueryText) -&gt; Query -&gt; QueryText
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Query
</span><span class="hs-identifier hs-var hs-var">queryString</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogBodyLength :: Maybe Natural
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogBodyLength"><span class="hs-identifier hs-var">_requestLogBodyLength</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Request -&gt; RequestBodyLength
</span><span class="hs-identifier hs-var hs-var">requestBodyLength</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">ChunkedBody</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">KnownLength</span></span><span> </span><span id="local-6989586621681473764"><span class="annot"><span class="annottext">x :: Word64
</span><a href="#local-6989586621681473764"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Maybe Natural
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; Maybe Natural) -&gt; Natural -&gt; Maybe Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681473764"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestLogUserAgent :: Maybe Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestLogUserAgent"><span class="hs-identifier hs-var">_requestLogUserAgent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">T.decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; Maybe ByteString -&gt; Maybe Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Maybe ByteString
</span><span class="hs-identifier hs-var hs-var">requestHeaderUserAgent</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473778"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="local-6989586621681473760"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestLogger"><span class="hs-identifier hs-type">requestLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681473760"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681473760"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span></span><span>
</span><span id="line-101"></span><span id="requestLogger"><span class="annot"><span class="annottext">requestLogger :: l -&gt; Middleware
</span><a href="Chainweb.Utils.RequestLog.html#requestLogger"><span class="hs-identifier hs-var hs-var">requestLogger</span></a></span></span><span> </span><span id="local-6989586621681473759"><span class="annot"><span class="annottext">logger :: l
</span><a href="#local-6989586621681473759"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681473758"><span class="annot"><span class="annottext">app :: Application
</span><a href="#local-6989586621681473758"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621681473757"><span class="annot"><span class="annottext">req :: Request
</span><a href="#local-6989586621681473757"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621681473756"><span class="annot"><span class="annottext">respond :: Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621681473756"><span class="hs-identifier hs-var">respond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">l -&gt; LogLevel -&gt; RequestLog -&gt; IO ()
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="annot"><span class="annottext">l
</span><a href="#local-6989586621681473759"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="annottext">(RequestLog -&gt; IO ()) -&gt; RequestLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#logRequest"><span class="hs-identifier hs-var">logRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473757"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621681473758"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473757"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621681473756"><span class="hs-identifier hs-var">respond</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- Request-Response Logger</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span id="local-6989586621681473752"><span id="local-6989586621681473753"></span></span><span class="hs-keyword">data</span><span> </span><span id="RequestResponseLog"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestResponseLog"><span class="hs-identifier hs-var">RequestResponseLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RequestResponseLog"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestResponseLog"><span class="hs-identifier hs-var">RequestResponseLog</span></a></span></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_requestResponseLogRequest"><span class="annot"><span class="annottext">RequestResponseLog -&gt; RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogRequest"><span class="hs-identifier hs-var hs-var">_requestResponseLogRequest</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier hs-type">RequestLog</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestResponseLogStatus"><span class="annot"><span class="annottext">RequestResponseLog -&gt; Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogStatus"><span class="hs-identifier hs-var hs-var">_requestResponseLogStatus</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_requestResponseLogDurationMicro"><span class="annot"><span class="annottext">RequestResponseLog -&gt; Int
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogDurationMicro"><span class="hs-identifier hs-var hs-var">_requestResponseLogDurationMicro</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681473742"><span id="local-6989586621681473744"><span id="local-6989586621681473746"><span class="annot"><span class="annottext">Int -&gt; RequestResponseLog -&gt; ShowS
[RequestResponseLog] -&gt; ShowS
RequestResponseLog -&gt; String
(Int -&gt; RequestResponseLog -&gt; ShowS)
-&gt; (RequestResponseLog -&gt; String)
-&gt; ([RequestResponseLog] -&gt; ShowS)
-&gt; Show RequestResponseLog
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RequestResponseLog] -&gt; ShowS
$cshowList :: [RequestResponseLog] -&gt; ShowS
show :: RequestResponseLog -&gt; String
$cshow :: RequestResponseLog -&gt; String
showsPrec :: Int -&gt; RequestResponseLog -&gt; ShowS
$cshowsPrec :: Int -&gt; RequestResponseLog -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473738"><span id="local-6989586621681473740"><span class="annot"><span class="annottext">RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
(RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; Eq RequestResponseLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c/= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
== :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c== :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473723"><span id="local-6989586621681473725"><span id="local-6989586621681473727"><span id="local-6989586621681473729"><span id="local-6989586621681473731"><span id="local-6989586621681473733"><span id="local-6989586621681473735"><span class="annot"><span class="annottext">Eq RequestResponseLog
Eq RequestResponseLog =&gt;
(RequestResponseLog -&gt; RequestResponseLog -&gt; Ordering)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; Bool)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog)
-&gt; (RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog)
-&gt; Ord RequestResponseLog
RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
RequestResponseLog -&gt; RequestResponseLog -&gt; Ordering
RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog
$cmin :: RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog
max :: RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog
$cmax :: RequestResponseLog -&gt; RequestResponseLog -&gt; RequestResponseLog
&gt;= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c&gt;= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
&gt; :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c&gt; :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
&lt;= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c&lt;= :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
&lt; :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
$c&lt; :: RequestResponseLog -&gt; RequestResponseLog -&gt; Bool
compare :: RequestResponseLog -&gt; RequestResponseLog -&gt; Ordering
$ccompare :: RequestResponseLog -&gt; RequestResponseLog -&gt; Ordering
$cp1Ord :: Eq RequestResponseLog
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. RequestResponseLog -&gt; Rep RequestResponseLog x)
-&gt; (forall x. Rep RequestResponseLog x -&gt; RequestResponseLog)
-&gt; Generic RequestResponseLog
forall x. Rep RequestResponseLog x -&gt; RequestResponseLog
forall x. RequestResponseLog -&gt; Rep RequestResponseLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep RequestResponseLog x -&gt; RequestResponseLog
$cfrom :: forall x. RequestResponseLog -&gt; Rep RequestResponseLog x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681473719"><span class="annot"><span class="annottext">RequestResponseLog -&gt; ()
(RequestResponseLog -&gt; ()) -&gt; NFData RequestResponseLog
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: RequestResponseLog -&gt; ()
$crnf :: RequestResponseLog -&gt; ()
</span><a href="#local-6989586621681473719"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681473711"><span id="local-6989586621681473713"><span id="local-6989586621681473715"><span id="local-6989586621681473717"><span class="annot"><span class="annottext">[RequestResponseLog] -&gt; Encoding
[RequestResponseLog] -&gt; Value
RequestResponseLog -&gt; Encoding
RequestResponseLog -&gt; Value
(RequestResponseLog -&gt; Value)
-&gt; (RequestResponseLog -&gt; Encoding)
-&gt; ([RequestResponseLog] -&gt; Value)
-&gt; ([RequestResponseLog] -&gt; Encoding)
-&gt; ToJSON RequestResponseLog
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [RequestResponseLog] -&gt; Encoding
$ctoEncodingList :: [RequestResponseLog] -&gt; Encoding
toJSONList :: [RequestResponseLog] -&gt; Value
$ctoJSONList :: [RequestResponseLog] -&gt; Value
toEncoding :: RequestResponseLog -&gt; Encoding
$ctoEncoding :: RequestResponseLog -&gt; Encoding
toJSON :: RequestResponseLog -&gt; Value
$ctoJSON :: RequestResponseLog -&gt; Value
</span><a href="#local-6989586621681473711"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span id="requestResponseLogDurationMicro"><span id="requestResponseLogStatus"><span id="requestResponseLogRequest"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">RequestResponseLog</span></span></span></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#logRequestResponse"><span class="hs-identifier hs-type">logRequestResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestLog"><span class="hs-identifier hs-type">RequestLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Utils.RequestLog.html#RequestResponseLog"><span class="hs-identifier hs-type">RequestResponseLog</span></a></span><span>
</span><span id="line-119"></span><span id="logRequestResponse"><span class="annot"><span class="annottext">logRequestResponse :: RequestLog -&gt; Response -&gt; Int -&gt; RequestResponseLog
</span><a href="Chainweb.Utils.RequestLog.html#logRequestResponse"><span class="hs-identifier hs-var hs-var">logRequestResponse</span></a></span></span><span> </span><span id="local-6989586621681473709"><span class="annot"><span class="annottext">reqLog :: RequestLog
</span><a href="#local-6989586621681473709"><span class="hs-identifier hs-var">reqLog</span></a></span></span><span> </span><span id="local-6989586621681473708"><span class="annot"><span class="annottext">res :: Response
</span><a href="#local-6989586621681473708"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span id="local-6989586621681473707"><span class="annot"><span class="annottext">d :: Int
</span><a href="#local-6989586621681473707"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WRequestResponseLog :: RequestLog -&gt; Text -&gt; Int -&gt; RequestResponseLog
</span><a href="Chainweb.Utils.RequestLog.html#%24WRequestResponseLog"><span class="hs-identifier hs-type hs-type">RequestResponseLog</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_requestResponseLogRequest :: RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogRequest"><span class="hs-identifier hs-var">_requestResponseLogRequest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestLog
</span><a href="#local-6989586621681473709"><span class="hs-identifier hs-var">reqLog</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestResponseLogStatus :: Text
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogStatus"><span class="hs-identifier hs-var">_requestResponseLogStatus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Status -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">(Status -&gt; Text) -&gt; Status -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Status
</span><span class="hs-identifier hs-var">responseStatus</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681473708"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_requestResponseLogDurationMicro :: Int
</span><a href="Chainweb.Utils.RequestLog.html#_requestResponseLogDurationMicro"><span class="hs-identifier hs-var">_requestResponseLogDurationMicro</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681473707"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- | NOTE: this middleware should only be used for APIs that don't stream. Otherwise</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- the logg may be delayed for indefinite time.</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span id="local-6989586621681473704"><span class="annot"><a href="Chainweb.Utils.RequestLog.html#requestResponseLogger"><span class="hs-identifier hs-type">requestResponseLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681473704"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681473704"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span></span><span>
</span><span id="line-129"></span><span id="requestResponseLogger"><span class="annot"><span class="annottext">requestResponseLogger :: l -&gt; Middleware
</span><a href="Chainweb.Utils.RequestLog.html#requestResponseLogger"><span class="hs-identifier hs-var hs-var">requestResponseLogger</span></a></span></span><span> </span><span id="local-6989586621681473703"><span class="annot"><span class="annottext">logger :: l
</span><a href="#local-6989586621681473703"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681473702"><span class="annot"><span class="annottext">app :: Application
</span><a href="#local-6989586621681473702"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621681473701"><span class="annot"><span class="annottext">req :: Request
</span><a href="#local-6989586621681473701"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621681473700"><span class="annot"><span class="annottext">respond :: Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621681473700"><span class="hs-identifier hs-var">respond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681473699"><span class="annot"><span class="annottext">reqLog :: RequestLog
</span><a href="#local-6989586621681473699"><span class="hs-identifier hs-var hs-var">reqLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; RequestLog
</span><a href="Chainweb.Utils.RequestLog.html#logRequest"><span class="hs-identifier hs-var">logRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473701"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621681473698"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621681473698"><span class="hs-identifier hs-var">reqTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO TimeSpec
</span><span class="hs-identifier hs-var">getTime</span></span><span> </span><span class="annot"><span class="annottext">Clock
</span><span class="hs-identifier hs-var">Monotonic</span></span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621681473702"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621681473701"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">((Response -&gt; IO ResponseReceived) -&gt; IO ResponseReceived)
-&gt; (Response -&gt; IO ResponseReceived) -&gt; IO ResponseReceived
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681473695"><span class="annot"><span class="annottext">res :: Response
</span><a href="#local-6989586621681473695"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621681473694"><span class="annot"><span class="annottext">ResponseReceived
</span><a href="#local-6989586621681473694"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621681473700"><span class="hs-identifier hs-var">respond</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681473695"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span id="local-6989586621681473693"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621681473693"><span class="hs-identifier hs-var">resTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO TimeSpec
</span><span class="hs-identifier hs-var">getTime</span></span><span> </span><span class="annot"><span class="annottext">Clock
</span><span class="hs-identifier hs-var">Monotonic</span></span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><span class="annottext">l -&gt; LogLevel -&gt; RequestResponseLog -&gt; IO ()
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="annot"><span class="annottext">l
</span><a href="#local-6989586621681473703"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">(RequestResponseLog -&gt; IO ()) -&gt; RequestResponseLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RequestLog -&gt; Response -&gt; Int -&gt; RequestResponseLog
</span><a href="Chainweb.Utils.RequestLog.html#logRequestResponse"><span class="hs-identifier hs-var">logRequestResponse</span></a></span><span> </span><span class="annot"><span class="annottext">RequestLog
</span><a href="#local-6989586621681473699"><span class="hs-identifier hs-var">reqLog</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621681473695"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-137"></span><span>            </span><span class="annot"><span class="annottext">(Int -&gt; RequestResponseLog) -&gt; Int -&gt; RequestResponseLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Int) -&gt; Integer -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; Integer
</span><span class="hs-identifier hs-var">toNanoSecs</span></span><span> </span><span class="annot"><span class="annottext">(TimeSpec -&gt; Integer) -&gt; TimeSpec -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; TimeSpec -&gt; TimeSpec
</span><span class="hs-identifier hs-var">diffTimeSpec</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621681473693"><span class="hs-identifier hs-var">resTime</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621681473698"><span class="hs-identifier hs-var">reqTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="hs-number">1000</span></span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">ResponseReceived -&gt; IO ResponseReceived
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ResponseReceived
</span><a href="#local-6989586621681473694"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span></pre></body></html>