<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-comment">-- | A mock in-memory mempool backend that does not persist to disk.</span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Chainweb.Mempool.InMem</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">(</span><span>
</span><span id="line-13"></span><span>   </span><span class="annot"><span class="hs-comment">-- * Initialization functions</span></span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool"><span class="hs-identifier">withInMemoryMempool</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool_"><span class="hs-identifier">withInMemoryMempool_</span></a></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Low-level create/destroy functions</span></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMem.html#makeInMemPool"><span class="hs-identifier">makeInMemPool</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMem.html#newInMemMempoolData"><span class="hs-identifier">newInMemMempoolData</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">withMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">withMVarMasked</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Error.Util</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hush</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bracket</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throw</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;$!&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Short</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SB</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Decimal</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldlM</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">modifyIORef'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">for</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Tuple.Strict</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Vector</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector.Algorithms.Tim</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TimSort</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Parse</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.Gas</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GasPrice</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">init</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">pred</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.LogLevel</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-comment">-- internal imports</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html"><span class="hs-identifier">Chainweb.BlockHash</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html"><span class="hs-identifier">Chainweb.BlockHeader</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Logger.html"><span class="hs-identifier">Chainweb.Logger</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html"><span class="hs-identifier">Chainweb.Mempool.InMemTypes</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html"><span class="hs-identifier">Chainweb.Mempool.Mempool</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Time.html"><span class="hs-identifier">Chainweb.Time</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.html"><span class="hs-identifier">Chainweb.Utils</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Version.html"><span class="hs-identifier">Chainweb.Version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier">ChainwebVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Version.html#txSilenceEndDate"><span class="hs-identifier">txSilenceEndDate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-69"></span><span id="local-6989586621681484525"><span class="annot"><a href="Chainweb.Mempool.InMem.html#compareOnGasPrice"><span class="hs-identifier hs-type">compareOnGasPrice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484525"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681484525"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681484525"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ordering</span></span></span><span>
</span><span id="line-70"></span><span id="compareOnGasPrice"><span class="annot"><span class="annottext">compareOnGasPrice :: TransactionConfig t -&gt; t -&gt; t -&gt; Ordering
</span><a href="Chainweb.Mempool.InMem.html#compareOnGasPrice"><span class="hs-identifier hs-var hs-var">compareOnGasPrice</span></a></span></span><span> </span><span id="local-6989586621681484472"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484472"><span class="hs-identifier hs-var">txcfg</span></a></span></span><span> </span><span id="local-6989586621681484471"><span class="annot"><span class="annottext">a :: t
</span><a href="#local-6989586621681484471"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681484470"><span class="annot"><span class="annottext">b :: t
</span><a href="#local-6989586621681484470"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Down GasPrice -&gt; Down GasPrice -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">Down GasPrice
</span><a href="#local-6989586621681484468"><span class="hs-identifier hs-var">aa</span></a></span><span> </span><span class="annot"><span class="annottext">Down GasPrice
</span><a href="#local-6989586621681484467"><span class="hs-identifier hs-var">bb</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621681484466"><span class="annot"><span class="annottext">getGP :: t -&gt; GasPrice
</span><a href="#local-6989586621681484466"><span class="hs-identifier hs-var hs-var">getGP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; GasPrice
forall t. TransactionConfig t -&gt; t -&gt; GasPrice
</span><a href="Chainweb.Mempool.Mempool.html#txGasPrice"><span class="hs-identifier hs-var hs-var">txGasPrice</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484472"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681484468"><span class="annot"><span class="annottext">aa :: Down GasPrice
</span><a href="#local-6989586621681484468"><span class="hs-identifier hs-var hs-var">aa</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GasPrice -&gt; Down GasPrice
forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">(GasPrice -&gt; Down GasPrice) -&gt; GasPrice -&gt; Down GasPrice
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; GasPrice
</span><a href="#local-6989586621681484466"><span class="hs-identifier hs-var">getGP</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484471"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681484467"><span class="annot"><span class="annottext">bb :: Down GasPrice
</span><a href="#local-6989586621681484467"><span class="hs-identifier hs-var hs-var">bb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GasPrice -&gt; Down GasPrice
forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">(GasPrice -&gt; Down GasPrice) -&gt; GasPrice -&gt; Down GasPrice
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; GasPrice
</span><a href="#local-6989586621681484466"><span class="hs-identifier hs-var">getGP</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484470"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-75"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMem.html#compareOnGasPrice"><span class="hs-pragma hs-type">compareOnGasPrice</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-78"></span><span id="local-6989586621681484707"><span class="annot"><a href="Chainweb.Mempool.InMem.html#makeInMemPool"><span class="hs-identifier hs-type">makeInMemPool</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484707"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-79"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempool"><span class="hs-identifier hs-type">InMemoryMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484707"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-80"></span><span id="makeInMemPool"><span class="annot"><span class="annottext">makeInMemPool :: InMemConfig t -&gt; IO (InMemoryMempool t)
</span><a href="Chainweb.Mempool.InMem.html#makeInMemPool"><span class="hs-identifier hs-var hs-var">makeInMemPool</span></a></span></span><span> </span><span id="local-6989586621681484463"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484463"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (InMemoryMempool t) -&gt; IO (InMemoryMempool t)
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO (InMemoryMempool t) -&gt; IO (InMemoryMempool t))
-&gt; IO (InMemoryMempool t) -&gt; IO (InMemoryMempool t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621681484462"><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484462"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ServerNonce
forall a. Random a =&gt; IO a
</span><span class="hs-identifier hs-var">randomIO</span></span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621681484460"><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484460"><span class="hs-identifier hs-var">dataLock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (InMemoryMempoolData t)
forall t. IO (InMemoryMempoolData t)
</span><a href="Chainweb.Mempool.InMem.html#newInMemMempoolData"><span class="hs-identifier hs-var">newInMemMempoolData</span></a></span><span> </span><span class="annot"><span class="annottext">IO (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO (MVar (InMemoryMempoolData t)))
-&gt; IO (MVar (InMemoryMempoolData t))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IO (MVar (InMemoryMempoolData t))
forall a. a -&gt; IO (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO (InMemoryMempool t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(InMemoryMempool t -&gt; IO (InMemoryMempool t))
-&gt; InMemoryMempool t -&gt; IO (InMemoryMempool t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; MVar (InMemoryMempoolData t) -&gt; ServerNonce -&gt; InMemoryMempool t
forall t.
InMemConfig t
-&gt; MVar (InMemoryMempoolData t) -&gt; ServerNonce -&gt; InMemoryMempool t
</span><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempool"><span class="hs-identifier hs-var">InMemoryMempool</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484463"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484460"><span class="hs-identifier hs-var">dataLock</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484462"><span class="hs-identifier hs-var">nonce</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span id="local-6989586621681484706"><span class="annot"><a href="Chainweb.Mempool.InMem.html#destroyInMemPool"><span class="hs-identifier hs-type">destroyInMemPool</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempool"><span class="hs-identifier hs-type">InMemoryMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484706"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-86"></span><span id="destroyInMemPool"><span class="annot"><span class="annottext">destroyInMemPool :: InMemoryMempool t -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#destroyInMemPool"><span class="hs-identifier hs-var hs-var">destroyInMemPool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; InMemoryMempool t -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; InMemoryMempool t -&gt; IO ())
-&gt; IO () -&gt; InMemoryMempool t -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-90"></span><span id="local-6989586621681484760"><span class="annot"><a href="Chainweb.Mempool.InMem.html#newInMemMempoolData"><span class="hs-identifier hs-type">newInMemMempoolData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484760"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-91"></span><span id="newInMemMempoolData"><span class="annot"><span class="annottext">newInMemMempoolData :: IO (InMemoryMempoolData t)
</span><a href="Chainweb.Mempool.InMem.html#newInMemMempoolData"><span class="hs-identifier hs-var hs-var">newInMemMempoolData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">IORef ServerNonce
-&gt; IORef PendingMap
-&gt; IORef RecentLog
-&gt; IORef BadMap
-&gt; InMemoryMempoolData t
forall t.
IORef ServerNonce
-&gt; IORef PendingMap
-&gt; IORef RecentLog
-&gt; IORef BadMap
-&gt; InMemoryMempoolData t
</span><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-var">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef ServerNonce
 -&gt; IORef PendingMap
 -&gt; IORef RecentLog
 -&gt; IORef BadMap
 -&gt; InMemoryMempoolData t)
-&gt; IO (IORef ServerNonce)
-&gt; IO
     (IORef PendingMap
      -&gt; IORef RecentLog -&gt; IORef BadMap -&gt; InMemoryMempoolData t)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; IO (IORef ServerNonce)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-93"></span><span>                        </span><span class="annot"><span class="annottext">IO
  (IORef PendingMap
   -&gt; IORef RecentLog -&gt; IORef BadMap -&gt; InMemoryMempoolData t)
-&gt; IO (IORef PendingMap)
-&gt; IO (IORef RecentLog -&gt; IORef BadMap -&gt; InMemoryMempoolData t)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; IO (IORef PendingMap)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-94"></span><span>                        </span><span class="annot"><span class="annottext">IO (IORef RecentLog -&gt; IORef BadMap -&gt; InMemoryMempoolData t)
-&gt; IO (IORef RecentLog)
-&gt; IO (IORef BadMap -&gt; InMemoryMempoolData t)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; IO (IORef RecentLog)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="Chainweb.Mempool.InMem.html#emptyRecentLog"><span class="hs-identifier hs-var">emptyRecentLog</span></a></span><span>
</span><span id="line-95"></span><span>                        </span><span class="annot"><span class="annottext">IO (IORef BadMap -&gt; InMemoryMempoolData t)
-&gt; IO (IORef BadMap) -&gt; IO (InMemoryMempoolData t)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">BadMap -&gt; IO (IORef BadMap)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">BadMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-99"></span><span id="local-6989586621681484711"><span class="annot"><a href="Chainweb.Mempool.InMem.html#toMempoolBackend"><span class="hs-identifier hs-type">toMempoolBackend</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempool"><span class="hs-identifier hs-type">InMemoryMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484711"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolBackend"><span class="hs-identifier hs-type">MempoolBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484711"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-103"></span><span id="toMempoolBackend"><span class="annot"><span class="annottext">toMempoolBackend :: ChainwebVersion -&gt; InMemoryMempool t -&gt; IO (MempoolBackend t)
</span><a href="Chainweb.Mempool.InMem.html#toMempoolBackend"><span class="hs-identifier hs-var hs-var">toMempoolBackend</span></a></span></span><span> </span><span id="local-6989586621681484452"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484452"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484451"><span class="annot"><span class="annottext">mempool :: InMemoryMempool t
</span><a href="#local-6989586621681484451"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">MempoolBackend t -&gt; IO (MempoolBackend t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(MempoolBackend t -&gt; IO (MempoolBackend t))
-&gt; MempoolBackend t -&gt; IO (MempoolBackend t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">$WMempoolBackend :: forall t.
TransactionConfig t
-&gt; GasLimit
-&gt; (Vector TransactionHash -&gt; IO (Vector Bool))
-&gt; (Vector TransactionHash -&gt; IO (Vector (LookupResult t)))
-&gt; (InsertType -&gt; Vector t -&gt; IO ())
-&gt; (Vector t -&gt; IO (Either (T2 TransactionHash InsertError) ()))
-&gt; (Vector TransactionHash -&gt; IO ())
-&gt; (MempoolPreBlockCheck t
    -&gt; BlockHeight -&gt; BlockHash -&gt; GasLimit -&gt; IO (Vector t))
-&gt; (Maybe HighwaterMark
    -&gt; (Vector TransactionHash -&gt; IO ()) -&gt; IO HighwaterMark)
-&gt; IO ()
-&gt; MempoolBackend t
</span><a href="Chainweb.Mempool.Mempool.html#%24WMempoolBackend"><span class="hs-identifier hs-type hs-type">MempoolBackend</span></a></span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mempoolTxConfig :: TransactionConfig t
</span><a href="Chainweb.Mempool.Mempool.html#mempoolTxConfig"><span class="hs-identifier hs-var">mempoolTxConfig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484447"><span class="hs-identifier hs-var">tcfg</span></a></span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolBlockGasLimit :: GasLimit
</span><a href="Chainweb.Mempool.Mempool.html#mempoolBlockGasLimit"><span class="hs-identifier hs-var">mempoolBlockGasLimit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484445"><span class="hs-identifier hs-var">blockSizeLimit</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolMember :: Vector TransactionHash -&gt; IO (Vector Bool)
</span><a href="Chainweb.Mempool.Mempool.html#mempoolMember"><span class="hs-identifier hs-var">mempoolMember</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; IO (Vector Bool)
</span><a href="#local-6989586621681484443"><span class="hs-identifier hs-var">member</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolLookup :: Vector TransactionHash -&gt; IO (Vector (LookupResult t))
</span><a href="Chainweb.Mempool.Mempool.html#mempoolLookup"><span class="hs-identifier hs-var">mempoolLookup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; IO (Vector (LookupResult t))
</span><a href="#local-6989586621681484441"><span class="hs-identifier hs-var">lookup</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolInsert :: InsertType -&gt; Vector t -&gt; IO ()
</span><a href="Chainweb.Mempool.Mempool.html#mempoolInsert"><span class="hs-identifier hs-var">mempoolInsert</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsertType -&gt; Vector t -&gt; IO ()
</span><a href="#local-6989586621681484439"><span class="hs-identifier hs-var">insert</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolInsertCheck :: Vector t -&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="Chainweb.Mempool.Mempool.html#mempoolInsertCheck"><span class="hs-identifier hs-var">mempoolInsertCheck</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="#local-6989586621681484437"><span class="hs-identifier hs-var">insertCheck</span></a></span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolMarkValidated :: Vector TransactionHash -&gt; IO ()
</span><a href="Chainweb.Mempool.Mempool.html#mempoolMarkValidated"><span class="hs-identifier hs-var">mempoolMarkValidated</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; IO ()
</span><a href="#local-6989586621681484435"><span class="hs-identifier hs-var">markValidated</span></a></span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolGetBlock :: MempoolPreBlockCheck t
-&gt; BlockHeight -&gt; BlockHash -&gt; GasLimit -&gt; IO (Vector t)
</span><a href="Chainweb.Mempool.Mempool.html#mempoolGetBlock"><span class="hs-identifier hs-var">mempoolGetBlock</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolPreBlockCheck t
-&gt; BlockHeight -&gt; BlockHash -&gt; GasLimit -&gt; IO (Vector t)
</span><a href="#local-6989586621681484433"><span class="hs-identifier hs-var">getBlock</span></a></span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolGetPendingTransactions :: Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ()) -&gt; IO HighwaterMark
</span><a href="Chainweb.Mempool.Mempool.html#mempoolGetPendingTransactions"><span class="hs-identifier hs-var">mempoolGetPendingTransactions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ()) -&gt; IO HighwaterMark
</span><a href="#local-6989586621681484431"><span class="hs-identifier hs-var">getPending</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mempoolClear :: IO ()
</span><a href="Chainweb.Mempool.Mempool.html#mempoolClear"><span class="hs-identifier hs-var">mempoolClear</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681484429"><span class="hs-identifier hs-var">clear</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621681484428"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; InMemConfig t
forall t. InMemoryMempool t -&gt; InMemConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemCfg"><span class="hs-identifier hs-var hs-var">_inmemCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484451"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621681484426"><span class="annot"><span class="annottext">nonce :: ServerNonce
</span><a href="#local-6989586621681484426"><span class="hs-identifier hs-var hs-var">nonce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; ServerNonce
forall t. InMemoryMempool t -&gt; ServerNonce
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemNonce"><span class="hs-identifier hs-var hs-var">_inmemNonce</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484451"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621681484424"><span class="annot"><span class="annottext">lockMVar :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var hs-var">lockMVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; MVar (InMemoryMempoolData t)
forall t. InMemoryMempool t -&gt; MVar (InMemoryMempoolData t)
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemDataLock"><span class="hs-identifier hs-var hs-var">_inmemDataLock</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484451"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span id="local-6989586621681484447"><span class="annot"><span class="annottext">tcfg :: TransactionConfig t
</span><a href="#local-6989586621681484447"><span class="hs-identifier hs-var">tcfg</span></a></span></span><span> </span><span id="local-6989586621681484445"><span class="annot"><span class="annottext">blockSizeLimit :: GasLimit
</span><a href="#local-6989586621681484445"><span class="hs-identifier hs-var">blockSizeLimit</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621681484443"><span class="annot"><span class="annottext">member :: Vector TransactionHash -&gt; IO (Vector Bool)
</span><a href="#local-6989586621681484443"><span class="hs-identifier hs-var hs-var">member</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash -&gt; IO (Vector Bool)
forall t.
MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash -&gt; IO (Vector Bool)
</span><a href="Chainweb.Mempool.InMem.html#memberInMem"><span class="hs-identifier hs-var">memberInMem</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621681484441"><span class="annot"><span class="annottext">lookup :: Vector TransactionHash -&gt; IO (Vector (LookupResult t))
</span><a href="#local-6989586621681484441"><span class="hs-identifier hs-var hs-var">lookup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash
-&gt; IO (Vector (LookupResult t))
forall t.
TransactionConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash
-&gt; IO (Vector (LookupResult t))
</span><a href="Chainweb.Mempool.InMem.html#lookupInMem"><span class="hs-identifier hs-var">lookupInMem</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484447"><span class="hs-identifier hs-var">tcfg</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621681484439"><span class="annot"><span class="annottext">insert :: InsertType -&gt; Vector t -&gt; IO ()
</span><a href="#local-6989586621681484439"><span class="hs-identifier hs-var hs-var">insert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; InsertType
-&gt; Vector t
-&gt; IO ()
forall t.
InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; InsertType
-&gt; Vector t
-&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#insertInMem"><span class="hs-identifier hs-var">insertInMem</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484452"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621681484437"><span class="annot"><span class="annottext">insertCheck :: Vector t -&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="#local-6989586621681484437"><span class="hs-identifier hs-var hs-var">insertCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall t.
InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="Chainweb.Mempool.InMem.html#insertCheckInMem"><span class="hs-identifier hs-var">insertCheckInMem</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484452"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621681484435"><span class="annot"><span class="annottext">markValidated :: Vector TransactionHash -&gt; IO ()
</span><a href="#local-6989586621681484435"><span class="hs-identifier hs-var hs-var">markValidated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t) -&gt; Vector TransactionHash -&gt; IO ()
forall t.
MVar (InMemoryMempoolData t) -&gt; Vector TransactionHash -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#markValidatedInMem"><span class="hs-identifier hs-var">markValidatedInMem</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621681484433"><span class="annot"><span class="annottext">getBlock :: MempoolPreBlockCheck t
-&gt; BlockHeight -&gt; BlockHash -&gt; GasLimit -&gt; IO (Vector t)
</span><a href="#local-6989586621681484433"><span class="hs-identifier hs-var hs-var">getBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; MempoolPreBlockCheck t
-&gt; BlockHeight
-&gt; BlockHash
-&gt; GasLimit
-&gt; IO (Vector t)
forall t.
InMemConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; MempoolPreBlockCheck t
-&gt; BlockHeight
-&gt; BlockHash
-&gt; GasLimit
-&gt; IO (Vector t)
</span><a href="Chainweb.Mempool.InMem.html#getBlockInMem"><span class="hs-identifier hs-var">getBlockInMem</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621681484431"><span class="annot"><span class="annottext">getPending :: Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ()) -&gt; IO HighwaterMark
</span><a href="#local-6989586621681484431"><span class="hs-identifier hs-var hs-var">getPending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ServerNonce
-&gt; MVar (InMemoryMempoolData t)
-&gt; Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ())
-&gt; IO HighwaterMark
forall t.
InMemConfig t
-&gt; ServerNonce
-&gt; MVar (InMemoryMempoolData t)
-&gt; Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ())
-&gt; IO HighwaterMark
</span><a href="Chainweb.Mempool.InMem.html#getPendingInMem"><span class="hs-identifier hs-var">getPendingInMem</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484428"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484426"><span class="hs-identifier hs-var">nonce</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621681484429"><span class="annot"><span class="annottext">clear :: IO ()
</span><a href="#local-6989586621681484429"><span class="hs-identifier hs-var hs-var">clear</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t) -&gt; IO ()
forall t. MVar (InMemoryMempoolData t) -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#clearInMem"><span class="hs-identifier hs-var">clearInMem</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484424"><span class="hs-identifier hs-var">lockMVar</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | A 'bracket' function for in-memory mempools.</span><span>
</span><span id="line-134"></span><span id="local-6989586621681484412"><span id="local-6989586621681484413"><span class="annot"><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool"><span class="hs-identifier hs-type">withInMemoryMempool</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621681484413"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-135"></span><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621681484413"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-136"></span><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484413"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-137"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-138"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolBackend"><span class="hs-identifier hs-type">MempoolBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484413"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681484412"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681484412"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-140"></span><span id="withInMemoryMempool"><span class="annot"><span class="annottext">withInMemoryMempool :: InMemConfig t
-&gt; ChainwebVersion -&gt; (MempoolBackend t -&gt; IO a) -&gt; IO a
</span><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool"><span class="hs-identifier hs-var hs-var">withInMemoryMempool</span></a></span></span><span> </span><span id="local-6989586621681484409"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484409"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484408"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484408"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484407"><span class="annot"><span class="annottext">f :: MempoolBackend t -&gt; IO a
</span><a href="#local-6989586621681484407"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484406"><span class="annot"><span class="annottext">action :: InMemoryMempool t -&gt; IO a
</span><a href="#local-6989586621681484406"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span id="local-6989586621681484405"><span class="annot"><span class="annottext">inMem :: InMemoryMempool t
</span><a href="#local-6989586621681484405"><span class="hs-identifier hs-var">inMem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>          </span><span id="local-6989586621681484404"><span class="annot"><span class="annottext">MempoolBackend t
</span><a href="#local-6989586621681484404"><span class="hs-identifier hs-var">back</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; InMemoryMempool t -&gt; IO (MempoolBackend t)
forall t.
ChainwebVersion -&gt; InMemoryMempool t -&gt; IO (MempoolBackend t)
</span><a href="Chainweb.Mempool.InMem.html#toMempoolBackend"><span class="hs-identifier hs-var">toMempoolBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484408"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484405"><span class="hs-identifier hs-var">inMem</span></a></span><span>
</span><span id="line-143"></span><span>          </span><span class="annot"><span class="annottext">MempoolBackend t -&gt; IO a
</span><a href="#local-6989586621681484407"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(MempoolBackend t -&gt; IO a) -&gt; MempoolBackend t -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">MempoolBackend t
</span><a href="#local-6989586621681484404"><span class="hs-identifier hs-var">back</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><span class="annottext">IO (InMemoryMempool t)
-&gt; (InMemoryMempool t -&gt; IO ())
-&gt; (InMemoryMempool t -&gt; IO a)
-&gt; IO a
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemConfig t -&gt; IO (InMemoryMempool t)
forall t. InMemConfig t -&gt; IO (InMemoryMempool t)
</span><a href="Chainweb.Mempool.InMem.html#makeInMemPool"><span class="hs-identifier hs-var">makeInMemPool</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484409"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO ()
forall t. InMemoryMempool t -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#destroyInMemPool"><span class="hs-identifier hs-var">destroyInMemPool</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO a
</span><a href="#local-6989586621681484406"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621681484401"><span id="local-6989586621681484402"><span id="local-6989586621681484403"><span class="annot"><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool_"><span class="hs-identifier hs-type">withInMemoryMempool_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484403"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-147"></span><span>                     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681484403"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-148"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484402"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-149"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-150"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolBackend"><span class="hs-identifier hs-type">MempoolBackend</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484402"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681484401"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681484401"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-152"></span><span id="withInMemoryMempool_"><span class="annot"><span class="annottext">withInMemoryMempool_ :: logger
-&gt; InMemConfig t
-&gt; ChainwebVersion
-&gt; (MempoolBackend t -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.Mempool.InMem.html#withInMemoryMempool_"><span class="hs-identifier hs-var hs-var">withInMemoryMempool_</span></a></span></span><span> </span><span id="local-6989586621681484400"><span class="annot"><span class="annottext">l :: logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681484399"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484399"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484398"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484398"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484397"><span class="annot"><span class="annottext">f :: MempoolBackend t -&gt; IO a
</span><a href="#local-6989586621681484397"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484396"><span class="annot"><span class="annottext">action :: InMemoryMempool t -&gt; IO a
</span><a href="#local-6989586621681484396"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span id="local-6989586621681484395"><span class="annot"><span class="annottext">inMem :: InMemoryMempool t
</span><a href="#local-6989586621681484395"><span class="hs-identifier hs-var">inMem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>          </span><span id="local-6989586621681484394"><span class="annot"><span class="annottext">Either () a
</span><a href="#local-6989586621681484394"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO a -&gt; IO (Either () a)
forall a b. IO a -&gt; IO b -&gt; IO (Either a b)
</span><span class="hs-identifier hs-var">race</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO ()
</span><a href="#local-6989586621681484392"><span class="hs-identifier hs-var">monitor</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484395"><span class="hs-identifier hs-var">inMem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO (Either () a)) -&gt; IO a -&gt; IO (Either () a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>            </span><span id="local-6989586621681484391"><span class="annot"><span class="annottext">MempoolBackend t
</span><a href="#local-6989586621681484391"><span class="hs-identifier hs-var">back</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; InMemoryMempool t -&gt; IO (MempoolBackend t)
forall t.
ChainwebVersion -&gt; InMemoryMempool t -&gt; IO (MempoolBackend t)
</span><a href="Chainweb.Mempool.InMem.html#toMempoolBackend"><span class="hs-identifier hs-var">toMempoolBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484398"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484395"><span class="hs-identifier hs-var">inMem</span></a></span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">MempoolBackend t -&gt; IO a
</span><a href="#local-6989586621681484397"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(MempoolBackend t -&gt; IO a) -&gt; MempoolBackend t -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">MempoolBackend t
</span><a href="#local-6989586621681484391"><span class="hs-identifier hs-var">back</span></a></span><span>
</span><span id="line-157"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either () a
</span><a href="#local-6989586621681484394"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InternalInvariantViolation -&gt; IO a
forall a e. Exception e =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">throw</span></span><span> </span><span class="annot"><span class="annottext">(InternalInvariantViolation -&gt; IO a)
-&gt; InternalInvariantViolation -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; InternalInvariantViolation
</span><a href="Chainweb.Utils.html#InternalInvariantViolation"><span class="hs-identifier hs-var">InternalInvariantViolation</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;mempool monitor exited unexpectedly&quot;</span></span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681484389"><span class="annot"><span class="annottext">result :: a
</span><a href="#local-6989586621681484389"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681484389"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="annottext">IO (InMemoryMempool t)
-&gt; (InMemoryMempool t -&gt; IO ())
-&gt; (InMemoryMempool t -&gt; IO a)
-&gt; IO a
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemConfig t -&gt; IO (InMemoryMempool t)
forall t. InMemConfig t -&gt; IO (InMemoryMempool t)
</span><a href="Chainweb.Mempool.InMem.html#makeInMemPool"><span class="hs-identifier hs-var">makeInMemPool</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484399"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO ()
forall t. InMemoryMempool t -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#destroyInMemPool"><span class="hs-identifier hs-var">destroyInMemPool</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO a
</span><a href="#local-6989586621681484396"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621681484392"><span class="annot"><span class="annottext">monitor :: InMemoryMempool t -&gt; IO ()
</span><a href="#local-6989586621681484392"><span class="hs-identifier hs-var hs-var">monitor</span></a></span></span><span> </span><span id="local-6989586621681484388"><span class="annot"><span class="annottext">m :: InMemoryMempool t
</span><a href="#local-6989586621681484388"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484387"><span class="annot"><span class="annottext">lf :: LogLevel -&gt; Text -&gt; IO ()
</span><a href="#local-6989586621681484387"><span class="hs-identifier hs-var hs-var">lf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunction
forall l. Logger l =&gt; l -&gt; LogFunction
</span><a href="Chainweb.Logger.html#logFunction"><span class="hs-identifier hs-var">logFunction</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="annot"><span class="annottext">logger -&gt; LogLevel -&gt; Text -&gt; IO ()
forall l. Logger l =&gt; l -&gt; LogLevel -&gt; Text -&gt; IO ()
</span><a href="Chainweb.Logger.html#logFunctionText"><span class="hs-identifier hs-var">logFunctionText</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Initialized Mempool Monitor&quot;</span></span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">(LogLevel -&gt; Text -&gt; IO ())
-&gt; Text -&gt; Word64 -&gt; Word64 -&gt; IO () -&gt; IO ()
</span><a href="Chainweb.Utils.html#runForeverThrottled"><span class="hs-identifier hs-var">runForeverThrottled</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; IO ()
</span><a href="#local-6989586621681484387"><span class="hs-identifier hs-var">lf</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Chainweb.Mempool.InMem.withInMemoryMempool_.monitor&quot;</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word64
forall a. Num a =&gt; a
</span><a href="Chainweb.Utils.html#mega"><span class="hs-identifier hs-var">mega</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>            </span><span id="local-6989586621681484380"><span class="annot"><span class="annottext">MempoolStats
</span><a href="#local-6989586621681484380"><span class="hs-identifier hs-var">stats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; IO MempoolStats
forall t. InMemoryMempool t -&gt; IO MempoolStats
</span><a href="Chainweb.Mempool.InMem.html#getMempoolStats"><span class="hs-identifier hs-var">getMempoolStats</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484388"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-167"></span><span>            </span><span class="annot"><span class="annottext">logger -&gt; LogLevel -&gt; Text -&gt; IO ()
forall l. Logger l =&gt; l -&gt; LogLevel -&gt; Text -&gt; IO ()
</span><a href="Chainweb.Logger.html#logFunctionText"><span class="hs-identifier hs-var">logFunctionText</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Debug</span></span><span> </span><span class="annot"><span class="hs-string">&quot;got stats&quot;</span></span><span>
</span><span id="line-168"></span><span>            </span><span class="annot"><span class="annottext">logger -&gt; LogLevel -&gt; MempoolStats -&gt; IO ()
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="annottext">MempoolStats
</span><a href="#local-6989586621681484380"><span class="hs-identifier hs-var">stats</span></a></span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">logger -&gt; LogLevel -&gt; Text -&gt; IO ()
forall l. Logger l =&gt; l -&gt; LogLevel -&gt; Text -&gt; IO ()
</span><a href="Chainweb.Logger.html#logFunctionText"><span class="hs-identifier hs-var">logFunctionText</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681484400"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Debug</span></span><span> </span><span class="annot"><span class="hs-string">&quot;logged stats&quot;</span></span><span>
</span><span id="line-170"></span><span>            </span><span class="annot"><span class="annottext">ServerNonce -&gt; IO ()
</span><a href="Chainweb.Utils.html#approximateThreadDelay"><span class="hs-identifier hs-var">approximateThreadDelay</span></a></span><span> </span><span class="annot"><span class="hs-number">60000000</span></span><span> </span><span class="hs-comment">{- 1 minute -}</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-173"></span><span id="local-6989586621681484721"><span class="annot"><a href="Chainweb.Mempool.InMem.html#memberInMem"><span class="hs-identifier hs-type">memberInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484721"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span>
</span><span id="line-175"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-176"></span><span id="memberInMem"><span class="annot"><span class="annottext">memberInMem :: MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash -&gt; IO (Vector Bool)
</span><a href="Chainweb.Mempool.InMem.html#memberInMem"><span class="hs-identifier hs-var hs-var">memberInMem</span></a></span></span><span> </span><span id="local-6989586621681484375"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484375"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484374"><span class="annot"><span class="annottext">txs :: Vector TransactionHash
</span><a href="#local-6989586621681484374"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621681484373"><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484373"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO PendingMap) -&gt; IO PendingMap
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484375"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef PendingMap -&gt; IO PendingMap)
-&gt; (InMemoryMempoolData t -&gt; IORef PendingMap)
-&gt; InMemoryMempoolData t
-&gt; IO PendingMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">(TransactionHash -&gt; IO Bool)
-&gt; Vector TransactionHash -&gt; IO (Vector Bool)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Vector a -&gt; m (Vector b)
</span><span class="hs-identifier hs-var">V.mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap -&gt; TransactionHash -&gt; IO Bool
forall (m :: * -&gt; *) k a.
(Monad m, Eq k, Hashable k) =&gt;
HashMap k a -&gt; k -&gt; m Bool
</span><a href="#local-6989586621681484369"><span class="hs-identifier hs-var">memberOne</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484373"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484374"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621681484369"><span class="annot"><span class="annottext">memberOne :: HashMap k a -&gt; k -&gt; m Bool
</span><a href="#local-6989586621681484369"><span class="hs-identifier hs-var hs-var">memberOne</span></a></span></span><span> </span><span id="local-6989586621681484368"><span class="annot"><span class="annottext">q :: HashMap k a
</span><a href="#local-6989586621681484368"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621681484367"><span class="annot"><span class="annottext">txHash :: k
</span><a href="#local-6989586621681484367"><span class="hs-identifier hs-var">txHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; HashMap k a -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><span class="hs-identifier hs-var">HashMap.member</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621681484367"><span class="hs-identifier hs-var">txHash</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap k a
</span><a href="#local-6989586621681484368"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-184"></span><span id="local-6989586621681484720"><span class="annot"><a href="Chainweb.Mempool.InMem.html#lookupInMem"><span class="hs-identifier hs-type">lookupInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484720"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-185"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484720"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#LookupResult"><span class="hs-identifier hs-type">LookupResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484720"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-188"></span><span id="lookupInMem"><span class="annot"><span class="annottext">lookupInMem :: TransactionConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector TransactionHash
-&gt; IO (Vector (LookupResult t))
</span><a href="Chainweb.Mempool.InMem.html#lookupInMem"><span class="hs-identifier hs-var hs-var">lookupInMem</span></a></span></span><span> </span><span id="local-6989586621681484365"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484365"><span class="hs-identifier hs-var">txcfg</span></a></span></span><span> </span><span id="local-6989586621681484364"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484364"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484363"><span class="annot"><span class="annottext">txs :: Vector TransactionHash
</span><a href="#local-6989586621681484363"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621681484362"><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484362"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO PendingMap) -&gt; IO PendingMap
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484364"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef PendingMap -&gt; IO PendingMap)
-&gt; (InMemoryMempoolData t -&gt; IORef PendingMap)
-&gt; InMemoryMempoolData t
-&gt; IO PendingMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="annottext">(TransactionHash -&gt; IO (LookupResult t))
-&gt; Vector TransactionHash -&gt; IO (Vector (LookupResult t))
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Vector a -&gt; m (Vector b)
</span><span class="hs-identifier hs-var">V.mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe (LookupResult t) -&gt; LookupResult t)
-&gt; IO (Maybe (LookupResult t)) -&gt; IO (LookupResult t)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe (LookupResult t) -&gt; LookupResult t
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><a href="Chainweb.Utils.html#fromJuste"><span class="hs-identifier hs-var">fromJuste</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe (LookupResult t)) -&gt; IO (LookupResult t))
-&gt; (TransactionHash -&gt; IO (Maybe (LookupResult t)))
-&gt; TransactionHash
-&gt; IO (LookupResult t)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; TransactionHash -&gt; IO (Maybe (LookupResult t))
</span><a href="#local-6989586621681484360"><span class="hs-identifier hs-var">lookupOne</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484362"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484363"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621681484360"><span class="annot"><span class="annottext">lookupOne :: PendingMap -&gt; TransactionHash -&gt; IO (Maybe (LookupResult t))
</span><a href="#local-6989586621681484360"><span class="hs-identifier hs-var hs-var">lookupOne</span></a></span></span><span> </span><span id="local-6989586621681484359"><span class="annot"><span class="annottext">q :: PendingMap
</span><a href="#local-6989586621681484359"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621681484358"><span class="annot"><span class="annottext">txHash :: TransactionHash
</span><a href="#local-6989586621681484358"><span class="hs-identifier hs-var">txHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (LookupResult t) -&gt; IO (Maybe (LookupResult t))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (LookupResult t) -&gt; IO (Maybe (LookupResult t)))
-&gt; Maybe (LookupResult t) -&gt; IO (Maybe (LookupResult t))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap -&gt; TransactionHash -&gt; Maybe (LookupResult t)
</span><a href="#local-6989586621681484357"><span class="hs-identifier hs-var">lookupQ</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484359"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484358"><span class="hs-identifier hs-var">txHash</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (LookupResult t)
-&gt; Maybe (LookupResult t) -&gt; Maybe (LookupResult t)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">LookupResult t -&gt; Maybe (LookupResult t)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">LookupResult t
forall t. LookupResult t
</span><a href="Chainweb.Mempool.Mempool.html#Missing"><span class="hs-identifier hs-var">Missing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621681484355"><span class="annot"><span class="annottext">codec :: Codec t
</span><a href="#local-6989586621681484355"><span class="hs-identifier hs-var hs-var">codec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; Codec t
forall t. TransactionConfig t -&gt; Codec t
</span><a href="Chainweb.Mempool.Mempool.html#txCodec"><span class="hs-identifier hs-var hs-var">txCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484365"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621681484353"><span class="annot"><span class="annottext">fixup :: ShortByteString -&gt; LookupResult t
</span><a href="#local-6989586621681484353"><span class="hs-identifier hs-var hs-var">fixup</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484352"><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621681484352"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; LookupResult t)
-&gt; (t -&gt; LookupResult t) -&gt; Either String t -&gt; LookupResult t
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LookupResult t -&gt; String -&gt; LookupResult t
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">LookupResult t
forall t. LookupResult t
</span><a href="Chainweb.Mempool.Mempool.html#Missing"><span class="hs-identifier hs-var">Missing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t -&gt; LookupResult t
forall t. t -&gt; LookupResult t
</span><a href="Chainweb.Mempool.Mempool.html#Pending"><span class="hs-identifier hs-var">Pending</span></a></span><span>
</span><span id="line-195"></span><span>                    </span><span class="annot"><span class="annottext">(Either String t -&gt; LookupResult t)
-&gt; Either String t -&gt; LookupResult t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Codec t -&gt; ByteString -&gt; Either String t
forall t. Codec t -&gt; ByteString -&gt; Either String t
</span><a href="Chainweb.Utils.html#codecDecode"><span class="hs-identifier hs-var hs-var">codecDecode</span></a></span><span> </span><span class="annot"><span class="annottext">Codec t
</span><a href="#local-6989586621681484355"><span class="hs-identifier hs-var">codec</span></a></span><span>
</span><span id="line-196"></span><span>                    </span><span class="annot"><span class="annottext">(ByteString -&gt; Either String t) -&gt; ByteString -&gt; Either String t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">SB.fromShort</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621681484352"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621681484357"><span class="annot"><span class="annottext">lookupQ :: PendingMap -&gt; TransactionHash -&gt; Maybe (LookupResult t)
</span><a href="#local-6989586621681484357"><span class="hs-identifier hs-var hs-var">lookupQ</span></a></span></span><span> </span><span id="local-6989586621681484347"><span class="annot"><span class="annottext">q :: PendingMap
</span><a href="#local-6989586621681484347"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621681484346"><span class="annot"><span class="annottext">txHash :: TransactionHash
</span><a href="#local-6989586621681484346"><span class="hs-identifier hs-var">txHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; LookupResult t
</span><a href="#local-6989586621681484353"><span class="hs-identifier hs-var">fixup</span></a></span><span> </span><span class="annot"><span class="annottext">(ShortByteString -&gt; LookupResult t)
-&gt; Maybe ShortByteString -&gt; Maybe (LookupResult t)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; PendingMap -&gt; Maybe ShortByteString
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484346"><span class="hs-identifier hs-var">txHash</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484347"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-201"></span><span id="local-6989586621681484717"><span class="annot"><a href="Chainweb.Mempool.InMem.html#markValidatedInMem"><span class="hs-identifier hs-type">markValidatedInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484717"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span>
</span><span id="line-203"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-204"></span><span id="markValidatedInMem"><span class="annot"><span class="annottext">markValidatedInMem :: MVar (InMemoryMempoolData t) -&gt; Vector TransactionHash -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#markValidatedInMem"><span class="hs-identifier hs-var hs-var">markValidatedInMem</span></a></span></span><span> </span><span id="local-6989586621681484344"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484344"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484343"><span class="annot"><span class="annottext">txs :: Vector TransactionHash
</span><a href="#local-6989586621681484343"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484344"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO ()) -&gt; IO ())
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484342"><span class="annot"><span class="annottext">mdata :: InMemoryMempoolData t
</span><a href="#local-6989586621681484342"><span class="hs-identifier hs-var">mdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484341"><span class="annot"><span class="annottext">pref :: IORef PendingMap
</span><a href="#local-6989586621681484341"><span class="hs-identifier hs-var hs-var">pref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484342"><span class="hs-identifier hs-var">mdata</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; (PendingMap -&gt; PendingMap) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef PendingMap
</span><a href="#local-6989586621681484341"><span class="hs-identifier hs-var">pref</span></a></span><span> </span><span class="annot"><span class="annottext">((PendingMap -&gt; PendingMap) -&gt; IO ())
-&gt; (PendingMap -&gt; PendingMap) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484340"><span class="annot"><span class="annottext">psq :: PendingMap
</span><a href="#local-6989586621681484340"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PendingMap -&gt; TransactionHash -&gt; PendingMap)
-&gt; PendingMap -&gt; Vector TransactionHash -&gt; PendingMap
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TransactionHash -&gt; PendingMap -&gt; PendingMap)
-&gt; PendingMap -&gt; TransactionHash -&gt; PendingMap
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; PendingMap -&gt; PendingMap
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.delete</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484340"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484343"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#maxNumPending"><span class="hs-identifier hs-type">maxNumPending</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-209"></span><span id="maxNumPending"><span class="annot"><span class="annottext">maxNumPending :: ServerNonce
</span><a href="Chainweb.Mempool.InMem.html#maxNumPending"><span class="hs-identifier hs-var hs-var">maxNumPending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">10000</span></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- | Validation: A short-circuiting variant of this check that fails outright at</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- the first detection of any validation failure on any Transaction.</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#insertCheckInMem"><span class="hs-identifier hs-type">insertCheckInMem</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681484718"><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-operator">.</span><span>  </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span><span>    </span><span class="hs-comment">-- ^ in-memory config</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ in-memory state</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span><span>  </span><span class="hs-comment">-- ^ new transactions</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span id="insertCheckInMem"><span class="annot"><span class="annottext">insertCheckInMem :: InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="Chainweb.Mempool.InMem.html#insertCheckInMem"><span class="hs-identifier hs-var hs-var">insertCheckInMem</span></a></span></span><span> </span><span id="local-6989586621681484336"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484336"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484335"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484335"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484334"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484334"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484333"><span class="annot"><span class="annottext">txs :: Vector t
</span><a href="#local-6989586621681484333"><span class="hs-identifier hs-var">txs</span></a></span></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; Bool
forall a. Vector a -&gt; Bool
</span><span class="hs-identifier hs-var">V.null</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484333"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either (T2 TransactionHash InsertError) ()
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either (T2 TransactionHash InsertError) ()
 -&gt; IO (Either (T2 TransactionHash InsertError) ()))
-&gt; Either (T2 TransactionHash InsertError) ()
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either (T2 TransactionHash InsertError) ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621681484331"><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484331"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Time Micros)
forall a. Integral a =&gt; IO (Time a)
</span><a href="Chainweb.Time.html#getCurrentTimeIntegral"><span class="hs-identifier hs-var">getCurrentTimeIntegral</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621681484329"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484329"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484334"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap)
-&gt; (InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef BadMap -&gt; IO BadMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef BadMap -&gt; IO BadMap)
-&gt; (InMemoryMempoolData t -&gt; IORef BadMap)
-&gt; InMemoryMempoolData t
-&gt; IO BadMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef BadMap
forall t. InMemoryMempoolData t -&gt; IORef BadMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemBadMap"><span class="hs-identifier hs-var hs-var">_inmemBadMap</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- We hash the tx here and pass it around around to avoid needing to repeat</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- the hashing effort.</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621681484327"><span class="hs-identifier hs-type">withHashes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>        </span><span id="local-6989586621681484327"><span class="annot"><span class="annottext">withHashes :: Either
  (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
</span><a href="#local-6989586621681484327"><span class="hs-identifier hs-var hs-var">withHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector t
-&gt; (t
    -&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Either
     (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484333"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="annot"><span class="annottext">((t
  -&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
 -&gt; Either
      (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t)))
-&gt; (t
    -&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Either
     (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484326"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484326"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484325"><span class="annot"><span class="annottext">h :: TransactionHash
</span><a href="#local-6989586621681484325"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484324"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484326"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-234"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(InsertError -&gt; T2 TransactionHash InsertError)
-&gt; (t -&gt; T2 TransactionHash t)
-&gt; Either InsertError t
-&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash -&gt; InsertError -&gt; T2 TransactionHash InsertError
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484325"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash -&gt; t -&gt; T2 TransactionHash t
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484325"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either InsertError t
 -&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Either InsertError t
-&gt; Either (T2 TransactionHash InsertError) (T2 TransactionHash t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ChainwebVersion
-&gt; BadMap
-&gt; Time Micros
-&gt; t
-&gt; TransactionHash
-&gt; Either InsertError t
forall t a.
InMemConfig t
-&gt; ChainwebVersion
-&gt; HashMap TransactionHash a
-&gt; Time Micros
-&gt; t
-&gt; TransactionHash
-&gt; Either InsertError t
</span><a href="Chainweb.Mempool.InMem.html#validateOne"><span class="hs-identifier hs-var">validateOne</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484336"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484335"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484329"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484331"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484326"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484325"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
</span><a href="#local-6989586621681484327"><span class="hs-identifier hs-var">withHashes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (T2 TransactionHash InsertError) ()
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either (T2 TransactionHash InsertError) ()
 -&gt; IO (Either (T2 TransactionHash InsertError) ()))
-&gt; Either (T2 TransactionHash InsertError) ()
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Either
  (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
-&gt; Either (T2 TransactionHash InsertError) ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">Either
  (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
</span><a href="#local-6989586621681484327"><span class="hs-identifier hs-var">withHashes</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681484321"><span class="annot"><span class="annottext">r :: Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484321"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either
  (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
-&gt; Either (T2 TransactionHash InsertError) ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Either
   (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
 -&gt; Either (T2 TransactionHash InsertError) ())
-&gt; (Vector
      (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
    -&gt; Either
         (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t)))
-&gt; Vector
     (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Either (T2 TransactionHash InsertError) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Vector
  (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Either
     (T2 TransactionHash InsertError) (Vector (T2 TransactionHash t))
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Traversable t, Applicative f) =&gt;
t (f a) -&gt; f (t a)
</span><span class="hs-identifier hs-var">sequenceA</span></span><span> </span><span class="annot"><span class="annottext">(Vector
   (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
 -&gt; Either (T2 TransactionHash InsertError) ())
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; Vector (T2 TransactionHash t)
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
forall t.
InMemConfig t
-&gt; Vector (T2 TransactionHash t)
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPreInsertBatchChecks"><span class="hs-identifier hs-var hs-var">_inmemPreInsertBatchChecks</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484336"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484321"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><a href="#local-6989586621681484324"><span class="hs-identifier hs-type">hasher</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621681484718"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621681484324"><span class="annot"><span class="annottext">hasher :: t -&gt; TransactionHash
</span><a href="#local-6989586621681484324"><span class="hs-identifier hs-var hs-var">hasher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionHash
forall t. TransactionConfig t -&gt; t -&gt; TransactionHash
</span><a href="Chainweb.Mempool.Mempool.html#txHasher"><span class="hs-identifier hs-var hs-var">txHasher</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemConfig t -&gt; TransactionConfig t
forall t. InMemConfig t -&gt; TransactionConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxCfg"><span class="hs-identifier hs-var hs-var">_inmemTxCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484336"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- | Validation: Confirm the validity of some single transaction @t@.</span><span>
</span><span id="line-244"></span><span class="hs-comment">--</span><span>
</span><span id="line-245"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#validateOne"><span class="hs-identifier hs-type">validateOne</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681484615"><span class="annot"><a href="#local-6989586621681484615"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621681484614"><span class="annot"><a href="#local-6989586621681484614"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-operator">.</span><span>  </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484615"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484614"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Time.html#Time"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span class="annot"><a href="Chainweb.Time.html#Micros"><span class="hs-identifier hs-type">Micros</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681484615"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484615"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-254"></span><span id="validateOne"><span class="annot"><span class="annottext">validateOne :: InMemConfig t
-&gt; ChainwebVersion
-&gt; HashMap TransactionHash a
-&gt; Time Micros
-&gt; t
-&gt; TransactionHash
-&gt; Either InsertError t
</span><a href="Chainweb.Mempool.InMem.html#validateOne"><span class="hs-identifier hs-var hs-var">validateOne</span></a></span></span><span> </span><span id="local-6989586621681484316"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484316"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484315"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484315"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484314"><span class="annot"><span class="annottext">badmap :: HashMap TransactionHash a
</span><a href="#local-6989586621681484314"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#Time"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#TimeSpan"><span class="hs-identifier hs-type">TimeSpan</span></a></span><span> </span><span id="local-6989586621681484311"><span class="annot"><span class="annottext">now :: Micros
</span><a href="#local-6989586621681484311"><span class="hs-identifier hs-var">now</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681484310"><span class="annot"><span class="annottext">t :: t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681484309"><span class="annot"><span class="annottext">h :: TransactionHash
</span><a href="#local-6989586621681484309"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
</span><a href="#local-6989586621681484308"><span class="hs-identifier hs-var">transactionsEnabled</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; Either InsertError () -&gt; Either InsertError ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either InsertError ()
</span><a href="#local-6989586621681484307"><span class="hs-identifier hs-var">sizeOK</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; Either InsertError () -&gt; Either InsertError ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either InsertError ()
</span><a href="#local-6989586621681484306"><span class="hs-identifier hs-var">gasPriceRoundingCheck</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; Either InsertError () -&gt; Either InsertError ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either InsertError ()
</span><a href="#local-6989586621681484305"><span class="hs-identifier hs-var">ttlCheck</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; Either InsertError () -&gt; Either InsertError ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either InsertError ()
</span><a href="#local-6989586621681484304"><span class="hs-identifier hs-var">notInBadMap</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; Either InsertError t -&gt; Either InsertError t
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; t -&gt; Either InsertError t
forall t. InMemConfig t -&gt; t -&gt; Either InsertError t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPreInsertPureChecks"><span class="hs-identifier hs-var hs-var">_inmemPreInsertPureChecks</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484316"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><a href="#local-6989586621681484302"><span class="hs-identifier hs-type">txcfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionConfig"><span class="hs-identifier hs-type">TransactionConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484615"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621681484302"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484302"><span class="hs-identifier hs-var hs-var">txcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; TransactionConfig t
forall t. InMemConfig t -&gt; TransactionConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxCfg"><span class="hs-identifier hs-var hs-var">_inmemTxCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484316"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- | KILLSWITCH: This is to be removed in a future version of Chainweb. This</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- prevents any transaction from entering the mempool.</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><a href="#local-6989586621681484308"><span class="hs-identifier hs-type">transactionsEnabled</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621681484308"><span class="annot"><span class="annottext">transactionsEnabled :: Either InsertError ()
</span><a href="#local-6989586621681484308"><span class="hs-identifier hs-var hs-var">transactionsEnabled</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; Maybe (Time Micros)
</span><a href="Chainweb.Version.html#txSilenceEndDate"><span class="hs-identifier hs-var">txSilenceEndDate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484315"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InsertError -&gt; Either InsertError ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">InsertError
</span><a href="Chainweb.Mempool.Mempool.html#InsertErrorTransactionsDisabled"><span class="hs-identifier hs-var">InsertErrorTransactionsDisabled</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either InsertError ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="#local-6989586621681484307"><span class="hs-identifier hs-type">sizeOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621681484307"><span class="annot"><span class="annottext">sizeOK :: Either InsertError ()
</span><a href="#local-6989586621681484307"><span class="hs-identifier hs-var hs-var">sizeOK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsertError -&gt; Bool -&gt; Either InsertError ()
forall e. e -&gt; Bool -&gt; Either e ()
</span><a href="Chainweb.Utils.html#ebool_"><span class="hs-identifier hs-var">ebool_</span></a></span><span> </span><span class="annot"><span class="annottext">InsertError
</span><a href="Chainweb.Mempool.Mempool.html#InsertErrorOversized"><span class="hs-identifier hs-var">InsertErrorOversized</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; GasLimit
</span><a href="#local-6989586621681484298"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484296"><span class="hs-identifier hs-var">maxSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-276"></span><span>        </span><span id="local-6989586621681484298"><span class="annot"><span class="annottext">getSize :: t -&gt; GasLimit
</span><a href="#local-6989586621681484298"><span class="hs-identifier hs-var hs-var">getSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; GasLimit
forall t. TransactionConfig t -&gt; t -&gt; GasLimit
</span><a href="Chainweb.Mempool.Mempool.html#txGasLimit"><span class="hs-identifier hs-var hs-var">txGasLimit</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484302"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span id="local-6989586621681484296"><span class="annot"><span class="annottext">maxSize :: GasLimit
</span><a href="#local-6989586621681484296"><span class="hs-identifier hs-var hs-var">maxSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; GasLimit
forall t. InMemConfig t -&gt; GasLimit
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxBlockSizeLimit"><span class="hs-identifier hs-var hs-var">_inmemTxBlockSizeLimit</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484316"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- prop_tx_gas_rounding</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><a href="#local-6989586621681484306"><span class="hs-identifier hs-type">gasPriceRoundingCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621681484306"><span class="annot"><span class="annottext">gasPriceRoundingCheck :: Either InsertError ()
</span><a href="#local-6989586621681484306"><span class="hs-identifier hs-var hs-var">gasPriceRoundingCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">InsertError -&gt; Bool -&gt; Either InsertError ()
forall e. e -&gt; Bool -&gt; Either e ()
</span><a href="Chainweb.Utils.html#ebool_"><span class="hs-identifier hs-var">ebool_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; InsertError
</span><a href="Chainweb.Mempool.Mempool.html#InsertErrorOther"><span class="hs-identifier hs-var">InsertErrorOther</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681484292"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GasPrice -&gt; Bool
</span><a href="#local-6989586621681484291"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; GasPrice
forall t. TransactionConfig t -&gt; t -&gt; GasPrice
</span><a href="Chainweb.Mempool.Mempool.html#txGasPrice"><span class="hs-identifier hs-var hs-var">txGasPrice</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484302"><span class="hs-identifier hs-var">txcfg</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621681484291"><span class="annot"><span class="annottext">f :: GasPrice -&gt; Bool
</span><a href="#local-6989586621681484291"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GasPrice</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ParsedDecimal</span></span><span> </span><span id="local-6989586621681484288"><span class="annot"><span class="annottext">d :: Decimal
</span><a href="#local-6989586621681484288"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Decimal -&gt; Word8
forall i. DecimalRaw i -&gt; Word8
</span><span class="hs-identifier hs-var hs-var">decimalPlaces</span></span><span> </span><span class="annot"><span class="annottext">Decimal
</span><a href="#local-6989586621681484288"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">12</span></span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621681484292"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621681484292"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-286"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;This  transaction's gas price: &quot;</span></span><span>
</span><span id="line-287"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GasPrice -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; GasPrice
forall t. TransactionConfig t -&gt; t -&gt; GasPrice
</span><a href="Chainweb.Mempool.Mempool.html#txGasPrice"><span class="hs-identifier hs-var hs-var">txGasPrice</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484302"><span class="hs-identifier hs-var">txcfg</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot; is not correctly rounded.&quot;</span></span><span>
</span><span id="line-289"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;It should be rounded to at most 12 decimal places.&quot;</span></span><span>
</span><span id="line-290"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-comment">-- prop_tx_ttl_arrival</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><a href="#local-6989586621681484305"><span class="hs-identifier hs-type">ttlCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621681484305"><span class="annot"><span class="annottext">ttlCheck :: Either InsertError ()
</span><a href="#local-6989586621681484305"><span class="hs-identifier hs-var hs-var">ttlCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InsertError -&gt; Bool -&gt; Either InsertError ()
forall e. e -&gt; Bool -&gt; Either e ()
</span><a href="Chainweb.Utils.html#ebool_"><span class="hs-identifier hs-var">ebool_</span></a></span><span> </span><span class="annot"><span class="annottext">InsertError
</span><a href="Chainweb.Mempool.Mempool.html#InsertErrorInvalidTime"><span class="hs-identifier hs-var">InsertErrorInvalidTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484284"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">Micros -&gt; Micros -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484311"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484311"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Micros -&gt; Micros -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484281"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484284"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">Micros -&gt; Micros -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Micros
</span><a href="#local-6989586621681484281"><span class="hs-identifier hs-var">et</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionMetadata"><span class="hs-identifier hs-type">TransactionMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#Time"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#TimeSpan"><span class="hs-identifier hs-type">TimeSpan</span></a></span><span> </span><span id="local-6989586621681484284"><span class="annot"><span class="annottext">ct :: Micros
</span><a href="#local-6989586621681484284"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#Time"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Time.html#TimeSpan"><span class="hs-identifier hs-type">TimeSpan</span></a></span><span> </span><span id="local-6989586621681484281"><span class="annot"><span class="annottext">et :: Micros
</span><a href="#local-6989586621681484281"><span class="hs-identifier hs-var">et</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionMetadata
forall t. TransactionConfig t -&gt; t -&gt; TransactionMetadata
</span><a href="Chainweb.Mempool.Mempool.html#txMetadata"><span class="hs-identifier hs-var hs-var">txMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484302"><span class="hs-identifier hs-var">txcfg</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484310"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><a href="#local-6989586621681484304"><span class="hs-identifier hs-type">notInBadMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621681484304"><span class="annot"><span class="annottext">notInBadMap :: Either InsertError ()
</span><a href="#local-6989586621681484304"><span class="hs-identifier hs-var hs-var">notInBadMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either InsertError ()
-&gt; (a -&gt; Either InsertError ()) -&gt; Maybe a -&gt; Either InsertError ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Either InsertError ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either InsertError () -&gt; a -&gt; Either InsertError ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Either InsertError () -&gt; a -&gt; Either InsertError ())
-&gt; Either InsertError () -&gt; a -&gt; Either InsertError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InsertError -&gt; Either InsertError ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">InsertError
</span><a href="Chainweb.Mempool.Mempool.html#InsertErrorBadlisted"><span class="hs-identifier hs-var">InsertErrorBadlisted</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; Either InsertError ())
-&gt; Maybe a -&gt; Either InsertError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; HashMap TransactionHash a -&gt; Maybe a
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484309"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash a
</span><a href="#local-6989586621681484314"><span class="hs-identifier hs-var">badmap</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | Validation: Similar to `insertCheckInMem`, but does not short circuit.</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- Instead, bad transactions are filtered out and the successful ones are kept.</span><span>
</span><span id="line-304"></span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#insertCheckInMem%27"><span class="hs-identifier hs-type">insertCheckInMem'</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681484572"><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-operator">.</span><span>  </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span><span>    </span><span class="hs-comment">-- ^ in-memory config</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ in-memory state</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span><span>  </span><span class="hs-comment">-- ^ new transactions</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span id="insertCheckInMem%27"><span class="annot"><span class="annottext">insertCheckInMem' :: InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Vector (T2 TransactionHash t))
</span><a href="Chainweb.Mempool.InMem.html#insertCheckInMem%27"><span class="hs-identifier hs-var hs-var">insertCheckInMem'</span></a></span></span><span> </span><span id="local-6989586621681484275"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484275"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484274"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484274"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484273"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484273"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484272"><span class="annot"><span class="annottext">txs :: Vector t
</span><a href="#local-6989586621681484272"><span class="hs-identifier hs-var">txs</span></a></span></span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; Bool
forall a. Vector a -&gt; Bool
</span><span class="hs-identifier hs-var">V.null</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484272"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t) -&gt; IO (Vector (T2 TransactionHash t))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
forall a. Vector a
</span><span class="hs-identifier hs-var">V.empty</span></span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621681484270"><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484270"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Time Micros)
forall a. Integral a =&gt; IO (Time a)
</span><a href="Chainweb.Time.html#getCurrentTimeIntegral"><span class="hs-identifier hs-var">getCurrentTimeIntegral</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621681484269"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484269"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484273"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap)
-&gt; (InMemoryMempoolData t -&gt; IO BadMap) -&gt; IO BadMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef BadMap -&gt; IO BadMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef BadMap -&gt; IO BadMap)
-&gt; (InMemoryMempoolData t -&gt; IORef BadMap)
-&gt; InMemoryMempoolData t
-&gt; IO BadMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef BadMap
forall t. InMemoryMempoolData t -&gt; IORef BadMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemBadMap"><span class="hs-identifier hs-var hs-var">_inmemBadMap</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621681484268"><span class="hs-identifier hs-type">withHashes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484572"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>        </span><span id="local-6989586621681484268"><span class="annot"><span class="annottext">withHashes :: Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484268"><span class="hs-identifier hs-var hs-var">withHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((t -&gt; Maybe (T2 TransactionHash t))
 -&gt; Vector t -&gt; Vector (T2 TransactionHash t))
-&gt; Vector t
-&gt; (t -&gt; Maybe (T2 TransactionHash t))
-&gt; Vector (T2 TransactionHash t)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(t -&gt; Maybe (T2 TransactionHash t))
-&gt; Vector t -&gt; Vector (T2 TransactionHash t)
forall a b. (a -&gt; Maybe b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484272"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="annot"><span class="annottext">((t -&gt; Maybe (T2 TransactionHash t))
 -&gt; Vector (T2 TransactionHash t))
-&gt; (t -&gt; Maybe (T2 TransactionHash t))
-&gt; Vector (T2 TransactionHash t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484266"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484266"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484265"><span class="annot"><span class="annottext">h :: TransactionHash
</span><a href="#local-6989586621681484265"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484264"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484266"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash -&gt; t -&gt; T2 TransactionHash t
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484265"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(t -&gt; T2 TransactionHash t)
-&gt; Maybe t -&gt; Maybe (T2 TransactionHash t)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either InsertError t -&gt; Maybe t
forall a b. Either a b -&gt; Maybe b
</span><span class="hs-identifier hs-var">hush</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ChainwebVersion
-&gt; BadMap
-&gt; Time Micros
-&gt; t
-&gt; TransactionHash
-&gt; Either InsertError t
forall t a.
InMemConfig t
-&gt; ChainwebVersion
-&gt; HashMap TransactionHash a
-&gt; Time Micros
-&gt; t
-&gt; TransactionHash
-&gt; Either InsertError t
</span><a href="Chainweb.Mempool.InMem.html#validateOne"><span class="hs-identifier hs-var">validateOne</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484275"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484274"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484269"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484270"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484266"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484265"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><span class="annottext">(Either (T2 TransactionHash InsertError) (T2 TransactionHash t)
 -&gt; Maybe (T2 TransactionHash t))
-&gt; Vector
     (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
-&gt; Vector (T2 TransactionHash t)
forall a b. (a -&gt; Maybe b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Either (T2 TransactionHash InsertError) (T2 TransactionHash t)
-&gt; Maybe (T2 TransactionHash t)
forall a b. Either a b -&gt; Maybe b
</span><span class="hs-identifier hs-var">hush</span></span><span> </span><span class="annot"><span class="annottext">(Vector
   (Either (T2 TransactionHash InsertError) (T2 TransactionHash t))
 -&gt; Vector (T2 TransactionHash t))
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
-&gt; IO (Vector (T2 TransactionHash t))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; Vector (T2 TransactionHash t)
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
forall t.
InMemConfig t
-&gt; Vector (T2 TransactionHash t)
-&gt; IO
     (Vector
        (Either (T2 TransactionHash InsertError) (T2 TransactionHash t)))
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPreInsertBatchChecks"><span class="hs-identifier hs-var hs-var">_inmemPreInsertBatchChecks</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484275"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484268"><span class="hs-identifier hs-var">withHashes</span></a></span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621681484262"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484262"><span class="hs-identifier hs-var hs-var">txcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; TransactionConfig t
forall t. InMemConfig t -&gt; TransactionConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxCfg"><span class="hs-identifier hs-var hs-var">_inmemTxCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484275"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621681484264"><span class="annot"><span class="annottext">hasher :: t -&gt; TransactionHash
</span><a href="#local-6989586621681484264"><span class="hs-identifier hs-var hs-var">hasher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionHash
forall t. TransactionConfig t -&gt; t -&gt; TransactionHash
</span><a href="Chainweb.Mempool.Mempool.html#txHasher"><span class="hs-identifier hs-var hs-var">txHasher</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484262"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#insertInMem"><span class="hs-identifier hs-type">insertInMem</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681484719"><span class="annot"><a href="#local-6989586621681484719"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-operator">.</span><span>  </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484719"><span class="hs-identifier hs-type">t</span></a></span><span>    </span><span class="hs-comment">-- ^ in-memory config</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484719"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ in-memory state</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertType"><span class="hs-identifier hs-type">InsertType</span></a></span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484719"><span class="hs-identifier hs-type">t</span></a></span><span>  </span><span class="hs-comment">-- ^ new transactions</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span id="insertInMem"><span class="annot"><span class="annottext">insertInMem :: InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; InsertType
-&gt; Vector t
-&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#insertInMem"><span class="hs-identifier hs-var hs-var">insertInMem</span></a></span></span><span> </span><span id="local-6989586621681484261"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484261"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484260"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681484260"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681484259"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484259"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484258"><span class="annot"><span class="annottext">runCheck :: InsertType
</span><a href="#local-6989586621681484258"><span class="hs-identifier hs-var">runCheck</span></a></span></span><span> </span><span id="local-6989586621681484257"><span class="annot"><span class="annottext">txs0 :: Vector t
</span><a href="#local-6989586621681484257"><span class="hs-identifier hs-var">txs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621681484256"><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484256"><span class="hs-identifier hs-var">txhashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Vector (T2 TransactionHash t))
</span><a href="#local-6989586621681484255"><span class="hs-identifier hs-var">insertCheck</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484259"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO ()) -&gt; IO ())
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484254"><span class="annot"><span class="annottext">mdata :: InMemoryMempoolData t
</span><a href="#local-6989586621681484254"><span class="hs-identifier hs-var">mdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484253"><span class="annot"><span class="annottext">countRef :: IORef ServerNonce
</span><a href="#local-6989586621681484253"><span class="hs-identifier hs-var hs-var">countRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef ServerNonce
forall t. InMemoryMempoolData t -&gt; IORef ServerNonce
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemCountPending"><span class="hs-identifier hs-var hs-var">_inmemCountPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484254"><span class="hs-identifier hs-var">mdata</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span id="local-6989586621681484251"><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484251"><span class="hs-identifier hs-var">cnt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef ServerNonce -&gt; IO ServerNonce
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ServerNonce
</span><a href="#local-6989586621681484253"><span class="hs-identifier hs-var">countRef</span></a></span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484250"><span class="annot"><span class="annottext">txs :: Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484250"><span class="hs-identifier hs-var hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerNonce
-&gt; Vector (T2 TransactionHash t) -&gt; Vector (T2 TransactionHash t)
forall a. ServerNonce -&gt; Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerNonce
</span><a href="Chainweb.Mempool.InMem.html#maxNumPending"><span class="hs-identifier hs-var">maxNumPending</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484251"><span class="hs-identifier hs-var">cnt</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484256"><span class="hs-identifier hs-var">txhashes</span></a></span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484247"><span class="annot"><span class="annottext">numTxs :: ServerNonce
</span><a href="#local-6989586621681484247"><span class="hs-identifier hs-var hs-var">numTxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t) -&gt; ServerNonce
forall a. Vector a -&gt; ServerNonce
</span><span class="hs-identifier hs-var">V.length</span></span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484250"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484245"><span class="annot"><span class="annottext">newCnt :: ServerNonce
</span><a href="#local-6989586621681484245"><span class="hs-identifier hs-var hs-var">newCnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484251"><span class="hs-identifier hs-var">cnt</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484247"><span class="hs-identifier hs-var">numTxs</span></a></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">IORef ServerNonce -&gt; ServerNonce -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ServerNonce
</span><a href="#local-6989586621681484253"><span class="hs-identifier hs-var">countRef</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerNonce -&gt; IO ()) -&gt; ServerNonce -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484245"><span class="hs-identifier hs-var">newCnt</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span id="local-6989586621681484243"><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484243"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484254"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681484242"><span class="annot"><span class="annottext">pending' :: PendingMap
</span><a href="#local-6989586621681484242"><span class="hs-identifier hs-var">pending'</span></a></span></span><span> </span><span id="local-6989586621681484241"><span class="annot"><span class="annottext">newHashesDL :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484241"><span class="hs-identifier hs-var">newHashesDL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
 -&gt; T2 TransactionHash t
 -&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash]))
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
-&gt; Vector (T2 TransactionHash t)
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="annot"><span class="annottext">T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
-&gt; T2 TransactionHash t
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
</span><a href="#local-6989586621681484239"><span class="hs-identifier hs-var">insOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap
-&gt; ([TransactionHash] -&gt; [TransactionHash])
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484243"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t)
</span><a href="#local-6989586621681484250"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484237"><span class="annot"><span class="annottext">newHashes :: Vector TransactionHash
</span><a href="#local-6989586621681484237"><span class="hs-identifier hs-var hs-var">newHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; Vector TransactionHash
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; Vector TransactionHash)
-&gt; [TransactionHash] -&gt; Vector TransactionHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484241"><span class="hs-identifier hs-var">newHashesDL</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; PendingMap -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484254"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PendingMap -&gt; IO ()) -&gt; PendingMap -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; PendingMap
forall a. NFData a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">force</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484242"><span class="hs-identifier hs-var">pending'</span></a></span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">IORef RecentLog -&gt; (RecentLog -&gt; RecentLog) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef RecentLog
forall t. InMemoryMempoolData t -&gt; IORef RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemRecentLog"><span class="hs-identifier hs-var hs-var">_inmemRecentLog</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484254"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecentLog -&gt; RecentLog) -&gt; IO ())
-&gt; (RecentLog -&gt; RecentLog) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-350"></span><span>            </span><span class="annot"><span class="annottext">ServerNonce -&gt; Vector TransactionHash -&gt; RecentLog -&gt; RecentLog
</span><a href="Chainweb.Mempool.InMem.html#recordRecentTransactions"><span class="hs-identifier hs-var">recordRecentTransactions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484232"><span class="hs-identifier hs-var">maxRecent</span></a></span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484237"><span class="hs-identifier hs-var">newHashes</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><a href="#local-6989586621681484255"><span class="hs-identifier hs-type">insertCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484719"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621681484255"><span class="annot"><span class="annottext">insertCheck :: IO (Vector (T2 TransactionHash t))
</span><a href="#local-6989586621681484255"><span class="hs-identifier hs-var hs-var">insertCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">InsertType
</span><a href="#local-6989586621681484258"><span class="hs-identifier hs-var">runCheck</span></a></span><span> </span><span class="annot"><span class="annottext">InsertType -&gt; InsertType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">InsertType
</span><a href="Chainweb.Mempool.Mempool.html#CheckedInsert"><span class="hs-identifier hs-var">CheckedInsert</span></a></span><span>
</span><span id="line-355"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Vector (T2 TransactionHash t))
forall t.
InMemConfig t
-&gt; ChainwebVersion
-&gt; MVar (InMemoryMempoolData t)
-&gt; Vector t
-&gt; IO (Vector (T2 TransactionHash t))
</span><a href="Chainweb.Mempool.InMem.html#insertCheckInMem%27"><span class="hs-identifier hs-var">insertCheckInMem'</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484261"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681484260"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484259"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484257"><span class="hs-identifier hs-var">txs0</span></a></span><span>
</span><span id="line-356"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Vector (T2 TransactionHash t) -&gt; IO (Vector (T2 TransactionHash t))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Vector (T2 TransactionHash t)
 -&gt; IO (Vector (T2 TransactionHash t)))
-&gt; Vector (T2 TransactionHash t)
-&gt; IO (Vector (T2 TransactionHash t))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(t -&gt; T2 TransactionHash t)
-&gt; Vector t -&gt; Vector (T2 TransactionHash t)
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681484229"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484229"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; t -&gt; T2 TransactionHash t
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484228"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484229"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484229"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484257"><span class="hs-identifier hs-var">txs0</span></a></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span>    </span><span id="local-6989586621681484227"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484227"><span class="hs-identifier hs-var hs-var">txcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; TransactionConfig t
forall t. InMemConfig t -&gt; TransactionConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxCfg"><span class="hs-identifier hs-var hs-var">_inmemTxCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484261"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621681484226"><span class="annot"><span class="annottext">encodeTx :: t -&gt; ByteString
</span><a href="#local-6989586621681484226"><span class="hs-identifier hs-var hs-var">encodeTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec t -&gt; t -&gt; ByteString
forall t. Codec t -&gt; t -&gt; ByteString
</span><a href="Chainweb.Utils.html#codecEncode"><span class="hs-identifier hs-var hs-var">codecEncode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionConfig t -&gt; Codec t
forall t. TransactionConfig t -&gt; Codec t
</span><a href="Chainweb.Mempool.Mempool.html#txCodec"><span class="hs-identifier hs-var hs-var">txCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484227"><span class="hs-identifier hs-var">txcfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621681484232"><span class="annot"><span class="annottext">maxRecent :: ServerNonce
</span><a href="#local-6989586621681484232"><span class="hs-identifier hs-var hs-var">maxRecent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; ServerNonce
forall t. InMemConfig t -&gt; ServerNonce
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemMaxRecentItems"><span class="hs-identifier hs-var hs-var">_inmemMaxRecentItems</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484261"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621681484228"><span class="annot"><span class="annottext">hasher :: t -&gt; TransactionHash
</span><a href="#local-6989586621681484228"><span class="hs-identifier hs-var hs-var">hasher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionHash
forall t. TransactionConfig t -&gt; t -&gt; TransactionHash
</span><a href="Chainweb.Mempool.Mempool.html#txHasher"><span class="hs-identifier hs-var hs-var">txHasher</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484227"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621681484239"><span class="annot"><span class="annottext">insOne :: T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
-&gt; T2 TransactionHash t
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
</span><a href="#local-6989586621681484239"><span class="hs-identifier hs-var hs-var">insOne</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681484223"><span class="annot"><span class="annottext">pending :: PendingMap
</span><a href="#local-6989586621681484223"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span id="local-6989586621681484222"><span class="annot"><span class="annottext">soFar :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484222"><span class="hs-identifier hs-var">soFar</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681484221"><span class="annot"><span class="annottext">txhash :: TransactionHash
</span><a href="#local-6989586621681484221"><span class="hs-identifier hs-var">txhash</span></a></span></span><span> </span><span id="local-6989586621681484220"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484220"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484219"><span class="annot"><span class="annottext">bytes :: ShortByteString
</span><a href="#local-6989586621681484219"><span class="hs-identifier hs-var hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ShortByteString
</span><span class="hs-identifier hs-var">SB.toShort</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ShortByteString) -&gt; ByteString -&gt; ShortByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; ByteString
</span><a href="#local-6989586621681484226"><span class="hs-identifier hs-var">encodeTx</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484220"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PendingMap
-&gt; ([TransactionHash] -&gt; [TransactionHash])
-&gt; T2 PendingMap ([TransactionHash] -&gt; [TransactionHash])
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash -&gt; ShortByteString -&gt; PendingMap -&gt; PendingMap
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484221"><span class="hs-identifier hs-var">txhash</span></a></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621681484219"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484223"><span class="hs-identifier hs-var">pending</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484222"><span class="hs-identifier hs-var">soFar</span></a></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash])
-&gt; ([TransactionHash] -&gt; [TransactionHash])
-&gt; [TransactionHash]
-&gt; [TransactionHash]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484221"><span class="hs-identifier hs-var">txhash</span></a></span><span class="annot"><span class="annottext">TransactionHash -&gt; [TransactionHash] -&gt; [TransactionHash]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-369"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#getBlockInMem"><span class="hs-identifier hs-type">getBlockInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681484716"><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span class="hs-operator">.</span><span>
</span><span id="line-370"></span><span>                 </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-371"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolPreBlockCheck"><span class="hs-identifier hs-type">MempoolPreBlockCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span>
</span><span id="line-374"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span>
</span><span id="line-375"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GasLimit</span></span><span>
</span><span id="line-376"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span id="getBlockInMem"><span class="annot"><span class="annottext">getBlockInMem :: InMemConfig t
-&gt; MVar (InMemoryMempoolData t)
-&gt; MempoolPreBlockCheck t
-&gt; BlockHeight
-&gt; BlockHash
-&gt; GasLimit
-&gt; IO (Vector t)
</span><a href="Chainweb.Mempool.InMem.html#getBlockInMem"><span class="hs-identifier hs-var hs-var">getBlockInMem</span></a></span></span><span> </span><span id="local-6989586621681484216"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484216"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484215"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484215"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484214"><span class="annot"><span class="annottext">txValidate :: MempoolPreBlockCheck t
</span><a href="#local-6989586621681484214"><span class="hs-identifier hs-var">txValidate</span></a></span></span><span> </span><span id="local-6989586621681484213"><span class="annot"><span class="annottext">bheight :: BlockHeight
</span><a href="#local-6989586621681484213"><span class="hs-identifier hs-var">bheight</span></a></span></span><span> </span><span id="local-6989586621681484212"><span class="annot"><span class="annottext">phash :: BlockHash
</span><a href="#local-6989586621681484212"><span class="hs-identifier hs-var">phash</span></a></span></span><span> </span><span id="local-6989586621681484211"><span class="annot"><span class="annottext">size0 :: GasLimit
</span><a href="#local-6989586621681484211"><span class="hs-identifier hs-var">size0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO (Vector t)) -&gt; IO (Vector t)
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484215"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO (Vector t)) -&gt; IO (Vector t))
-&gt; (InMemoryMempoolData t -&gt; IO (Vector t)) -&gt; IO (Vector t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484210"><span class="annot"><span class="annottext">mdata :: InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681484209"><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484209"><span class="hs-identifier hs-var">psq0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef PendingMap -&gt; IO PendingMap)
-&gt; IORef PendingMap -&gt; IO PendingMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621681484208"><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484208"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Time Micros)
forall a. Integral a =&gt; IO (Time a)
</span><a href="Chainweb.Time.html#getCurrentTimeIntegral"><span class="hs-identifier hs-var">getCurrentTimeIntegral</span></a></span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681484207"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484207"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Time Micros -&gt; BadMap -&gt; BadMap
forall a k. Ord a =&gt; a -&gt; HashMap k a -&gt; HashMap k a
</span><a href="#local-6989586621681484206"><span class="hs-identifier hs-var">pruneBadMap</span></a></span><span> </span><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484208"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">(BadMap -&gt; BadMap) -&gt; IO BadMap -&gt; IO BadMap
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef BadMap -&gt; IO BadMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef BadMap
forall t. InMemoryMempoolData t -&gt; IORef BadMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemBadMap"><span class="hs-identifier hs-var hs-var">_inmemBadMap</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484205"><span class="annot"><span class="annottext">psq :: HashMap TransactionHash t
</span><a href="#local-6989586621681484205"><span class="hs-identifier hs-var hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ShortByteString -&gt; t) -&gt; PendingMap -&gt; HashMap TransactionHash t
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">HashMap.map</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; t
</span><a href="#local-6989586621681484203"><span class="hs-identifier hs-var">decodeTx</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484209"><span class="hs-identifier hs-var">psq0</span></a></span><span>
</span><span id="line-383"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">T3</span></span><span> </span><span id="local-6989586621681484201"><span class="annot"><span class="annottext">psq' :: HashMap TransactionHash t
</span><a href="#local-6989586621681484201"><span class="hs-identifier hs-var">psq'</span></a></span></span><span> </span><span id="local-6989586621681484200"><span class="annot"><span class="annottext">badmap' :: BadMap
</span><a href="#local-6989586621681484200"><span class="hs-identifier hs-var">badmap'</span></a></span></span><span> </span><span id="local-6989586621681484199"><span class="annot"><span class="annottext">out :: Vector t
</span><a href="#local-6989586621681484199"><span class="hs-identifier hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
-&gt; BadMap
-&gt; GasLimit
-&gt; [Vector t]
-&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t))
</span><a href="#local-6989586621681484198"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484205"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484207"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484211"><span class="hs-identifier hs-var">size0</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-comment">-- put the txs chosen for the block back into the map -- they don't get</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- expunged until they are mined and validated by consensus.</span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484197"><span class="annot"><span class="annottext">psq'' :: PendingMap
</span><a href="#local-6989586621681484197"><span class="hs-identifier hs-var hs-var">psq''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(t -&gt; ShortByteString) -&gt; HashMap TransactionHash t -&gt; PendingMap
forall v1 v2 k. (v1 -&gt; v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><span class="hs-identifier hs-var">HashMap.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ShortByteString
</span><span class="hs-identifier hs-var">SB.toShort</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ShortByteString)
-&gt; (t -&gt; ByteString) -&gt; t -&gt; ShortByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; ByteString
</span><a href="#local-6989586621681484196"><span class="hs-identifier hs-var">encodeTx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HashMap TransactionHash t -&gt; PendingMap)
-&gt; HashMap TransactionHash t -&gt; PendingMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t)
-&gt; HashMap TransactionHash t
-&gt; Vector t
-&gt; HashMap TransactionHash t
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t
</span><a href="#local-6989586621681484195"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484201"><span class="hs-identifier hs-var">psq'</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484199"><span class="hs-identifier hs-var">out</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; PendingMap -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PendingMap -&gt; IO ()) -&gt; PendingMap -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; PendingMap
forall a. NFData a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">force</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484197"><span class="hs-identifier hs-var">psq''</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">IORef ServerNonce -&gt; ServerNonce -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef ServerNonce
forall t. InMemoryMempoolData t -&gt; IORef ServerNonce
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemCountPending"><span class="hs-identifier hs-var hs-var">_inmemCountPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerNonce -&gt; IO ()) -&gt; ServerNonce -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; ServerNonce
forall k v. HashMap k v -&gt; ServerNonce
</span><span class="hs-identifier hs-var">HashMap.size</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484197"><span class="hs-identifier hs-var">psq''</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">IORef BadMap -&gt; BadMap -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef BadMap
forall t. InMemoryMempoolData t -&gt; IORef BadMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemBadMap"><span class="hs-identifier hs-var hs-var">_inmemBadMap</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484210"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BadMap -&gt; IO ()) -&gt; BadMap -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">BadMap -&gt; BadMap
forall a. NFData a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">force</span></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484200"><span class="hs-identifier hs-var">badmap'</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">Vector t -&gt; IO (Vector t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Vector t -&gt; IO (Vector t)) -&gt; Vector t -&gt; IO (Vector t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484199"><span class="hs-identifier hs-var">out</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621681484206"><span class="annot"><span class="annottext">pruneBadMap :: a -&gt; HashMap k a -&gt; HashMap k a
</span><a href="#local-6989586621681484206"><span class="hs-identifier hs-var hs-var">pruneBadMap</span></a></span></span><span> </span><span id="local-6989586621681484193"><span class="annot"><span class="annottext">now :: a
</span><a href="#local-6989586621681484193"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Bool) -&gt; HashMap k a -&gt; HashMap k a
forall v k. (v -&gt; Bool) -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681484193"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621681484195"><span class="annot"><span class="annottext">ins :: HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t
</span><a href="#local-6989586621681484195"><span class="hs-identifier hs-var hs-var">ins</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484190"><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484190"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484189"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484189"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionHash
-&gt; t -&gt; HashMap TransactionHash t -&gt; HashMap TransactionHash t
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484188"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484189"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484189"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484190"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621681484187"><span class="annot"><span class="annottext">insBadMap :: BadMap -&gt; t -&gt; BadMap
</span><a href="#local-6989586621681484187"><span class="hs-identifier hs-var hs-var">insBadMap</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484186"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484186"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484185"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484185"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484184"><span class="annot"><span class="annottext">endTime :: Time Micros
</span><a href="#local-6989586621681484184"><span class="hs-identifier hs-var hs-var">endTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionMetadata -&gt; Time Micros
</span><a href="Chainweb.Mempool.Mempool.html#txMetaExpiryTime"><span class="hs-identifier hs-var hs-var">txMetaExpiryTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionMetadata
forall t. TransactionConfig t -&gt; t -&gt; TransactionMetadata
</span><a href="Chainweb.Mempool.Mempool.html#txMetadata"><span class="hs-identifier hs-var hs-var">txMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var">txcfg</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484185"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; Time Micros -&gt; BadMap -&gt; BadMap
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484188"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484185"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Time Micros
</span><a href="#local-6989586621681484184"><span class="hs-identifier hs-var">endTime</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484186"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>    </span><span id="local-6989586621681484181"><span class="annot"><span class="annottext">del :: HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t
</span><a href="#local-6989586621681484181"><span class="hs-identifier hs-var hs-var">del</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484180"><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484180"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span id="local-6989586621681484179"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484179"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484178"><span class="annot"><span class="annottext">h :: TransactionHash
</span><a href="#local-6989586621681484178"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; TransactionHash
</span><a href="#local-6989586621681484188"><span class="hs-identifier hs-var">hasher</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484179"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-401"></span><span>                  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TransactionHash
-&gt; HashMap TransactionHash t -&gt; HashMap TransactionHash t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.delete</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484178"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484180"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>    </span><span id="local-6989586621681484188"><span class="annot"><span class="annottext">hasher :: t -&gt; TransactionHash
</span><a href="#local-6989586621681484188"><span class="hs-identifier hs-var hs-var">hasher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; TransactionHash
forall t. TransactionConfig t -&gt; t -&gt; TransactionHash
</span><a href="Chainweb.Mempool.Mempool.html#txHasher"><span class="hs-identifier hs-var hs-var">txHasher</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621681484182"><span class="annot"><span class="annottext">txcfg :: TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var hs-var">txcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; TransactionConfig t
forall t. InMemConfig t -&gt; TransactionConfig t
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxCfg"><span class="hs-identifier hs-var hs-var">_inmemTxCfg</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484216"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621681484177"><span class="annot"><span class="annottext">codec :: Codec t
</span><a href="#local-6989586621681484177"><span class="hs-identifier hs-var hs-var">codec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; Codec t
forall t. TransactionConfig t -&gt; Codec t
</span><a href="Chainweb.Mempool.Mempool.html#txCodec"><span class="hs-identifier hs-var hs-var">txCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621681484203"><span class="annot"><span class="annottext">decodeTx :: ShortByteString -&gt; t
</span><a href="#local-6989586621681484203"><span class="hs-identifier hs-var hs-var">decodeTx</span></a></span></span><span> </span><span id="local-6989586621681484176"><span class="annot"><span class="annottext">tx0 :: ShortByteString
</span><a href="#local-6989586621681484176"><span class="hs-identifier hs-var">tx0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; t) -&gt; (t -&gt; t) -&gt; Either String t -&gt; t
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; t
</span><a href="#local-6989586621681484175"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(Either String t -&gt; t) -&gt; Either String t -&gt; t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Codec t -&gt; ByteString -&gt; Either String t
forall t. Codec t -&gt; ByteString -&gt; Either String t
</span><a href="Chainweb.Utils.html#codecDecode"><span class="hs-identifier hs-var hs-var">codecDecode</span></a></span><span> </span><span class="annot"><span class="annottext">Codec t
</span><a href="#local-6989586621681484177"><span class="hs-identifier hs-var">codec</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681484174"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-408"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681484174"><span class="annot"><span class="annottext">tx :: ByteString
</span><a href="#local-6989586621681484174"><span class="hs-identifier hs-var hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">SB.fromShort</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621681484176"><span class="hs-identifier hs-var">tx0</span></a></span><span>
</span><span id="line-409"></span><span>        </span><span id="local-6989586621681484175"><span class="annot"><span class="annottext">err :: String -&gt; t
</span><a href="#local-6989586621681484175"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span id="local-6989586621681484173"><span class="annot"><span class="annottext">s :: String
</span><a href="#local-6989586621681484173"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; t
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; t) -&gt; String -&gt; t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-410"></span><span>                </span><span class="annot"><span class="annottext">[String] -&gt; String
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;Error decoding tx (\&quot;&quot;</span></span><span>
</span><span id="line-411"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681484173"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-412"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;\&quot;): tx was: &quot;</span></span><span>
</span><span id="line-413"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">T.decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681484174"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621681484196"><span class="annot"><span class="annottext">encodeTx :: t -&gt; ByteString
</span><a href="#local-6989586621681484196"><span class="hs-identifier hs-var hs-var">encodeTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec t -&gt; t -&gt; ByteString
forall t. Codec t -&gt; t -&gt; ByteString
</span><a href="Chainweb.Utils.html#codecEncode"><span class="hs-identifier hs-var hs-var">codecEncode</span></a></span><span> </span><span class="annot"><span class="annottext">Codec t
</span><a href="#local-6989586621681484177"><span class="hs-identifier hs-var">codec</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span id="local-6989586621681484169"><span class="annot"><span class="annottext">getSize :: t -&gt; GasLimit
</span><a href="#local-6989586621681484169"><span class="hs-identifier hs-var hs-var">getSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionConfig t -&gt; t -&gt; GasLimit
forall t. TransactionConfig t -&gt; t -&gt; GasLimit
</span><a href="Chainweb.Mempool.Mempool.html#txGasLimit"><span class="hs-identifier hs-var hs-var">txGasLimit</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var">txcfg</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621681484168"><span class="annot"><span class="annottext">maxSize :: GasLimit
</span><a href="#local-6989586621681484168"><span class="hs-identifier hs-var hs-var">maxSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; GasLimit
forall t. InMemConfig t -&gt; GasLimit
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemTxBlockSizeLimit"><span class="hs-identifier hs-var hs-var">_inmemTxBlockSizeLimit</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484216"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-418"></span><span>    </span><span id="local-6989586621681484167"><span class="annot"><span class="annottext">sizeOK :: t -&gt; Bool
</span><a href="#local-6989586621681484167"><span class="hs-identifier hs-var hs-var">sizeOK</span></a></span></span><span> </span><span id="local-6989586621681484166"><span class="annot"><span class="annottext">tx :: t
</span><a href="#local-6989586621681484166"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; GasLimit
</span><a href="#local-6989586621681484169"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484166"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484168"><span class="hs-identifier hs-var">maxSize</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><a href="#local-6989586621681484165"><span class="hs-identifier hs-type">validateBatch</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#BadMap"><span class="hs-identifier hs-type">BadMap</span></a></span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#BadMap"><span class="hs-identifier hs-type">BadMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>    </span><span id="local-6989586621681484165"><span class="annot"><span class="annottext">validateBatch :: HashMap TransactionHash t
-&gt; BadMap
-&gt; Vector t
-&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap)
</span><a href="#local-6989586621681484165"><span class="hs-identifier hs-var hs-var">validateBatch</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484164"><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484164"><span class="hs-identifier hs-var">psq0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484163"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484163"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span id="local-6989586621681484162"><span class="annot"><span class="annottext">q :: Vector t
</span><a href="#local-6989586621681484162"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-426"></span><span>        </span><span id="local-6989586621681484161"><span class="annot"><span class="annottext">Vector Bool
</span><a href="#local-6989586621681484161"><span class="hs-identifier hs-var">oks1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MempoolPreBlockCheck t
</span><a href="#local-6989586621681484214"><span class="hs-identifier hs-var">txValidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681484213"><span class="hs-identifier hs-var">bheight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681484212"><span class="hs-identifier hs-var">phash</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484162"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484160"><span class="annot"><span class="annottext">oks2 :: Vector Bool
</span><a href="#local-6989586621681484160"><span class="hs-identifier hs-var hs-var">oks2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(t -&gt; Bool) -&gt; Vector t -&gt; Vector Bool
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Bool
</span><a href="#local-6989586621681484167"><span class="hs-identifier hs-var">sizeOK</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484162"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484159"><span class="annot"><span class="annottext">oks :: Vector Bool
</span><a href="#local-6989586621681484159"><span class="hs-identifier hs-var hs-var">oks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool) -&gt; Vector Bool -&gt; Vector Bool -&gt; Vector Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; Vector a -&gt; Vector b -&gt; Vector c
</span><span class="hs-identifier hs-var">V.zipWith</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">(&amp;&amp;)</span></span><span> </span><span class="annot"><span class="annottext">Vector Bool
</span><a href="#local-6989586621681484161"><span class="hs-identifier hs-var">oks1</span></a></span><span> </span><span class="annot"><span class="annottext">Vector Bool
</span><a href="#local-6989586621681484160"><span class="hs-identifier hs-var">oks2</span></a></span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681484157"><span class="annot"><span class="annottext">good1 :: Vector (t, Bool)
</span><a href="#local-6989586621681484157"><span class="hs-identifier hs-var">good1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681484156"><span class="annot"><span class="annottext">bad1 :: Vector (t, Bool)
</span><a href="#local-6989586621681484156"><span class="hs-identifier hs-var">bad1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((t, Bool) -&gt; Bool)
-&gt; Vector (t, Bool) -&gt; (Vector (t, Bool), Vector (t, Bool))
forall a. (a -&gt; Bool) -&gt; Vector a -&gt; (Vector a, Vector a)
</span><span class="hs-identifier hs-var">V.partition</span></span><span> </span><span class="annot"><span class="annottext">(t, Bool) -&gt; Bool
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Vector (t, Bool) -&gt; (Vector (t, Bool), Vector (t, Bool)))
-&gt; Vector (t, Bool) -&gt; (Vector (t, Bool), Vector (t, Bool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; Vector Bool -&gt; Vector (t, Bool)
forall a b. Vector a -&gt; Vector b -&gt; Vector (a, b)
</span><span class="hs-identifier hs-var">V.zip</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484162"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Vector Bool
</span><a href="#local-6989586621681484159"><span class="hs-identifier hs-var">oks</span></a></span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484153"><span class="annot"><span class="annottext">good :: Vector t
</span><a href="#local-6989586621681484153"><span class="hs-identifier hs-var hs-var">good</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((t, Bool) -&gt; t) -&gt; Vector (t, Bool) -&gt; Vector t
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="annot"><span class="annottext">(t, Bool) -&gt; t
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Vector (t, Bool)
</span><a href="#local-6989586621681484157"><span class="hs-identifier hs-var">good1</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-comment">-- remove considered txs -- successful ones will be re-added at the end</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484152"><span class="annot"><span class="annottext">psq' :: HashMap TransactionHash t
</span><a href="#local-6989586621681484152"><span class="hs-identifier hs-var hs-var">psq'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t)
-&gt; HashMap TransactionHash t
-&gt; Vector t
-&gt; HashMap TransactionHash t
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t -&gt; t -&gt; HashMap TransactionHash t
</span><a href="#local-6989586621681484181"><span class="hs-identifier hs-var">del</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484164"><span class="hs-identifier hs-var">psq0</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484162"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-comment">-- txs that fail pre-block validation get sent to the naughty list.</span><span>
</span><span id="line-435"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484151"><span class="annot"><span class="annottext">badmap' :: BadMap
</span><a href="#local-6989586621681484151"><span class="hs-identifier hs-var hs-var">badmap'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BadMap -&gt; t -&gt; BadMap) -&gt; BadMap -&gt; Vector t -&gt; BadMap
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="annot"><span class="annottext">BadMap -&gt; t -&gt; BadMap
</span><a href="#local-6989586621681484187"><span class="hs-identifier hs-var">insBadMap</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484163"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((t, Bool) -&gt; t) -&gt; Vector (t, Bool) -&gt; Vector t
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="annot"><span class="annottext">(t, Bool) -&gt; t
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Vector (t, Bool)
</span><a href="#local-6989586621681484156"><span class="hs-identifier hs-var">bad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>        </span><span class="annot"><span class="annottext">T3 (Vector t) (HashMap TransactionHash t) BadMap
-&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(T3 (Vector t) (HashMap TransactionHash t) BadMap
 -&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap))
-&gt; T3 (Vector t) (HashMap TransactionHash t) BadMap
-&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Vector t
-&gt; HashMap TransactionHash t
-&gt; BadMap
-&gt; T3 (Vector t) (HashMap TransactionHash t) BadMap
forall a b c. a -&gt; b -&gt; c -&gt; T3 a b c
</span><span class="hs-identifier hs-var">T3</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484153"><span class="hs-identifier hs-var">good</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484152"><span class="hs-identifier hs-var">psq'</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484151"><span class="hs-identifier hs-var">badmap'</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><a href="#local-6989586621681484150"><span class="hs-identifier hs-type">maxInARow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621681484150"><span class="annot"><span class="annottext">maxInARow :: ServerNonce
</span><a href="#local-6989586621681484150"><span class="hs-identifier hs-var hs-var">maxInARow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">200</span></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621681484149"><span class="annot"><span class="annottext">unconsV :: Vector a -&gt; T2 a (Vector a)
</span><a href="#local-6989586621681484149"><span class="hs-identifier hs-var hs-var">unconsV</span></a></span></span><span> </span><span id="local-6989586621681484148"><span class="annot"><span class="annottext">v :: Vector a
</span><a href="#local-6989586621681484148"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Vector a -&gt; T2 a (Vector a)
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector a -&gt; a
forall a. Vector a -&gt; a
</span><span class="hs-identifier hs-var">V.unsafeHead</span></span><span> </span><span class="annot"><span class="annottext">Vector a
</span><a href="#local-6989586621681484148"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector a -&gt; Vector a
forall a. Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.unsafeTail</span></span><span> </span><span class="annot"><span class="annottext">Vector a
</span><a href="#local-6989586621681484148"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><a href="#local-6989586621681484145"><span class="hs-identifier hs-type">nextBatch</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GasLimit</span></span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-447"></span><span>    </span><span id="local-6989586621681484145"><span class="annot"><span class="annottext">nextBatch :: HashMap TransactionHash t -&gt; GasLimit -&gt; IO [t]
</span><a href="#local-6989586621681484145"><span class="hs-identifier hs-var hs-var">nextBatch</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484144"><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484144"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484143"><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484143"><span class="hs-identifier hs-var">remainingGas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484142"><span class="annot"><span class="annottext">pendingTxs0 :: Vector t
</span><a href="#local-6989586621681484142"><span class="hs-identifier hs-var hs-var">pendingTxs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[t] -&gt; Vector t
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([t] -&gt; Vector t) -&gt; [t] -&gt; Vector t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t -&gt; [t]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">HashMap.elems</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484144"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-449"></span><span>        </span><span id="local-6989586621681484140"><span class="annot"><span class="annottext">MVector RealWorld t
</span><a href="#local-6989586621681484140"><span class="hs-identifier hs-var">mPendingTxs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; IO (MVector (PrimState IO) t)
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
Vector a -&gt; m (MVector (PrimState m) a)
</span><span class="hs-identifier hs-var">V.unsafeThaw</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484142"><span class="hs-identifier hs-var">pendingTxs0</span></a></span><span>
</span><span id="line-450"></span><span>        </span><span class="annot"><span class="annottext">Comparison t -&gt; MVector (PrimState IO) t -&gt; IO ()
forall (m :: * -&gt; *) (v :: * -&gt; * -&gt; *) e.
(PrimMonad m, MVector v e) =&gt;
Comparison e -&gt; v (PrimState m) e -&gt; m ()
</span><span class="hs-identifier hs-var">TimSort.sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionConfig t -&gt; Comparison t
forall t. TransactionConfig t -&gt; t -&gt; t -&gt; Ordering
</span><a href="Chainweb.Mempool.InMem.html#compareOnGasPrice"><span class="hs-identifier hs-var">compareOnGasPrice</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionConfig t
</span><a href="#local-6989586621681484182"><span class="hs-identifier hs-var">txcfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MVector RealWorld t
MVector (PrimState IO) t
</span><a href="#local-6989586621681484140"><span class="hs-identifier hs-var">mPendingTxs</span></a></span><span>
</span><span id="line-451"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681484137"><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484137"><span class="hs-identifier hs-var">pendingTxs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState IO) t -&gt; IO (Vector t)
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><span class="hs-identifier hs-var">V.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MVector RealWorld t
MVector (PrimState IO) t
</span><a href="#local-6989586621681484140"><span class="hs-identifier hs-var">mPendingTxs</span></a></span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="annottext">[t] -&gt; IO [t]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([t] -&gt; IO [t]) -&gt; [t] -&gt; IO [t]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; GasLimit -&gt; [t] -&gt; ServerNonce -&gt; [t]
</span><a href="#local-6989586621681484135"><span class="hs-identifier hs-var">getBatch</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484137"><span class="hs-identifier hs-var">pendingTxs</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484143"><span class="hs-identifier hs-var">remainingGas</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>    </span><span class="annot"><a href="#local-6989586621681484135"><span class="hs-identifier hs-type">getBatch</span></a></span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GasLimit</span></span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-460"></span><span>    </span><span id="local-6989586621681484135"><span class="annot"><span class="annottext">getBatch :: Vector t -&gt; GasLimit -&gt; [t] -&gt; ServerNonce -&gt; [t]
</span><a href="#local-6989586621681484135"><span class="hs-identifier hs-var hs-var">getBatch</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484134"><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484134"><span class="hs-identifier hs-var">pendingTxs</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484133"><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484133"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484132"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484132"><span class="hs-identifier hs-var">soFar</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484131"><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484131"><span class="hs-identifier hs-var">inARow</span></a></span></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-comment">-- we'll keep looking for transactions until we hit maxInARow that are</span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-comment">-- too large</span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; Bool
forall a. Vector a -&gt; Bool
</span><span class="hs-identifier hs-var">V.null</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484134"><span class="hs-identifier hs-var">pendingTxs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484132"><span class="hs-identifier hs-var">soFar</span></a></span><span>
</span><span id="line-464"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484131"><span class="hs-identifier hs-var">inARow</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484150"><span class="hs-identifier hs-var">maxInARow</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484133"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484132"><span class="hs-identifier hs-var">soFar</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484129"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484129"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484128"><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484128"><span class="hs-identifier hs-var">pendingTxs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; T2 t (Vector t)
forall a. Vector a -&gt; T2 a (Vector a)
</span><a href="#local-6989586621681484149"><span class="hs-identifier hs-var">unconsV</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484134"><span class="hs-identifier hs-var">pendingTxs</span></a></span><span>
</span><span id="line-467"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484127"><span class="annot"><span class="annottext">txSz :: GasLimit
</span><a href="#local-6989586621681484127"><span class="hs-identifier hs-var hs-var">txSz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; GasLimit
</span><a href="#local-6989586621681484169"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484129"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-468"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484127"><span class="hs-identifier hs-var">txSz</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484133"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-469"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; GasLimit -&gt; [t] -&gt; ServerNonce -&gt; [t]
</span><a href="#local-6989586621681484135"><span class="hs-identifier hs-var">getBatch</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484128"><span class="hs-identifier hs-var">pendingTxs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484133"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; GasLimit
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484127"><span class="hs-identifier hs-var">txSz</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484129"><span class="hs-identifier hs-var">tx</span></a></span><span class="annot"><span class="annottext">t -&gt; [t] -&gt; [t]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484132"><span class="hs-identifier hs-var">soFar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-470"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; GasLimit -&gt; [t] -&gt; ServerNonce -&gt; [t]
</span><a href="#local-6989586621681484135"><span class="hs-identifier hs-var">getBatch</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484128"><span class="hs-identifier hs-var">pendingTxs'</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484133"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484132"><span class="hs-identifier hs-var">soFar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484131"><span class="hs-identifier hs-var">inARow</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>    </span><span class="annot"><a href="#local-6989586621681484198"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-473"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#BadMap"><span class="hs-identifier hs-type">BadMap</span></a></span><span>
</span><span id="line-474"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GasLimit</span></span><span>
</span><span id="line-475"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#BadMap"><span class="hs-identifier hs-type">BadMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="#local-6989586621681484716"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621681484198"><span class="annot"><span class="annottext">go :: HashMap TransactionHash t
-&gt; BadMap
-&gt; GasLimit
-&gt; [Vector t]
-&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t))
</span><a href="#local-6989586621681484198"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484126"><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484126"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484125"><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484125"><span class="hs-identifier hs-var">badmap</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484124"><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484124"><span class="hs-identifier hs-var">remainingGas</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484123"><span class="annot"><span class="annottext">[Vector t]
</span><a href="#local-6989586621681484123"><span class="hs-identifier hs-var">soFar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-478"></span><span>        </span><span id="local-6989586621681484122"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484122"><span class="hs-identifier hs-var">nb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t -&gt; GasLimit -&gt; IO [t]
</span><a href="#local-6989586621681484145"><span class="hs-identifier hs-var">nextBatch</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484126"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484124"><span class="hs-identifier hs-var">remainingGas</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[t] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484122"><span class="hs-identifier hs-var">nb</span></a></span><span>
</span><span id="line-480"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">T3 (HashMap TransactionHash t) BadMap (Vector t)
-&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(T3 (HashMap TransactionHash t) BadMap (Vector t)
 -&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t)))
-&gt; T3 (HashMap TransactionHash t) BadMap (Vector t)
-&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
-&gt; BadMap
-&gt; Vector t
-&gt; T3 (HashMap TransactionHash t) BadMap (Vector t)
forall a b c. a -&gt; b -&gt; c -&gt; T3 a b c
</span><span class="hs-identifier hs-var">T3</span></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484126"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484125"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Vector t] -&gt; Vector t
forall a. [Vector a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.concat</span></span><span> </span><span class="annot"><span class="annottext">[Vector t]
</span><a href="#local-6989586621681484123"><span class="hs-identifier hs-var">soFar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-482"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">T3</span></span><span> </span><span id="local-6989586621681484119"><span class="annot"><span class="annottext">good :: Vector t
</span><a href="#local-6989586621681484119"><span class="hs-identifier hs-var">good</span></a></span></span><span> </span><span id="local-6989586621681484118"><span class="annot"><span class="annottext">psq' :: HashMap TransactionHash t
</span><a href="#local-6989586621681484118"><span class="hs-identifier hs-var">psq'</span></a></span></span><span> </span><span id="local-6989586621681484117"><span class="annot"><span class="annottext">badmap' :: BadMap
</span><a href="#local-6989586621681484117"><span class="hs-identifier hs-var">badmap'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
-&gt; BadMap
-&gt; Vector t
-&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap)
</span><a href="#local-6989586621681484165"><span class="hs-identifier hs-var">validateBatch</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484126"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484125"><span class="hs-identifier hs-var">badmap</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector t -&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap))
-&gt; Vector t
-&gt; IO (T3 (Vector t) (HashMap TransactionHash t) BadMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">[t] -&gt; Vector t
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681484122"><span class="hs-identifier hs-var">nb</span></a></span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484116"><span class="annot"><span class="annottext">newGas :: GasLimit
</span><a href="#local-6989586621681484116"><span class="hs-identifier hs-var hs-var">newGas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GasLimit -&gt; t -&gt; GasLimit) -&gt; GasLimit -&gt; Vector t -&gt; GasLimit
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Vector b -&gt; a
</span><span class="hs-identifier hs-var">V.foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681484115"><span class="annot"><span class="annottext">s :: GasLimit
</span><a href="#local-6989586621681484115"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681484114"><span class="annot"><span class="annottext">t :: t
</span><a href="#local-6989586621681484114"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484115"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; GasLimit
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; GasLimit
</span><a href="#local-6989586621681484169"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681484114"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484119"><span class="hs-identifier hs-var">good</span></a></span><span>
</span><span id="line-484"></span><span>            </span><span class="annot"><span class="annottext">HashMap TransactionHash t
-&gt; BadMap
-&gt; GasLimit
-&gt; [Vector t]
-&gt; IO (T3 (HashMap TransactionHash t) BadMap (Vector t))
</span><a href="#local-6989586621681484198"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap TransactionHash t
</span><a href="#local-6989586621681484118"><span class="hs-identifier hs-var">psq'</span></a></span><span> </span><span class="annot"><span class="annottext">BadMap
</span><a href="#local-6989586621681484117"><span class="hs-identifier hs-var">badmap'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484124"><span class="hs-identifier hs-var">remainingGas</span></a></span><span> </span><span class="annot"><span class="annottext">GasLimit -&gt; GasLimit -&gt; GasLimit
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">GasLimit
</span><a href="#local-6989586621681484116"><span class="hs-identifier hs-var">newGas</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector t
</span><a href="#local-6989586621681484119"><span class="hs-identifier hs-var">good</span></a></span><span> </span><span class="annot"><span class="annottext">Vector t -&gt; [Vector t] -&gt; [Vector t]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Vector t]
</span><a href="#local-6989586621681484123"><span class="hs-identifier hs-var">soFar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-488"></span><span id="local-6989586621681484715"><span class="annot"><a href="Chainweb.Mempool.InMem.html#getPendingInMem"><span class="hs-identifier hs-type">getPendingInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemConfig"><span class="hs-identifier hs-type">InMemConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484715"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-489"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#ServerNonce"><span class="hs-identifier hs-type">ServerNonce</span></a></span><span>
</span><span id="line-490"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484715"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#ServerNonce"><span class="hs-identifier hs-type">ServerNonce</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolTxId"><span class="hs-identifier hs-type">MempoolTxId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#ServerNonce"><span class="hs-identifier hs-type">ServerNonce</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolTxId"><span class="hs-identifier hs-type">MempoolTxId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-494"></span><span id="getPendingInMem"><span class="annot"><span class="annottext">getPendingInMem :: InMemConfig t
-&gt; ServerNonce
-&gt; MVar (InMemoryMempoolData t)
-&gt; Maybe HighwaterMark
-&gt; (Vector TransactionHash -&gt; IO ())
-&gt; IO HighwaterMark
</span><a href="Chainweb.Mempool.InMem.html#getPendingInMem"><span class="hs-identifier hs-var hs-var">getPendingInMem</span></a></span></span><span> </span><span id="local-6989586621681484113"><span class="annot"><span class="annottext">cfg :: InMemConfig t
</span><a href="#local-6989586621681484113"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621681484112"><span class="annot"><span class="annottext">nonce :: ServerNonce
</span><a href="#local-6989586621681484112"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span id="local-6989586621681484111"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484111"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span id="local-6989586621681484110"><span class="annot"><span class="annottext">since :: Maybe HighwaterMark
</span><a href="#local-6989586621681484110"><span class="hs-identifier hs-var">since</span></a></span></span><span> </span><span id="local-6989586621681484109"><span class="annot"><span class="annottext">callback :: Vector TransactionHash -&gt; IO ()
</span><a href="#local-6989586621681484109"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681484108"><span class="annot"><span class="annottext">psq :: PendingMap
</span><a href="#local-6989586621681484108"><span class="hs-identifier hs-var">psq</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484107"><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484107"><span class="hs-identifier hs-var">rlog</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (PendingMap, RecentLog)
</span><a href="#local-6989586621681484106"><span class="hs-identifier hs-var">readLock</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; (HighwaterMark -&gt; IO ()) -&gt; Maybe HighwaterMark -&gt; IO ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap -&gt; IO ()
</span><a href="#local-6989586621681484105"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484108"><span class="hs-identifier hs-var">psq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap -&gt; RecentLog -&gt; HighwaterMark -&gt; IO ()
</span><a href="#local-6989586621681484104"><span class="hs-identifier hs-var">sendSome</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484108"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484107"><span class="hs-identifier hs-var">rlog</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe HighwaterMark
</span><a href="#local-6989586621681484110"><span class="hs-identifier hs-var">since</span></a></span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><span class="annottext">HighwaterMark -&gt; IO HighwaterMark
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(HighwaterMark -&gt; IO HighwaterMark)
-&gt; HighwaterMark -&gt; IO HighwaterMark
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484112"><span class="hs-identifier hs-var">nonce</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; MempoolTxId
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlNext"><span class="hs-identifier hs-var hs-var">_rlNext</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484107"><span class="hs-identifier hs-var">rlog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-500"></span><span>    </span><span id="local-6989586621681484105"><span class="annot"><span class="annottext">sendAll :: PendingMap -&gt; IO ()
</span><a href="#local-6989586621681484105"><span class="hs-identifier hs-var hs-var">sendAll</span></a></span></span><span> </span><span id="local-6989586621681484102"><span class="annot"><span class="annottext">psq :: PendingMap
</span><a href="#local-6989586621681484102"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484101"><span class="annot"><span class="annottext">keys :: [TransactionHash]
</span><a href="#local-6989586621681484101"><span class="hs-identifier hs-var hs-var">keys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; [TransactionHash]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">HashMap.keys</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484102"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681484099"><span class="annot"><span class="annottext">dl :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484099"><span class="hs-identifier hs-var">dl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681484098"><span class="annot"><span class="annottext">sz :: ServerNonce
</span><a href="#local-6989586621681484098"><span class="hs-identifier hs-var">sz</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(([TransactionHash] -&gt; [TransactionHash], ServerNonce)
 -&gt; TransactionHash
 -&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce))
-&gt; ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; [TransactionHash]
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldlM</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; TransactionHash
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
</span><a href="#local-6989586621681484097"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall a. (a -&gt; a, ServerNonce)
</span><a href="#local-6989586621681484096"><span class="hs-identifier hs-var">initState</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionHash]
</span><a href="#local-6989586621681484101"><span class="hs-identifier hs-var">keys</span></a></span><span>
</span><span id="line-503"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash]) -&gt; ServerNonce -&gt; IO ()
</span><a href="#local-6989586621681484095"><span class="hs-identifier hs-var">sendChunk</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484099"><span class="hs-identifier hs-var">dl</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484098"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>    </span><span id="local-6989586621681484104"><span class="annot"><span class="annottext">sendSome :: PendingMap -&gt; RecentLog -&gt; HighwaterMark -&gt; IO ()
</span><a href="#local-6989586621681484104"><span class="hs-identifier hs-var hs-var">sendSome</span></a></span></span><span> </span><span id="local-6989586621681484094"><span class="annot"><span class="annottext">psq :: PendingMap
</span><a href="#local-6989586621681484094"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span id="local-6989586621681484093"><span class="annot"><span class="annottext">rlog :: RecentLog
</span><a href="#local-6989586621681484093"><span class="hs-identifier hs-var">rlog</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681484092"><span class="annot"><span class="annottext">rNonce :: ServerNonce
</span><a href="#local-6989586621681484092"><span class="hs-identifier hs-var">rNonce</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681484091"><span class="annot"><span class="annottext">oHw :: MempoolTxId
</span><a href="#local-6989586621681484091"><span class="hs-identifier hs-var">oHw</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484092"><span class="hs-identifier hs-var">rNonce</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484112"><span class="hs-identifier hs-var">nonce</span></a></span><span>
</span><span id="line-507"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; IO ()
</span><a href="#local-6989586621681484105"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484094"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-508"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; RecentLog -&gt; MempoolTxId -&gt; IO ()
</span><a href="#local-6989586621681484089"><span class="hs-identifier hs-var">sendSince</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484094"><span class="hs-identifier hs-var">psq</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484093"><span class="hs-identifier hs-var">rlog</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484091"><span class="hs-identifier hs-var">oHw</span></a></span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621681484089"><span class="annot"><span class="annottext">sendSince :: PendingMap -&gt; RecentLog -&gt; MempoolTxId -&gt; IO ()
</span><a href="#local-6989586621681484089"><span class="hs-identifier hs-var hs-var">sendSince</span></a></span></span><span> </span><span id="local-6989586621681484088"><span class="annot"><span class="annottext">psq :: PendingMap
</span><a href="#local-6989586621681484088"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span id="local-6989586621681484087"><span class="annot"><span class="annottext">rlog :: RecentLog
</span><a href="#local-6989586621681484087"><span class="hs-identifier hs-var">rlog</span></a></span></span><span> </span><span id="local-6989586621681484086"><span class="annot"><span class="annottext">oHw :: MempoolTxId
</span><a href="#local-6989586621681484086"><span class="hs-identifier hs-var">oHw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484085"><span class="annot"><span class="annottext">mbTxs :: Maybe [TransactionHash]
</span><a href="#local-6989586621681484085"><span class="hs-identifier hs-var hs-var">mbTxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; MempoolTxId -&gt; RecentLog -&gt; Maybe [TransactionHash]
</span><a href="Chainweb.Mempool.InMem.html#getRecentTxs"><span class="hs-identifier hs-var">getRecentTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484083"><span class="hs-identifier hs-var">maxNumRecent</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484086"><span class="hs-identifier hs-var">oHw</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484087"><span class="hs-identifier hs-var">rlog</span></a></span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [TransactionHash]
</span><a href="#local-6989586621681484085"><span class="hs-identifier hs-var">mbTxs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-513"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PendingMap -&gt; IO ()
</span><a href="#local-6989586621681484105"><span class="hs-identifier hs-var">sendAll</span></a></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484088"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-514"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681484082"><span class="annot"><span class="annottext">txs :: [TransactionHash]
</span><a href="#local-6989586621681484082"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484081"><span class="annot"><span class="annottext">isPending :: TransactionHash -&gt; Bool
</span><a href="#local-6989586621681484081"><span class="hs-identifier hs-var hs-var">isPending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TransactionHash -&gt; PendingMap -&gt; Bool)
-&gt; PendingMap -&gt; TransactionHash -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; PendingMap -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><span class="hs-identifier hs-var">HashMap.member</span></span><span> </span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484088"><span class="hs-identifier hs-var">psq</span></a></span><span>
</span><span id="line-516"></span><span>              </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; IO ()
</span><a href="#local-6989586621681484109"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector TransactionHash -&gt; IO ())
-&gt; Vector TransactionHash -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; Vector TransactionHash
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; Vector TransactionHash)
-&gt; [TransactionHash] -&gt; Vector TransactionHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TransactionHash -&gt; Bool) -&gt; [TransactionHash] -&gt; [TransactionHash]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; Bool
</span><a href="#local-6989586621681484081"><span class="hs-identifier hs-var">isPending</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionHash]
</span><a href="#local-6989586621681484082"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>    </span><span id="local-6989586621681484106"><span class="annot"><span class="annottext">readLock :: IO (PendingMap, RecentLog)
</span><a href="#local-6989586621681484106"><span class="hs-identifier hs-var hs-var">readLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO (PendingMap, RecentLog))
-&gt; IO (PendingMap, RecentLog)
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484111"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO (PendingMap, RecentLog))
 -&gt; IO (PendingMap, RecentLog))
-&gt; (InMemoryMempoolData t -&gt; IO (PendingMap, RecentLog))
-&gt; IO (PendingMap, RecentLog)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484080"><span class="annot"><span class="annottext">mdata :: InMemoryMempoolData t
</span><a href="#local-6989586621681484080"><span class="hs-identifier hs-var">mdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681484079"><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484079"><span class="hs-identifier hs-var">psq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef PendingMap -&gt; IO PendingMap)
-&gt; IORef PendingMap -&gt; IO PendingMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484080"><span class="hs-identifier hs-var">mdata</span></a></span><span>
</span><span id="line-520"></span><span>        </span><span id="local-6989586621681484078"><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484078"><span class="hs-identifier hs-var">rlog</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef RecentLog -&gt; IO RecentLog
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef RecentLog -&gt; IO RecentLog)
-&gt; IORef RecentLog -&gt; IO RecentLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef RecentLog
forall t. InMemoryMempoolData t -&gt; IORef RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemRecentLog"><span class="hs-identifier hs-var hs-var">_inmemRecentLog</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484080"><span class="hs-identifier hs-var">mdata</span></a></span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">(PendingMap, RecentLog) -&gt; IO (PendingMap, RecentLog)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((PendingMap, RecentLog) -&gt; IO (PendingMap, RecentLog))
-&gt; (PendingMap, RecentLog) -&gt; IO (PendingMap, RecentLog)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap
</span><a href="#local-6989586621681484079"><span class="hs-identifier hs-var">psq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484078"><span class="hs-identifier hs-var">rlog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621681484096"><span class="annot"><span class="annottext">initState :: (a -&gt; a, ServerNonce)
</span><a href="#local-6989586621681484096"><span class="hs-identifier hs-var hs-var">initState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- difference list</span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621681484083"><span class="annot"><span class="annottext">maxNumRecent :: ServerNonce
</span><a href="#local-6989586621681484083"><span class="hs-identifier hs-var hs-var">maxNumRecent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InMemConfig t -&gt; ServerNonce
forall t. InMemConfig t -&gt; ServerNonce
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemMaxRecentItems"><span class="hs-identifier hs-var hs-var">_inmemMaxRecentItems</span></a></span><span> </span><span class="annot"><span class="annottext">InMemConfig t
</span><a href="#local-6989586621681484113"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>    </span><span id="local-6989586621681484097"><span class="annot"><span class="annottext">go :: ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; TransactionHash
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
</span><a href="#local-6989586621681484097"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681484077"><span class="annot"><span class="annottext">dl :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484077"><span class="hs-identifier hs-var">dl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484076"><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484076"><span class="hs-identifier hs-var">sz</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681484075"><span class="annot"><span class="annottext">txhash :: TransactionHash
</span><a href="#local-6989586621681484075"><span class="hs-identifier hs-var">txhash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681484074"><span class="annot"><span class="annottext">dl' :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484074"><span class="hs-identifier hs-var hs-var">dl'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484077"><span class="hs-identifier hs-var">dl</span></a></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash])
-&gt; ([TransactionHash] -&gt; [TransactionHash])
-&gt; [TransactionHash]
-&gt; [TransactionHash]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681484075"><span class="hs-identifier hs-var">txhash</span></a></span><span class="annot"><span class="annottext">TransactionHash -&gt; [TransactionHash] -&gt; [TransactionHash]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681484073"><span class="annot"><span class="annottext">sz' :: ServerNonce
</span><a href="#local-6989586621681484073"><span class="hs-identifier hs-var hs-var">sz'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484076"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-529"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484073"><span class="hs-identifier hs-var">sz'</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484072"><span class="hs-identifier hs-var">chunkSize</span></a></span><span>
</span><span id="line-530"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash]) -&gt; ServerNonce -&gt; IO ()
</span><a href="#local-6989586621681484095"><span class="hs-identifier hs-var">sendChunk</span></a></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484074"><span class="hs-identifier hs-var">dl'</span></a></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484073"><span class="hs-identifier hs-var">sz'</span></a></span><span>
</span><span id="line-531"></span><span>                  </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall a. (a -&gt; a, ServerNonce)
</span><a href="#local-6989586621681484096"><span class="hs-identifier hs-var">initState</span></a></span><span>
</span><span id="line-532"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(([TransactionHash] -&gt; [TransactionHash], ServerNonce)
 -&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce))
-&gt; ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
-&gt; IO ([TransactionHash] -&gt; [TransactionHash], ServerNonce)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484074"><span class="hs-identifier hs-var">dl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484073"><span class="hs-identifier hs-var">sz'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621681484072"><span class="annot"><span class="annottext">chunkSize :: ServerNonce
</span><a href="#local-6989586621681484072"><span class="hs-identifier hs-var hs-var">chunkSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1024</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>    </span><span id="local-6989586621681484095"><span class="annot"><span class="annottext">sendChunk :: ([TransactionHash] -&gt; [TransactionHash]) -&gt; ServerNonce -&gt; IO ()
</span><a href="#local-6989586621681484095"><span class="hs-identifier hs-var hs-var">sendChunk</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>    </span><span class="annot"><a href="#local-6989586621681484095"><span class="hs-identifier hs-var">sendChunk</span></a></span><span> </span><span id="local-6989586621681484071"><span class="annot"><span class="annottext">dl :: [TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484071"><span class="hs-identifier hs-var">dl</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; IO ()
</span><a href="#local-6989586621681484109"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector TransactionHash -&gt; IO ())
-&gt; Vector TransactionHash -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; Vector TransactionHash
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; Vector TransactionHash)
-&gt; [TransactionHash] -&gt; Vector TransactionHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; [TransactionHash]
</span><a href="#local-6989586621681484071"><span class="hs-identifier hs-var">dl</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-540"></span><span id="local-6989586621681484714"><span class="annot"><a href="Chainweb.Mempool.InMem.html#clearInMem"><span class="hs-identifier hs-type">clearInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempoolData"><span class="hs-identifier hs-type">InMemoryMempoolData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484714"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-541"></span><span id="clearInMem"><span class="annot"><span class="annottext">clearInMem :: MVar (InMemoryMempoolData t) -&gt; IO ()
</span><a href="Chainweb.Mempool.InMem.html#clearInMem"><span class="hs-identifier hs-var hs-var">clearInMem</span></a></span></span><span> </span><span id="local-6989586621681484070"><span class="annot"><span class="annottext">lock :: MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484070"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVarMasked</span></span><span> </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
</span><a href="#local-6989586621681484070"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO ()) -&gt; IO ())
-&gt; (InMemoryMempoolData t -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484069"><span class="annot"><span class="annottext">mdata :: InMemoryMempoolData t
</span><a href="#local-6989586621681484069"><span class="hs-identifier hs-var">mdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>        </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; PendingMap -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484069"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PendingMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-544"></span><span>        </span><span class="annot"><span class="annottext">IORef RecentLog -&gt; RecentLog -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef RecentLog
forall t. InMemoryMempoolData t -&gt; IORef RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemRecentLog"><span class="hs-identifier hs-var hs-var">_inmemRecentLog</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484069"><span class="hs-identifier hs-var">mdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="Chainweb.Mempool.InMem.html#emptyRecentLog"><span class="hs-identifier hs-var">emptyRecentLog</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-548"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#emptyRecentLog"><span class="hs-identifier hs-type">emptyRecentLog</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#RecentLog"><span class="hs-identifier hs-type">RecentLog</span></a></span><span>
</span><span id="line-549"></span><span id="emptyRecentLog"><span class="annot"><span class="annottext">emptyRecentLog :: RecentLog
</span><a href="Chainweb.Mempool.InMem.html#emptyRecentLog"><span class="hs-identifier hs-var hs-var">emptyRecentLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; Vector RecentItem -&gt; RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#RecentLog"><span class="hs-identifier hs-var">RecentLog</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Vector RecentItem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#recordRecentTransactions"><span class="hs-identifier hs-type">recordRecentTransactions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#RecentLog"><span class="hs-identifier hs-type">RecentLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#RecentLog"><span class="hs-identifier hs-type">RecentLog</span></a></span><span>
</span><span id="line-552"></span><span id="recordRecentTransactions"><span class="annot"><span class="annottext">recordRecentTransactions :: ServerNonce -&gt; Vector TransactionHash -&gt; RecentLog -&gt; RecentLog
</span><a href="Chainweb.Mempool.InMem.html#recordRecentTransactions"><span class="hs-identifier hs-var hs-var">recordRecentTransactions</span></a></span></span><span> </span><span id="local-6989586621681484067"><span class="annot"><span class="annottext">maxNumRecent :: ServerNonce
</span><a href="#local-6989586621681484067"><span class="hs-identifier hs-var">maxNumRecent</span></a></span></span><span> </span><span id="local-6989586621681484066"><span class="annot"><span class="annottext">newTxs :: Vector TransactionHash
</span><a href="#local-6989586621681484066"><span class="hs-identifier hs-var">newTxs</span></a></span></span><span> </span><span id="local-6989586621681484065"><span class="annot"><span class="annottext">rlog :: RecentLog
</span><a href="#local-6989586621681484065"><span class="hs-identifier hs-var">rlog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484064"><span class="hs-identifier hs-var">rlog'</span></a></span><span>
</span><span id="line-553"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681484064"><span class="annot"><span class="annottext">rlog' :: RecentLog
</span><a href="#local-6989586621681484064"><span class="hs-identifier hs-var hs-var">rlog'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WRecentLog :: MempoolTxId -&gt; Vector RecentItem -&gt; RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#%24WRecentLog"><span class="hs-identifier hs-type hs-type">RecentLog</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_rlNext :: MempoolTxId
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlNext"><span class="hs-identifier hs-var">_rlNext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484062"><span class="hs-identifier hs-var">newNext</span></a></span><span>
</span><span id="line-555"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_rlRecent :: Vector RecentItem
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlRecent"><span class="hs-identifier hs-var">_rlRecent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector RecentItem
</span><a href="#local-6989586621681484060"><span class="hs-identifier hs-var">newL</span></a></span><span>
</span><span id="line-556"></span><span>                       </span><span class="hs-special">}</span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span>    </span><span id="local-6989586621681484059"><span class="annot"><span class="annottext">numNewItems :: ServerNonce
</span><a href="#local-6989586621681484059"><span class="hs-identifier hs-var hs-var">numNewItems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; ServerNonce
forall a. Vector a -&gt; ServerNonce
</span><span class="hs-identifier hs-var">V.length</span></span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484066"><span class="hs-identifier hs-var">newTxs</span></a></span><span>
</span><span id="line-559"></span><span>    </span><span id="local-6989586621681484058"><span class="annot"><span class="annottext">oldNext :: MempoolTxId
</span><a href="#local-6989586621681484058"><span class="hs-identifier hs-var hs-var">oldNext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; MempoolTxId
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlNext"><span class="hs-identifier hs-var hs-var">_rlNext</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484065"><span class="hs-identifier hs-var">rlog</span></a></span><span>
</span><span id="line-560"></span><span>    </span><span id="local-6989586621681484062"><span class="annot"><span class="annottext">newNext :: MempoolTxId
</span><a href="#local-6989586621681484062"><span class="hs-identifier hs-var hs-var">newNext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484058"><span class="hs-identifier hs-var">oldNext</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; MempoolTxId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; MempoolTxId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484059"><span class="hs-identifier hs-var">numNewItems</span></a></span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621681484057"><span class="annot"><span class="annottext">newTxs' :: Vector RecentItem
</span><a href="#local-6989586621681484057"><span class="hs-identifier hs-var hs-var">newTxs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector RecentItem -&gt; Vector RecentItem
forall a. Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TransactionHash -&gt; RecentItem)
-&gt; Vector TransactionHash -&gt; Vector RecentItem
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolTxId -&gt; TransactionHash -&gt; RecentItem
forall a b. a -&gt; b -&gt; T2 a b
</span><span class="hs-identifier hs-var">T2</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484058"><span class="hs-identifier hs-var">oldNext</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484066"><span class="hs-identifier hs-var">newTxs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>    </span><span id="local-6989586621681484055"><span class="annot"><span class="annottext">newL' :: Vector RecentItem
</span><a href="#local-6989586621681484055"><span class="hs-identifier hs-var hs-var">newL'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector RecentItem
</span><a href="#local-6989586621681484057"><span class="hs-identifier hs-var">newTxs'</span></a></span><span> </span><span class="annot"><span class="annottext">Vector RecentItem -&gt; Vector RecentItem -&gt; Vector RecentItem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; Vector RecentItem
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlRecent"><span class="hs-identifier hs-var hs-var">_rlRecent</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484065"><span class="hs-identifier hs-var">rlog</span></a></span><span>
</span><span id="line-563"></span><span>    </span><span id="local-6989586621681484060"><span class="annot"><span class="annottext">newL :: Vector RecentItem
</span><a href="#local-6989586621681484060"><span class="hs-identifier hs-var hs-var">newL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector RecentItem -&gt; Vector RecentItem
forall a. NFData a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">force</span></span><span> </span><span class="annot"><span class="annottext">(Vector RecentItem -&gt; Vector RecentItem)
-&gt; Vector RecentItem -&gt; Vector RecentItem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; Vector RecentItem -&gt; Vector RecentItem
forall a. ServerNonce -&gt; Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.take</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484067"><span class="hs-identifier hs-var">maxNumRecent</span></a></span><span> </span><span class="annot"><span class="annottext">Vector RecentItem
</span><a href="#local-6989586621681484055"><span class="hs-identifier hs-var">newL'</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="hs-comment">-- | Get the recent transactions from the transaction log. Returns Nothing if</span><span>
</span><span id="line-567"></span><span class="hs-comment">-- the old high water mark is too out of date.</span><span>
</span><span id="line-568"></span><span class="annot"><a href="Chainweb.Mempool.InMem.html#getRecentTxs"><span class="hs-identifier hs-type">getRecentTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolTxId"><span class="hs-identifier hs-type">MempoolTxId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#RecentLog"><span class="hs-identifier hs-type">RecentLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-569"></span><span id="getRecentTxs"><span class="annot"><span class="annottext">getRecentTxs :: ServerNonce -&gt; MempoolTxId -&gt; RecentLog -&gt; Maybe [TransactionHash]
</span><a href="Chainweb.Mempool.InMem.html#getRecentTxs"><span class="hs-identifier hs-var hs-var">getRecentTxs</span></a></span></span><span> </span><span id="local-6989586621681484054"><span class="annot"><span class="annottext">maxNumRecent :: ServerNonce
</span><a href="#local-6989586621681484054"><span class="hs-identifier hs-var">maxNumRecent</span></a></span></span><span> </span><span id="local-6989586621681484053"><span class="annot"><span class="annottext">oldHw :: MempoolTxId
</span><a href="#local-6989586621681484053"><span class="hs-identifier hs-var">oldHw</span></a></span></span><span> </span><span id="local-6989586621681484052"><span class="annot"><span class="annottext">rlog :: RecentLog
</span><a href="#local-6989586621681484052"><span class="hs-identifier hs-var">rlog</span></a></span></span><span>
</span><span id="line-570"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484053"><span class="hs-identifier hs-var">oldHw</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484051"><span class="hs-identifier hs-var">oldestHw</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484053"><span class="hs-identifier hs-var">oldHw</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484050"><span class="hs-identifier hs-var">oldNext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [TransactionHash]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484053"><span class="hs-identifier hs-var">oldHw</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484050"><span class="hs-identifier hs-var">oldNext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; Maybe [TransactionHash]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[TransactionHash]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-572"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TransactionHash] -&gt; Maybe [TransactionHash]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([TransactionHash] -&gt; Maybe [TransactionHash])
-&gt; [TransactionHash] -&gt; Maybe [TransactionHash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash -&gt; [TransactionHash]
forall a. Vector a -&gt; [a]
</span><span class="hs-identifier hs-var">V.toList</span></span><span> </span><span class="annot"><span class="annottext">Vector TransactionHash
</span><a href="#local-6989586621681484048"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-575"></span><span>    </span><span id="local-6989586621681484050"><span class="annot"><span class="annottext">oldNext :: MempoolTxId
</span><a href="#local-6989586621681484050"><span class="hs-identifier hs-var hs-var">oldNext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; MempoolTxId
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlNext"><span class="hs-identifier hs-var hs-var">_rlNext</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484052"><span class="hs-identifier hs-var">rlog</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span id="local-6989586621681484051"><span class="annot"><span class="annottext">oldestHw :: MempoolTxId
</span><a href="#local-6989586621681484051"><span class="hs-identifier hs-var hs-var">oldestHw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484050"><span class="hs-identifier hs-var">oldNext</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; MempoolTxId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; MempoolTxId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">ServerNonce
</span><a href="#local-6989586621681484054"><span class="hs-identifier hs-var">maxNumRecent</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621681484048"><span class="annot"><span class="annottext">txs :: Vector TransactionHash
</span><a href="#local-6989586621681484048"><span class="hs-identifier hs-var hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RecentItem -&gt; TransactionHash)
-&gt; Vector RecentItem -&gt; Vector TransactionHash
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="annot"><span class="annottext">RecentItem -&gt; TransactionHash
forall a b. T2 a b -&gt; b
</span><span class="hs-identifier hs-var">ssnd</span></span><span> </span><span class="annot"><span class="annottext">(Vector RecentItem -&gt; Vector TransactionHash)
-&gt; Vector RecentItem -&gt; Vector TransactionHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RecentItem -&gt; Bool) -&gt; Vector RecentItem -&gt; Vector RecentItem
forall a. (a -&gt; Bool) -&gt; Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.takeWhile</span></span><span> </span><span class="annot"><span class="annottext">RecentItem -&gt; Bool
</span><a href="#local-6989586621681484045"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector RecentItem -&gt; Vector RecentItem)
-&gt; Vector RecentItem -&gt; Vector RecentItem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; Vector RecentItem
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlRecent"><span class="hs-identifier hs-var hs-var">_rlRecent</span></a></span><span> </span><span class="annot"><span class="annottext">RecentLog
</span><a href="#local-6989586621681484052"><span class="hs-identifier hs-var">rlog</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span id="local-6989586621681484045"><span class="annot"><span class="annottext">pred :: RecentItem -&gt; Bool
</span><a href="#local-6989586621681484045"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681484044"><span class="annot"><span class="annottext">x :: MempoolTxId
</span><a href="#local-6989586621681484044"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484044"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolTxId -&gt; MempoolTxId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">MempoolTxId
</span><a href="#local-6989586621681484053"><span class="hs-identifier hs-var">oldHw</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-581"></span><span id="local-6989586621681484686"><span class="annot"><a href="Chainweb.Mempool.InMem.html#getMempoolStats"><span class="hs-identifier hs-type">getMempoolStats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#InMemoryMempool"><span class="hs-identifier hs-type">InMemoryMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681484686"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.InMemTypes.html#MempoolStats"><span class="hs-identifier hs-type">MempoolStats</span></a></span></span><span>
</span><span id="line-582"></span><span id="getMempoolStats"><span class="annot"><span class="annottext">getMempoolStats :: InMemoryMempool t -&gt; IO MempoolStats
</span><a href="Chainweb.Mempool.InMem.html#getMempoolStats"><span class="hs-identifier hs-var hs-var">getMempoolStats</span></a></span></span><span> </span><span id="local-6989586621681484043"><span class="annot"><span class="annottext">m :: InMemoryMempool t
</span><a href="#local-6989586621681484043"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><span class="annottext">MVar (InMemoryMempoolData t)
-&gt; (InMemoryMempoolData t -&gt; IO MempoolStats) -&gt; IO MempoolStats
forall a b. MVar a -&gt; (a -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempool t -&gt; MVar (InMemoryMempoolData t)
forall t. InMemoryMempool t -&gt; MVar (InMemoryMempoolData t)
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemDataLock"><span class="hs-identifier hs-var hs-var">_inmemDataLock</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempool t
</span><a href="#local-6989586621681484043"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((InMemoryMempoolData t -&gt; IO MempoolStats) -&gt; IO MempoolStats)
-&gt; (InMemoryMempoolData t -&gt; IO MempoolStats) -&gt; IO MempoolStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681484042"><span class="annot"><span class="annottext">d :: InMemoryMempoolData t
</span><a href="#local-6989586621681484042"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerNonce -&gt; ServerNonce -&gt; ServerNonce -&gt; MempoolStats
</span><a href="Chainweb.Mempool.InMemTypes.html#MempoolStats"><span class="hs-identifier hs-var">MempoolStats</span></a></span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><span class="annottext">(ServerNonce -&gt; ServerNonce -&gt; ServerNonce -&gt; MempoolStats)
-&gt; IO ServerNonce
-&gt; IO (ServerNonce -&gt; ServerNonce -&gt; MempoolStats)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PendingMap -&gt; ServerNonce
forall k v. HashMap k v -&gt; ServerNonce
</span><span class="hs-identifier hs-var">HashMap.size</span></span><span> </span><span class="annot"><span class="annottext">(PendingMap -&gt; ServerNonce) -&gt; IO PendingMap -&gt; IO ServerNonce
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef PendingMap -&gt; IO PendingMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef PendingMap
forall t. InMemoryMempoolData t -&gt; IORef PendingMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemPending"><span class="hs-identifier hs-var hs-var">_inmemPending</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484042"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>        </span><span class="annot"><span class="annottext">IO (ServerNonce -&gt; ServerNonce -&gt; MempoolStats)
-&gt; IO ServerNonce -&gt; IO (ServerNonce -&gt; MempoolStats)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector RecentItem -&gt; ServerNonce
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; ServerNonce
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(Vector RecentItem -&gt; ServerNonce)
-&gt; (RecentLog -&gt; Vector RecentItem) -&gt; RecentLog -&gt; ServerNonce
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RecentLog -&gt; Vector RecentItem
</span><a href="Chainweb.Mempool.InMemTypes.html#_rlRecent"><span class="hs-identifier hs-var hs-var">_rlRecent</span></a></span><span> </span><span class="annot"><span class="annottext">(RecentLog -&gt; ServerNonce) -&gt; IO RecentLog -&gt; IO ServerNonce
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef RecentLog -&gt; IO RecentLog
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef RecentLog
forall t. InMemoryMempoolData t -&gt; IORef RecentLog
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemRecentLog"><span class="hs-identifier hs-var hs-var">_inmemRecentLog</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484042"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">IO (ServerNonce -&gt; MempoolStats)
-&gt; IO ServerNonce -&gt; IO MempoolStats
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BadMap -&gt; ServerNonce
forall k v. HashMap k v -&gt; ServerNonce
</span><span class="hs-identifier hs-var">HashMap.size</span></span><span> </span><span class="annot"><span class="annottext">(BadMap -&gt; ServerNonce) -&gt; IO BadMap -&gt; IO ServerNonce
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef BadMap -&gt; IO BadMap
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InMemoryMempoolData t -&gt; IORef BadMap
forall t. InMemoryMempoolData t -&gt; IORef BadMap
</span><a href="Chainweb.Mempool.InMemTypes.html#_inmemBadMap"><span class="hs-identifier hs-var hs-var">_inmemBadMap</span></a></span><span> </span><span class="annot"><span class="annottext">InMemoryMempoolData t
</span><a href="#local-6989586621681484042"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-587"></span></pre></body></html>