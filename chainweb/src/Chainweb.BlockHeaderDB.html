<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">-- due to module import cycle-breaking with pact: pact wants a BlockHeaderDB,</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- but the TreeDB instance wants to know about genesis blocks, which requires</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- validation, which requires pact</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- Module: Chainweb.BlockHeaderDB</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- Copyright: Copyright &#169; 2018 Kadena LLC.</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- License: MIT</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- Maintainer: Lars Kuhtz &lt;lars@kadena.io&gt;</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Stability: experimental</span><span>
</span><span id="line-27"></span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- TODO</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Chainweb.BlockHeaderDB</span><span>
</span><span id="line-31"></span><span class="hs-special">(</span><span>
</span><span id="line-32"></span><span class="annot"><span class="hs-comment">-- * Chain Database Handle</span></span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#Configuration"><span class="hs-identifier">Configuration</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier">BlockHeaderDb</span></a></span><span>
</span><span id="line-35"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#initBlockHeaderDb"><span class="hs-identifier">initBlockHeaderDb</span></a></span><span>
</span><span id="line-36"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#closeBlockHeaderDb"><span class="hs-identifier">closeBlockHeaderDb</span></a></span><span>
</span><span id="line-37"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#withBlockHeaderDb"><span class="hs-identifier">withBlockHeaderDb</span></a></span><span>
</span><span id="line-38"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#pruneForks"><span class="hs-identifier">pruneForks</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- internal</span><span>
</span><span id="line-41"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#seekTreeDb"><span class="hs-identifier">seekTreeDb</span></a></span><span>
</span><span id="line-42"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">children</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.ST</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.BloomFilter.Easy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">suggestSizing</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.BloomFilter.Hash</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BF</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.BloomFilter.Mutable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BF</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bytes.Get</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bytes.Put</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semigroup</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Numeric.Natural</span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Streaming.Prelude</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.LogLevel</span></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">-- internal imports</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html"><span class="hs-identifier">Chainweb.BlockHash</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html"><span class="hs-identifier">Chainweb.BlockHeader</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html"><span class="hs-identifier">Chainweb.BlockHeaderDB.Types</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.Genesis.html"><span class="hs-identifier">Chainweb.BlockHeader.Genesis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.Genesis.html#genesisBlockHeader"><span class="hs-identifier">genesisBlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html"><span class="hs-identifier">Chainweb.ChainId</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Logger.html"><span class="hs-identifier">Chainweb.Logger</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html"><span class="hs-identifier">Chainweb.TreeDB</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.Validation.html"><span class="hs-identifier">Chainweb.TreeDB.Validation</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.html"><span class="hs-identifier">Chainweb.Utils</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Utils.html#Codec"><span class="hs-identifier">Codec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.Paging.html"><span class="hs-identifier">Chainweb.Utils.Paging</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Version.html"><span class="hs-identifier">Chainweb.Version</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS.RocksDB</span></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- Internal</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">type</span><span> </span><span id="E"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#E"><span class="hs-identifier hs-var">E</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span id="local-6989586621681491155"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHeader"><span class="hs-identifier hs-type">encodeRankedBlockHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadPut</span></span><span> </span><span class="annot"><a href="#local-6989586621681491155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-96"></span><span id="encodeRankedBlockHeader"><span class="annot"><span class="annottext">encodeRankedBlockHeader :: RankedBlockHeader -&gt; m ()
</span><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHeader"><span class="hs-identifier hs-var hs-var">encodeRankedBlockHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; m ()
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHeader -&gt; m ()
</span><a href="Chainweb.BlockHeader.html#encodeBlockHeader"><span class="hs-identifier hs-var">encodeBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; m ())
-&gt; (RankedBlockHeader -&gt; BlockHeader) -&gt; RankedBlockHeader -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader -&gt; BlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_getRankedBlockHeader"><span class="hs-identifier hs-var hs-var">_getRankedBlockHeader</span></a></span><span>
</span><span id="line-97"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHeader"><span class="hs-pragma hs-type">encodeRankedBlockHeader</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span id="local-6989586621681491150"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHeader"><span class="hs-identifier hs-type">decodeRankedBlockHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadGet</span></span><span> </span><span class="annot"><a href="#local-6989586621681491150"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491150"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span></span><span>
</span><span id="line-100"></span><span id="decodeRankedBlockHeader"><span class="annot"><span class="annottext">decodeRankedBlockHeader :: m RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHeader"><span class="hs-identifier hs-var hs-var">decodeRankedBlockHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-var">RankedBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; RankedBlockHeader)
-&gt; m BlockHeader -&gt; m RankedBlockHeader
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">m BlockHeader
forall (m :: * -&gt; *). MonadGet m =&gt; m BlockHeader
</span><a href="Chainweb.BlockHeader.html#decodeBlockHeader"><span class="hs-identifier hs-var">decodeBlockHeader</span></a></span><span>
</span><span id="line-101"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHeader"><span class="hs-pragma hs-type">decodeRankedBlockHeader</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span id="local-6989586621681491149"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHash"><span class="hs-identifier hs-type">encodeRankedBlockHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadPut</span></span><span> </span><span class="annot"><a href="#local-6989586621681491149"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491149"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-104"></span><span id="encodeRankedBlockHash"><span class="annot"><span class="annottext">encodeRankedBlockHash :: RankedBlockHash -&gt; m ()
</span><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHash"><span class="hs-identifier hs-var hs-var">encodeRankedBlockHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span id="local-6989586621681491030"><span class="annot"><span class="annottext">r :: BlockHeight
</span><a href="#local-6989586621681491030"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681491029"><span class="annot"><span class="annottext">bh :: BlockHash
</span><a href="#local-6989586621681491029"><span class="hs-identifier hs-var">bh</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">BlockHeight -&gt; m ()
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHeight -&gt; m ()
</span><a href="Chainweb.BlockHeader.html#encodeBlockHeightBe"><span class="hs-identifier hs-var">encodeBlockHeightBe</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681491030"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">BlockHash -&gt; m ()
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHash -&gt; m ()
</span><a href="Chainweb.BlockHash.html#encodeBlockHash"><span class="hs-identifier hs-var">encodeBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681491029"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-107"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHash"><span class="hs-pragma hs-type">encodeRankedBlockHash</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span id="local-6989586621681491147"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHash"><span class="hs-identifier hs-type">decodeRankedBlockHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadGet</span></span><span> </span><span class="annot"><a href="#local-6989586621681491147"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491147"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span></span><span>
</span><span id="line-110"></span><span id="decodeRankedBlockHash"><span class="annot"><span class="annottext">decodeRankedBlockHash :: m RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHash"><span class="hs-identifier hs-var hs-var">decodeRankedBlockHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">(BlockHeight -&gt; BlockHash -&gt; RankedBlockHash)
-&gt; m BlockHeight -&gt; m (BlockHash -&gt; RankedBlockHash)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">m BlockHeight
forall (m :: * -&gt; *). MonadGet m =&gt; m BlockHeight
</span><a href="Chainweb.BlockHeader.html#decodeBlockHeightBe"><span class="hs-identifier hs-var">decodeBlockHeightBe</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">m (BlockHash -&gt; RankedBlockHash)
-&gt; m BlockHash -&gt; m RankedBlockHash
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m BlockHash
forall (m :: * -&gt; *). MonadGet m =&gt; m BlockHash
</span><a href="Chainweb.BlockHash.html#decodeBlockHash"><span class="hs-identifier hs-var">decodeBlockHash</span></a></span><span>
</span><span id="line-113"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHash"><span class="hs-pragma hs-type">decodeRankedBlockHash</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Configuration of the chain DB.</span><span>
</span><span id="line-117"></span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span class="hs-keyword">data</span><span> </span><span id="Configuration"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#Configuration"><span class="hs-identifier hs-var">Configuration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Configuration"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#Configuration"><span class="hs-identifier hs-var">Configuration</span></a></span></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_configRoot"><span class="annot"><span class="annottext">Configuration -&gt; BlockHeader
</span><a href="Chainweb.BlockHeaderDB.html#_configRoot"><span class="hs-identifier hs-var hs-var">_configRoot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_configRocksDb"><span class="annot"><span class="annottext">Configuration -&gt; RocksDb
</span><a href="Chainweb.BlockHeaderDB.html#_configRocksDb"><span class="hs-identifier hs-var hs-var">_configRocksDb</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">RocksDb</span></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- Prune Old Forks</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | Prunes most block headers and block payloads from forks that are older than</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- the given number of blocks.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- This function guarantees that the predecessors of all remaining nodes also</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- remain in the database and that there are are no tangling references.</span><span>
</span><span id="line-131"></span><span class="hs-comment">--</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- This function doesn't guarantee to delete all blocks on forks. A small number</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- of fork blocks may not get deleted.</span><span>
</span><span id="line-134"></span><span class="hs-comment">--</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- The function takes a callback that is invoked on each deleted block header.</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- The callback takes a parameter that indicates whether the block payload hash</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- is shared with any non-deleted block header. There is a small rate of false</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- positives of block payload hashes that are marked in use.</span><span>
</span><span id="line-139"></span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- This doesn't update the the cut db or the payload db.</span><span>
</span><span id="line-141"></span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span id="local-6989586621681491020"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#pruneForks"><span class="hs-identifier hs-type">pruneForks</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681491020"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681491020"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-comment">-- ^ The depth at which the roots are collected for marking block</span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-comment">-- headers that are kept. Any fork that was active that the given depth</span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-comment">-- is kept.</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-comment">-- The depth is computed based on the entry of maximum rank. This entry</span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-comment">-- is not necessarily included in the overall consensus of the chainweb.</span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-comment">-- In particular the the higest ranking entry is not necessarily the</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-comment">-- entry of largest POW weight.</span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-comment">-- Usually this number would be defined in terms of the chainweb</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-comment">-- diameter and/or the difficulty adjustment window.</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-comment">-- ^ Deletion call back. This hook is called /after/ the entry is</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-comment">-- deleted from the database. It's main purpose is to delete any</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">-- resources that were related to the deleted header and that are not</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">-- needed any more. The Boolean argument indicates whether the payload</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">-- of the block is shared with any block header that isn't marked for</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-comment">-- deletion.</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-166"></span><span id="pruneForks"><span class="annot"><span class="annottext">pruneForks :: logger
-&gt; BlockHeaderDb
-&gt; Natural
-&gt; (BlockHeader -&gt; Bool -&gt; IO ())
-&gt; IO Int
</span><a href="Chainweb.BlockHeaderDB.html#pruneForks"><span class="hs-identifier hs-var hs-var">pruneForks</span></a></span></span><span> </span><span id="local-6989586621681491019"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681491019"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681491018"><span class="annot"><span class="annottext">cdb :: BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span></span><span> </span><span id="local-6989586621681491017"><span class="annot"><span class="annottext">limit :: Natural
</span><a href="#local-6989586621681491017"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681491016"><span class="annot"><span class="annottext">callback :: BlockHeader -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621681491016"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- find all roots at \(maxEntry - limit\)</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621681491015"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491015"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; IO Natural
forall db. TreeDb db =&gt; db -&gt; IO Natural
</span><a href="Chainweb.TreeDB.html#maxRank"><span class="hs-identifier hs-var">maxRank</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681491013"><span class="annot"><span class="annottext">rootHeight :: Natural
</span><a href="#local-6989586621681491013"><span class="hs-identifier hs-var hs-var">rootHeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491015"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491015"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491017"><span class="hs-identifier hs-var">limit</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681491011"><span class="annot"><span class="annottext">HashSet BlockHash
</span><a href="#local-6989586621681491011"><span class="hs-identifier hs-var">roots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem (DbKey BlockHeaderDb))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos)
    -&gt; IO (HashSet BlockHash))
-&gt; IO (HashSet BlockHash)
forall db a.
TreeDb db =&gt;
db
-&gt; Maybe (NextItem (DbKey db))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbKey db)) IO (Natural, Eos) -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.TreeDB.html#keys"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem (DbKey BlockHeaderDb))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MinRank -&gt; Maybe MinRank
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MinRank -&gt; Maybe MinRank) -&gt; MinRank -&gt; Maybe MinRank
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Min Natural -&gt; MinRank
</span><a href="Chainweb.TreeDB.html#MinRank"><span class="hs-identifier hs-var">MinRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Min Natural -&gt; MinRank) -&gt; Min Natural -&gt; MinRank
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Min Natural
forall a. a -&gt; Min a
</span><span class="hs-identifier hs-var">Min</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491013"><span class="hs-identifier hs-var">rootHeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">Maybe MaxRank
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-176"></span><span>            </span><span class="hs-comment">-- include all block headers in the root set, so that all headers</span><span>
</span><span id="line-177"></span><span>            </span><span class="hs-comment">-- are included in the marking phase. PayloadBlockHashes can be</span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-comment">-- shared between blocks at different height, so we must make sure</span><span>
</span><span id="line-179"></span><span>            </span><span class="hs-comment">-- that they are retained if a root depends on them.</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos)
-&gt; IO (HashSet BlockHash)
forall (m :: * -&gt; *) a r.
(Monad m, Eq a, Hashable a) =&gt;
Stream (Of a) m r -&gt; m (HashSet a)
</span><a href="Chainweb.Utils.html#streamToHashSet_"><span class="hs-identifier hs-var">streamToHashSet_</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- Bloom filter for marking block headers</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681491006"><span class="annot"><span class="annottext">s :: Int
</span><a href="#local-6989586621681491006"><span class="hs-identifier hs-var hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491013"><span class="hs-identifier hs-var">rootHeight</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">HashSet BlockHash -&gt; Int
forall a. HashSet a -&gt; Int
</span><span class="hs-identifier hs-var">HS.size</span></span><span> </span><span class="annot"><span class="annottext">HashSet BlockHash
</span><a href="#local-6989586621681491011"><span class="hs-identifier hs-var">roots</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491013"><span class="hs-identifier hs-var">rootHeight</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681491000"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621681491000"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681490999"><span class="annot"><span class="annottext">hashNum :: Int
</span><a href="#local-6989586621681490999"><span class="hs-identifier hs-var">hashNum</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; (Int, Int)
</span><span class="hs-identifier hs-var">BF.suggestSizing</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681491006"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="hs-number">0.0001</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681490998"><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490998"><span class="hs-identifier hs-var">marked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST RealWorld (MBloom RealWorld ByteString)
-&gt; IO (MBloom RealWorld ByteString)
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld (MBloom RealWorld ByteString)
 -&gt; IO (MBloom RealWorld ByteString))
-&gt; ST RealWorld (MBloom RealWorld ByteString)
-&gt; IO (MBloom RealWorld ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; [Hash])
-&gt; Int -&gt; ST RealWorld (MBloom RealWorld ByteString)
forall a s. (a -&gt; [Hash]) -&gt; Int -&gt; ST s (MBloom s a)
</span><span class="hs-identifier hs-var">BF.new</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; [Hash]
forall a. Hashable a =&gt; Int -&gt; a -&gt; [Hash]
</span><span class="hs-identifier hs-var">BF.cheapHashes</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490999"><span class="hs-identifier hs-var">hashNum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681491000"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- Bloom filter for marking block payload hashes</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- Payloads can be shared between different blocks. Thus, to be on the safe</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">-- side, we are not deleting any marked payload.</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">-- Note that we could use cuckoo hashes or counting bloom filters to do</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- reference counting and collect more unreferenced payloads.</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- TODO: would it be better to use a single shared filter?</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681490994"><span class="annot"><span class="annottext">psize :: Int
</span><a href="#local-6989586621681490994"><span class="hs-identifier hs-var">psize</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681490993"><span class="annot"><span class="annottext">phashNum :: Int
</span><a href="#local-6989586621681490993"><span class="hs-identifier hs-var">phashNum</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; (Int, Int)
</span><span class="hs-identifier hs-var">BF.suggestSizing</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681491006"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="hs-number">0.0001</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681490992"><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490992"><span class="hs-identifier hs-var">markedPayloads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST RealWorld (MBloom RealWorld ByteString)
-&gt; IO (MBloom RealWorld ByteString)
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld (MBloom RealWorld ByteString)
 -&gt; IO (MBloom RealWorld ByteString))
-&gt; ST RealWorld (MBloom RealWorld ByteString)
-&gt; IO (MBloom RealWorld ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; [Hash])
-&gt; Int -&gt; ST RealWorld (MBloom RealWorld ByteString)
forall a s. (a -&gt; [Hash]) -&gt; Int -&gt; ST s (MBloom s a)
</span><span class="hs-identifier hs-var">BF.new</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; [Hash]
forall a. Hashable a =&gt; Int -&gt; a -&gt; [Hash]
</span><span class="hs-identifier hs-var">BF.cheapHashes</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490993"><span class="hs-identifier hs-var">phashNum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490994"><span class="hs-identifier hs-var">psize</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-comment">-- Iterate backwards and mark all predecessors of the roots</span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">IO (Natural, Eos) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Natural, Eos) -&gt; IO ()) -&gt; IO (Natural, Eos) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem (DbKey BlockHeaderDb))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; HashSet (LowerBound (DbKey BlockHeaderDb))
-&gt; HashSet (UpperBound (DbKey BlockHeaderDb))
-&gt; (Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
    -&gt; IO (Natural, Eos))
-&gt; IO (Natural, Eos)
forall db a.
TreeDb db =&gt;
db
-&gt; Maybe (NextItem (DbKey db))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; HashSet (LowerBound (DbKey db))
-&gt; HashSet (UpperBound (DbKey db))
-&gt; (Stream (Of (DbEntry db)) IO (Natural, Eos) -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.TreeDB.html#branchEntries"><span class="hs-identifier hs-var">branchEntries</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem (DbKey BlockHeaderDb))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe MaxRank
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">HashSet (LowerBound (DbKey BlockHeaderDb))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHash -&gt; UpperBound BlockHash)
-&gt; HashSet BlockHash -&gt; HashSet (UpperBound BlockHash)
forall b a.
(Hashable b, Eq b) =&gt;
(a -&gt; b) -&gt; HashSet a -&gt; HashSet b
</span><span class="hs-identifier hs-var">HS.map</span></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; UpperBound BlockHash
forall k. k -&gt; UpperBound k
</span><a href="Chainweb.TreeDB.html#UpperBound"><span class="hs-identifier hs-var">UpperBound</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet BlockHash
</span><a href="#local-6989586621681491011"><span class="hs-identifier hs-var">roots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">((Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
  -&gt; IO (Natural, Eos))
 -&gt; IO (Natural, Eos))
-&gt; (Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
    -&gt; IO (Natural, Eos))
-&gt; IO (Natural, Eos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; IO ())
-&gt; Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
-&gt; IO (Natural, Eos)
forall (m :: * -&gt; *) a x r.
Monad m =&gt;
(a -&gt; m x) -&gt; Stream (Of a) m r -&gt; m r
</span><span class="hs-identifier hs-var">S.mapM_</span></span><span> </span><span class="annot"><span class="annottext">((BlockHeader -&gt; IO ())
 -&gt; Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
 -&gt; IO (Natural, Eos))
-&gt; (BlockHeader -&gt; IO ())
-&gt; Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
-&gt; IO (Natural, Eos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681490986"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681490986"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">ST RealWorld () -&gt; IO ()
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld () -&gt; IO ()) -&gt; ST RealWorld () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>                </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString -&gt; ByteString -&gt; ST RealWorld ()
forall s a. MBloom s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">BF.insert</span></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490998"><span class="hs-identifier hs-var">marked</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ST RealWorld ()) -&gt; ByteString -&gt; ST RealWorld ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString) -&gt; Put -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHash -&gt; m ()
</span><a href="Chainweb.BlockHash.html#encodeBlockHash"><span class="hs-identifier hs-var">encodeBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHash -&gt; Put) -&gt; BlockHash -&gt; Put
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490986"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-207"></span><span>                </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString -&gt; ByteString -&gt; ST RealWorld ()
forall s a. MBloom s a -&gt; a -&gt; ST s ()
</span><span class="hs-identifier hs-var">BF.insert</span></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490992"><span class="hs-identifier hs-var">markedPayloads</span></a></span><span>
</span><span id="line-208"></span><span>                    </span><span class="annot"><span class="annottext">(ByteString -&gt; ST RealWorld ()) -&gt; ByteString -&gt; ST RealWorld ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString) -&gt; Put -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockPayloadHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockPayloadHash -&gt; m ()
</span><a href="Chainweb.Payload.html#encodeBlockPayloadHash"><span class="hs-identifier hs-var">encodeBlockPayloadHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockPayloadHash -&gt; Put) -&gt; BlockPayloadHash -&gt; Put
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockPayloadHash
</span><a href="Chainweb.BlockHeader.html#_blockPayloadHash"><span class="hs-identifier hs-var hs-var">_blockPayloadHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490986"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-comment">-- Iterate forward and delete all non-marked block headers that are not a</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-comment">-- predecessor of a block header that is kept.</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem (DbKey BlockHeaderDb))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
    -&gt; IO Int)
-&gt; IO Int
forall db a.
TreeDb db =&gt;
db
-&gt; Maybe (NextItem (DbKey db))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbEntry db)) IO (Natural, Eos) -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.TreeDB.html#entries"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem (DbKey BlockHeaderDb))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaxRank -&gt; Maybe MaxRank
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MaxRank -&gt; Maybe MaxRank) -&gt; MaxRank -&gt; Maybe MaxRank
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Max Natural -&gt; MaxRank
</span><a href="Chainweb.TreeDB.html#MaxRank"><span class="hs-identifier hs-var">MaxRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Max Natural -&gt; MaxRank) -&gt; Max Natural -&gt; MaxRank
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Max Natural
forall a. a -&gt; Max a
</span><span class="hs-identifier hs-var">Max</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621681491013"><span class="hs-identifier hs-var">rootHeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">((Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO Int)
 -&gt; IO Int)
-&gt; (Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos)
    -&gt; IO Int)
-&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((HashSet ByteString, Int)
 -&gt; BlockHeader -&gt; IO (HashSet ByteString, Int))
-&gt; IO (HashSet ByteString, Int)
-&gt; ((HashSet ByteString, Int) -&gt; IO Int)
-&gt; Stream (Of BlockHeader) IO (Natural, Eos)
-&gt; IO Int
forall (m :: * -&gt; *) x a b r.
Monad m =&gt;
(x -&gt; a -&gt; m x) -&gt; m x -&gt; (x -&gt; m b) -&gt; Stream (Of a) m r -&gt; m b
</span><span class="hs-identifier hs-var">S.foldM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
-&gt; MBloom RealWorld ByteString
-&gt; (HashSet ByteString, Int)
-&gt; BlockHeader
-&gt; IO (HashSet ByteString, Int)
</span><a href="#local-6989586621681490976"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490998"><span class="hs-identifier hs-var">marked</span></a></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490992"><span class="hs-identifier hs-var">markedPayloads</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HashSet ByteString, Int) -&gt; IO (HashSet ByteString, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet ByteString
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO Int)
-&gt; ((HashSet ByteString, Int) -&gt; Int)
-&gt; (HashSet ByteString, Int)
-&gt; IO Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(HashSet ByteString, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621681490975"><span class="annot"><span class="annottext">logg :: LogFunctionText
</span><a href="#local-6989586621681490975"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunctionText
forall l. Logger l =&gt; l -&gt; LogFunctionText
</span><a href="Chainweb.Logger.html#logFunctionText"><span class="hs-identifier hs-var">logFunctionText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; logger -&gt; logger
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pact-tx-replay&quot;</span></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681491019"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">-- The falsePositiveSet collects all deleted nodes that are known to be</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-comment">-- false positives.</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-comment">-- We know that a node is false positive when it is in the filter but any of</span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-comment">-- its ancestors is neither in the filter nor in the falsePositiveSet.</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-comment">-- (Because for a true positive all ancestors are in the filter.) We also</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-comment">-- know that a node is false positive if it's payload isn't marked, because</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- we mark the payload of all nodes that are true positives.</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- Note that this doesn't capture all false positives, but only those that</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- are not connected to the main chain.</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- Nodes that are known to be false positives are safe to remove, if also</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- all of its successors are removed.</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-comment">-- Nodes that are known to be false postives must be removed, if any of their</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">-- predecessors got removed or if their payload got removed.</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621681490976"><span class="annot"><span class="annottext">go :: MBloom RealWorld ByteString
-&gt; MBloom RealWorld ByteString
-&gt; (HashSet ByteString, Int)
-&gt; BlockHeader
-&gt; IO (HashSet ByteString, Int)
</span><a href="#local-6989586621681490976"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681490972"><span class="annot"><span class="annottext">marked :: MBloom RealWorld ByteString
</span><a href="#local-6989586621681490972"><span class="hs-identifier hs-var">marked</span></a></span></span><span> </span><span id="local-6989586621681490971"><span class="annot"><span class="annottext">markedPayloads :: MBloom RealWorld ByteString
</span><a href="#local-6989586621681490971"><span class="hs-identifier hs-var">markedPayloads</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681490970"><span class="annot"><span class="annottext">HashSet ByteString
</span><a href="#local-6989586621681490970"><span class="hs-identifier hs-var">falsePositiveSet</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681490969"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490969"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681490968"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681490967"><span class="annot"><span class="annottext">k :: ByteString
</span><a href="#local-6989586621681490967"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString) -&gt; Put -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHash -&gt; m ()
</span><a href="Chainweb.BlockHash.html#encodeBlockHash"><span class="hs-identifier hs-var">encodeBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHash -&gt; Put) -&gt; BlockHash -&gt; Put
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681490966"><span class="annot"><span class="annottext">p :: ByteString
</span><a href="#local-6989586621681490966"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString) -&gt; Put -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHash -&gt; m ()
</span><a href="Chainweb.BlockHash.html#encodeBlockHash"><span class="hs-identifier hs-var">encodeBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHash -&gt; Put) -&gt; BlockHash -&gt; Put
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockParent"><span class="hs-identifier hs-var hs-var">_blockParent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span id="local-6989586621681490964"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490964"><span class="hs-identifier hs-var">isMarked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST RealWorld Bool -&gt; IO Bool
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld Bool -&gt; IO Bool) -&gt; ST RealWorld Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; MBloom RealWorld ByteString -&gt; ST RealWorld Bool
forall a s. a -&gt; MBloom s a -&gt; ST s Bool
</span><span class="hs-identifier hs-var">BF.elem</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490967"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490972"><span class="hs-identifier hs-var">marked</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681490962"><span class="annot"><span class="annottext">payloadHashBytes :: ByteString
</span><a href="#local-6989586621681490962"><span class="hs-identifier hs-var hs-var">payloadHashBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString) -&gt; Put -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockPayloadHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockPayloadHash -&gt; m ()
</span><a href="Chainweb.Payload.html#encodeBlockPayloadHash"><span class="hs-identifier hs-var">encodeBlockPayloadHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockPayloadHash -&gt; Put) -&gt; BlockPayloadHash -&gt; Put
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockPayloadHash
</span><a href="Chainweb.BlockHeader.html#_blockPayloadHash"><span class="hs-identifier hs-var hs-var">_blockPayloadHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span id="local-6989586621681490961"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490961"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST RealWorld Bool -&gt; IO Bool
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld Bool -&gt; IO Bool) -&gt; ST RealWorld Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; MBloom RealWorld ByteString -&gt; ST RealWorld Bool
forall a s. a -&gt; MBloom s a -&gt; ST s Bool
</span><span class="hs-identifier hs-var">BF.elem</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490962"><span class="hs-identifier hs-var">payloadHashBytes</span></a></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490971"><span class="hs-identifier hs-var">markedPayloads</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-comment">-- Delete nodes not in the filter</span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490964"><span class="hs-identifier hs-var">isMarked</span></a></span><span>
</span><span id="line-247"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>            </span><span class="annot"><span class="annottext">BlockHeader -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621681490959"><span class="hs-identifier hs-var">deleteKey</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490961"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="annottext">(HashSet ByteString, Int) -&gt; IO (HashSet ByteString, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet ByteString
</span><a href="#local-6989586621681490970"><span class="hs-identifier hs-var">falsePositiveSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490969"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>            </span><span class="hs-comment">-- Delete nodes which parent isn't in the filter or is in the</span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-comment">-- falsePositiveSet</span><span>
</span><span id="line-253"></span><span>            </span><span id="local-6989586621681490957"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490957"><span class="hs-identifier hs-var">parentIsMarked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST RealWorld Bool -&gt; IO Bool
forall a. ST RealWorld a -&gt; IO a
</span><span class="hs-identifier hs-var">stToIO</span></span><span> </span><span class="annot"><span class="annottext">(ST RealWorld Bool -&gt; IO Bool) -&gt; ST RealWorld Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; MBloom RealWorld ByteString -&gt; ST RealWorld Bool
forall a s. a -&gt; MBloom s a -&gt; ST s Bool
</span><span class="hs-identifier hs-var">BF.elem</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490966"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">MBloom RealWorld ByteString
</span><a href="#local-6989586621681490972"><span class="hs-identifier hs-var">marked</span></a></span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Bool
</span><a href="Chainweb.BlockHeader.html#isGenesisBlockHeader"><span class="hs-identifier hs-var">isGenesisBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490957"><span class="hs-identifier hs-var">parentIsMarked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; HashSet ByteString -&gt; Bool
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">HS.member</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490966"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet ByteString
</span><a href="#local-6989586621681490970"><span class="hs-identifier hs-var">falsePositiveSet</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490961"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>                </span><span class="hs-comment">-- We know that this a false positive. We keep track of this for</span><span>
</span><span id="line-257"></span><span>                </span><span class="hs-comment">-- future reference.</span><span>
</span><span id="line-258"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-259"></span><span>                </span><span class="hs-comment">-- TODO: consider using cuckoo filters because entries can be</span><span>
</span><span id="line-260"></span><span>                </span><span class="hs-comment">-- deleted from them. So we wouldn't need to keep track of</span><span>
</span><span id="line-261"></span><span>                </span><span class="hs-comment">-- deleted falsePositives. However, with cuckoo filters we'd</span><span>
</span><span id="line-262"></span><span>                </span><span class="hs-comment">-- have to re-hash or keep track of failing inserts.</span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">BlockHeader -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621681490959"><span class="hs-identifier hs-var">deleteKey</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490968"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490961"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><span class="annottext">(HashSet ByteString, Int) -&gt; IO (HashSet ByteString, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; HashSet ByteString -&gt; HashSet ByteString
forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.insert</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490967"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet ByteString
</span><a href="#local-6989586621681490970"><span class="hs-identifier hs-var">falsePositiveSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490969"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>              </span><span class="hs-keyword">else</span><span>
</span><span id="line-266"></span><span>                </span><span class="hs-comment">-- The key is either</span><span>
</span><span id="line-267"></span><span>                </span><span class="hs-comment">-- 1. in the chain or</span><span>
</span><span id="line-268"></span><span>                </span><span class="hs-comment">-- 2. is a false positive that has a payload and is connected to</span><span>
</span><span id="line-269"></span><span>                </span><span class="hs-comment">--    the chain (i.e. has all of its predecessors).</span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-comment">-- We accept a small number of nodes of the second case.</span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">(HashSet ByteString, Int) -&gt; IO (HashSet ByteString, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet ByteString
</span><a href="#local-6989586621681490970"><span class="hs-identifier hs-var">falsePositiveSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681490969"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621681490959"><span class="annot"><span class="annottext">deleteKey :: BlockHeader -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621681490959"><span class="hs-identifier hs-var hs-var">deleteKey</span></a></span></span><span> </span><span id="local-6989586621681490951"><span class="annot"><span class="annottext">h :: BlockHeader
</span><a href="#local-6989586621681490951"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621681490950"><span class="annot"><span class="annottext">isPayloadMarked :: Bool
</span><a href="#local-6989586621681490950"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- TODO: make this atomic (create boilerplate to combine queries for</span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-comment">-- different tables)</span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
-&gt; IO ()
forall a. IsCas a =&gt; a -&gt; CasKeyType (CasValueType a) -&gt; IO ()
</span><span class="hs-identifier hs-var">casDelete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
forall v. IsCasValue v =&gt; v -&gt; CasKeyType v
</span><span class="hs-identifier hs-var">casKey</span></span><span> </span><span class="annot"><span class="annottext">(RankedBlockHeader
 -&gt; CasKeyType
      (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader)))
-&gt; RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-var">RankedBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490951"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTable BlockHash BlockHeight -&gt; BlockHash -&gt; IO ()
forall k v. RocksDbTable k v -&gt; k -&gt; IO ()
</span><span class="hs-identifier hs-var">tableDelete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable BlockHash BlockHeight
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbRankTable"><span class="hs-identifier hs-var hs-var">_chainDbRankTable</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681491018"><span class="hs-identifier hs-var">cdb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490951"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">LogFunctionText
</span><a href="#local-6989586621681490975"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Debug</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; Text -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted block header at height &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490951"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot; with payload mark &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490950"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="annottext">BlockHeader -&gt; Bool -&gt; IO ()
</span><a href="#local-6989586621681491016"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490951"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681490950"><span class="hs-identifier hs-var">isPayloadMarked</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- Insert</span><span>
</span><span id="line-285"></span><span class="hs-comment">--</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- Only functions in this section are allowed to modify values of the Db type.</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | A a new entry to the database</span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- Updates all indices.</span><span>
</span><span id="line-291"></span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#dbAddChecked"><span class="hs-identifier hs-type">dbAddChecked</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span id="dbAddChecked"><span class="annot"><span class="annottext">dbAddChecked :: BlockHeaderDb -&gt; BlockHeader -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#dbAddChecked"><span class="hs-identifier hs-var hs-var">dbAddChecked</span></a></span></span><span> </span><span id="local-6989586621681490940"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490940"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490939"><span class="annot"><span class="annottext">e :: BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><a href="Chainweb.Utils.html#unlessM"><span class="hs-identifier hs-var">unlessM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
-&gt; IO Bool
forall a. IsCas a =&gt; a -&gt; CasKeyType (CasValueType a) -&gt; IO Bool
</span><span class="hs-identifier hs-var">casMember</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490940"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CasKeyType
  (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
RankedBlockHash
</span><a href="#local-6989586621681490936"><span class="hs-identifier hs-var">ek</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681490935"><span class="hs-identifier hs-var">dbAddCheckedInternal</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621681490934"><span class="annot"><span class="annottext">r :: BlockHeight
</span><a href="#local-6989586621681490934"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; BlockHeight
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; BlockHeight) -&gt; Natural -&gt; BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; Natural
forall e. TreeDbEntry e =&gt; e -&gt; Natural
</span><a href="Chainweb.TreeDB.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621681490936"><span class="annot"><span class="annottext">ek :: RankedBlockHash
</span><a href="#local-6989586621681490936"><span class="hs-identifier hs-var hs-var">ek</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490934"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">-- Internal helper methods</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">-- | Unchecked addition</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- ASSUMES that</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">-- * Item is not yet in database</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="#local-6989586621681490935"><span class="hs-identifier hs-type">dbAddCheckedInternal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621681490935"><span class="annot"><span class="annottext">dbAddCheckedInternal :: IO ()
</span><a href="#local-6989586621681490935"><span class="hs-identifier hs-var hs-var">dbAddCheckedInternal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; Maybe (Key BlockHeader)
forall e. TreeDbEntry e =&gt; e -&gt; Maybe (Key e)
</span><a href="Chainweb.TreeDB.html#parent"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681490931"><span class="hs-identifier hs-var">add</span></a></span><span>
</span><span id="line-309"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681490930"><span class="annot"><span class="annottext">p :: Key BlockHeader
</span><a href="#local-6989586621681490930"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
-&gt; IO
     (Maybe
        (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader)))
forall a.
IsCas a =&gt;
a -&gt; CasKeyType (CasValueType a) -&gt; IO (Maybe (CasValueType a))
</span><span class="hs-identifier hs-var">casLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490940"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490934"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHeight -&gt; BlockHeight
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Key BlockHeader
BlockHash
</span><a href="#local-6989586621681490930"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHeader)
-&gt; (Maybe RankedBlockHeader -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-310"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TreeDbException BlockHeaderDb -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(TreeDbException BlockHeaderDb -&gt; IO ())
-&gt; TreeDbException BlockHeaderDb -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb -&gt; TreeDbException BlockHeaderDb
forall db. DbEntry db -&gt; TreeDbException db
</span><a href="Chainweb.TreeDB.html#TreeDbParentMissing"><span class="hs-identifier hs-var">TreeDbParentMissing</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span><span> </span><span id="local-6989586621681490926"><span class="annot"><span class="annottext">pe :: BlockHeader
</span><a href="#local-6989586621681490926"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Natural
forall e. TreeDbEntry e =&gt; e -&gt; Natural
</span><a href="Chainweb.TreeDB.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; Natural
forall e. TreeDbEntry e =&gt; e -&gt; Natural
</span><a href="Chainweb.TreeDB.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490926"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>                    </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TreeDbException BlockHeaderDb -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(TreeDbException BlockHeaderDb -&gt; IO ())
-&gt; TreeDbException BlockHeaderDb -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb -&gt; TreeDbException BlockHeaderDb
forall db. DbEntry db -&gt; TreeDbException db
</span><a href="Chainweb.TreeDB.html#TreeDbInvalidRank"><span class="hs-identifier hs-var">TreeDbInvalidRank</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-314"></span><span>                </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681490931"><span class="hs-identifier hs-var">add</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621681490931"><span class="annot"><span class="annottext">add :: IO ()
</span><a href="#local-6989586621681490931"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [RocksDbUpdate] -&gt; IO ()
[RocksDbUpdate] -&gt; IO ()
</span><span class="hs-identifier hs-var">updateBatch</span></span><span>
</span><span id="line-318"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; RankedBlockHash -&gt; RankedBlockHeader -&gt; RocksDbUpdate
forall k v. RocksDbTable k v -&gt; k -&gt; v -&gt; RocksDbUpdate
</span><span class="hs-identifier hs-var">RocksDbInsert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490940"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RankedBlockHeader -&gt; CasKeyType RankedBlockHeader
forall v. IsCasValue v =&gt; v -&gt; CasKeyType v
</span><span class="hs-identifier hs-var">casKey</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader
</span><a href="#local-6989586621681490921"><span class="hs-identifier hs-var">rbh</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader
</span><a href="#local-6989586621681490921"><span class="hs-identifier hs-var">rbh</span></a></span><span>
</span><span id="line-319"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RocksDbTable BlockHash BlockHeight
-&gt; BlockHash -&gt; BlockHeight -&gt; RocksDbUpdate
forall k v. RocksDbTable k v -&gt; k -&gt; v -&gt; RocksDbUpdate
</span><span class="hs-identifier hs-var">RocksDbInsert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable BlockHash BlockHeight
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbRankTable"><span class="hs-identifier hs-var hs-var">_chainDbRankTable</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490940"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
</span><a href="Chainweb.BlockHeader.html#_blockHash"><span class="hs-identifier hs-var hs-var">_blockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>        </span><span id="local-6989586621681490921"><span class="annot"><span class="annottext">rbh :: RankedBlockHeader
</span><a href="#local-6989586621681490921"><span class="hs-identifier hs-var hs-var">rbh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-var">RankedBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490939"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- Initialization</span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- | Initialize a database handle</span><span>
</span><span id="line-328"></span><span class="hs-comment">--</span><span>
</span><span id="line-329"></span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#initBlockHeaderDb"><span class="hs-identifier hs-type">initBlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#Configuration"><span class="hs-identifier hs-type">Configuration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span>
</span><span id="line-330"></span><span id="initBlockHeaderDb"><span class="annot"><span class="annottext">initBlockHeaderDb :: Configuration -&gt; IO BlockHeaderDb
</span><a href="Chainweb.BlockHeaderDB.html#initBlockHeaderDb"><span class="hs-identifier hs-var hs-var">initBlockHeaderDb</span></a></span></span><span> </span><span id="local-6989586621681490920"><span class="annot"><span class="annottext">config :: Configuration
</span><a href="#local-6989586621681490920"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; BlockHeader -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#dbAddChecked"><span class="hs-identifier hs-var">dbAddChecked</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490919"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490918"><span class="hs-identifier hs-var">rootEntry</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; IO BlockHeaderDb
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490919"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621681490918"><span class="annot"><span class="annottext">rootEntry :: BlockHeader
</span><a href="#local-6989586621681490918"><span class="hs-identifier hs-var hs-var">rootEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Configuration -&gt; BlockHeader
</span><a href="Chainweb.BlockHeaderDB.html#_configRoot"><span class="hs-identifier hs-var hs-var">_configRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Configuration
</span><a href="#local-6989586621681490920"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621681490917"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681490917"><span class="hs-identifier hs-var hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainId
forall a. HasChainId a =&gt; a -&gt; ChainId
</span><a href="Chainweb.ChainId.html#_chainId"><span class="hs-identifier hs-var">_chainId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490918"><span class="hs-identifier hs-var">rootEntry</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621681490915"><span class="annot"><span class="annottext">cidNs :: ByteString
</span><a href="#local-6989586621681490915"><span class="hs-identifier hs-var hs-var">cidNs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">T.encodeUtf8</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainId -&gt; Text
forall a. HasTextRepresentation a =&gt; a -&gt; Text
</span><a href="Chainweb.Utils.html#toText"><span class="hs-identifier hs-var">toText</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681490917"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621681490912"><span class="annot"><span class="annottext">headerTable :: RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490912"><span class="hs-identifier hs-var hs-var">headerTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDb
-&gt; Codec RankedBlockHeader
-&gt; Codec RankedBlockHash
-&gt; [ByteString]
-&gt; RocksDbTable RankedBlockHash RankedBlockHeader
forall v k.
HasCallStack =&gt;
RocksDb -&gt; Codec v -&gt; Codec k -&gt; [ByteString] -&gt; RocksDbTable k v
</span><span class="hs-identifier hs-var">newTable</span></span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Configuration -&gt; RocksDb
</span><a href="Chainweb.BlockHeaderDB.html#_configRocksDb"><span class="hs-identifier hs-var hs-var">_configRocksDb</span></a></span><span> </span><span class="annot"><span class="annottext">Configuration
</span><a href="#local-6989586621681490920"><span class="hs-identifier hs-var">config</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RankedBlockHeader -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *).
    MonadThrow m =&gt;
    ByteString -&gt; m RankedBlockHeader)
-&gt; Codec RankedBlockHeader
forall a.
(a -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *). MonadThrow m =&gt; ByteString -&gt; m a)
-&gt; Codec a
</span><span class="hs-identifier hs-var">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString)
-&gt; (RankedBlockHeader -&gt; Put) -&gt; RankedBlockHeader -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; RankedBlockHeader -&gt; m ()
</span><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHeader"><span class="hs-identifier hs-var">encodeRankedBlockHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Get RankedBlockHeader -&gt; ByteString -&gt; m RankedBlockHeader
forall (m :: * -&gt; *) a. MonadThrow m =&gt; Get a -&gt; ByteString -&gt; m a
</span><a href="Chainweb.Utils.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get RankedBlockHeader
forall (m :: * -&gt; *). MonadGet m =&gt; m RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHeader"><span class="hs-identifier hs-var">decodeRankedBlockHeader</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RankedBlockHash -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *).
    MonadThrow m =&gt;
    ByteString -&gt; m RankedBlockHash)
-&gt; Codec RankedBlockHash
forall a.
(a -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *). MonadThrow m =&gt; ByteString -&gt; m a)
-&gt; Codec a
</span><span class="hs-identifier hs-var">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString)
-&gt; (RankedBlockHash -&gt; Put) -&gt; RankedBlockHash -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; RankedBlockHash -&gt; m ()
</span><a href="Chainweb.BlockHeaderDB.html#encodeRankedBlockHash"><span class="hs-identifier hs-var">encodeRankedBlockHash</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Get RankedBlockHash -&gt; ByteString -&gt; m RankedBlockHash
forall (m :: * -&gt; *) a. MonadThrow m =&gt; Get a -&gt; ByteString -&gt; m a
</span><a href="Chainweb.Utils.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get RankedBlockHash
forall (m :: * -&gt; *). MonadGet m =&gt; m RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.html#decodeRankedBlockHash"><span class="hs-identifier hs-var">decodeRankedBlockHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;BlockHeader&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490915"><span class="hs-identifier hs-var">cidNs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;header&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621681490908"><span class="annot"><span class="annottext">rankTable :: RocksDbTable BlockHash BlockHeight
</span><a href="#local-6989586621681490908"><span class="hs-identifier hs-var hs-var">rankTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDb
-&gt; Codec BlockHeight
-&gt; Codec BlockHash
-&gt; [ByteString]
-&gt; RocksDbTable BlockHash BlockHeight
forall v k.
HasCallStack =&gt;
RocksDb -&gt; Codec v -&gt; Codec k -&gt; [ByteString] -&gt; RocksDbTable k v
</span><span class="hs-identifier hs-var">newTable</span></span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Configuration -&gt; RocksDb
</span><a href="Chainweb.BlockHeaderDB.html#_configRocksDb"><span class="hs-identifier hs-var hs-var">_configRocksDb</span></a></span><span> </span><span class="annot"><span class="annottext">Configuration
</span><a href="#local-6989586621681490920"><span class="hs-identifier hs-var">config</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHeight -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *).
    MonadThrow m =&gt;
    ByteString -&gt; m BlockHeight)
-&gt; Codec BlockHeight
forall a.
(a -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *). MonadThrow m =&gt; ByteString -&gt; m a)
-&gt; Codec a
</span><span class="hs-identifier hs-var">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString)
-&gt; (BlockHeight -&gt; Put) -&gt; BlockHeight -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHeight -&gt; m ()
</span><a href="Chainweb.BlockHeader.html#encodeBlockHeight"><span class="hs-identifier hs-var">encodeBlockHeight</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Get BlockHeight -&gt; ByteString -&gt; m BlockHeight
forall (m :: * -&gt; *) a. MonadThrow m =&gt; Get a -&gt; ByteString -&gt; m a
</span><a href="Chainweb.Utils.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get BlockHeight
forall (m :: * -&gt; *). MonadGet m =&gt; m BlockHeight
</span><a href="Chainweb.BlockHeader.html#decodeBlockHeight"><span class="hs-identifier hs-var">decodeBlockHeight</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BlockHash -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *).
    MonadThrow m =&gt;
    ByteString -&gt; m BlockHash)
-&gt; Codec BlockHash
forall a.
(a -&gt; ByteString)
-&gt; (forall (m :: * -&gt; *). MonadThrow m =&gt; ByteString -&gt; m a)
-&gt; Codec a
</span><span class="hs-identifier hs-var">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="Chainweb.Utils.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="annot"><span class="annottext">(Put -&gt; ByteString)
-&gt; (BlockHash -&gt; Put) -&gt; BlockHash -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; Put
forall (m :: * -&gt; *). MonadPut m =&gt; BlockHash -&gt; m ()
</span><a href="Chainweb.BlockHash.html#encodeBlockHash"><span class="hs-identifier hs-var">encodeBlockHash</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Get BlockHash -&gt; ByteString -&gt; m BlockHash
forall (m :: * -&gt; *) a. MonadThrow m =&gt; Get a -&gt; ByteString -&gt; m a
</span><a href="Chainweb.Utils.html#runGet"><span class="hs-identifier hs-var">runGet</span></a></span><span> </span><span class="annot"><span class="annottext">Get BlockHash
forall (m :: * -&gt; *). MonadGet m =&gt; m BlockHash
</span><a href="Chainweb.BlockHash.html#decodeBlockHash"><span class="hs-identifier hs-var">decodeBlockHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;BlockHeader&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681490915"><span class="hs-identifier hs-var">cidNs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;rank&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681490919"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490919"><span class="hs-identifier hs-var hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainId
-&gt; ChainwebVersion
-&gt; RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; RocksDbTable BlockHash BlockHeight
-&gt; BlockHeaderDb
</span><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-var">BlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681490917"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; ChainwebVersion
forall a. HasChainwebVersion a =&gt; a -&gt; ChainwebVersion
</span><a href="Chainweb.Version.html#_chainwebVersion"><span class="hs-identifier hs-var">_chainwebVersion</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490918"><span class="hs-identifier hs-var">rootEntry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490912"><span class="hs-identifier hs-var">headerTable</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTable BlockHash BlockHeight
</span><a href="#local-6989586621681490908"><span class="hs-identifier hs-var">rankTable</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span class="hs-comment">-- | Close a database handle and release all resources</span><span>
</span><span id="line-356"></span><span class="hs-comment">--</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#closeBlockHeaderDb"><span class="hs-identifier hs-type">closeBlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span id="closeBlockHeaderDb"><span class="annot"><span class="annottext">closeBlockHeaderDb :: BlockHeaderDb -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#closeBlockHeaderDb"><span class="hs-identifier hs-var hs-var">closeBlockHeaderDb</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span id="local-6989586621681490903"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#withBlockHeaderDb"><span class="hs-identifier hs-type">withBlockHeaderDb</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RocksDb</span></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681490903"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681490903"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-366"></span><span id="withBlockHeaderDb"><span class="annot"><span class="annottext">withBlockHeaderDb :: RocksDb
-&gt; ChainwebVersion -&gt; ChainId -&gt; (BlockHeaderDb -&gt; IO b) -&gt; IO b
</span><a href="Chainweb.BlockHeaderDB.html#withBlockHeaderDb"><span class="hs-identifier hs-var hs-var">withBlockHeaderDb</span></a></span></span><span> </span><span id="local-6989586621681490902"><span class="annot"><span class="annottext">db :: RocksDb
</span><a href="#local-6989586621681490902"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490901"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681490901"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681490900"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681490900"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO BlockHeaderDb
-&gt; (BlockHeaderDb -&gt; IO ()) -&gt; (BlockHeaderDb -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="annot"><span class="annottext">IO BlockHeaderDb
</span><a href="#local-6989586621681490898"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#closeBlockHeaderDb"><span class="hs-identifier hs-var">closeBlockHeaderDb</span></a></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-368"></span><span>    </span><span id="local-6989586621681490898"><span class="annot"><span class="annottext">start :: IO BlockHeaderDb
</span><a href="#local-6989586621681490898"><span class="hs-identifier hs-var hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Configuration -&gt; IO BlockHeaderDb
</span><a href="Chainweb.BlockHeaderDB.html#initBlockHeaderDb"><span class="hs-identifier hs-var">initBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">$WConfiguration :: BlockHeader -&gt; RocksDb -&gt; Configuration
</span><a href="Chainweb.BlockHeaderDB.html#%24WConfiguration"><span class="hs-identifier hs-type hs-type">Configuration</span></a></span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_configRoot :: BlockHeader
</span><a href="Chainweb.BlockHeaderDB.html#_configRoot"><span class="hs-identifier hs-var">_configRoot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; ChainId -&gt; BlockHeader
forall p. HasChainId p =&gt; ChainwebVersion -&gt; p -&gt; BlockHeader
</span><a href="Chainweb.BlockHeader.Genesis.html#genesisBlockHeader"><span class="hs-identifier hs-var">genesisBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681490901"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681490900"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_configRocksDb :: RocksDb
</span><a href="Chainweb.BlockHeaderDB.html#_configRocksDb"><span class="hs-identifier hs-var">_configRocksDb</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDb
</span><a href="#local-6989586621681490902"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-371"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- TreeDB instance</span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | TODO provide more efficient branchEntries implementation that uses</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- iterators.</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681490886"><span id="local-6989586621681490888"><span id="local-6989586621681490890"><span class="annot"><a href="Chainweb.TreeDB.html#TreeDb"><span class="hs-identifier hs-type">TreeDb</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="DbEntry"><span class="annot"><a href="Chainweb.TreeDB.html#DbEntry"><span class="hs-identifier hs-var">DbEntry</span></a></span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>    </span><span id="local-6989586621681490881"><span class="annot"><span class="annottext">lookup :: BlockHeaderDb
-&gt; DbKey BlockHeaderDb -&gt; IO (Maybe (DbEntry BlockHeaderDb))
</span><a href="Chainweb.TreeDB.html#lookup"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookup</span></a></span></span><span> </span><span id="local-6989586621681490879"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490879"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490878"><span class="annot"><span class="annottext">h :: DbKey BlockHeaderDb
</span><a href="#local-6989586621681490878"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT IO BlockHeader -&gt; IO (Maybe (DbEntry BlockHeaderDb))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT IO BlockHeader -&gt; IO (Maybe (DbEntry BlockHeaderDb)))
-&gt; MaybeT IO BlockHeader -&gt; IO (Maybe (DbEntry BlockHeaderDb))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-comment">-- lookup rank</span><span>
</span><span id="line-384"></span><span>        </span><span id="local-6989586621681490876"><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490876"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe BlockHeight) -&gt; MaybeT IO BlockHeight
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe BlockHeight) -&gt; MaybeT IO BlockHeight)
-&gt; IO (Maybe BlockHeight) -&gt; MaybeT IO BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTable BlockHash BlockHeight
-&gt; BlockHash -&gt; IO (Maybe BlockHeight)
forall k v. RocksDbTable k v -&gt; k -&gt; IO (Maybe v)
</span><span class="hs-identifier hs-var">tableLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable BlockHash BlockHeight
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbRankTable"><span class="hs-identifier hs-var hs-var">_chainDbRankTable</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490879"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb
BlockHash
</span><a href="#local-6989586621681490878"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- lookup header</span><span>
</span><span id="line-387"></span><span>        </span><span id="local-6989586621681490873"><span class="annot"><span class="annottext">RankedBlockHeader
</span><a href="#local-6989586621681490873"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHeader) -&gt; MaybeT IO RankedBlockHeader
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe RankedBlockHeader) -&gt; MaybeT IO RankedBlockHeader)
-&gt; IO (Maybe RankedBlockHeader) -&gt; MaybeT IO RankedBlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
-&gt; IO
     (Maybe
        (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader)))
forall a.
IsCas a =&gt;
a -&gt; CasKeyType (CasValueType a) -&gt; IO (Maybe (CasValueType a))
</span><span class="hs-identifier hs-var">casLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490879"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CasKeyType
   (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
 -&gt; IO (Maybe RankedBlockHeader))
-&gt; CasKeyType
     (CasValueType (RocksDbTable RankedBlockHash RankedBlockHeader))
-&gt; IO (Maybe RankedBlockHeader)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490876"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb
BlockHash
</span><a href="#local-6989586621681490878"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">BlockHeader -&gt; MaybeT IO BlockHeader
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; MaybeT IO BlockHeader)
-&gt; BlockHeader -&gt; MaybeT IO BlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader -&gt; BlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_getRankedBlockHeader"><span class="hs-identifier hs-var hs-var">_getRankedBlockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader
</span><a href="#local-6989586621681490873"><span class="hs-identifier hs-var">rh</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#lookup"><span class="hs-pragma hs-type">lookup</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>    </span><span id="local-6989586621681490871"><span class="annot"><span class="annottext">entries :: BlockHeaderDb
-&gt; Maybe (NextItem (DbKey BlockHeaderDb))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a)
-&gt; IO a
</span><a href="#local-6989586621681490871"><span class="hs-identifier hs-var hs-var hs-var hs-var">entries</span></a></span></span><span> </span><span id="local-6989586621681490870"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490870"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490869"><span class="annot"><span class="annottext">k :: Maybe (NextItem (DbKey BlockHeaderDb))
</span><a href="#local-6989586621681490869"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681490868"><span class="annot"><span class="annottext">l :: Maybe Limit
</span><a href="#local-6989586621681490868"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681490867"><span class="annot"><span class="annottext">mir :: Maybe MinRank
</span><a href="#local-6989586621681490867"><span class="hs-identifier hs-var">mir</span></a></span></span><span> </span><span id="local-6989586621681490866"><span class="annot"><span class="annottext">mar :: Maybe MaxRank
</span><a href="#local-6989586621681490866"><span class="hs-identifier hs-var">mar</span></a></span></span><span> </span><span id="local-6989586621681490865"><span class="annot"><span class="annottext">f :: Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
</span><a href="#local-6989586621681490865"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
forall a.
BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.BlockHeaderDB.html#withSeekTreeDb"><span class="hs-identifier hs-var">withSeekTreeDb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490870"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem (DbKey BlockHeaderDb))
Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490869"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
</span><a href="#local-6989586621681490867"><span class="hs-identifier hs-var">mir</span></a></span><span> </span><span class="annot"><span class="annottext">((RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
 -&gt; IO a)
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681490863"><span class="annot"><span class="annottext">it :: RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490863"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
</span><a href="#local-6989586621681490865"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a)
-&gt; Stream (Of (DbEntry BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; Stream (Of RankedBlockHeader) IO ()
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
RocksDbTableIter k v -&gt; Stream (Of v) m ()
</span><span class="hs-identifier hs-var">iterToValueStream</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490863"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of RankedBlockHeader) IO ()
-&gt; (Stream (Of RankedBlockHeader) IO ()
    -&gt; Stream (Of BlockHeader) IO ())
-&gt; Stream (Of BlockHeader) IO ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(RankedBlockHeader -&gt; BlockHeader)
-&gt; Stream (Of RankedBlockHeader) IO ()
-&gt; Stream (Of BlockHeader) IO ()
forall (m :: * -&gt; *) a b r.
Monad m =&gt;
(a -&gt; b) -&gt; Stream (Of a) m r -&gt; Stream (Of b) m r
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHeader -&gt; BlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_getRankedBlockHeader"><span class="hs-identifier hs-var hs-var">_getRankedBlockHeader</span></a></span><span>
</span><span id="line-395"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of BlockHeader) IO ()
-&gt; (Stream (Of BlockHeader) IO () -&gt; Stream (Of BlockHeader) IO ())
-&gt; Stream (Of BlockHeader) IO ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Stream (Of BlockHeader) IO () -&gt; Stream (Of BlockHeader) IO ())
-&gt; (MaxRank
    -&gt; Stream (Of BlockHeader) IO () -&gt; Stream (Of BlockHeader) IO ())
-&gt; Maybe MaxRank
-&gt; Stream (Of BlockHeader) IO ()
-&gt; Stream (Of BlockHeader) IO ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Stream (Of BlockHeader) IO () -&gt; Stream (Of BlockHeader) IO ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681490857"><span class="annot"><span class="annottext">x :: MaxRank
</span><a href="#local-6989586621681490857"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; Bool)
-&gt; Stream (Of BlockHeader) IO () -&gt; Stream (Of BlockHeader) IO ()
forall (m :: * -&gt; *) a r.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream (Of a) m r -&gt; Stream (Of a) m ()
</span><span class="hs-identifier hs-var">S.takeWhile</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681490855"><span class="annot"><span class="annottext">a :: BlockHeader
</span><a href="#local-6989586621681490855"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; MaxRank
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#_blockHeight"><span class="hs-identifier hs-var hs-var">_blockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490855"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaxRank -&gt; MaxRank -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">MaxRank
</span><a href="#local-6989586621681490857"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe MaxRank
</span><a href="#local-6989586621681490866"><span class="hs-identifier hs-var">mar</span></a></span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of BlockHeader) IO ()
-&gt; (Stream (Of BlockHeader) IO ()
    -&gt; Stream (Of BlockHeader) IO (Natural, Eos))
-&gt; Stream (Of BlockHeader) IO (Natural, Eos)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
-&gt; Stream (Of BlockHeader) IO ()
-&gt; Stream (Of BlockHeader) IO (Natural, Eos)
forall (m :: * -&gt; *) a.
Monad m =&gt;
Maybe Limit -&gt; Stream (Of a) m () -&gt; Stream (Of a) m (Natural, Eos)
</span><a href="Chainweb.TreeDB.html#limitStream"><span class="hs-identifier hs-var">limitStream</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
</span><a href="#local-6989586621681490868"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#entries"><span class="hs-pragma hs-type">entries</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621681490852"><span class="annot"><span class="annottext">keys :: BlockHeaderDb
-&gt; Maybe (NextItem (DbKey BlockHeaderDb))
-&gt; Maybe Limit
-&gt; Maybe MinRank
-&gt; Maybe MaxRank
-&gt; (Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a)
-&gt; IO a
</span><a href="#local-6989586621681490852"><span class="hs-identifier hs-var hs-var hs-var hs-var">keys</span></a></span></span><span> </span><span id="local-6989586621681490851"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490851"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490850"><span class="annot"><span class="annottext">k :: Maybe (NextItem (DbKey BlockHeaderDb))
</span><a href="#local-6989586621681490850"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681490849"><span class="annot"><span class="annottext">l :: Maybe Limit
</span><a href="#local-6989586621681490849"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681490848"><span class="annot"><span class="annottext">mir :: Maybe MinRank
</span><a href="#local-6989586621681490848"><span class="hs-identifier hs-var">mir</span></a></span></span><span> </span><span id="local-6989586621681490847"><span class="annot"><span class="annottext">mar :: Maybe MaxRank
</span><a href="#local-6989586621681490847"><span class="hs-identifier hs-var">mar</span></a></span></span><span> </span><span id="local-6989586621681490846"><span class="annot"><span class="annottext">f :: Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
</span><a href="#local-6989586621681490846"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
forall a.
BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.BlockHeaderDB.html#withSeekTreeDb"><span class="hs-identifier hs-var">withSeekTreeDb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490851"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem (DbKey BlockHeaderDb))
Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490850"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
</span><a href="#local-6989586621681490848"><span class="hs-identifier hs-var">mir</span></a></span><span> </span><span class="annot"><span class="annottext">((RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
 -&gt; IO a)
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681490845"><span class="annot"><span class="annottext">it :: RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490845"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
</span><a href="#local-6989586621681490846"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a)
-&gt; Stream (Of (DbKey BlockHeaderDb)) IO (Natural, Eos) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; Stream (Of RankedBlockHash) IO ()
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
RocksDbTableIter k v -&gt; Stream (Of k) m ()
</span><span class="hs-identifier hs-var">iterToKeyStream</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490845"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-401"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of RankedBlockHash) IO ()
-&gt; (Stream (Of RankedBlockHash) IO ()
    -&gt; Stream (Of RankedBlockHash) IO ())
-&gt; Stream (Of RankedBlockHash) IO ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Stream (Of RankedBlockHash) IO ()
 -&gt; Stream (Of RankedBlockHash) IO ())
-&gt; (MaxRank
    -&gt; Stream (Of RankedBlockHash) IO ()
    -&gt; Stream (Of RankedBlockHash) IO ())
-&gt; Maybe MaxRank
-&gt; Stream (Of RankedBlockHash) IO ()
-&gt; Stream (Of RankedBlockHash) IO ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Stream (Of RankedBlockHash) IO ()
-&gt; Stream (Of RankedBlockHash) IO ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681490843"><span class="annot"><span class="annottext">x :: MaxRank
</span><a href="#local-6989586621681490843"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RankedBlockHash -&gt; Bool)
-&gt; Stream (Of RankedBlockHash) IO ()
-&gt; Stream (Of RankedBlockHash) IO ()
forall (m :: * -&gt; *) a r.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream (Of a) m r -&gt; Stream (Of a) m ()
</span><span class="hs-identifier hs-var">S.takeWhile</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681490842"><span class="annot"><span class="annottext">a :: RankedBlockHash
</span><a href="#local-6989586621681490842"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; MaxRank
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RankedBlockHash -&gt; BlockHeight
</span><a href="Chainweb.BlockHeaderDB.Types.html#_rankedBlockHashHeight"><span class="hs-identifier hs-var hs-var">_rankedBlockHashHeight</span></a></span><span> </span><span class="annot"><span class="annottext">RankedBlockHash
</span><a href="#local-6989586621681490842"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MaxRank -&gt; MaxRank -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">MaxRank
</span><a href="#local-6989586621681490843"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe MaxRank
</span><a href="#local-6989586621681490847"><span class="hs-identifier hs-var">mar</span></a></span><span>
</span><span id="line-402"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of RankedBlockHash) IO ()
-&gt; (Stream (Of RankedBlockHash) IO ()
    -&gt; Stream (Of BlockHash) IO ())
-&gt; Stream (Of BlockHash) IO ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(RankedBlockHash -&gt; BlockHash)
-&gt; Stream (Of RankedBlockHash) IO () -&gt; Stream (Of BlockHash) IO ()
forall (m :: * -&gt; *) a b r.
Monad m =&gt;
(a -&gt; b) -&gt; Stream (Of a) m r -&gt; Stream (Of b) m r
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">RankedBlockHash -&gt; BlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#_rankedBlockHash"><span class="hs-identifier hs-var hs-var">_rankedBlockHash</span></a></span><span>
</span><span id="line-403"></span><span>            </span><span class="annot"><span class="annottext">Stream (Of BlockHash) IO ()
-&gt; (Stream (Of BlockHash) IO ()
    -&gt; Stream (Of BlockHash) IO (Natural, Eos))
-&gt; Stream (Of BlockHash) IO (Natural, Eos)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
-&gt; Stream (Of BlockHash) IO ()
-&gt; Stream (Of BlockHash) IO (Natural, Eos)
forall (m :: * -&gt; *) a.
Monad m =&gt;
Maybe Limit -&gt; Stream (Of a) m () -&gt; Stream (Of a) m (Natural, Eos)
</span><a href="Chainweb.TreeDB.html#limitStream"><span class="hs-identifier hs-var">limitStream</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Limit
</span><a href="#local-6989586621681490849"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#keys"><span class="hs-pragma hs-type">keys</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621681490839"><span class="annot"><span class="annottext">insert :: BlockHeaderDb -&gt; DbEntry BlockHeaderDb -&gt; IO ()
</span><a href="Chainweb.TreeDB.html#insert"><span class="hs-identifier hs-var hs-var hs-var hs-var">insert</span></a></span></span><span> </span><span id="local-6989586621681490837"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490837"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490836"><span class="annot"><span class="annottext">e :: DbEntry BlockHeaderDb
</span><a href="#local-6989586621681490836"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; [BlockHeader] -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#insertBlockHeaderDb"><span class="hs-identifier hs-var">insertBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490837"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DbEntry BlockHeaderDb
BlockHeader
</span><a href="#local-6989586621681490836"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#insert"><span class="hs-pragma hs-type">insert</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>    </span><span id="local-6989586621681490833"><span class="annot"><span class="annottext">maxEntry :: BlockHeaderDb -&gt; IO (DbEntry BlockHeaderDb)
</span><a href="Chainweb.TreeDB.html#maxEntry"><span class="hs-identifier hs-var hs-var hs-var hs-var">maxEntry</span></a></span></span><span> </span><span id="local-6989586621681490831"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490831"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader
    -&gt; IO BlockHeader)
-&gt; IO BlockHeader
forall k v a.
RocksDbTable k v -&gt; (RocksDbTableIter k v -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withTableIter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490831"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RocksDbTableIter RankedBlockHash RankedBlockHeader
  -&gt; IO BlockHeader)
 -&gt; IO (DbEntry BlockHeaderDb))
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader
    -&gt; IO BlockHeader)
-&gt; IO (DbEntry BlockHeaderDb)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681490829"><span class="annot"><span class="annottext">it :: RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490829"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterLast</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490829"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; IO (Maybe RankedBlockHeader)
forall (m :: * -&gt; *) k v.
(MonadIO m, MonadThrow m) =&gt;
RocksDbTableIter k v -&gt; m (Maybe v)
</span><span class="hs-identifier hs-var">tableIterValue</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490829"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHeader)
-&gt; (Maybe RankedBlockHeader -&gt; IO BlockHeader) -&gt; IO BlockHeader
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681490826"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490826"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; IO BlockHeader
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681490826"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-413"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InternalInvariantViolation -&gt; IO BlockHeader
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span>
</span><span id="line-414"></span><span>                </span><span class="annot"><span class="annottext">(InternalInvariantViolation -&gt; IO BlockHeader)
-&gt; InternalInvariantViolation -&gt; IO BlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; InternalInvariantViolation
</span><a href="Chainweb.Utils.html#InternalInvariantViolation"><span class="hs-identifier hs-var">InternalInvariantViolation</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;BlockHeaderDb.maxEntry: empty block header db&quot;</span></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#maxEntry"><span class="hs-pragma hs-type">maxEntry</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621681490824"><span class="annot"><span class="annottext">maxRank :: BlockHeaderDb -&gt; IO Natural
</span><a href="#local-6989586621681490824"><span class="hs-identifier hs-var hs-var hs-var hs-var">maxRank</span></a></span></span><span> </span><span id="local-6989586621681490823"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490823"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader
    -&gt; IO Natural)
-&gt; IO Natural
forall k v a.
RocksDbTable k v -&gt; (RocksDbTableIter k v -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withTableIter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490823"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO Natural)
 -&gt; IO Natural)
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader
    -&gt; IO Natural)
-&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681490822"><span class="annot"><span class="annottext">it :: RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490822"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterLast</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490822"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; IO (Maybe RankedBlockHash)
forall (m :: * -&gt; *) k v.
(MonadIO m, MonadThrow m) =&gt;
RocksDbTableIter k v -&gt; m (Maybe k)
</span><span class="hs-identifier hs-var">tableIterKey</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490822"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHash)
-&gt; (Maybe RankedBlockHash -&gt; IO Natural) -&gt; IO Natural
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-420"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681490820"><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490820"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; IO Natural
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; IO Natural) -&gt; Natural -&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490820"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-421"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InternalInvariantViolation -&gt; IO Natural
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="annottext">(InternalInvariantViolation -&gt; IO Natural)
-&gt; InternalInvariantViolation -&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; InternalInvariantViolation
</span><a href="Chainweb.Utils.html#InternalInvariantViolation"><span class="hs-identifier hs-var">InternalInvariantViolation</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;BlockHeaderDb.maxRank: empty block header db&quot;</span></span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#maxRank"><span class="hs-pragma hs-type">maxRank</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span id="local-6989586621681491120"><span class="annot"><a href="Chainweb.BlockHeaderDB.html#withSeekTreeDb"><span class="hs-identifier hs-type">withSeekTreeDb</span></a></span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Utils.Paging.html#NextItem"><span class="hs-identifier hs-type">NextItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#MinRank"><span class="hs-identifier hs-type">MinRank</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RocksDbTableIter</span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681491120"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681491120"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-431"></span><span id="withSeekTreeDb"><span class="annot"><span class="annottext">withSeekTreeDb :: BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
</span><a href="Chainweb.BlockHeaderDB.html#withSeekTreeDb"><span class="hs-identifier hs-var hs-var">withSeekTreeDb</span></a></span></span><span> </span><span id="local-6989586621681490819"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490819"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490818"><span class="annot"><span class="annottext">k :: Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490818"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681490817"><span class="annot"><span class="annottext">mir :: Maybe MinRank
</span><a href="#local-6989586621681490817"><span class="hs-identifier hs-var">mir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (RocksDbTableIter RankedBlockHash RankedBlockHeader)
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ())
-&gt; (RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO a)
-&gt; IO a
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; IO (RocksDbTableIter RankedBlockHash RankedBlockHeader)
</span><a href="Chainweb.BlockHeaderDB.html#seekTreeDb"><span class="hs-identifier hs-var">seekTreeDb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490819"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490818"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
</span><a href="#local-6989586621681490817"><span class="hs-identifier hs-var">mir</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ()
forall k v. RocksDbTableIter k v -&gt; IO ()
</span><span class="hs-identifier hs-var">releaseTableIter</span></span><span>
</span><span id="line-432"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#withSeekTreeDb"><span class="hs-pragma hs-type">withSeekTreeDb</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="hs-comment">-- | If @k@ is not 'Nothing', @seekTreeDb d k mir@ seeks key @k@ in @db@. If the</span><span>
</span><span id="line-435"></span><span class="hs-comment">-- key doesn't exist it throws @TreeDbKeyNotFound@. Otherwise if @k@ was</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- exclusive, it advance the iterator to the next item. If @minr@ is not</span><span>
</span><span id="line-437"></span><span class="hs-comment">-- 'Nothing' and the iterator is at a position smaller than @minr@ an invalid</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- iterator is returned. Otherwise the iterator is returned.</span><span>
</span><span id="line-439"></span><span class="hs-comment">--</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- If @k@ is 'Nothing' and @minr@ is not 'Nothing' it seeks up to @minr@ and</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- returns the iterator.</span><span>
</span><span id="line-442"></span><span class="hs-comment">--</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- If both @k@ and @minr@ are 'Nothing' it returns an iterator that points to</span><span>
</span><span id="line-444"></span><span class="hs-comment">-- the first entry in @d@.</span><span>
</span><span id="line-445"></span><span class="hs-comment">--</span><span>
</span><span id="line-446"></span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#seekTreeDb"><span class="hs-identifier hs-type">seekTreeDb</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Utils.Paging.html#NextItem"><span class="hs-identifier hs-type">NextItem</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html#MinRank"><span class="hs-identifier hs-type">MinRank</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RocksDbTableIter</span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHeader"><span class="hs-identifier hs-type">RankedBlockHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span id="seekTreeDb"><span class="annot"><span class="annottext">seekTreeDb :: BlockHeaderDb
-&gt; Maybe (NextItem BlockHash)
-&gt; Maybe MinRank
-&gt; IO (RocksDbTableIter RankedBlockHash RankedBlockHeader)
</span><a href="Chainweb.BlockHeaderDB.html#seekTreeDb"><span class="hs-identifier hs-var hs-var">seekTreeDb</span></a></span></span><span> </span><span id="local-6989586621681490815"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490815"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490814"><span class="annot"><span class="annottext">k :: Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490814"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681490813"><span class="annot"><span class="annottext">mir :: Maybe MinRank
</span><a href="#local-6989586621681490813"><span class="hs-identifier hs-var">mir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681490812"><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RocksDbTable RankedBlockHash RankedBlockHeader
-&gt; IO (RocksDbTableIter RankedBlockHash RankedBlockHeader)
forall k v. RocksDbTable k v -&gt; IO (RocksDbTableIter k v)
</span><span class="hs-identifier hs-var">createTableIter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable RankedBlockHash RankedBlockHeader
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbCas"><span class="hs-identifier hs-var hs-var">_chainDbCas</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490815"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (NextItem BlockHash)
</span><a href="#local-6989586621681490814"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
</span><a href="#local-6989586621681490813"><span class="hs-identifier hs-var">mir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-455"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681490810"><span class="annot"><span class="annottext">r :: MinRank
</span><a href="#local-6989586621681490810"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; RankedBlockHash -&gt; IO ()
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
RocksDbTableIter k v -&gt; k -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterSeek</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-457"></span><span>                </span><span class="annot"><span class="annottext">(RankedBlockHash -&gt; IO ()) -&gt; RankedBlockHash -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; BlockHeight
</span><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-var">BlockHeight</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; BlockHeight) -&gt; Word64 -&gt; BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; Word64) -&gt; Natural -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MinRank -&gt; Natural
</span><a href="Chainweb.TreeDB.html#_getMinRank"><span class="hs-identifier hs-var">_getMinRank</span></a></span><span> </span><span class="annot"><span class="annottext">MinRank
</span><a href="#local-6989586621681490810"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="Chainweb.BlockHash.html#nullBlockHash"><span class="hs-identifier hs-var">nullBlockHash</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681490805"><span class="annot"><span class="annottext">a :: NextItem BlockHash
</span><a href="#local-6989586621681490805"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>            </span><span class="hs-comment">-- Seek to cursor</span><span>
</span><span id="line-462"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681490804"><span class="annot"><span class="annottext">x :: BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NextItem BlockHash -&gt; BlockHash
forall k. NextItem k -&gt; k
</span><a href="Chainweb.Utils.Paging.html#_getNextItem"><span class="hs-identifier hs-var">_getNextItem</span></a></span><span> </span><span class="annot"><span class="annottext">NextItem BlockHash
</span><a href="#local-6989586621681490805"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-463"></span><span>            </span><span id="local-6989586621681490802"><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490802"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RocksDbTable BlockHash BlockHeight
-&gt; BlockHash -&gt; IO (Maybe BlockHeight)
forall k v. RocksDbTable k v -&gt; k -&gt; IO (Maybe v)
</span><span class="hs-identifier hs-var">tableLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; RocksDbTable BlockHash BlockHeight
</span><a href="Chainweb.BlockHeaderDB.Types.html#_chainDbRankTable"><span class="hs-identifier hs-var hs-var">_chainDbRankTable</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490815"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe BlockHeight)
-&gt; (Maybe BlockHeight -&gt; IO BlockHeight) -&gt; IO BlockHeight
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-464"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TreeDbException BlockHeaderDb -&gt; IO BlockHeight
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(TreeDbException BlockHeaderDb -&gt; IO BlockHeight)
-&gt; TreeDbException BlockHeaderDb -&gt; IO BlockHeight
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb -&gt; TreeDbException BlockHeaderDb
forall db. DbKey db -&gt; TreeDbException db
</span><a href="Chainweb.TreeDB.html#TreeDbKeyNotFound"><span class="hs-identifier hs-var">TreeDbKeyNotFound</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb
BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-465"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681490800"><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490800"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; IO BlockHeight
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490800"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-466"></span><span>            </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; RankedBlockHash -&gt; IO ()
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
RocksDbTableIter k v -&gt; k -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterSeek</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeight -&gt; BlockHash -&gt; RankedBlockHash
</span><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-var">RankedBlockHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490802"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>            </span><span class="hs-comment">-- if we don't find the cursor, throw exception</span><span>
</span><span id="line-469"></span><span>            </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; IO (Maybe RankedBlockHash)
forall (m :: * -&gt; *) k v.
(MonadIO m, MonadThrow m) =&gt;
RocksDbTableIter k v -&gt; m (Maybe k)
</span><span class="hs-identifier hs-var">tableIterKey</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHash)
-&gt; (Maybe RankedBlockHash -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-470"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681490799"><span class="annot"><span class="annottext">b :: BlockHash
</span><a href="#local-6989586621681490799"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681490799"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash -&gt; BlockHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TreeDbException BlockHeaderDb -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">(TreeDbException BlockHeaderDb -&gt; IO ())
-&gt; TreeDbException BlockHeaderDb -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb -&gt; TreeDbException BlockHeaderDb
forall db. DbKey db -&gt; TreeDbException db
</span><a href="Chainweb.TreeDB.html#TreeDbKeyNotFound"><span class="hs-identifier hs-var">TreeDbKeyNotFound</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb
BlockHash
</span><a href="#local-6989586621681490804"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-comment">-- If the cursor is exclusive, then advance the iterator</span><span>
</span><span id="line-474"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NextItem BlockHash -&gt; Bool
forall k. NextItem k -&gt; Bool
</span><a href="Chainweb.Utils.Paging.html#isExclusive"><span class="hs-identifier hs-var">isExclusive</span></a></span><span> </span><span class="annot"><span class="annottext">NextItem BlockHash
</span><a href="#local-6989586621681490805"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterNext</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span>            </span><span class="hs-comment">-- Check minimum rank. Return invalid iter if cursor is below</span><span>
</span><span id="line-477"></span><span>            </span><span class="hs-comment">-- minimum rank.</span><span>
</span><span id="line-478"></span><span>            </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; IO (Maybe RankedBlockHash)
forall (m :: * -&gt; *) k v.
(MonadIO m, MonadThrow m) =&gt;
RocksDbTableIter k v -&gt; m (Maybe k)
</span><span class="hs-identifier hs-var">tableIterKey</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe RankedBlockHash)
-&gt; (Maybe RankedBlockHash -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-479"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#RankedBlockHash"><span class="hs-identifier hs-type">RankedBlockHash</span></a></span><span> </span><span id="local-6989586621681490795"><span class="annot"><span class="annottext">r' :: BlockHeight
</span><a href="#local-6989586621681490795"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681490794"><span class="annot"><span class="annottext">m :: MinRank
</span><a href="#local-6989586621681490794"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe MinRank
</span><a href="#local-6989586621681490813"><span class="hs-identifier hs-var">mir</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockHeight -&gt; MinRank
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681490795"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">MinRank -&gt; MinRank -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">MinRank
</span><a href="#local-6989586621681490794"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader -&gt; IO ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><a href="#local-6989586621681490792"><span class="hs-identifier hs-var">invalidIter</span></a></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-480"></span><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>    </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
-&gt; IO (RocksDbTableIter RankedBlockHash RankedBlockHeader)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter RankedBlockHash RankedBlockHeader
</span><a href="#local-6989586621681490812"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-483"></span><span>    </span><span id="local-6989586621681490792"><span class="annot"><span class="annottext">invalidIter :: RocksDbTableIter k v -&gt; m ()
</span><a href="#local-6989586621681490792"><span class="hs-identifier hs-var hs-var">invalidIter</span></a></span></span><span> </span><span id="local-6989586621681490791"><span class="annot"><span class="annottext">it :: RocksDbTableIter k v
</span><a href="#local-6989586621681490791"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter k v -&gt; m ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterLast</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter k v
</span><a href="#local-6989586621681490791"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter k v -&gt; m ()
forall (m :: * -&gt; *) k v. MonadIO m =&gt; RocksDbTableIter k v -&gt; m ()
</span><span class="hs-identifier hs-var">tableIterNext</span></span><span> </span><span class="annot"><span class="annottext">RocksDbTableIter k v
</span><a href="#local-6989586621681490791"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="hs-comment">-- -------------------------------------------------------------------------- --</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- Insertions</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#insertBlockHeaderDb"><span class="hs-identifier hs-type">insertBlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.BlockHeaderDB.Types.html#BlockHeaderDb"><span class="hs-identifier hs-type">BlockHeaderDb</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Chainweb.BlockHeaderDB.html#E"><span class="hs-identifier hs-type">E</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span id="insertBlockHeaderDb"><span class="annot"><span class="annottext">insertBlockHeaderDb :: BlockHeaderDb -&gt; [BlockHeader] -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#insertBlockHeaderDb"><span class="hs-identifier hs-var hs-var">insertBlockHeaderDb</span></a></span></span><span> </span><span id="local-6989586621681490790"><span class="annot"><span class="annottext">db :: BlockHeaderDb
</span><a href="#local-6989586621681490790"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span id="local-6989586621681490789"><span class="annot"><span class="annottext">es :: [BlockHeader]
</span><a href="#local-6989586621681490789"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-comment">-- Validate set of additions</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; HashMap BlockHash BlockHeader -&gt; IO ()
forall db.
(TreeDb db, DbEntry db ~ BlockHeader) =&gt;
db -&gt; HashMap BlockHash BlockHeader -&gt; IO ()
</span><a href="Chainweb.TreeDB.Validation.html#validateAdditionsDbM"><span class="hs-identifier hs-var">validateAdditionsDbM</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490790"><span class="hs-identifier hs-var">db</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap BlockHash BlockHeader -&gt; IO ())
-&gt; HashMap BlockHash BlockHeader -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(BlockHash, BlockHeader)] -&gt; HashMap BlockHash BlockHeader
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(BlockHash, BlockHeader)] -&gt; HashMap BlockHash BlockHeader)
-&gt; [(BlockHash, BlockHeader)] -&gt; HashMap BlockHash BlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHash
forall e. TreeDbEntry e =&gt; e -&gt; Key e
</span><a href="Chainweb.TreeDB.html#key"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; BlockHash)
-&gt; (BlockHeader -&gt; BlockHeader)
-&gt; BlockHeader
-&gt; (BlockHash, BlockHeader)
forall (a :: * -&gt; * -&gt; *) b c c'.
Arrow a =&gt;
a b c -&gt; a b c' -&gt; a b (c, c')
</span><span class="hs-operator hs-var">&amp;&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockHeader
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; (BlockHash, BlockHeader))
-&gt; [BlockHeader] -&gt; [(BlockHash, BlockHeader)]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">&lt;$!&gt;</span></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621681490789"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-comment">-- add set of additions to database</span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><span class="annottext">(BlockHeader -&gt; IO ()) -&gt; [BlockHeader] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; BlockHeader -&gt; IO ()
</span><a href="Chainweb.BlockHeaderDB.html#dbAddChecked"><span class="hs-identifier hs-var">dbAddChecked</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681490790"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621681490783"><span class="hs-identifier hs-var">rankedAdditions</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621681490783"><span class="annot"><span class="annottext">rankedAdditions :: [BlockHeader]
</span><a href="#local-6989586621681490783"><span class="hs-identifier hs-var hs-var">rankedAdditions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BlockHeader -&gt; Natural) -&gt; [BlockHeader] -&gt; [BlockHeader]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sortOn</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; Natural
forall e. TreeDbEntry e =&gt; e -&gt; Natural
</span><a href="Chainweb.TreeDB.html#rank"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockHeader]
</span><a href="#local-6989586621681490789"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-498"></span></pre></body></html>