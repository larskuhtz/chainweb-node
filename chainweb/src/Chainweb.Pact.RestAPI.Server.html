<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Chainweb.Pact.RestAPI.Server</span><span>
</span><span id="line-17"></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier">PactServerData</span></a></span><span>
</span><span id="line-18"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier">PactServerData_</span></a></span><span>
</span><span id="line-19"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLog"><span class="hs-identifier">PactCmdLog</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier">SomePactServerData</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServerData"><span class="hs-identifier">somePactServerData</span></a></span><span>
</span><span id="line-22"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#pactServer"><span class="hs-identifier">pactServer</span></a></span><span>
</span><span id="line-23"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServer"><span class="hs-identifier">somePactServer</span></a></span><span>
</span><span id="line-24"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServers"><span class="hs-identifier">somePactServers</span></a></span><span>
</span><span id="line-25"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">atomically</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">retry</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">view</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^?!)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">_head</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Handler</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExceptT</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Aeson</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy.Char8</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BSL8</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Short</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SB</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.CAS</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NEL</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.html"><span class="hs-identifier">Data.Singletons</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Tuple.Strict</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Event</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ev</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">init</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Servant</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.LogLevel</span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- internal modules</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.API</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.ChainId</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pact</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.Command</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Pact.Types.Hash</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pact</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html"><span class="hs-identifier">Chainweb.BlockHash</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html"><span class="hs-identifier">Chainweb.BlockHeader</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html"><span class="hs-identifier">Chainweb.ChainId</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html"><span class="hs-identifier">Chainweb.Chainweb.ChainResources</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html"><span class="hs-identifier">Chainweb.Chainweb.CutResources</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Cut.html"><span class="hs-identifier">Chainweb.Cut</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Chainweb.CutDB.html"><span class="hs-identifier">Chainweb.CutDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CutDB</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Logger.html"><span class="hs-identifier">Chainweb.Logger</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html"><span class="hs-identifier">Chainweb.Mempool.Mempool</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier">InsertError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertType"><span class="hs-identifier">InsertType</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolBackend"><span class="hs-identifier">MempoolBackend</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier">TransactionHash</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.html"><span class="hs-identifier">Chainweb.Pact.RestAPI</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Pact.Service.Types.html"><span class="hs-identifier">Chainweb.Pact.Service.Types</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Pact.SPV.html"><span class="hs-identifier">Chainweb.Pact.SPV</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Payload.html"><span class="hs-identifier">Chainweb.Payload</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.html"><span class="hs-identifier">Chainweb.Payload.PayloadStore</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.RestAPI.Orphans.html"><span class="hs-identifier">Chainweb.RestAPI.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.RestAPI.Utils.html"><span class="hs-identifier">Chainweb.RestAPI.Utils</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.SPV.html"><span class="hs-identifier">Chainweb.SPV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.SPV.html#SpvException"><span class="hs-identifier">SpvException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.SPV.CreateProof.html"><span class="hs-identifier">Chainweb.SPV.CreateProof</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Transaction.html"><span class="hs-identifier">Chainweb.Transaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Transaction.html#ChainwebTransaction"><span class="hs-identifier">ChainwebTransaction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Transaction.html#mkPayloadWithText"><span class="hs-identifier">mkPayloadWithText</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Chainweb.TreeDB.html"><span class="hs-identifier">Chainweb.TreeDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TreeDB</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Utils.html"><span class="hs-identifier">Chainweb.Utils</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.Version.html"><span class="hs-identifier">Chainweb.Version</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Chainweb.WebPactExecutionService.html"><span class="hs-identifier">Chainweb.WebPactExecutionService</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-98"></span><span class="hs-keyword">type</span><span> </span><span id="PactServerData"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier hs-var">PactServerData</span></a></span></span><span> </span><span id="local-6989586621681509374"><span class="annot"><a href="#local-6989586621681509374"><span class="hs-identifier hs-type">logger</span></a></span></span><span> </span><span id="local-6989586621681509373"><span class="annot"><a href="#local-6989586621681509373"><span class="hs-identifier hs-type">cas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509374"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509373"><span class="hs-identifier hs-type">cas</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509374"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-keyword">newtype</span><span> </span><span id="PactServerData_"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier hs-var">PactServerData_</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509704"><span class="annot"><a href="#local-6989586621681509704"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersionT"><span class="hs-identifier hs-type">ChainwebVersionT</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509703"><span class="annot"><a href="#local-6989586621681509703"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainIdT"><span class="hs-identifier hs-type">ChainIdT</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681509706"><span class="annot"><a href="#local-6989586621681509706"><span class="hs-identifier hs-type">logger</span></a></span></span><span> </span><span id="local-6989586621681509705"><span class="annot"><a href="#local-6989586621681509705"><span class="hs-identifier hs-type">cas</span></a></span></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="PactServerData_"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier hs-var">PactServerData_</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_unPactServerData"><span class="annot"><span class="annottext">PactServerData_ v c logger cas -&gt; PactServerData logger cas
</span><a href="Chainweb.Pact.RestAPI.Server.html#_unPactServerData"><span class="hs-identifier hs-var hs-var">_unPactServerData</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier hs-type">PactServerData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509706"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509705"><span class="hs-identifier hs-type">cas</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-keyword">data</span><span> </span><span id="SomePactServerData"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-var">SomePactServerData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681509714"><span class="annot"><a href="#local-6989586621681509714"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621681509712"><span class="annot"><a href="#local-6989586621681509712"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621681509708"><span class="annot"><a href="#local-6989586621681509708"><span class="hs-identifier hs-type">logger</span></a></span></span><span> </span><span id="local-6989586621681509710"><span class="annot"><a href="#local-6989586621681509710"><span class="hs-identifier hs-type">cas</span></a></span></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Version.html#KnownChainwebVersionSymbol"><span class="hs-identifier hs-type">KnownChainwebVersionSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509714"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>       </span><span class="annot"><a href="Chainweb.ChainId.html#KnownChainIdSymbol"><span class="hs-identifier hs-type">KnownChainIdSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509712"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>       </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509710"><span class="hs-identifier hs-type">cas</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>       </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509708"><span class="hs-identifier hs-type">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span id="SomePactServerData"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-var">SomePactServerData</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier hs-type">PactServerData_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509714"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509712"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509708"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509710"><span class="hs-identifier hs-type">cas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621681509620"><span id="local-6989586621681509621"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServerData"><span class="hs-identifier hs-type">somePactServerData</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509621"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509620"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier hs-type">PactServerData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509620"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509621"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-type">SomePactServerData</span></a></span></span></span><span>
</span><span id="line-119"></span><span id="somePactServerData"><span class="annot"><span class="annottext">somePactServerData :: ChainwebVersion
-&gt; ChainId -&gt; PactServerData logger cas -&gt; SomePactServerData
</span><a href="Chainweb.Pact.RestAPI.Server.html#somePactServerData"><span class="hs-identifier hs-var hs-var">somePactServerData</span></a></span></span><span> </span><span id="local-6989586621681509369"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681509369"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681509368"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681509368"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681509367"><span class="annot"><span class="annottext">db :: PactServerData logger cas
</span><a href="#local-6989586621681509367"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; SomeChainwebVersionT
</span><a href="Chainweb.Version.html#someChainwebVersionVal"><span class="hs-identifier hs-var">someChainwebVersionVal</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681509369"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Version.html#SomeChainwebVersionT"><span class="hs-identifier hs-type">SomeChainwebVersionT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509364"><span class="annot"><span class="annottext">Proxy a
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621681509364"><span class="hs-identifier hs-type">vt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; SomeChainIdT
</span><a href="Chainweb.ChainId.html#someChainIdVal"><span class="hs-identifier hs-var">someChainIdVal</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509368"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-123"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.ChainId.html#SomeChainIdT"><span class="hs-identifier hs-type">SomeChainIdT</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509360"><span class="annot"><span class="annottext">Proxy a
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621681509360"><span class="hs-identifier hs-type">cidt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>                  </span><span class="annot"><span class="annottext">PactServerData_ a a logger cas -&gt; SomePactServerData
forall (v :: ChainwebVersionT) (c :: ChainIdT) logger
       (cas :: * -&gt; *).
(KnownChainwebVersionSymbol v, KnownChainIdSymbol c,
 PayloadCas cas, Logger logger) =&gt;
PactServerData_ v c logger cas -&gt; SomePactServerData
</span><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-var">SomePactServerData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PactServerData logger cas -&gt; PactServerData_ a a logger cas
forall (v :: ChainwebVersionT) (c :: ChainIdT) logger
       (cas :: * -&gt; *).
PactServerData logger cas -&gt; PactServerData_ v c logger cas
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier hs-var">PactServerData_</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621681509364"><span class="hs-identifier hs-type">vt</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621681509360"><span class="hs-identifier hs-type">cidt</span></a></span><span> </span><span class="annot"><span class="annottext">PactServerData logger cas
</span><a href="#local-6989586621681509367"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#pactServer"><span class="hs-identifier hs-type">pactServer</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681509640"><span class="annot"><a href="#local-6989586621681509640"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621681509639"><span class="annot"><a href="#local-6989586621681509639"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621681509638"><span class="annot"><a href="#local-6989586621681509638"><span class="hs-identifier hs-type">cas</span></a></span></span><span> </span><span id="local-6989586621681509637"><span class="annot"><a href="#local-6989586621681509637"><span class="hs-identifier hs-type">logger</span></a></span></span><span>
</span><span id="line-129"></span><span>     </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Chainweb.Version.html#KnownChainwebVersionSymbol"><span class="hs-identifier hs-type">KnownChainwebVersionSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509640"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#KnownChainIdSymbol"><span class="hs-identifier hs-type">KnownChainIdSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509639"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509638"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509637"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier hs-type">PactServerData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509637"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509638"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Server</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Pact.RestAPI.html#PactServiceApi"><span class="hs-identifier hs-type">PactServiceApi</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509640"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509639"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span id="pactServer"><span class="annot"><span class="annottext">pactServer :: PactServerData logger cas -&gt; Server (PactServiceApi v c)
</span><a href="Chainweb.Pact.RestAPI.Server.html#pactServer"><span class="hs-identifier hs-var hs-var">pactServer</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509359"><span class="annot"><span class="annottext">cut :: CutResources logger cas
</span><a href="#local-6989586621681509359"><span class="hs-identifier hs-var">cut</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681509358"><span class="annot"><span class="annottext">chain :: ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">(SubmitBatch -&gt; Handler RequestKeys)
:&lt;|&gt; ((Poll -&gt; Handler PollResponses)
      :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
            :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash))))
</span><a href="#local-6989586621681509357"><span class="hs-identifier hs-var">pactApiHandlers</span></a></span><span> </span><span class="annot"><span class="annottext">((SubmitBatch -&gt; Handler RequestKeys)
 :&lt;|&gt; ((Poll -&gt; Handler PollResponses)
       :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
             :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash)))))
-&gt; (SpvRequest -&gt; Handler TransactionOutputProofB64)
-&gt; ((SubmitBatch -&gt; Handler RequestKeys)
    :&lt;|&gt; ((Poll -&gt; Handler PollResponses)
          :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
                :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash)))))
   :&lt;|&gt; (SpvRequest -&gt; Handler TransactionOutputProofB64)
forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">SpvRequest -&gt; Handler TransactionOutputProofB64
</span><a href="#local-6989586621681509355"><span class="hs-identifier hs-var">pactSpvHandler</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621681509354"><span class="annot"><span class="annottext">cid :: Demote ChainIdT
</span><a href="#local-6989586621681509354"><span class="hs-identifier hs-var hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing c -&gt; Demote ChainIdT
forall k (a :: k). SingKind k =&gt; Sing a -&gt; Demote k
</span><a href="Data.Singletons.html#FromSing"><span class="hs-identifier hs-var">FromSing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sing c
forall (n :: ChainIdT). KnownChainIdSymbol n =&gt; Sing n
</span><a href="Chainweb.ChainId.html#SChainId"><span class="hs-identifier hs-var">SChainId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.html#Sing"><span class="hs-identifier hs-type">Sing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509639"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621681509351"><span class="annot"><span class="annottext">v :: Demote ChainwebVersionT
</span><a href="#local-6989586621681509351"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing v -&gt; Demote ChainwebVersionT
forall k (a :: k). SingKind k =&gt; Sing a -&gt; Demote k
</span><a href="Data.Singletons.html#FromSing"><span class="hs-identifier hs-var">FromSing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Sing v
forall (v :: ChainwebVersionT).
KnownChainwebVersionSymbol v =&gt;
Sing v
</span><a href="Chainweb.Version.html#SChainwebVersion"><span class="hs-identifier hs-var">SChainwebVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.html#Sing"><span class="hs-identifier hs-type">Sing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509640"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621681509349"><span class="annot"><span class="annottext">mempool :: MempoolBackend ChainwebTransaction
</span><a href="#local-6989586621681509349"><span class="hs-identifier hs-var hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainResources logger -&gt; MempoolBackend ChainwebTransaction
forall logger.
ChainResources logger -&gt; MempoolBackend ChainwebTransaction
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResMempool"><span class="hs-identifier hs-var hs-var">_chainResMempool</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span id="local-6989586621681509347"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainResources logger -&gt; logger
forall logger. ChainResources logger -&gt; logger
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResLogger"><span class="hs-identifier hs-var hs-var">_chainResLogger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621681509357"><span class="annot"><span class="annottext">pactApiHandlers :: (SubmitBatch -&gt; Handler RequestKeys)
:&lt;|&gt; ((Poll -&gt; Handler PollResponses)
      :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
            :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash))))
</span><a href="#local-6989586621681509357"><span class="hs-identifier hs-var hs-var">pactApiHandlers</span></a></span></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger
-&gt; ChainwebVersion
-&gt; MempoolBackend ChainwebTransaction
-&gt; SubmitBatch
-&gt; Handler RequestKeys
forall logger.
Logger logger =&gt;
logger
-&gt; ChainwebVersion
-&gt; MempoolBackend ChainwebTransaction
-&gt; SubmitBatch
-&gt; Handler RequestKeys
</span><a href="Chainweb.Pact.RestAPI.Server.html#sendHandler"><span class="hs-identifier hs-var">sendHandler</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Demote ChainwebVersionT
ChainwebVersion
</span><a href="#local-6989586621681509351"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolBackend ChainwebTransaction
</span><a href="#local-6989586621681509349"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="annottext">(SubmitBatch -&gt; Handler RequestKeys)
-&gt; ((Poll -&gt; Handler PollResponses)
    :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
          :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash))))
-&gt; (SubmitBatch -&gt; Handler RequestKeys)
   :&lt;|&gt; ((Poll -&gt; Handler PollResponses)
         :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
               :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash))))
forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Poll
-&gt; Handler PollResponses
forall (cas :: * -&gt; *) logger.
(PayloadCas cas, Logger logger) =&gt;
logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Poll
-&gt; Handler PollResponses
</span><a href="Chainweb.Pact.RestAPI.Server.html#pollHandler"><span class="hs-identifier hs-var">pollHandler</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509359"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="annot"><span class="annottext">Demote ChainIdT
ChainId
</span><a href="#local-6989586621681509354"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">(Poll -&gt; Handler PollResponses)
-&gt; ((ListenerRequest -&gt; Handler ListenResponse)
    :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash)))
-&gt; (Poll -&gt; Handler PollResponses)
   :&lt;|&gt; ((ListenerRequest -&gt; Handler ListenResponse)
         :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash)))
forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; ListenerRequest
-&gt; Handler ListenResponse
forall (cas :: * -&gt; *) logger.
(PayloadCas cas, Logger logger) =&gt;
logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; ListenerRequest
-&gt; Handler ListenResponse
</span><a href="Chainweb.Pact.RestAPI.Server.html#listenHandler"><span class="hs-identifier hs-var">listenHandler</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509359"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="annot"><span class="annottext">Demote ChainIdT
ChainId
</span><a href="#local-6989586621681509354"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">(ListenerRequest -&gt; Handler ListenResponse)
-&gt; (Command Text -&gt; Handler (CommandResult Hash))
-&gt; (ListenerRequest -&gt; Handler ListenResponse)
   :&lt;|&gt; (Command Text -&gt; Handler (CommandResult Hash))
forall a b. a -&gt; b -&gt; a :&lt;|&gt; b
</span><span class="hs-operator hs-var">:&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Command Text
-&gt; Handler (CommandResult Hash)
forall logger (cas :: * -&gt; *).
Logger logger =&gt;
logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Command Text
-&gt; Handler (CommandResult Hash)
</span><a href="Chainweb.Pact.RestAPI.Server.html#localHandler"><span class="hs-identifier hs-var">localHandler</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509359"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="annot"><span class="annottext">Demote ChainIdT
ChainId
</span><a href="#local-6989586621681509354"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>    </span><span id="local-6989586621681509355"><span class="annot"><span class="annottext">pactSpvHandler :: SpvRequest -&gt; Handler TransactionOutputProofB64
</span><a href="#local-6989586621681509355"><span class="hs-identifier hs-var hs-var">pactSpvHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; SpvRequest
-&gt; Handler TransactionOutputProofB64
forall (cas :: * -&gt; *) l.
(Logger l, PayloadCas cas) =&gt;
l
-&gt; CutResources l cas
-&gt; ChainId
-&gt; ChainResources l
-&gt; SpvRequest
-&gt; Handler TransactionOutputProofB64
</span><a href="Chainweb.Pact.RestAPI.Server.html#spvHandler"><span class="hs-identifier hs-var">spvHandler</span></a></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509347"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509359"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="annot"><span class="annottext">Demote ChainIdT
ChainId
</span><a href="#local-6989586621681509354"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509358"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServer"><span class="hs-identifier hs-type">somePactServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-type">SomePactServerData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.RestAPI.Utils.html#SomeServer"><span class="hs-identifier hs-type">SomeServer</span></a></span><span>
</span><span id="line-153"></span><span id="somePactServer"><span class="annot"><span class="annottext">somePactServer :: SomePactServerData -&gt; SomeServer
</span><a href="Chainweb.Pact.RestAPI.Server.html#somePactServer"><span class="hs-identifier hs-var hs-var">somePactServer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#SomePactServerData"><span class="hs-identifier hs-type">SomePactServerData</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509337"><span id="local-6989586621681509338"><span id="local-6989586621681509339"><span id="local-6989586621681509340"><span id="local-6989586621681509336"><span class="annot"><span class="annottext">PactServerData_ v c logger cas
</span><a href="#local-6989586621681509336"><span class="hs-identifier hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData_"><span class="hs-identifier hs-type">PactServerData_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509340"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509339"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509338"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509337"><span class="hs-identifier hs-type">cas</span></a></span></span></span></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy
  (('ChainwebEndpoint v
    :&gt; (ChainEndpoint c
        :&gt; (&quot;pact&quot;
            :&gt; (&quot;api&quot;
                :&gt; (&quot;v1&quot;
                    :&gt; (ApiSend :&lt;|&gt; (ApiPoll :&lt;|&gt; (ApiListen :&lt;|&gt; ApiLocal))))))))
   :&lt;|&gt; PactSpvApi v c)
-&gt; Server
     (('ChainwebEndpoint v
       :&gt; (ChainEndpoint c
           :&gt; (&quot;pact&quot;
               :&gt; (&quot;api&quot;
                   :&gt; (&quot;v1&quot;
                       :&gt; (ApiSend :&lt;|&gt; (ApiPoll :&lt;|&gt; (ApiListen :&lt;|&gt; ApiLocal))))))))
      :&lt;|&gt; PactSpvApi v c)
-&gt; SomeServer
forall a. HasServer a '[] =&gt; Proxy a -&gt; Server a -&gt; SomeServer
</span><a href="Chainweb.RestAPI.Utils.html#SomeServer"><span class="hs-identifier hs-var">SomeServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy (PactServiceApi v c)
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Pact.RestAPI.html#PactServiceApi"><span class="hs-identifier hs-type">PactServiceApi</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509340"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509339"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (v :: ChainwebVersionT) (c :: ChainIdT) (cas :: * -&gt; *)
       logger.
(KnownChainwebVersionSymbol v, KnownChainIdSymbol c,
 PayloadCas cas, Logger logger) =&gt;
PactServerData logger cas -&gt; Server (PactServiceApi v c)
forall (cas :: * -&gt; *) logger.
(KnownChainwebVersionSymbol v, KnownChainIdSymbol c,
 PayloadCas cas, Logger logger) =&gt;
PactServerData logger cas -&gt; Server (PactServiceApi v c)
</span><a href="Chainweb.Pact.RestAPI.Server.html#pactServer"><span class="hs-identifier hs-var">pactServer</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621681509340"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621681509339"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><span class="annottext">(PactServerData logger cas
 -&gt; Server
      (('ChainwebEndpoint v
        :&gt; (ChainEndpoint c
            :&gt; (&quot;pact&quot;
                :&gt; (&quot;api&quot;
                    :&gt; (&quot;v1&quot;
                        :&gt; (ApiSend :&lt;|&gt; (ApiPoll :&lt;|&gt; (ApiListen :&lt;|&gt; ApiLocal))))))))
       :&lt;|&gt; PactSpvApi v c))
-&gt; PactServerData logger cas
-&gt; Server
     (('ChainwebEndpoint v
       :&gt; (ChainEndpoint c
           :&gt; (&quot;pact&quot;
               :&gt; (&quot;api&quot;
                   :&gt; (&quot;v1&quot;
                       :&gt; (ApiSend :&lt;|&gt; (ApiPoll :&lt;|&gt; (ApiListen :&lt;|&gt; ApiLocal))))))))
      :&lt;|&gt; PactSpvApi v c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PactServerData_ v c logger cas -&gt; PactServerData logger cas
forall (v :: ChainwebVersionT) (c :: ChainIdT) logger
       (cas :: * -&gt; *).
PactServerData_ v c logger cas -&gt; PactServerData logger cas
</span><a href="Chainweb.Pact.RestAPI.Server.html#_unPactServerData"><span class="hs-identifier hs-var hs-var">_unPactServerData</span></a></span><span> </span><span class="annot"><span class="annottext">PactServerData_ v c logger cas
</span><a href="#local-6989586621681509336"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span id="local-6989586621681509333"><span id="local-6989586621681509334"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#somePactServers"><span class="hs-identifier hs-type">somePactServers</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509334"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509333"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactServerData"><span class="hs-identifier hs-type">PactServerData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509333"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509334"><span class="hs-identifier hs-type">cas</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.RestAPI.Utils.html#SomeServer"><span class="hs-identifier hs-type">SomeServer</span></a></span></span></span><span>
</span><span id="line-163"></span><span id="somePactServers"><span class="annot"><span class="annottext">somePactServers :: ChainwebVersion
-&gt; [(ChainId, PactServerData logger cas)] -&gt; SomeServer
</span><a href="Chainweb.Pact.RestAPI.Server.html#somePactServers"><span class="hs-identifier hs-var hs-var">somePactServers</span></a></span></span><span> </span><span id="local-6989586621681509332"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681509332"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><span class="annottext">[SomeServer] -&gt; SomeServer
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([SomeServer] -&gt; SomeServer)
-&gt; ([(ChainId, PactServerData logger cas)] -&gt; [SomeServer])
-&gt; [(ChainId, PactServerData logger cas)]
-&gt; SomeServer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((ChainId, PactServerData logger cas) -&gt; SomeServer)
-&gt; [(ChainId, PactServerData logger cas)] -&gt; [SomeServer]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomePactServerData -&gt; SomeServer
</span><a href="Chainweb.Pact.RestAPI.Server.html#somePactServer"><span class="hs-identifier hs-var">somePactServer</span></a></span><span> </span><span class="annot"><span class="annottext">(SomePactServerData -&gt; SomeServer)
-&gt; ((ChainId, PactServerData logger cas) -&gt; SomePactServerData)
-&gt; (ChainId, PactServerData logger cas)
-&gt; SomeServer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ChainId -&gt; PactServerData logger cas -&gt; SomePactServerData)
-&gt; (ChainId, PactServerData logger cas) -&gt; SomePactServerData
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainwebVersion
-&gt; ChainId -&gt; PactServerData logger cas -&gt; SomePactServerData
forall (cas :: * -&gt; *) logger.
(PayloadCas cas, Logger logger) =&gt;
ChainwebVersion
-&gt; ChainId -&gt; PactServerData logger cas -&gt; SomePactServerData
</span><a href="Chainweb.Pact.RestAPI.Server.html#somePactServerData"><span class="hs-identifier hs-var">somePactServerData</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681509332"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span id="local-6989586621681509328"><span id="local-6989586621681509329"></span></span><span class="hs-keyword">data</span><span> </span><span id="PactCmdLog"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLog"><span class="hs-identifier hs-var">PactCmdLog</span></a></span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="PactCmdLogSend"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogSend"><span class="hs-identifier hs-var">PactCmdLogSend</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PactCmdLogPoll"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogPoll"><span class="hs-identifier hs-var">PactCmdLogPoll</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PactCmdLogListen"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogListen"><span class="hs-identifier hs-var">PactCmdLogListen</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PactCmdLogLocal"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogLocal"><span class="hs-identifier hs-var">PactCmdLogLocal</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PactCmdLogSpv"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogSpv"><span class="hs-identifier hs-var">PactCmdLogSpv</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509317"><span id="local-6989586621681509319"><span id="local-6989586621681509321"><span class="annot"><span class="annottext">Int -&gt; PactCmdLog -&gt; ShowS
[PactCmdLog] -&gt; ShowS
PactCmdLog -&gt; String
(Int -&gt; PactCmdLog -&gt; ShowS)
-&gt; (PactCmdLog -&gt; String)
-&gt; ([PactCmdLog] -&gt; ShowS)
-&gt; Show PactCmdLog
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PactCmdLog] -&gt; ShowS
$cshowList :: [PactCmdLog] -&gt; ShowS
show :: PactCmdLog -&gt; String
$cshow :: PactCmdLog -&gt; String
showsPrec :: Int -&gt; PactCmdLog -&gt; ShowS
$cshowsPrec :: Int -&gt; PactCmdLog -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PactCmdLog -&gt; Rep PactCmdLog x)
-&gt; (forall x. Rep PactCmdLog x -&gt; PactCmdLog) -&gt; Generic PactCmdLog
forall x. Rep PactCmdLog x -&gt; PactCmdLog
forall x. PactCmdLog -&gt; Rep PactCmdLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PactCmdLog x -&gt; PactCmdLog
$cfrom :: forall x. PactCmdLog -&gt; Rep PactCmdLog x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681509305"><span id="local-6989586621681509307"><span id="local-6989586621681509309"><span id="local-6989586621681509311"><span class="annot"><span class="annottext">[PactCmdLog] -&gt; Encoding
[PactCmdLog] -&gt; Value
PactCmdLog -&gt; Encoding
PactCmdLog -&gt; Value
(PactCmdLog -&gt; Value)
-&gt; (PactCmdLog -&gt; Encoding)
-&gt; ([PactCmdLog] -&gt; Value)
-&gt; ([PactCmdLog] -&gt; Encoding)
-&gt; ToJSON PactCmdLog
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [PactCmdLog] -&gt; Encoding
$ctoEncodingList :: [PactCmdLog] -&gt; Encoding
toJSONList :: [PactCmdLog] -&gt; Value
$ctoJSONList :: [PactCmdLog] -&gt; Value
toEncoding :: PactCmdLog -&gt; Encoding
$ctoEncoding :: PactCmdLog -&gt; Encoding
toJSON :: PactCmdLog -&gt; Value
$ctoJSON :: PactCmdLog -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681509302"><span class="annot"><span class="annottext">PactCmdLog -&gt; ()
(PactCmdLog -&gt; ()) -&gt; NFData PactCmdLog
forall a. (a -&gt; ()) -&gt; NFData a
rnf :: PactCmdLog -&gt; ()
$crnf :: PactCmdLog -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></span></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- | KILLSWITCH: The logic here involving `txSilenceEndDate` is to be removed in a</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- future version of Chainweb. This prevents any &quot;real&quot; Pact transactions from</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- being submitted to the system.</span><span>
</span><span id="line-178"></span><span class="hs-comment">--</span><span>
</span><span id="line-179"></span><span id="local-6989586621681509668"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#sendHandler"><span class="hs-identifier hs-type">sendHandler</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509668"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681509668"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Version.html#ChainwebVersion"><span class="hs-identifier hs-type">ChainwebVersion</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#MempoolBackend"><span class="hs-identifier hs-type">MempoolBackend</span></a></span><span> </span><span class="annot"><a href="Chainweb.Transaction.html#ChainwebTransaction"><span class="hs-identifier hs-type">ChainwebTransaction</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SubmitBatch</span></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestKeys</span></span></span><span>
</span><span id="line-186"></span><span id="sendHandler"><span class="annot"><span class="annottext">sendHandler :: logger
-&gt; ChainwebVersion
-&gt; MempoolBackend ChainwebTransaction
-&gt; SubmitBatch
-&gt; Handler RequestKeys
</span><a href="Chainweb.Pact.RestAPI.Server.html#sendHandler"><span class="hs-identifier hs-var hs-var">sendHandler</span></a></span></span><span> </span><span id="local-6989586621681509300"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681509300"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681509299"><span class="annot"><span class="annottext">v :: ChainwebVersion
</span><a href="#local-6989586621681509299"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681509298"><span class="annot"><span class="annottext">mempool :: MempoolBackend ChainwebTransaction
</span><a href="#local-6989586621681509298"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SubmitBatch</span></span><span> </span><span id="local-6989586621681509296"><span class="annot"><span class="annottext">cmds :: NonEmpty (Command Text)
</span><a href="#local-6989586621681509296"><span class="hs-identifier hs-var">cmds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT ServerError IO RequestKeys -&gt; Handler RequestKeys
forall a. ExceptT ServerError IO a -&gt; Handler a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT ServerError IO RequestKeys -&gt; Handler RequestKeys)
-&gt; ExceptT ServerError IO RequestKeys -&gt; Handler RequestKeys
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT ServerError IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT ServerError IO ())
-&gt; IO () -&gt; ExceptT ServerError IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509293"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Command Text) -&gt; PactCmdLog
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogSend"><span class="hs-identifier hs-var">PactCmdLogSend</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Command Text)
</span><a href="#local-6989586621681509296"><span class="hs-identifier hs-var">cmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainwebVersion -&gt; Maybe (Time Micros)
</span><a href="Chainweb.Version.html#txSilenceEndDate"><span class="hs-identifier hs-var">txSilenceEndDate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainwebVersion
</span><a href="#local-6989586621681509299"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ExceptT ServerError IO RequestKeys
forall a. String -&gt; ExceptT ServerError IO a
</span><a href="#local-6989586621681509290"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Transactions are disabled until December 5&quot;</span></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Command Text -&gt; Either String ChainwebTransaction)
-&gt; NonEmpty (Command Text)
-&gt; Either String (NonEmpty ChainwebTransaction)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">Command Text -&gt; Either String ChainwebTransaction
</span><a href="Chainweb.Pact.RestAPI.Server.html#validateCommand"><span class="hs-identifier hs-var">validateCommand</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Command Text)
</span><a href="#local-6989586621681509296"><span class="hs-identifier hs-var">cmds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681509287"><span class="annot"><span class="annottext">enriched :: NonEmpty ChainwebTransaction
</span><a href="#local-6989586621681509287"><span class="hs-identifier hs-var">enriched</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509286"><span class="annot"><span class="annottext">txs :: Vector ChainwebTransaction
</span><a href="#local-6989586621681509286"><span class="hs-identifier hs-var hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ChainwebTransaction] -&gt; Vector ChainwebTransaction
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([ChainwebTransaction] -&gt; Vector ChainwebTransaction)
-&gt; [ChainwebTransaction] -&gt; Vector ChainwebTransaction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty ChainwebTransaction -&gt; [ChainwebTransaction]
forall a. NonEmpty a -&gt; [a]
</span><span class="hs-identifier hs-var">NEL.toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty ChainwebTransaction
</span><a href="#local-6989586621681509287"><span class="hs-identifier hs-var">enriched</span></a></span><span>
</span><span id="line-193"></span><span>                </span><span class="hs-comment">-- If any of the txs in the batch fail validation, we reject them all.</span><span>
</span><span id="line-194"></span><span>                </span><span class="annot"><span class="annottext">IO (Either (T2 TransactionHash InsertError) ())
-&gt; ExceptT
     ServerError IO (Either (T2 TransactionHash InsertError) ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolBackend ChainwebTransaction
-&gt; Vector ChainwebTransaction
-&gt; IO (Either (T2 TransactionHash InsertError) ())
forall t.
MempoolBackend t
-&gt; Vector t -&gt; IO (Either (T2 TransactionHash InsertError) ())
</span><a href="Chainweb.Mempool.Mempool.html#mempoolInsertCheck"><span class="hs-identifier hs-var hs-var">mempoolInsertCheck</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolBackend ChainwebTransaction
</span><a href="#local-6989586621681509298"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">Vector ChainwebTransaction
</span><a href="#local-6989586621681509286"><span class="hs-identifier hs-var">txs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT ServerError IO (Either (T2 TransactionHash InsertError) ())
-&gt; (Either (T2 TransactionHash InsertError) ()
    -&gt; ExceptT ServerError IO ())
-&gt; ExceptT ServerError IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either (T2 TransactionHash InsertError) ()
-&gt; ExceptT ServerError IO ()
</span><a href="#local-6989586621681509282"><span class="hs-identifier hs-var">checkResult</span></a></span><span>
</span><span id="line-195"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT ServerError IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolBackend ChainwebTransaction
-&gt; InsertType -&gt; Vector ChainwebTransaction -&gt; IO ()
forall t. MempoolBackend t -&gt; InsertType -&gt; Vector t -&gt; IO ()
</span><a href="Chainweb.Mempool.Mempool.html#mempoolInsert"><span class="hs-identifier hs-var hs-var">mempoolInsert</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolBackend ChainwebTransaction
</span><a href="#local-6989586621681509298"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">InsertType
</span><a href="Chainweb.Mempool.Mempool.html#UncheckedInsert"><span class="hs-identifier hs-var">UncheckedInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Vector ChainwebTransaction
</span><a href="#local-6989586621681509286"><span class="hs-identifier hs-var">txs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>                </span><span class="annot"><span class="annottext">RequestKeys -&gt; ExceptT ServerError IO RequestKeys
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RequestKeys -&gt; ExceptT ServerError IO RequestKeys)
-&gt; RequestKeys -&gt; ExceptT ServerError IO RequestKeys
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty RequestKey -&gt; RequestKeys
</span><span class="hs-identifier hs-var">RequestKeys</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty RequestKey -&gt; RequestKeys)
-&gt; NonEmpty RequestKey -&gt; RequestKeys
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ChainwebTransaction -&gt; RequestKey)
-&gt; NonEmpty ChainwebTransaction -&gt; NonEmpty RequestKey
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
</span><span class="hs-identifier hs-var">NEL.map</span></span><span> </span><span class="annot"><span class="annottext">ChainwebTransaction -&gt; RequestKey
forall a. Command a -&gt; RequestKey
</span><span class="hs-identifier hs-var">cmdToRequestKey</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty ChainwebTransaction
</span><a href="#local-6989586621681509287"><span class="hs-identifier hs-var">enriched</span></a></span><span>
</span><span id="line-197"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509275"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621681509275"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ExceptT ServerError IO RequestKeys
forall a. String -&gt; ExceptT ServerError IO a
</span><a href="#local-6989586621681509290"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ExceptT ServerError IO RequestKeys)
-&gt; String -&gt; ExceptT ServerError IO RequestKeys
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Validation failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681509275"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621681509593"><span class="annot"><a href="#local-6989586621681509290"><span class="hs-identifier hs-type">failWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681509593"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621681509290"><span class="annot"><span class="annottext">failWith :: String -&gt; ExceptT ServerError IO a
</span><a href="#local-6989586621681509290"><span class="hs-identifier hs-var hs-var">failWith</span></a></span></span><span> </span><span id="local-6989586621681509274"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621681509274"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerError -&gt; ExceptT ServerError IO a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(ServerError -&gt; ExceptT ServerError IO a)
-&gt; ServerError -&gt; ExceptT ServerError IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerError
</span><span class="hs-identifier hs-var">err400</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">errBody :: ByteString
</span><span class="hs-identifier hs-var">errBody</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BSL8.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681509274"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621681509293"><span class="annot"><span class="annottext">logg :: LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509293"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunctionJson PactCmdLog
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; logger -&gt; logger
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;send-handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509300"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621681509551"><span class="annot"><a href="#local-6989586621681509267"><span class="hs-identifier hs-type">toPactHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pact.TypedHash</span></span><span> </span><span class="annot"><a href="#local-6989586621681509551"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621681509267"><span class="annot"><span class="annottext">toPactHash :: TransactionHash -&gt; TypedHash h
</span><a href="#local-6989586621681509267"><span class="hs-identifier hs-var hs-var">toPactHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span id="local-6989586621681509265"><span class="annot"><span class="annottext">h :: ShortByteString
</span><a href="#local-6989586621681509265"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TypedHash h
forall (h :: HashAlgo). ByteString -&gt; TypedHash h
</span><span class="hs-identifier hs-var">Pact.TypedHash</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; TypedHash h) -&gt; ByteString -&gt; TypedHash h
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">SB.fromShort</span></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621681509265"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="#local-6989586621681509282"><span class="hs-identifier hs-type">checkResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#TransactionHash"><span class="hs-identifier hs-type">TransactionHash</span></a></span><span> </span><span class="annot"><a href="Chainweb.Mempool.Mempool.html#InsertError"><span class="hs-identifier hs-type">InsertError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621681509282"><span class="annot"><span class="annottext">checkResult :: Either (T2 TransactionHash InsertError) ()
-&gt; ExceptT ServerError IO ()
</span><a href="#local-6989586621681509282"><span class="hs-identifier hs-var hs-var">checkResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT ServerError IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><a href="#local-6989586621681509282"><span class="hs-identifier hs-var">checkResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681509261"><span class="annot"><span class="annottext">hash :: TransactionHash
</span><a href="#local-6989586621681509261"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621681509260"><span class="annot"><span class="annottext">insErr :: InsertError
</span><a href="#local-6989586621681509260"><span class="hs-identifier hs-var">insErr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ExceptT ServerError IO ()
forall a. String -&gt; ExceptT ServerError IO a
</span><a href="#local-6989586621681509290"><span class="hs-identifier hs-var">failWith</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ExceptT ServerError IO ())
-&gt; String -&gt; ExceptT ServerError IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;Validation failed for hash &quot;</span></span><span>
</span><span id="line-211"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypedHash Any -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(TypedHash Any -&gt; String) -&gt; TypedHash Any -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TransactionHash -&gt; TypedHash Any
forall (h :: HashAlgo). TransactionHash -&gt; TypedHash h
</span><a href="#local-6989586621681509267"><span class="hs-identifier hs-var">toPactHash</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionHash
</span><a href="#local-6989586621681509261"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-212"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;: &quot;</span></span><span>
</span><span id="line-213"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InsertError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">InsertError
</span><a href="#local-6989586621681509260"><span class="hs-identifier hs-var">insErr</span></a></span><span>
</span><span id="line-214"></span><span>                          </span><span class="hs-special">]</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span id="local-6989586621681509666"><span id="local-6989586621681509667"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#pollHandler"><span class="hs-identifier hs-type">pollHandler</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509667"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509666"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681509666"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509666"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509667"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509666"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Poll</span></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PollResponses</span></span></span></span><span>
</span><span id="line-225"></span><span id="pollHandler"><span class="annot"><span class="annottext">pollHandler :: logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Poll
-&gt; Handler PollResponses
</span><a href="Chainweb.Pact.RestAPI.Server.html#pollHandler"><span class="hs-identifier hs-var hs-var">pollHandler</span></a></span></span><span> </span><span id="local-6989586621681509257"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681509257"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681509256"><span class="annot"><span class="annottext">cutR :: CutResources logger cas
</span><a href="#local-6989586621681509256"><span class="hs-identifier hs-var">cutR</span></a></span></span><span> </span><span id="local-6989586621681509255"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681509255"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681509254"><span class="annot"><span class="annottext">chain :: ChainResources logger
</span><a href="#local-6989586621681509254"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Poll</span></span><span> </span><span id="local-6989586621681509252"><span class="annot"><span class="annottext">request :: NonEmpty RequestKey
</span><a href="#local-6989586621681509252"><span class="hs-identifier hs-var">request</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO PollResponses -&gt; Handler PollResponses
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO PollResponses -&gt; Handler PollResponses)
-&gt; IO PollResponses -&gt; Handler PollResponses
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509251"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="annottext">(PactCmdLog -&gt; IO ()) -&gt; PactCmdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty Text -&gt; PactCmdLog
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogPoll"><span class="hs-identifier hs-var">PactCmdLogPoll</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty Text -&gt; PactCmdLog) -&gt; NonEmpty Text -&gt; PactCmdLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RequestKey -&gt; Text) -&gt; NonEmpty RequestKey -&gt; NonEmpty Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; Text
</span><span class="hs-identifier hs-var">requestKeyToB16Text</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty RequestKey
</span><a href="#local-6989586621681509252"><span class="hs-identifier hs-var">request</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- get current best cut</span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621681509249"><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509249"><span class="hs-identifier hs-var">cut</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CutDb cas -&gt; IO Cut
forall (cas :: * -&gt; *). CutDb cas -&gt; IO Cut
</span><a href="Chainweb.CutDB.html#_cut"><span class="hs-identifier hs-var">CutDB._cut</span></a></span><span> </span><span class="annot"><span class="annottext">(CutDb cas -&gt; IO Cut) -&gt; CutDb cas -&gt; IO Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas -&gt; CutDb cas
forall logger (cas1 :: * -&gt; *).
CutResources logger cas1 -&gt; CutDb cas1
</span><a href="Chainweb.Chainweb.CutResources.html#_cutResCutDb"><span class="hs-identifier hs-var hs-var">_cutResCutDb</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509256"><span class="hs-identifier hs-var">cutR</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash) -&gt; PollResponses
</span><span class="hs-identifier hs-var">PollResponses</span></span><span> </span><span class="annot"><span class="annottext">(HashMap RequestKey (CommandResult Hash) -&gt; PollResponses)
-&gt; IO (HashMap RequestKey (CommandResult Hash)) -&gt; IO PollResponses
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Cut
-&gt; NonEmpty RequestKey
-&gt; IO (HashMap RequestKey (CommandResult Hash))
forall (cas :: * -&gt; *) logger.
PayloadCas cas =&gt;
CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Cut
-&gt; NonEmpty RequestKey
-&gt; IO (HashMap RequestKey (CommandResult Hash))
</span><a href="Chainweb.Pact.RestAPI.Server.html#internalPoll"><span class="hs-identifier hs-var">internalPoll</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509256"><span class="hs-identifier hs-var">cutR</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509255"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509254"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509249"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty RequestKey
</span><a href="#local-6989586621681509252"><span class="hs-identifier hs-var">request</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621681509251"><span class="annot"><span class="annottext">logg :: LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509251"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunctionJson PactCmdLog
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; logger -&gt; logger
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;poll-handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509257"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span id="local-6989586621681509664"><span id="local-6989586621681509665"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#listenHandler"><span class="hs-identifier hs-type">listenHandler</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509665"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509664"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681509664"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509664"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509665"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509664"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ListenerRequest</span></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ListenResponse</span></span></span></span><span>
</span><span id="line-242"></span><span id="listenHandler"><span class="annot"><span class="annottext">listenHandler :: logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; ListenerRequest
-&gt; Handler ListenResponse
</span><a href="Chainweb.Pact.RestAPI.Server.html#listenHandler"><span class="hs-identifier hs-var hs-var">listenHandler</span></a></span></span><span> </span><span id="local-6989586621681509243"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681509243"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681509242"><span class="annot"><span class="annottext">cutR :: CutResources logger cas
</span><a href="#local-6989586621681509242"><span class="hs-identifier hs-var">cutR</span></a></span></span><span> </span><span id="local-6989586621681509241"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681509241"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681509240"><span class="annot"><span class="annottext">chain :: ChainResources logger
</span><a href="#local-6989586621681509240"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ListenerRequest</span></span><span> </span><span id="local-6989586621681509238"><span class="annot"><span class="annottext">key :: RequestKey
</span><a href="#local-6989586621681509238"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Handler ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Handler ()) -&gt; IO () -&gt; Handler ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509237"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="annottext">(PactCmdLog -&gt; IO ()) -&gt; PactCmdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PactCmdLog
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogListen"><span class="hs-identifier hs-var">PactCmdLogListen</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PactCmdLog) -&gt; Text -&gt; PactCmdLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; Text
</span><span class="hs-identifier hs-var">requestKeyToB16Text</span></span><span> </span><span class="annot"><span class="annottext">(RequestKey -&gt; Text) -&gt; RequestKey -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509238"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">IO ListenResponse -&gt; Handler ListenResponse
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TVar Bool -&gt; IO ListenResponse) -&gt; IO ListenResponse
</span><a href="#local-6989586621681509236"><span class="hs-identifier hs-var">handleTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; IO ListenResponse
</span><a href="#local-6989586621681509235"><span class="hs-identifier hs-var">runListen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-246"></span><span>    </span><span id="local-6989586621681509237"><span class="annot"><span class="annottext">logg :: LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509237"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunctionJson PactCmdLog
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; logger -&gt; logger
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;listen-handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509243"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="#local-6989586621681509235"><span class="hs-identifier hs-type">runListen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ListenResponse</span></span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621681509235"><span class="annot"><span class="annottext">runListen :: TVar Bool -&gt; IO ListenResponse
</span><a href="#local-6989586621681509235"><span class="hs-identifier hs-var hs-var">runListen</span></a></span></span><span> </span><span id="local-6989586621681509234"><span class="annot"><span class="annottext">timedOut :: TVar Bool
</span><a href="#local-6989586621681509234"><span class="hs-identifier hs-var">timedOut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Cut -&gt; IO ListenResponse
</span><a href="#local-6989586621681509233"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Cut
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><a href="#local-6989586621681509233"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ListenResponse</span></span><span>
</span><span id="line-251"></span><span>        </span><span id="local-6989586621681509233"><span class="annot"><span class="annottext">go :: Maybe Cut -&gt; IO ListenResponse
</span><a href="#local-6989586621681509233"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681509232"><span class="annot"><span class="annottext">Maybe Cut
</span><a href="#local-6989586621681509232"><span class="hs-identifier hs-var">prevCut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>            </span><span id="local-6989586621681509231"><span class="annot"><span class="annottext">Maybe Cut
</span><a href="#local-6989586621681509231"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Cut -&gt; IO (Maybe Cut)
</span><a href="#local-6989586621681509230"><span class="hs-identifier hs-var">waitForNewCut</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Cut
</span><a href="#local-6989586621681509232"><span class="hs-identifier hs-var">prevCut</span></a></span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Cut
</span><a href="#local-6989586621681509231"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-254"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ListenResponse -&gt; IO ListenResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ListenResponse -&gt; IO ListenResponse)
-&gt; ListenResponse -&gt; IO ListenResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ListenResponse
</span><span class="hs-identifier hs-var">ListenTimeout</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681509228"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span>
</span><span id="line-255"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681509227"><span class="annot"><span class="annottext">cut :: Cut
</span><a href="#local-6989586621681509227"><span class="hs-identifier hs-var">cut</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; IO ListenResponse
</span><a href="#local-6989586621681509226"><span class="hs-identifier hs-var">poll</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509227"><span class="hs-identifier hs-var">cut</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><a href="#local-6989586621681509226"><span class="hs-identifier hs-type">poll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ListenResponse</span></span><span>
</span><span id="line-258"></span><span>        </span><span id="local-6989586621681509226"><span class="annot"><span class="annottext">poll :: Cut -&gt; IO ListenResponse
</span><a href="#local-6989586621681509226"><span class="hs-identifier hs-var hs-var">poll</span></a></span></span><span> </span><span id="local-6989586621681509225"><span class="annot"><span class="annottext">cut :: Cut
</span><a href="#local-6989586621681509225"><span class="hs-identifier hs-var">cut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>            </span><span id="local-6989586621681509224"><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash)
</span><a href="#local-6989586621681509224"><span class="hs-identifier hs-var">hm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Cut
-&gt; NonEmpty RequestKey
-&gt; IO (HashMap RequestKey (CommandResult Hash))
forall (cas :: * -&gt; *) logger.
PayloadCas cas =&gt;
CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Cut
-&gt; NonEmpty RequestKey
-&gt; IO (HashMap RequestKey (CommandResult Hash))
</span><a href="Chainweb.Pact.RestAPI.Server.html#internalPoll"><span class="hs-identifier hs-var">internalPoll</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509242"><span class="hs-identifier hs-var">cutR</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509241"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509240"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509225"><span class="hs-identifier hs-var">cut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestKey -&gt; NonEmpty RequestKey
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509238"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash) -&gt; Bool
forall k v. HashMap k v -&gt; Bool
</span><span class="hs-identifier hs-var">HM.null</span></span><span> </span><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash)
</span><a href="#local-6989586621681509224"><span class="hs-identifier hs-var">hm</span></a></span><span>
</span><span id="line-261"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Cut -&gt; IO ListenResponse
</span><a href="#local-6989586621681509233"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cut -&gt; Maybe Cut
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509225"><span class="hs-identifier hs-var">cut</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ListenResponse -&gt; IO ListenResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ListenResponse -&gt; IO ListenResponse)
-&gt; ListenResponse -&gt; IO ListenResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">CommandResult Hash -&gt; ListenResponse
</span><span class="hs-identifier hs-var">ListenResponse</span></span><span> </span><span class="annot"><span class="annottext">(CommandResult Hash -&gt; ListenResponse)
-&gt; CommandResult Hash -&gt; ListenResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RequestKey, CommandResult Hash) -&gt; CommandResult Hash
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((RequestKey, CommandResult Hash) -&gt; CommandResult Hash)
-&gt; (RequestKey, CommandResult Hash) -&gt; CommandResult Hash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(RequestKey, CommandResult Hash)]
-&gt; (RequestKey, CommandResult Hash)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([(RequestKey, CommandResult Hash)]
 -&gt; (RequestKey, CommandResult Hash))
-&gt; [(RequestKey, CommandResult Hash)]
-&gt; (RequestKey, CommandResult Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash)
-&gt; [(RequestKey, CommandResult Hash)]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">HM.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap RequestKey (CommandResult Hash)
</span><a href="#local-6989586621681509224"><span class="hs-identifier hs-var">hm</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><a href="#local-6989586621681509230"><span class="hs-identifier hs-type">waitForNewCut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>        </span><span id="local-6989586621681509230"><span class="annot"><span class="annottext">waitForNewCut :: Maybe Cut -&gt; IO (Maybe Cut)
</span><a href="#local-6989586621681509230"><span class="hs-identifier hs-var hs-var">waitForNewCut</span></a></span></span><span> </span><span id="local-6989586621681509219"><span class="annot"><span class="annottext">lastCut :: Maybe Cut
</span><a href="#local-6989586621681509219"><span class="hs-identifier hs-var">lastCut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM (Maybe Cut) -&gt; IO (Maybe Cut)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe Cut) -&gt; IO (Maybe Cut))
-&gt; STM (Maybe Cut) -&gt; IO (Maybe Cut)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>             </span><span class="hs-comment">-- TODO: we should compute greatest common ancestor here to bound the</span><span>
</span><span id="line-267"></span><span>             </span><span class="hs-comment">-- search</span><span>
</span><span id="line-268"></span><span>             </span><span id="local-6989586621681509218"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681509218"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621681509234"><span class="hs-identifier hs-var">timedOut</span></a></span><span>
</span><span id="line-269"></span><span>             </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681509218"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-270"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Cut -&gt; STM (Maybe Cut)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Cut
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Maybe Cut
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Cut -&gt; Maybe Cut) -&gt; STM Cut -&gt; STM (Maybe Cut)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>                     </span><span class="hs-glyph">!</span><span id="local-6989586621681509216"><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509216"><span class="hs-identifier hs-var">cut</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CutDb cas -&gt; STM Cut
forall (cas :: * -&gt; *). CutDb cas -&gt; STM Cut
</span><a href="Chainweb.CutDB.html#_cutStm"><span class="hs-identifier hs-var">CutDB._cutStm</span></a></span><span> </span><span class="annot"><span class="annottext">(CutDb cas -&gt; STM Cut) -&gt; CutDb cas -&gt; STM Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas -&gt; CutDb cas
forall logger (cas1 :: * -&gt; *).
CutResources logger cas1 -&gt; CutDb cas1
</span><a href="Chainweb.Chainweb.CutResources.html#_cutResCutDb"><span class="hs-identifier hs-var hs-var">_cutResCutDb</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509242"><span class="hs-identifier hs-var">cutR</span></a></span><span>
</span><span id="line-273"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Cut
</span><a href="#local-6989586621681509219"><span class="hs-identifier hs-var">lastCut</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Cut -&gt; Maybe Cut -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Cut -&gt; Maybe Cut
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509216"><span class="hs-identifier hs-var">cut</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ()
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-274"></span><span>                     </span><span class="annot"><span class="annottext">Cut -&gt; STM Cut
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509216"><span class="hs-identifier hs-var">cut</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">-- TODO: make configurable</span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621681509228"><span class="annot"><span class="annottext">defaultTimeout :: Int
</span><a href="#local-6989586621681509228"><span class="hs-identifier hs-var hs-var">defaultTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">120</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="hs-number">1000000</span></span><span>      </span><span class="hs-comment">-- two minutes</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span id="local-6989586621681509236"><span class="annot"><span class="annottext">handleTimeout :: (TVar Bool -&gt; IO ListenResponse) -&gt; IO ListenResponse
</span><a href="#local-6989586621681509236"><span class="hs-identifier hs-var hs-var">handleTimeout</span></a></span></span><span> </span><span id="local-6989586621681509212"><span class="annot"><span class="annottext">m :: TVar Bool -&gt; IO ListenResponse
</span><a href="#local-6989586621681509212"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (TVar Bool, TimeoutKey)
-&gt; ((TVar Bool, TimeoutKey) -&gt; IO ())
-&gt; ((TVar Bool, TimeoutKey) -&gt; IO ListenResponse)
-&gt; IO ListenResponse
forall (m :: * -&gt; *) a c b.
MonadMask m =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="annot"><span class="annottext">IO (TVar Bool, TimeoutKey)
</span><a href="#local-6989586621681509210"><span class="hs-identifier hs-var">init</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar Bool, TimeoutKey) -&gt; IO ()
forall a. (a, TimeoutKey) -&gt; IO ()
</span><a href="#local-6989586621681509209"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Bool -&gt; IO ListenResponse
</span><a href="#local-6989586621681509212"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar Bool -&gt; IO ListenResponse)
-&gt; ((TVar Bool, TimeoutKey) -&gt; TVar Bool)
-&gt; (TVar Bool, TimeoutKey)
-&gt; IO ListenResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TVar Bool, TimeoutKey) -&gt; TVar Bool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>        </span><span id="local-6989586621681509210"><span class="annot"><span class="annottext">init :: IO (TVar Bool, TimeoutKey)
</span><a href="#local-6989586621681509210"><span class="hs-identifier hs-var hs-var">init</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621681509208"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621681509208"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-283"></span><span>            </span><span id="local-6989586621681509206"><span class="annot"><span class="annottext">TimerManager
</span><a href="#local-6989586621681509206"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimerManager
</span><span class="hs-identifier hs-var">Ev.getSystemTimerManager</span></span><span>
</span><span id="line-284"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621681509204"><span class="annot"><span class="annottext">TimeoutKey
</span><a href="#local-6989586621681509204"><span class="hs-identifier hs-var">tkey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TimerManager -&gt; Int -&gt; IO () -&gt; IO TimeoutKey
</span><span class="hs-identifier hs-var">Ev.registerTimeout</span></span><span> </span><span class="annot"><span class="annottext">TimerManager
</span><a href="#local-6989586621681509206"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681509228"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO TimeoutKey) -&gt; IO () -&gt; IO TimeoutKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-285"></span><span>                     </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621681509208"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="annottext">(TVar Bool, TimeoutKey) -&gt; IO (TVar Bool, TimeoutKey)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((TVar Bool, TimeoutKey) -&gt; IO (TVar Bool, TimeoutKey))
-&gt; (TVar Bool, TimeoutKey) -&gt; IO (TVar Bool, TimeoutKey)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621681509208"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TimeoutKey
</span><a href="#local-6989586621681509204"><span class="hs-identifier hs-var">tkey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621681509209"><span class="annot"><span class="annottext">cleanup :: (a, TimeoutKey) -&gt; IO ()
</span><a href="#local-6989586621681509209"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681509201"><span class="annot"><span class="annottext">tkey :: TimeoutKey
</span><a href="#local-6989586621681509201"><span class="hs-identifier hs-var">tkey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>            </span><span id="local-6989586621681509200"><span class="annot"><span class="annottext">TimerManager
</span><a href="#local-6989586621681509200"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimerManager
</span><span class="hs-identifier hs-var">Ev.getSystemTimerManager</span></span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">TimerManager -&gt; TimeoutKey -&gt; IO ()
</span><span class="hs-identifier hs-var">Ev.unregisterTimeout</span></span><span> </span><span class="annot"><span class="annottext">TimerManager
</span><a href="#local-6989586621681509200"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutKey
</span><a href="#local-6989586621681509201"><span class="hs-identifier hs-var">tkey</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- TODO: reimplement local in terms of pact execution service</span><span>
</span><span id="line-292"></span><span id="local-6989586621681509662"><span id="local-6989586621681509663"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#localHandler"><span class="hs-identifier hs-type">localHandler</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509663"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681509663"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509663"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509662"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509663"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CommandResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-300"></span><span id="localHandler"><span class="annot"><span class="annottext">localHandler :: logger
-&gt; CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Command Text
-&gt; Handler (CommandResult Hash)
</span><a href="Chainweb.Pact.RestAPI.Server.html#localHandler"><span class="hs-identifier hs-var hs-var">localHandler</span></a></span></span><span> </span><span id="local-6989586621681509198"><span class="annot"><span class="annottext">logger :: logger
</span><a href="#local-6989586621681509198"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681509197"><span class="annot"><span class="annottext">cr :: ChainResources logger
</span><a href="#local-6989586621681509197"><span class="hs-identifier hs-var">cr</span></a></span></span><span> </span><span id="local-6989586621681509196"><span class="annot"><span class="annottext">cmd :: Command Text
</span><a href="#local-6989586621681509196"><span class="hs-identifier hs-var">cmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Handler ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Handler ()) -&gt; IO () -&gt; Handler ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509195"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span> </span><span class="annot"><span class="annottext">(PactCmdLog -&gt; IO ()) -&gt; PactCmdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Command Text -&gt; PactCmdLog
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogLocal"><span class="hs-identifier hs-var">PactCmdLogLocal</span></a></span><span> </span><span class="annot"><span class="annottext">Command Text
</span><a href="#local-6989586621681509196"><span class="hs-identifier hs-var">cmd</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621681509194"><span class="annot"><span class="annottext">ChainwebTransaction
</span><a href="#local-6989586621681509194"><span class="hs-identifier hs-var">cmd'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Command Text -&gt; Either String ChainwebTransaction
</span><a href="Chainweb.Pact.RestAPI.Server.html#validateCommand"><span class="hs-identifier hs-var">validateCommand</span></a></span><span> </span><span class="annot"><span class="annottext">Command Text
</span><a href="#local-6989586621681509196"><span class="hs-identifier hs-var">cmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681509193"><span class="annot"><span class="annottext">ChainwebTransaction
</span><a href="#local-6989586621681509193"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainwebTransaction -&gt; Handler ChainwebTransaction
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ChainwebTransaction
</span><a href="#local-6989586621681509193"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509192"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621681509192"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>        </span><span class="annot"><span class="annottext">ServerError -&gt; Handler ChainwebTransaction
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(ServerError -&gt; Handler ChainwebTransaction)
-&gt; ServerError -&gt; Handler ChainwebTransaction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerError
</span><span class="hs-identifier hs-var">err400</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">errBody :: ByteString
</span><span class="hs-identifier hs-var">errBody</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;Validation failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BSL8.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681509192"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621681509191"><span class="annot"><span class="annottext">Either PactException (CommandResult Hash)
</span><a href="#local-6989586621681509191"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either PactException (CommandResult Hash))
-&gt; Handler (Either PactException (CommandResult Hash))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either PactException (CommandResult Hash))
 -&gt; Handler (Either PactException (CommandResult Hash)))
-&gt; IO (Either PactException (CommandResult Hash))
-&gt; Handler (Either PactException (CommandResult Hash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PactExecutionService
-&gt; ChainwebTransaction
-&gt; IO (Either PactException (CommandResult Hash))
</span><a href="Chainweb.WebPactExecutionService.Types.html#_pactLocal"><span class="hs-identifier hs-var hs-var">_pactLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainResources logger -&gt; PactExecutionService
forall logger. ChainResources logger -&gt; PactExecutionService
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResPact"><span class="hs-identifier hs-var hs-var">_chainResPact</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509197"><span class="hs-identifier hs-var">cr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainwebTransaction
</span><a href="#local-6989586621681509194"><span class="hs-identifier hs-var">cmd'</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either PactException (CommandResult Hash)
</span><a href="#local-6989586621681509191"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-308"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509188"><span class="annot"><span class="annottext">err :: PactException
</span><a href="#local-6989586621681509188"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>        </span><span class="annot"><span class="annottext">ServerError -&gt; Handler (CommandResult Hash)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(ServerError -&gt; Handler (CommandResult Hash))
-&gt; ServerError -&gt; Handler (CommandResult Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerError
</span><span class="hs-identifier hs-var">err400</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">errBody :: ByteString
</span><span class="hs-identifier hs-var">errBody</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-string">&quot;Execution failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BSL8.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PactException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">PactException
</span><a href="#local-6989586621681509188"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681509187"><span class="annot"><span class="annottext">CommandResult Hash
</span><a href="#local-6989586621681509187"><span class="hs-identifier hs-var">r'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CommandResult Hash -&gt; Handler (CommandResult Hash)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CommandResult Hash
</span><a href="#local-6989586621681509187"><span class="hs-identifier hs-var">r'</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621681509195"><span class="annot"><span class="annottext">logg :: LogLevel -&gt; PactCmdLog -&gt; IO ()
</span><a href="#local-6989586621681509195"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">logger -&gt; LogFunctionJson PactCmdLog
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; logger -&gt; logger
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;local-handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">logger
</span><a href="#local-6989586621681509198"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#spvHandler"><span class="hs-identifier hs-type">spvHandler</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681509660"><span class="annot"><a href="#local-6989586621681509660"><span class="hs-identifier hs-type">cas</span></a></span></span><span> </span><span id="local-6989586621681509661"><span class="annot"><a href="#local-6989586621681509661"><span class="hs-identifier hs-type">l</span></a></span></span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Chainweb.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509661"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509660"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681509661"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509661"><span class="hs-identifier hs-type">l</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509660"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-comment">-- ^ cut resources contain the cut, payload, and</span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-comment">-- block db</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-325"></span><span>        </span><span class="hs-comment">-- ^ the chain id of the source chain id used in the</span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-comment">-- execution of a cross-chain-transfer.</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509661"><span class="hs-identifier hs-type">l</span></a></span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-comment">-- ^ chain resources contain a pact service</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Pact.Service.Types.html#SpvRequest"><span class="hs-identifier hs-type">SpvRequest</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-comment">-- ^ Contains the (pact) chain id of the target chain id used in the</span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- 'target-chain' field of a cross-chain-transfer.</span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-comment">-- Also contains the request key of of the cross-chain transfer</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- tx request.</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handler</span></span><span> </span><span class="annot"><a href="Chainweb.Pact.Service.Types.html#TransactionOutputProofB64"><span class="hs-identifier hs-type">TransactionOutputProofB64</span></a></span><span>
</span><span id="line-335"></span><span id="spvHandler"><span class="annot"><span class="annottext">spvHandler :: l
-&gt; CutResources l cas
-&gt; ChainId
-&gt; ChainResources l
-&gt; SpvRequest
-&gt; Handler TransactionOutputProofB64
</span><a href="Chainweb.Pact.RestAPI.Server.html#spvHandler"><span class="hs-identifier hs-var hs-var">spvHandler</span></a></span></span><span> </span><span id="local-6989586621681509186"><span class="annot"><span class="annottext">l :: l
</span><a href="#local-6989586621681509186"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681509185"><span class="annot"><span class="annottext">cutR :: CutResources l cas
</span><a href="#local-6989586621681509185"><span class="hs-identifier hs-var">cutR</span></a></span></span><span> </span><span id="local-6989586621681509184"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681509184"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681509183"><span class="annot"><span class="annottext">chainR :: ChainResources l
</span><a href="#local-6989586621681509183"><span class="hs-identifier hs-var">chainR</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Pact.Service.Types.html#SpvRequest"><span class="hs-identifier hs-type">SpvRequest</span></a></span><span> </span><span id="local-6989586621681509181"><span class="annot"><span class="annottext">rk :: RequestKey
</span><a href="#local-6989586621681509181"><span class="hs-identifier hs-var">rk</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pact.ChainId</span></span><span> </span><span id="local-6989586621681509179"><span class="annot"><span class="annottext">ptid :: Text
</span><a href="#local-6989586621681509179"><span class="hs-identifier hs-var">ptid</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Handler ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Handler ()) -&gt; IO () -&gt; Handler ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><a href="#local-6989586621681509178"><span class="hs-identifier hs-var">logg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256 -&gt; Text
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509176"><span class="hs-identifier hs-var">ph</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621681509175"><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509175"><span class="hs-identifier hs-var">cut</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Cut -&gt; Handler Cut
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Cut -&gt; Handler Cut) -&gt; IO Cut -&gt; Handler Cut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">CutDb cas -&gt; IO Cut
forall (cas :: * -&gt; *). CutDb cas -&gt; IO Cut
</span><a href="Chainweb.CutDB.html#_cut"><span class="hs-identifier hs-var">CutDB._cut</span></a></span><span> </span><span class="annot"><span class="annottext">CutDb cas
</span><a href="#local-6989586621681509174"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-339"></span><span>    </span><span id="local-6989586621681509173"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509173"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO BlockHeader -&gt; Handler BlockHeader
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO BlockHeader -&gt; Handler BlockHeader)
-&gt; IO BlockHeader -&gt; Handler BlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; Cut -&gt; IO BlockHeader
forall (m :: * -&gt; *) cid.
(MonadThrow m, HasChainId cid) =&gt;
cid -&gt; Cut -&gt; m BlockHeader
</span><a href="Chainweb.Cut.html#lookupCutM"><span class="hs-identifier hs-var">lookupCutM</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509184"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509175"><span class="hs-identifier hs-var">cut</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span id="local-6989586621681509171"><span class="annot"><span class="annottext">bhe :: BlockHeight
</span><a href="#local-6989586621681509171"><span class="hs-identifier hs-var">bhe</span></a></span></span><span> </span><span id="local-6989586621681509170"><span class="annot"><span class="annottext">_bha :: BlockHash
</span><a href="#local-6989586621681509170"><span class="hs-identifier hs-var">_bha</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO
  (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; Handler
     (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PactExecutionService
-&gt; Either ChainId BlockHeader
-&gt; Vector (TypedHash 'Blake2b_256)
-&gt; IO
     (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
</span><a href="Chainweb.WebPactExecutionService.Types.html#_pactLookup"><span class="hs-identifier hs-var hs-var">_pactLookup</span></a></span><span> </span><span class="annot"><span class="annottext">PactExecutionService
</span><a href="#local-6989586621681509168"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Either ChainId BlockHeader
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509173"><span class="hs-identifier hs-var">bh</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256 -&gt; Vector (TypedHash 'Blake2b_256)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509176"><span class="hs-identifier hs-var">ph</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Handler
  (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; (Either
      PactException (Vector (Maybe (T2 BlockHeight BlockHash)))
    -&gt; Handler (T2 BlockHeight BlockHash))
-&gt; Handler (T2 BlockHeight BlockHash)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-342"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509167"><span class="annot"><span class="annottext">e :: PactException
</span><a href="#local-6989586621681509167"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; Handler (T2 BlockHeight BlockHash)
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler (T2 BlockHeight BlockHash))
-&gt; ByteString -&gt; Handler (T2 BlockHeight BlockHash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: transaction hash lookup failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PactException -&gt; ByteString
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">PactException
</span><a href="#local-6989586621681509167"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-344"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681509165"><span class="annot"><span class="annottext">v :: Vector (Maybe (T2 BlockHeight BlockHash))
</span><a href="#local-6989586621681509165"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Vector (Maybe (T2 BlockHeight BlockHash))
</span><a href="#local-6989586621681509165"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Maybe (T2 BlockHeight BlockHash))
-&gt; Getting
     (Endo (Maybe (T2 BlockHeight BlockHash)))
     (Vector (Maybe (T2 BlockHeight BlockHash)))
     (Maybe (T2 BlockHeight BlockHash))
-&gt; Maybe (T2 BlockHeight BlockHash)
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Endo (Maybe (T2 BlockHeight BlockHash)))
  (Vector (Maybe (T2 BlockHeight BlockHash)))
  (Maybe (T2 BlockHeight BlockHash))
forall s a. Cons s s a a =&gt; Traversal' s a
</span><span class="hs-identifier hs-var">_head</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Handler (T2 BlockHeight BlockHash)
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler (T2 BlockHeight BlockHash))
-&gt; ByteString -&gt; Handler (T2 BlockHeight BlockHash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Transaction hash not found: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256 -&gt; ByteString
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509176"><span class="hs-identifier hs-var">ph</span></a></span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681509164"><span class="annot"><span class="annottext">t :: T2 BlockHeight BlockHash
</span><a href="#local-6989586621681509164"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">T2 BlockHeight BlockHash -&gt; Handler (T2 BlockHeight BlockHash)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">T2 BlockHeight BlockHash
</span><a href="#local-6989586621681509164"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621681509163"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681509163"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either Text Int) -&gt; Handler (Either Text Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeaderDb
-&gt; PayloadDb cas
-&gt; BlockHeight
-&gt; TypedHash 'Blake2b_256
-&gt; IO (Either Text Int)
forall (cas :: * -&gt; *).
(HasCallStack, PayloadCas cas) =&gt;
BlockHeaderDb
-&gt; PayloadDb cas
-&gt; BlockHeight
-&gt; TypedHash 'Blake2b_256
-&gt; IO (Either Text Int)
</span><a href="Chainweb.Pact.SPV.html#getTxIdx"><span class="hs-identifier hs-var">getTxIdx</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681509161"><span class="hs-identifier hs-var">bdb</span></a></span><span> </span><span class="annot"><span class="annottext">PayloadDb cas
</span><a href="#local-6989586621681509160"><span class="hs-identifier hs-var">pdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681509171"><span class="hs-identifier hs-var">bhe</span></a></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509176"><span class="hs-identifier hs-var">ph</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Handler (Either Text Int)
-&gt; (Either Text Int -&gt; Handler Int) -&gt; Handler Int
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509159"><span class="annot"><span class="annottext">e :: Text
</span><a href="#local-6989586621681509159"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Handler Int
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler Int) -&gt; ByteString -&gt; Handler Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: Index lookup for hash failed: &quot;</span></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
forall a b. (Show a, IsString b) =&gt; a -&gt; b
</span><a href="Chainweb.Utils.html#sshow"><span class="hs-identifier hs-var">sshow</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681509159"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681509158"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621681509158"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Handler Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681509158"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621681509157"><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509157"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Handler ChainId
forall (m :: * -&gt; *). MonadThrow m =&gt; Text -&gt; m ChainId
</span><a href="Chainweb.ChainId.html#chainIdFromText"><span class="hs-identifier hs-var">chainIdFromText</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681509179"><span class="hs-identifier hs-var">ptid</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621681509155"><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256
</span><a href="#local-6989586621681509155"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either SpvException (TransactionOutputProof SHA512t_256))
-&gt; Handler
     (Either SpvException (TransactionOutputProof SHA512t_256))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (TransactionOutputProof SHA512t_256)
-&gt; IO (Either SpvException (TransactionOutputProof SHA512t_256))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(IO (TransactionOutputProof SHA512t_256)
 -&gt; IO (Either SpvException (TransactionOutputProof SHA512t_256)))
-&gt; IO (TransactionOutputProof SHA512t_256)
-&gt; IO (Either SpvException (TransactionOutputProof SHA512t_256))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CutDb cas
-&gt; ChainId
-&gt; ChainId
-&gt; BlockHeight
-&gt; Int
-&gt; IO (TransactionOutputProof SHA512t_256)
forall (cas :: * -&gt; *).
(HasCallStack, PayloadCas cas) =&gt;
CutDb cas
-&gt; ChainId
-&gt; ChainId
-&gt; BlockHeight
-&gt; Int
-&gt; IO (TransactionOutputProof SHA512t_256)
</span><a href="Chainweb.SPV.CreateProof.html#createTransactionOutputProof"><span class="hs-identifier hs-var">createTransactionOutputProof</span></a></span><span> </span><span class="annot"><span class="annottext">CutDb cas
</span><a href="#local-6989586621681509174"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509157"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509184"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeight
</span><a href="#local-6989586621681509171"><span class="hs-identifier hs-var">bhe</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681509163"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Handler (Either SpvException (TransactionOutputProof SHA512t_256))
-&gt; (Either SpvException (TransactionOutputProof SHA512t_256)
    -&gt; Handler (TransactionOutputProof SHA512t_256))
-&gt; Handler (TransactionOutputProof SHA512t_256)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509152"><span class="annot"><span class="annottext">e :: SpvException
</span><a href="#local-6989586621681509152"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.SPV.html#SpvExceptionTargetNotReachable"><span class="hs-identifier hs-type">SpvExceptionTargetNotReachable</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler (TransactionOutputProof SHA512t_256))
-&gt; ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;SPV target not reachable: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SpvException -&gt; ByteString
</span><a href="#local-6989586621681509150"><span class="hs-identifier hs-var">spvErrOf</span></a></span><span> </span><span class="annot"><span class="annottext">SpvException
</span><a href="#local-6989586621681509152"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509149"><span class="annot"><span class="annottext">e :: SpvException
</span><a href="#local-6989586621681509149"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Chainweb.SPV.html#SpvExceptionVerificationFailed"><span class="hs-identifier hs-type">SpvExceptionVerificationFailed</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler (TransactionOutputProof SHA512t_256))
-&gt; ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;SPV verification failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SpvException -&gt; ByteString
</span><a href="#local-6989586621681509150"><span class="hs-identifier hs-var">spvErrOf</span></a></span><span> </span><span class="annot"><span class="annottext">SpvException
</span><a href="#local-6989586621681509149"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621681509147"><span class="annot"><span class="annottext">e :: SpvException
</span><a href="#local-6989586621681509147"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall (m :: * -&gt; *) a.
MonadError ServerError m =&gt;
ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var">toErr</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Handler (TransactionOutputProof SHA512t_256))
-&gt; ByteString -&gt; Handler (TransactionOutputProof SHA512t_256)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: SPV verification failed: &quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SpvException -&gt; ByteString
</span><a href="#local-6989586621681509150"><span class="hs-identifier hs-var">spvErrOf</span></a></span><span> </span><span class="annot"><span class="annottext">SpvException
</span><a href="#local-6989586621681509147"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621681509146"><span class="annot"><span class="annottext">q :: TransactionOutputProof SHA512t_256
</span><a href="#local-6989586621681509146"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256
-&gt; Handler (TransactionOutputProof SHA512t_256)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256
</span><a href="#local-6989586621681509146"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><span class="annottext">TransactionOutputProofB64 -&gt; Handler TransactionOutputProofB64
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TransactionOutputProofB64 -&gt; Handler TransactionOutputProofB64)
-&gt; TransactionOutputProofB64 -&gt; Handler TransactionOutputProofB64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256 -&gt; TransactionOutputProofB64
</span><a href="#local-6989586621681509145"><span class="hs-identifier hs-var">b64</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256
</span><a href="#local-6989586621681509155"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621681509168"><span class="annot"><span class="annottext">pe :: PactExecutionService
</span><a href="#local-6989586621681509168"><span class="hs-identifier hs-var hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainResources l -&gt; PactExecutionService
forall logger. ChainResources logger -&gt; PactExecutionService
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResPact"><span class="hs-identifier hs-var hs-var">_chainResPact</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources l
</span><a href="#local-6989586621681509183"><span class="hs-identifier hs-var">chainR</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621681509176"><span class="annot"><span class="annottext">ph :: TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509176"><span class="hs-identifier hs-var hs-var">ph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; TypedHash 'Blake2b_256
forall (h :: HashAlgo). Hash -&gt; TypedHash h
</span><span class="hs-identifier hs-var">Pact.fromUntypedHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; TypedHash 'Blake2b_256) -&gt; Hash -&gt; TypedHash 'Blake2b_256
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; Hash
</span><span class="hs-identifier hs-var hs-var">unRequestKey</span></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509181"><span class="hs-identifier hs-var">rk</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621681509174"><span class="annot"><span class="annottext">cdb :: CutDb cas
</span><a href="#local-6989586621681509174"><span class="hs-identifier hs-var hs-var">cdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CutResources l cas -&gt; CutDb cas
forall logger (cas1 :: * -&gt; *).
CutResources logger cas1 -&gt; CutDb cas1
</span><a href="Chainweb.Chainweb.CutResources.html#_cutResCutDb"><span class="hs-identifier hs-var hs-var">_cutResCutDb</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources l cas
</span><a href="#local-6989586621681509185"><span class="hs-identifier hs-var">cutR</span></a></span><span>
</span><span id="line-368"></span><span>    </span><span id="local-6989586621681509161"><span class="annot"><span class="annottext">bdb :: BlockHeaderDb
</span><a href="#local-6989586621681509161"><span class="hs-identifier hs-var hs-var">bdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainResources l -&gt; BlockHeaderDb
forall logger. ChainResources logger -&gt; BlockHeaderDb
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResBlockHeaderDb"><span class="hs-identifier hs-var hs-var">_chainResBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources l
</span><a href="#local-6989586621681509183"><span class="hs-identifier hs-var">chainR</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span id="local-6989586621681509160"><span class="annot"><span class="annottext">pdb :: PayloadDb cas
</span><a href="#local-6989586621681509160"><span class="hs-identifier hs-var hs-var">pdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting (PayloadDb cas) (CutDb cas) (PayloadDb cas)
-&gt; CutDb cas -&gt; PayloadDb cas
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting (PayloadDb cas) (CutDb cas) (PayloadDb cas)
forall (cas :: * -&gt; *). Getter (CutDb cas) (PayloadDb cas)
</span><a href="Chainweb.CutDB.html#cutDbPayloadCas"><span class="hs-identifier hs-var">CutDB.cutDbPayloadCas</span></a></span><span> </span><span class="annot"><span class="annottext">CutDb cas
</span><a href="#local-6989586621681509174"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621681509145"><span class="annot"><span class="annottext">b64 :: TransactionOutputProof SHA512t_256 -&gt; TransactionOutputProofB64
</span><a href="#local-6989586621681509145"><span class="hs-identifier hs-var hs-var">b64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; TransactionOutputProofB64
</span><a href="Chainweb.Pact.Service.Types.html#TransactionOutputProofB64"><span class="hs-identifier hs-var">TransactionOutputProofB64</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; TransactionOutputProofB64)
-&gt; (TransactionOutputProof SHA512t_256 -&gt; Text)
-&gt; TransactionOutputProof SHA512t_256
-&gt; TransactionOutputProofB64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><a href="Chainweb.Utils.html#encodeB64UrlNoPaddingText"><span class="hs-identifier hs-var">encodeB64UrlNoPaddingText</span></a></span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">(ByteString -&gt; Text)
-&gt; (TransactionOutputProof SHA512t_256 -&gt; ByteString)
-&gt; TransactionOutputProof SHA512t_256
-&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BSL8.toStrict</span></span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (TransactionOutputProof SHA512t_256 -&gt; ByteString)
-&gt; TransactionOutputProof SHA512t_256
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TransactionOutputProof SHA512t_256 -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Aeson.encode</span></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621681509178"><span class="annot"><span class="annottext">logg :: Text -&gt; IO ()
</span><a href="#local-6989586621681509178"><span class="hs-identifier hs-var hs-var">logg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">l -&gt; LogLevel -&gt; PactCmdLog -&gt; IO ()
forall l a. Logger l =&gt; l -&gt; LogFunctionJson a
</span><a href="Chainweb.Logger.html#logFunctionJson"><span class="hs-identifier hs-var">logFunctionJson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; l -&gt; l
forall logger. Logger logger =&gt; Text -&gt; logger -&gt; logger
</span><a href="Chainweb.Logger.html#setComponent"><span class="hs-identifier hs-var">setComponent</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;spv-handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">l
</span><a href="#local-6989586621681509186"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><span class="hs-identifier hs-var">Info</span></span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><span class="annottext">(PactCmdLog -&gt; IO ()) -&gt; (Text -&gt; PactCmdLog) -&gt; Text -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PactCmdLog
</span><a href="Chainweb.Pact.RestAPI.Server.html#PactCmdLogSpv"><span class="hs-identifier hs-var">PactCmdLogSpv</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621681509166"><span class="annot"><span class="annottext">toErr :: ByteString -&gt; m a
</span><a href="#local-6989586621681509166"><span class="hs-identifier hs-var hs-var">toErr</span></a></span></span><span> </span><span id="local-6989586621681509136"><span class="annot"><span class="annottext">e :: ByteString
</span><a href="#local-6989586621681509136"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerError -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(ServerError -&gt; m a) -&gt; ServerError -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerError
</span><span class="hs-identifier hs-var">err400</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">errBody :: ByteString
</span><span class="hs-identifier hs-var">errBody</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681509136"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>    </span><span id="local-6989586621681509150"><span class="annot"><span class="annottext">spvErrOf :: SpvException -&gt; ByteString
</span><a href="#local-6989586621681509150"><span class="hs-identifier hs-var hs-var">spvErrOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BSL8.fromStrict</span></span><span>
</span><span id="line-381"></span><span>      </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (SpvException -&gt; ByteString) -&gt; SpvException -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">encodeUtf8</span></span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="annottext">(Text -&gt; ByteString)
-&gt; (SpvException -&gt; Text) -&gt; SpvException -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SpvException -&gt; Text
</span><a href="Chainweb.SPV.html#_spvExceptionMsg"><span class="hs-identifier hs-var hs-var">_spvExceptionMsg</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span id="local-6989586621681509538"><span id="local-6989586621681509539"><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#internalPoll"><span class="hs-identifier hs-type">internalPoll</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.PayloadStore.Types.html#PayloadCas"><span class="hs-identifier hs-type">PayloadCas</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509539"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.CutResources.html#CutResources"><span class="hs-identifier hs-type">CutResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509538"><span class="hs-identifier hs-type">logger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509539"><span class="hs-identifier hs-type">cas</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.ChainId.html#ChainId"><span class="hs-identifier hs-type">ChainId</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Chainweb.ChainResources.html#ChainResources"><span class="hs-identifier hs-type">ChainResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681509538"><span class="hs-identifier hs-type">logger</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Chainweb.Cut.html#Cut"><span class="hs-identifier hs-type">Cut</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestKey</span></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestKey</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CommandResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-394"></span><span id="internalPoll"><span class="annot"><span class="annottext">internalPoll :: CutResources logger cas
-&gt; ChainId
-&gt; ChainResources logger
-&gt; Cut
-&gt; NonEmpty RequestKey
-&gt; IO (HashMap RequestKey (CommandResult Hash))
</span><a href="Chainweb.Pact.RestAPI.Server.html#internalPoll"><span class="hs-identifier hs-var hs-var">internalPoll</span></a></span></span><span> </span><span id="local-6989586621681509132"><span class="annot"><span class="annottext">cutR :: CutResources logger cas
</span><a href="#local-6989586621681509132"><span class="hs-identifier hs-var">cutR</span></a></span></span><span> </span><span id="local-6989586621681509131"><span class="annot"><span class="annottext">cid :: ChainId
</span><a href="#local-6989586621681509131"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621681509130"><span class="annot"><span class="annottext">chain :: ChainResources logger
</span><a href="#local-6989586621681509130"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621681509129"><span class="annot"><span class="annottext">cut :: Cut
</span><a href="#local-6989586621681509129"><span class="hs-identifier hs-var">cut</span></a></span></span><span> </span><span id="local-6989586621681509128"><span class="annot"><span class="annottext">requestKeys0 :: NonEmpty RequestKey
</span><a href="#local-6989586621681509128"><span class="hs-identifier hs-var">requestKeys0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-comment">-- get leaf block header for our chain from current best cut</span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621681509127"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509127"><span class="hs-identifier hs-var">chainLeaf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainId -&gt; Cut -&gt; IO BlockHeader
forall (m :: * -&gt; *) cid.
(MonadThrow m, HasChainId cid) =&gt;
cid -&gt; Cut -&gt; m BlockHeader
</span><a href="Chainweb.Cut.html#lookupCutM"><span class="hs-identifier hs-var">lookupCutM</span></a></span><span> </span><span class="annot"><span class="annottext">ChainId
</span><a href="#local-6989586621681509131"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Cut
</span><a href="#local-6989586621681509129"><span class="hs-identifier hs-var">cut</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621681509126"><span class="annot"><span class="annottext">Vector (Maybe (T2 BlockHeight BlockHash))
</span><a href="#local-6989586621681509126"><span class="hs-identifier hs-var">results0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PactExecutionService
-&gt; Either ChainId BlockHeader
-&gt; Vector (TypedHash 'Blake2b_256)
-&gt; IO
     (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
</span><a href="Chainweb.WebPactExecutionService.Types.html#_pactLookup"><span class="hs-identifier hs-var hs-var">_pactLookup</span></a></span><span> </span><span class="annot"><span class="annottext">PactExecutionService
</span><a href="#local-6989586621681509125"><span class="hs-identifier hs-var">pactEx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockHeader -&gt; Either ChainId BlockHeader
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509127"><span class="hs-identifier hs-var">chainLeaf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector (TypedHash 'Blake2b_256)
</span><a href="#local-6989586621681509124"><span class="hs-identifier hs-var">requestKeys</span></a></span><span> </span><span class="annot"><span class="annottext">IO
  (Either PactException (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; (Either
      PactException (Vector (Maybe (T2 BlockHeight BlockHash)))
    -&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(PactException -&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; (Vector (Maybe (T2 BlockHeight BlockHash))
    -&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash))))
-&gt; Either PactException (Vector (Maybe (T2 BlockHeight BlockHash)))
-&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash)))
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">PactException -&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash)))
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwM</span></span><span> </span><span class="annot"><span class="annottext">Vector (Maybe (T2 BlockHeight BlockHash))
-&gt; IO (Vector (Maybe (T2 BlockHeight BlockHash)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509121"><span class="annot"><span class="annottext">results :: Vector (RequestKey, T2 BlockHeight BlockHash)
</span><a href="#local-6989586621681509121"><span class="hs-identifier hs-var hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((RequestKey, Maybe (T2 BlockHeight BlockHash))
 -&gt; (RequestKey, T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, T2 BlockHeight BlockHash)
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681509119"><span class="annot"><span class="annottext">a :: RequestKey
</span><a href="#local-6989586621681509119"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681509118"><span class="annot"><span class="annottext">b :: Maybe (T2 BlockHeight BlockHash)
</span><a href="#local-6989586621681509118"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509119"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (T2 BlockHeight BlockHash) -&gt; T2 BlockHeight BlockHash
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (T2 BlockHeight BlockHash)
</span><a href="#local-6989586621681509118"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
 -&gt; Vector (RequestKey, T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, T2 BlockHeight BlockHash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-399"></span><span>                  </span><span class="annot"><span class="annottext">((RequestKey, Maybe (T2 BlockHeight BlockHash)) -&gt; Bool)
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
forall a. (a -&gt; Bool) -&gt; Vector a -&gt; Vector a
</span><span class="hs-identifier hs-var">V.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (T2 BlockHeight BlockHash) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (T2 BlockHeight BlockHash) -&gt; Bool)
-&gt; ((RequestKey, Maybe (T2 BlockHeight BlockHash))
    -&gt; Maybe (T2 BlockHeight BlockHash))
-&gt; (RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Maybe (T2 BlockHeight BlockHash)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
 -&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash)))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-400"></span><span>                  </span><span class="annot"><span class="annottext">Vector RequestKey
-&gt; Vector (Maybe (T2 BlockHeight BlockHash))
-&gt; Vector (RequestKey, Maybe (T2 BlockHeight BlockHash))
forall a b. Vector a -&gt; Vector b -&gt; Vector (a, b)
</span><span class="hs-identifier hs-var">V.zip</span></span><span> </span><span class="annot"><span class="annottext">Vector RequestKey
</span><a href="#local-6989586621681509113"><span class="hs-identifier hs-var">requestKeysV</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Maybe (T2 BlockHeight BlockHash))
</span><a href="#local-6989586621681509126"><span class="hs-identifier hs-var">results0</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(RequestKey, CommandResult Hash)]
-&gt; HashMap RequestKey (CommandResult Hash)
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(RequestKey, CommandResult Hash)]
 -&gt; HashMap RequestKey (CommandResult Hash))
-&gt; (Vector (Maybe (RequestKey, CommandResult Hash))
    -&gt; [(RequestKey, CommandResult Hash)])
-&gt; Vector (Maybe (RequestKey, CommandResult Hash))
-&gt; HashMap RequestKey (CommandResult Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (RequestKey, CommandResult Hash)]
-&gt; [(RequestKey, CommandResult Hash)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (RequestKey, CommandResult Hash)]
 -&gt; [(RequestKey, CommandResult Hash)])
-&gt; (Vector (Maybe (RequestKey, CommandResult Hash))
    -&gt; [Maybe (RequestKey, CommandResult Hash)])
-&gt; Vector (Maybe (RequestKey, CommandResult Hash))
-&gt; [(RequestKey, CommandResult Hash)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Vector (Maybe (RequestKey, CommandResult Hash))
-&gt; [Maybe (RequestKey, CommandResult Hash)]
forall a. Vector a -&gt; [a]
</span><span class="hs-identifier hs-var">V.toList</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Vector (Maybe (RequestKey, CommandResult Hash))
 -&gt; HashMap RequestKey (CommandResult Hash))
-&gt; IO (Vector (Maybe (RequestKey, CommandResult Hash)))
-&gt; IO (HashMap RequestKey (CommandResult Hash))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((RequestKey, T2 BlockHeight BlockHash)
 -&gt; IO (Maybe (RequestKey, CommandResult Hash)))
-&gt; Vector (RequestKey, T2 BlockHeight BlockHash)
-&gt; IO (Vector (Maybe (RequestKey, CommandResult Hash)))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(RequestKey, T2 BlockHeight BlockHash)
-&gt; IO (Maybe (RequestKey, CommandResult Hash))
</span><a href="#local-6989586621681509108"><span class="hs-identifier hs-var">lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (RequestKey, T2 BlockHeight BlockHash)
</span><a href="#local-6989586621681509121"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-403"></span><span>    </span><span id="local-6989586621681509125"><span class="annot"><span class="annottext">pactEx :: PactExecutionService
</span><a href="#local-6989586621681509125"><span class="hs-identifier hs-var hs-var">pactEx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting
  PactExecutionService (ChainResources logger) PactExecutionService
-&gt; ChainResources logger -&gt; PactExecutionService
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting
  PactExecutionService (ChainResources logger) PactExecutionService
forall logger. Lens' (ChainResources logger) PactExecutionService
</span><a href="Chainweb.Chainweb.ChainResources.html#chainResPact"><span class="hs-identifier hs-var">chainResPact</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509130"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681509113"><span class="annot"><span class="annottext">requestKeysV :: Vector RequestKey
</span><a href="#local-6989586621681509113"><span class="hs-identifier hs-var hs-var">requestKeysV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RequestKey] -&gt; Vector RequestKey
forall a. [a] -&gt; Vector a
</span><span class="hs-identifier hs-var">V.fromList</span></span><span> </span><span class="annot"><span class="annottext">([RequestKey] -&gt; Vector RequestKey)
-&gt; [RequestKey] -&gt; Vector RequestKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty RequestKey -&gt; [RequestKey]
forall a. NonEmpty a -&gt; [a]
</span><span class="hs-identifier hs-var">NEL.toList</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty RequestKey
</span><a href="#local-6989586621681509128"><span class="hs-identifier hs-var">requestKeys0</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681509124"><span class="annot"><span class="annottext">requestKeys :: Vector (TypedHash 'Blake2b_256)
</span><a href="#local-6989586621681509124"><span class="hs-identifier hs-var hs-var">requestKeys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RequestKey -&gt; TypedHash 'Blake2b_256)
-&gt; Vector RequestKey -&gt; Vector (TypedHash 'Blake2b_256)
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TypedHash 'Blake2b_256
forall (h :: HashAlgo). Hash -&gt; TypedHash h
</span><span class="hs-identifier hs-var">Pact.fromUntypedHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; TypedHash 'Blake2b_256)
-&gt; (RequestKey -&gt; Hash) -&gt; RequestKey -&gt; TypedHash 'Blake2b_256
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; Hash
</span><span class="hs-identifier hs-var hs-var">unRequestKey</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector RequestKey
</span><a href="#local-6989586621681509113"><span class="hs-identifier hs-var">requestKeysV</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621681509106"><span class="annot"><span class="annottext">pdb :: PayloadDb cas
</span><a href="#local-6989586621681509106"><span class="hs-identifier hs-var hs-var">pdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
</span><a href="#local-6989586621681509132"><span class="hs-identifier hs-var">cutR</span></a></span><span> </span><span class="annot"><span class="annottext">CutResources logger cas
-&gt; Getting
     (PayloadDb cas) (CutResources logger cas) (PayloadDb cas)
-&gt; PayloadDb cas
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(CutDb cas -&gt; Const (PayloadDb cas) (CutDb cas))
-&gt; CutResources logger cas
-&gt; Const (PayloadDb cas) (CutResources logger cas)
forall logger (cas1 :: * -&gt; *) (cas2 :: * -&gt; *).
Lens
  (CutResources logger cas1)
  (CutResources logger cas2)
  (CutDb cas1)
  (CutDb cas2)
</span><a href="Chainweb.Chainweb.CutResources.html#cutsCutDb"><span class="hs-identifier hs-var">cutsCutDb</span></a></span><span> </span><span class="annot"><span class="annottext">((CutDb cas -&gt; Const (PayloadDb cas) (CutDb cas))
 -&gt; CutResources logger cas
 -&gt; Const (PayloadDb cas) (CutResources logger cas))
-&gt; ((PayloadDb cas -&gt; Const (PayloadDb cas) (PayloadDb cas))
    -&gt; CutDb cas -&gt; Const (PayloadDb cas) (CutDb cas))
-&gt; Getting
     (PayloadDb cas) (CutResources logger cas) (PayloadDb cas)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PayloadDb cas -&gt; Const (PayloadDb cas) (PayloadDb cas))
-&gt; CutDb cas -&gt; Const (PayloadDb cas) (CutDb cas)
forall (cas :: * -&gt; *). Getter (CutDb cas) (PayloadDb cas)
</span><a href="Chainweb.CutDB.html#cutDbPayloadCas"><span class="hs-identifier hs-var">CutDB.cutDbPayloadCas</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621681509104"><span class="annot"><span class="annottext">bhdb :: BlockHeaderDb
</span><a href="#local-6989586621681509104"><span class="hs-identifier hs-var hs-var">bhdb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainResources logger -&gt; BlockHeaderDb
forall logger. ChainResources logger -&gt; BlockHeaderDb
</span><a href="Chainweb.Chainweb.ChainResources.html#_chainResBlockHeaderDb"><span class="hs-identifier hs-var hs-var">_chainResBlockHeaderDb</span></a></span><span> </span><span class="annot"><span class="annottext">ChainResources logger
</span><a href="#local-6989586621681509130"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><a href="#local-6989586621681509108"><span class="hs-identifier hs-type">lookup</span></a></span><span>
</span><span id="line-410"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RequestKey</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="annot"><a href="Chainweb.BlockHeader.html#BlockHeight"><span class="hs-identifier hs-type">BlockHeight</span></a></span><span> </span><span class="annot"><a href="Chainweb.BlockHash.html#BlockHash"><span class="hs-identifier hs-type">BlockHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RequestKey</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CommandResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>    </span><span id="local-6989586621681509108"><span class="annot"><span class="annottext">lookup :: (RequestKey, T2 BlockHeight BlockHash)
-&gt; IO (Maybe (RequestKey, CommandResult Hash))
</span><a href="#local-6989586621681509108"><span class="hs-identifier hs-var hs-var">lookup</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509103"><span class="annot"><span class="annottext">key :: RequestKey
</span><a href="#local-6989586621681509103"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T2</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681509102"><span class="annot"><span class="annottext">ha :: BlockHash
</span><a href="#local-6989586621681509102"><span class="hs-identifier hs-var">ha</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CommandResult Hash -&gt; (RequestKey, CommandResult Hash))
-&gt; Maybe (CommandResult Hash)
-&gt; Maybe (RequestKey, CommandResult Hash)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509103"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (CommandResult Hash)
 -&gt; Maybe (RequestKey, CommandResult Hash))
-&gt; IO (Maybe (CommandResult Hash))
-&gt; IO (Maybe (RequestKey, CommandResult Hash))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; BlockHash -&gt; IO (Maybe (CommandResult Hash))
</span><a href="#local-6989586621681509101"><span class="hs-identifier hs-var">lookupRequestKey</span></a></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509103"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHash
</span><a href="#local-6989586621681509102"><span class="hs-identifier hs-var">ha</span></a></span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-comment">-- TODO: group by block for performance (not very important right now)</span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621681509101"><span class="annot"><span class="annottext">lookupRequestKey :: RequestKey -&gt; BlockHash -&gt; IO (Maybe (CommandResult Hash))
</span><a href="#local-6989586621681509101"><span class="hs-identifier hs-var hs-var">lookupRequestKey</span></a></span></span><span> </span><span id="local-6989586621681509100"><span class="annot"><span class="annottext">key :: RequestKey
</span><a href="#local-6989586621681509100"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621681509099"><span class="annot"><span class="annottext">bHash :: BlockHash
</span><a href="#local-6989586621681509099"><span class="hs-identifier hs-var">bHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT IO (CommandResult Hash) -&gt; IO (Maybe (CommandResult Hash))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT IO (CommandResult Hash) -&gt; IO (Maybe (CommandResult Hash)))
-&gt; MaybeT IO (CommandResult Hash)
-&gt; IO (Maybe (CommandResult Hash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509097"><span class="annot"><span class="annottext">keyHash :: Hash
</span><a href="#local-6989586621681509097"><span class="hs-identifier hs-var hs-var">keyHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; Hash
</span><span class="hs-identifier hs-var hs-var">unRequestKey</span></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509100"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509096"><span class="annot"><span class="annottext">pactHash :: TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509096"><span class="hs-identifier hs-var hs-var">pactHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; TypedHash 'Blake2b_256
forall (h :: HashAlgo). Hash -&gt; TypedHash h
</span><span class="hs-identifier hs-var">Pact.fromUntypedHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621681509097"><span class="hs-identifier hs-var">keyHash</span></a></span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509095"><span class="annot"><span class="annottext">matchingHash :: (Command Text, TransactionOutput) -&gt; Bool
</span><a href="#local-6989586621681509095"><span class="hs-identifier hs-var hs-var">matchingHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256 -&gt; TypedHash 'Blake2b_256 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TypedHash 'Blake2b_256
</span><a href="#local-6989586621681509096"><span class="hs-identifier hs-var">pactHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypedHash 'Blake2b_256 -&gt; Bool)
-&gt; ((Command Text, TransactionOutput) -&gt; TypedHash 'Blake2b_256)
-&gt; (Command Text, TransactionOutput)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Command Text -&gt; TypedHash 'Blake2b_256
forall a. Command a -&gt; TypedHash 'Blake2b_256
</span><span class="hs-identifier hs-var hs-var">_cmdHash</span></span><span> </span><span class="annot"><span class="annottext">(Command Text -&gt; TypedHash 'Blake2b_256)
-&gt; ((Command Text, TransactionOutput) -&gt; Command Text)
-&gt; (Command Text, TransactionOutput)
-&gt; TypedHash 'Blake2b_256
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Command Text, TransactionOutput) -&gt; Command Text
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-419"></span><span>        </span><span id="local-6989586621681509093"><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509093"><span class="hs-identifier hs-var">blockHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO BlockHeader -&gt; MaybeT IO BlockHeader
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO BlockHeader -&gt; MaybeT IO BlockHeader)
-&gt; IO BlockHeader -&gt; MaybeT IO BlockHeader
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb -&gt; DbKey BlockHeaderDb -&gt; IO (DbEntry BlockHeaderDb)
forall db. TreeDb db =&gt; db -&gt; DbKey db -&gt; IO (DbEntry db)
</span><a href="Chainweb.TreeDB.html#lookupM"><span class="hs-identifier hs-var">TreeDB.lookupM</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeaderDb
</span><a href="#local-6989586621681509104"><span class="hs-identifier hs-var">bhdb</span></a></span><span> </span><span class="annot"><span class="annottext">DbKey BlockHeaderDb
BlockHash
</span><a href="#local-6989586621681509099"><span class="hs-identifier hs-var">bHash</span></a></span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681509091"><span class="annot"><span class="annottext">payloadHash :: BlockPayloadHash
</span><a href="#local-6989586621681509091"><span class="hs-identifier hs-var hs-var">payloadHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockHeader -&gt; BlockPayloadHash
</span><a href="Chainweb.BlockHeader.html#_blockPayloadHash"><span class="hs-identifier hs-var hs-var">_blockPayloadHash</span></a></span><span> </span><span class="annot"><span class="annottext">BlockHeader
</span><a href="#local-6989586621681509093"><span class="hs-identifier hs-var">blockHeader</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Payload.html#PayloadWithOutputs"><span class="hs-identifier hs-type">PayloadWithOutputs</span></a></span><span> </span><span id="local-6989586621681509088"><span class="annot"><span class="annottext">txsBs :: Vector (Transaction, TransactionOutput)
</span><a href="#local-6989586621681509088"><span class="hs-identifier hs-var">txsBs</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe PayloadWithOutputs) -&gt; MaybeT IO PayloadWithOutputs
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe PayloadWithOutputs) -&gt; MaybeT IO PayloadWithOutputs)
-&gt; IO (Maybe PayloadWithOutputs) -&gt; MaybeT IO PayloadWithOutputs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PayloadDb cas
-&gt; CasKeyType (CasValueType (PayloadDb cas))
-&gt; IO (Maybe (CasValueType (PayloadDb cas)))
forall a.
IsCas a =&gt;
a -&gt; CasKeyType (CasValueType a) -&gt; IO (Maybe (CasValueType a))
</span><span class="hs-identifier hs-var">casLookup</span></span><span> </span><span class="annot"><span class="annottext">PayloadDb cas
</span><a href="#local-6989586621681509106"><span class="hs-identifier hs-var">pdb</span></a></span><span> </span><span class="annot"><span class="annottext">CasKeyType (CasValueType (PayloadDb cas))
BlockPayloadHash
</span><a href="#local-6989586621681509091"><span class="hs-identifier hs-var">payloadHash</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681509085"><span class="annot"><span class="annottext">Vector (Command Text, TransactionOutput)
</span><a href="#local-6989586621681509085"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Transaction, TransactionOutput)
 -&gt; MaybeT IO (Command Text, TransactionOutput))
-&gt; Vector (Transaction, TransactionOutput)
-&gt; MaybeT IO (Vector (Command Text, TransactionOutput))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Transaction, TransactionOutput)
-&gt; MaybeT IO (Command Text, TransactionOutput)
forall (m :: * -&gt; *) b.
Monad m =&gt;
(Transaction, b) -&gt; MaybeT m (Command Text, b)
</span><a href="#local-6989586621681509084"><span class="hs-identifier hs-var">fromTx</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Transaction, TransactionOutput)
</span><a href="#local-6989586621681509088"><span class="hs-identifier hs-var">txsBs</span></a></span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">((Command Text, TransactionOutput) -&gt; Bool)
-&gt; Vector (Command Text, TransactionOutput)
-&gt; Maybe (Command Text, TransactionOutput)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="annot"><span class="annottext">(Command Text, TransactionOutput) -&gt; Bool
</span><a href="#local-6989586621681509095"><span class="hs-identifier hs-var">matchingHash</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (Command Text, TransactionOutput)
</span><a href="#local-6989586621681509085"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-424"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681509083"><span class="annot"><span class="annottext">_cmd :: Command Text
</span><a href="#local-6989586621681509083"><span class="hs-identifier hs-var">_cmd</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Payload.html#TransactionOutput"><span class="hs-identifier hs-type">TransactionOutput</span></a></span><span> </span><span id="local-6989586621681509081"><span class="annot"><span class="annottext">output :: ByteString
</span><a href="#local-6989586621681509081"><span class="hs-identifier hs-var">output</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>                </span><span id="local-6989586621681509080"><span class="annot"><span class="annottext">CommandResult Hash
</span><a href="#local-6989586621681509080"><span class="hs-identifier hs-var">out</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (CommandResult Hash)) -&gt; MaybeT IO (CommandResult Hash)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe (CommandResult Hash)) -&gt; MaybeT IO (CommandResult Hash))
-&gt; IO (Maybe (CommandResult Hash))
-&gt; MaybeT IO (CommandResult Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (CommandResult Hash) -&gt; IO (Maybe (CommandResult Hash))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (CommandResult Hash) -&gt; IO (Maybe (CommandResult Hash)))
-&gt; Maybe (CommandResult Hash) -&gt; IO (Maybe (CommandResult Hash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (CommandResult Hash)
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">decodeStrict'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681509081"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-426"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT IO () -&gt; MaybeT IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandResult Hash -&gt; RequestKey
forall l. CommandResult l -&gt; RequestKey
</span><span class="hs-identifier hs-var hs-var">_crReqKey</span></span><span> </span><span class="annot"><span class="annottext">CommandResult Hash
</span><a href="#local-6989586621681509080"><span class="hs-identifier hs-var">out</span></a></span><span> </span><span class="annot"><span class="annottext">RequestKey -&gt; RequestKey -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RequestKey
</span><a href="#local-6989586621681509100"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MaybeT IO () -&gt; MaybeT IO ()) -&gt; MaybeT IO () -&gt; MaybeT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-427"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; MaybeT IO ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;internal error: Transaction output doesn't match its hash!&quot;</span></span><span>
</span><span id="line-428"></span><span>                </span><span class="annot"><span class="annottext">CommandResult Hash -&gt; MaybeT IO (CommandResult Hash)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">CommandResult Hash
</span><a href="#local-6989586621681509080"><span class="hs-identifier hs-var">out</span></a></span><span>
</span><span id="line-429"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeT IO (CommandResult Hash)
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><span class="hs-identifier hs-var">mzero</span></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621681509084"><span class="annot"><span class="annottext">fromTx :: (Transaction, b) -&gt; MaybeT m (Command Text, b)
</span><a href="#local-6989586621681509084"><span class="hs-identifier hs-var hs-var">fromTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681509075"><span class="annot"><span class="annottext">Transaction
</span><a href="#local-6989586621681509075"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681509074"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681509074"><span class="hs-identifier hs-var">out</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681509073"><span class="annot"><span class="annottext">Command Text
</span><a href="#local-6989586621681509073"><span class="hs-identifier hs-var">tx'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Maybe (Command Text)) -&gt; MaybeT m (Command Text)
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Command Text) -&gt; m (Maybe (Command Text))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transaction -&gt; Maybe (Command Text)
</span><a href="Chainweb.Pact.RestAPI.Server.html#toPactTx"><span class="hs-identifier hs-var">toPactTx</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction
</span><a href="#local-6989586621681509075"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="annottext">(Command Text, b) -&gt; MaybeT m (Command Text, b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((Command Text, b) -&gt; MaybeT m (Command Text, b))
-&gt; (Command Text, b) -&gt; MaybeT m (Command Text, b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Command Text
</span><a href="#local-6989586621681509073"><span class="hs-identifier hs-var">tx'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681509074"><span class="hs-identifier hs-var">out</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#toPactTx"><span class="hs-identifier hs-type">toPactTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Chainweb.Payload.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span id="toPactTx"><span class="annot"><span class="annottext">toPactTx :: Transaction -&gt; Maybe (Command Text)
</span><a href="Chainweb.Pact.RestAPI.Server.html#toPactTx"><span class="hs-identifier hs-var hs-var">toPactTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Chainweb.Payload.html#Transaction"><span class="hs-identifier hs-type">Transaction</span></a></span><span> </span><span id="local-6989586621681509070"><span class="annot"><span class="annottext">b :: ByteString
</span><a href="#local-6989586621681509070"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Command Text)
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">decodeStrict'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681509070"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span class="annot"><a href="Chainweb.Pact.RestAPI.Server.html#validateCommand"><span class="hs-identifier hs-type">validateCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Chainweb.Transaction.html#ChainwebTransaction"><span class="hs-identifier hs-type">ChainwebTransaction</span></a></span><span>
</span><span id="line-440"></span><span id="validateCommand"><span class="annot"><span class="annottext">validateCommand :: Command Text -&gt; Either String ChainwebTransaction
</span><a href="Chainweb.Pact.RestAPI.Server.html#validateCommand"><span class="hs-identifier hs-var hs-var">validateCommand</span></a></span></span><span> </span><span id="local-6989586621681509069"><span class="annot"><span class="annottext">cmdText :: Command Text
</span><a href="#local-6989586621681509069"><span class="hs-identifier hs-var">cmdText</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Command ByteString -&gt; ProcessedCommand PublicMeta ParsedCode
forall m.
FromJSON m =&gt;
Command ByteString -&gt; ProcessedCommand m ParsedCode
</span><span class="hs-identifier hs-var">verifyCommand</span></span><span> </span><span class="annot"><span class="annottext">Command ByteString
</span><a href="#local-6989586621681509067"><span class="hs-identifier hs-var">cmdBS</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ProcSucc</span></span><span> </span><span id="local-6989586621681509065"><span class="annot"><span class="annottext">cmd :: Command (Payload PublicMeta ParsedCode)
</span><a href="#local-6989586621681509065"><span class="hs-identifier hs-var">cmd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainwebTransaction -&gt; Either String ChainwebTransaction
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Payload PublicMeta ParsedCode -&gt; PayloadWithText
</span><a href="Chainweb.Transaction.html#mkPayloadWithText"><span class="hs-identifier hs-var">mkPayloadWithText</span></a></span><span> </span><span class="annot"><span class="annottext">(Payload PublicMeta ParsedCode -&gt; PayloadWithText)
-&gt; Command (Payload PublicMeta ParsedCode) -&gt; ChainwebTransaction
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Command (Payload PublicMeta ParsedCode)
</span><a href="#local-6989586621681509065"><span class="hs-identifier hs-var">cmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ProcFail</span></span><span> </span><span id="local-6989586621681509063"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621681509063"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ChainwebTransaction
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681509063"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><a href="#local-6989586621681509067"><span class="hs-identifier hs-type">cmdBS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-445"></span><span>    </span><span id="local-6989586621681509067"><span class="annot"><span class="annottext">cmdBS :: Command ByteString
</span><a href="#local-6989586621681509067"><span class="hs-identifier hs-var hs-var">cmdBS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; Command Text -&gt; Command ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Command Text
</span><a href="#local-6989586621681509069"><span class="hs-identifier hs-var">cmdText</span></a></span><span>
</span><span id="line-446"></span></pre></body></html>